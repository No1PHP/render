(this.webpackJsonprender=this.webpackJsonprender||[]).push([[0],{212:function(t,e,i){},370:function(t,e,i){"use strict";i.r(e);var r=i(0),n=i.n(r),a=i(12),s=i.n(a),o=(i(212),i(56)),h=i(57),l=i(35),m=i(60),c=i(59),u=i(21),f=(i(142),i(13)),d=function(t){Object(m.a)(i,t);var e=Object(c.a)(i);function i(t){var r;return Object(o.a)(this,i),(r=e.call(this,t)).val=r.props.defaultValue,r}return Object(h.a)(i,[{key:"render",value:function(){var t=this;return Object(f.jsx)(f.Fragment,{children:Object(f.jsxs)(u.d,{style:{marginLeft:30,marginRight:30},min:this.props.min,max:this.props.max,step:this.props.step,defaultValue:this.props.defaultValue,onChange:function(e){switch(t.val=e,t.forceUpdate(),t.props.name){case"LeftRight":t.props.parent.getLeftRightSlider(t,e);break;case"TopDown":t.props.parent.getTopDownSlider(t,e);break;case"ZaxisRotation":t.props.parent.getZaxisSlider(t,e);break;case"HorizontalRotate":t.props.parent.getHorizontalSlider(t,e);break;case"FlatRotation":t.props.parent.getFlatSlider(t,e);break;case"PerspectiveDistance":t.props.parent.getDistanceSlider(t,e)}},children:[Object(f.jsx)(u.f,{}),this.props.name," ",this.val," "]})})}}]),i}(r.Component),v=i(151),g=function(t){Object(m.a)(i,t);var e=Object(c.a)(i);function i(t){var r;return Object(o.a)(this,i),(r=e.call(this,t)).val=r.props.defaultValue,r.state={type:"digit",xValue:-10.1,yValue:4.1,zValue:-20.1},r}return Object(h.a)(i,[{key:"render",value:function(){var t=this,e=(this.props.form.getFieldProps,this.state.type);return Object(f.jsx)("div",{children:Object(f.jsxs)(u.c,{children:[Object(f.jsx)(u.b,{step:.1,type:e,labelNumber:7,clear:!0,onChange:function(e){t.props.parent.getXFromAttribInput(t,e)},defaultValue:-10.1,children:"-  LightSourceX"}),Object(f.jsx)(u.b,{step:.1,type:e,labelNumber:7,clear:!0,onChange:function(e){t.props.parent.getYFromAttribInput(t,e)},defaultValue:4.1,children:"-  LightSourceY"}),Object(f.jsx)(u.b,{step:.1,type:e,labelNumber:7,clear:!0,onChange:function(e){t.props.parent.getZFromAttribInput(t,e)},defaultValue:-20.1,children:"-  LightSourceZ"})]})})}}]),i}(r.Component),p=i(204),x=i(155),y=i.n(x),_=i(199),M=i(206),T=(i(174),i(156)),b=i.n(T),A=i(374),L=function(t){var e=Object(r.useState)([]),i=Object(M.a)(e,2),n=i[0],a=i[1],s=function(){var e=Object(_.a)(y.a.mark((function e(i){var r,n,a,s,o,h,l,m,c,u,f;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=!1,n=i.onSuccess,a=i.file,s=new FormData,{headers:{"content-type":"multipart/form-data"}},s.append("image",a),b.a.defaults.timeout=3e4,e.prev=6,e.next=9,b.a.post("http://localhost.charlesproxy.com:3000/api/mock");case 9:o=e.sent,n("Ok"),h=o.data.depth,l=o.data.albedo,m=o.data.env_light,c=o.data.diffuse_light,u=o.data.index,f=o.data.normals,t.parent.getRenderInfo(h,l,m,c,u,f),r=!0,t.parent.getRenderStatus(r),console.log("Rcv response after upload"),e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.log("Error: ",e.t0);case 26:case"end":return e.stop()}}),e,null,[[6,23]])})));return function(t){return e.apply(this,arguments)}}();return Object(f.jsx)("div",{style:{display:"block",marginLeft:20,marginRight:"auto",width:"40%"},children:Object(f.jsx)(v.a,{rotate:!0,modalTitle:"Please clip the image to maximize the facial part",grid:!0,quality:.8,modalOk:"Submit",children:Object(f.jsx)(A.a,{style:{marginLeft:20},accept:"image/*",customRequest:s,onChange:function(t){t.file;var e=t.fileList;t.event;a(e)},listType:"picture-card",defaultFileList:n,className:"image-upload-grid",children:n.length>=1?null:Object(f.jsx)("div",{children:"+ Upload"})})})})},S={ERROR:0,TYPE_VEC2:1,TYPE_VEC3:2,TYPE_VEC4:4,TYPE_MAT4:8,TYPE_MAT43:16,AXIS_X:1,AXIS_Y:2,AXIS_Z:3,COLLIDE_FALSE:0,COLLIDE_TRUE:1,COLLIDE_CONTAIN:2,SPACE_LOCAL:1,SPACE_WORLD:2,SPACE_VIEW:3,FLOAT_PRECISION:1e-6,PROJMODE_PERSPECTIVE:1,PROJMODE_ORTHO:2,FTPLANE_NEAR:0,FTPLANE_FAR:1,FTPLANE_LEFT:2,FTPLANE_RIGHT:3,FTPLANE_TOP:4,FTPLANE_BOTTOM:5,SKBLEND_ACCUMULATE:1,SKBLEND_LERP:2,BLENDCHANNEL_COLOR:1,BLENDCHANNEL_ALPHA:2,BLENDCHANNEL_ALL:3,MCUSAGE_ALBEDO1:0,MCUSAGE_ALBEDO2:1,MCUSAGE_ALBEDO3:2,MCUSAGE_ALBEDO4:3,MCUSAGE_NORMAL:4,MCUSAGE_OPACITY:5,MCUSAGE_SPECULAR_LEVEL:6,ETYPE_UNKNOWN:0,ETYPE_STATIC:1,ETYPE_DYNAMIC:2,ETYPE_DCT_LIGHT:4,ETYPE_POINT_LIGHT:8,ETYPE_SPOT_LIGHT:16,ETYPE_TERRAIN:32,ETYPE_CUSTOM_MESH:64,ETYPE_VIDEO:128,ETYPE_PARTICLE:256,ETYPE_CONFIG:512,ETYPE_LIGHT:28,ETYPE_VISIBLE:483,ETYPE_INTREE:483,ETYPE_UPDATE:258,ETYPE_ALL:4294967295,ESTATE_UNAVAILABLE:1,ESTATE_BASIC_AVAILABLE:2,ESTATE_COMPLETE_AVAILABLE:4,RESDOCTYPE_XML:1,RESDOCTYPE_JSON:2,RESDOCTYPE_BINARY:3,RESTYPE_UNKNOWN:0,RESTYPE_MODEL:1,RESTYPE_TEXTURE:2,RESTYPE_SKANIMATION:3,RESSTATE_NONE:1,RESSTATE_UNLOAD:2,RESSTATE_LOADING:3,RESSTATE_LOADED:4,RESSTATE_READY:5,RESPRIORITY_HIGH:1,RESPRIORITY_NORMAL:2,RESPRIORITY_LOW:3,ENV_FOG1:1,RSTAGE_DEPTH:0,RSTAGE_SHADOW:1,RSTAGE_LIGHTING:2,WORLDMAP_NOT_READ:1,WORLDMAP_PARSING:2,WORLDMAP_PARSED:3,TEXTURE_IMAGE:1,TEXTURE_VIDEO:2,PARTIME_BEGIN:1,PARTIME_END:2,PARTIME_ALL:4294967295,DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,NUM_COMPRESSED_TEXTURE_FORMATS:34466,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_UNIFORM_MAX_LENGTH:35719,ACTIVE_ATTRIBUTES:35721,ACTIVE_ATTRIBUTE_MAX_LENGTH:35722,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,INFO_LOG_LENGTH:35716,SHADER_SOURCE_LENGTH:35720,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444};window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame;function C(t){return"undefined"==typeof t}function E(t){return"string"==typeof t}function O(t){return"[object Array]"===Object.prototype.toString.call(t)}function P(t){return"number"==typeof t}function B(){this.aDataList=new Array,this.iDataReserveHead=-1,this.iDataCount=0,this.iIterator=0}function w(){this.root=null,this.tail=null,this.iSize=0,this.pool=new Array}function k(t,e){this.aValidBlockList=new w,this.aValidBlockList.pushBack(new Lt(0,0,t,e))}function R(t){return(255*t.x<<16|255*t.y<<8|255*t.z)/(1<<24)}function z(t,e){var i=function(){};i.prototype=e.prototype,t.__parent=e.prototype,t.prototype=new i,t.prototype.constructor=t}function D(t,e){var i=arguments;if(i.__parent)return i.__parent.constructor.apply(t,Array.prototype.slice.call(arguments,1));for(var r=Array.prototype.slice.call(arguments,2),n=!1,a=t.constructor;a;a=a.__parent&&a.__parent.constructor)if(a.prototype[e]===i)n=!0;else if(n)return a.prototype[e].apply(t,r);if(t[e]===i)return t.constructor.prototype[e].apply(t,r);throw Error("Called from a method of one name to a method of a different name")}function N(){this.aVec2=new Array,this.aVec3=new Array,this.aVec4=new Array,this.aMat3=new Array,this.aMat4=new Array,this.aMat43=new Array,this.aQuat=new Array,this.aPlane=new Array,this.aAABBox=new Array,this.aSceneNode=new Array,this.aRenderBatch=new Array,this.aParticle=new Array,this.aArray=new Array,this.aObjectArray=new Array}B.prototype={clear:function(){this.aDataList.lengh=0,this.iDataReserveHead=-1,this.iDataCount=0,this.iIterator=0},add:function(t){if(-1!=this.iDataReserveHead){var e=this.iDataReserveHead;return this.iDataReserveHead=this.aDataList[this.iDataReserveHead].reserve,this.aDataList[e].data=t,this.aDataList[e].reserve=-1,this.aDataList[e].bValid=!0,this.iDataCount+=1,e}var i=new Object;return i.data=t,i.reserve=-1,i.bValid=!0,this.aDataList.push(i),this.iDataCount+=1,this.aDataList.length-1},find:function(t){for(var e=this.aDataList.length-1;e>=0;--e)if(this.aDataList[e].bValid&&this.aDataList[e].data==t)return!0;return!1},remove:function(t){for(var e=this.aDataList.length-1;e>=0;--e)if(this.aDataList[e].bValid&&this.aDataList[e].data==t)return this.aDataList[e].reserve=this.iDataReserveHead,this.aDataList[e].bValid=!1,this.iDataReserveHead=e,void(this.iDataCount-=1)},removeByIndex:function(t){this.aDataList[t].bValid&&(this.aDataList[t].reserve=this.iDataReserveHead,this.aDataList[t].bValid=!1,this.iDataReserveHead=t,this.iDataCount-=1)},getSize:function(){return this.iDataCount},getCapacity:function(){return this.aDataList.length},getDataByIndex:function(t){return this.aDataList[t].data},isIndexValid:function(t){return t<this.aDataList.length&&t>=0&&this.aDataList[t].bValid},resetIterator:function(){this.iIterator=0},iterate:function(){for(;this.iIterator<this.aDataList.length&&0==this.aDataList[this.iIterator].bValid;)this.iIterator++;return this.iIterator>=this.aDataList.length?null:this.aDataList[this.iIterator++].data}},w.prototype={clear:function(){for(var t=this.root;t;){var e=t.next;t.data=null,t.pre=null,t.next=null,this.pool.push(t),t=e}this.root=null,this.tail=null,this.iSize=0},getRoot:function(){return this.root},getTail:function(){return this.tail},getSize:function(){return this.iSize},isEmpty:function(){return 0==this.iSize},pushFront:function(t){var e=this.pool.length?this.pool.shift():new Object;e.data=t,e.next=this.root,e.pre=null,this.root?this.root.pre=e:this.tail=e,this.root=e,this.iSize+=1},popFront:function(){if(null==this.root)return null;var t=this.root;this.root=this.root.next,null!=this.root?this.root.pre=null:this.tail=null,this.iSize-=1,t.pre=null,t.next=null;var e=t.data;return t.data=null,this.pool.push(t),e},front:function(){return this.root?this.root.data:null},pushBack:function(t){var e=this.pool.length?this.pool.shift():new Object;e.data=t,e.pre=this.tail,e.next=null,this.tail?this.tail.next=e:this.root=e,this.tail=e,this.iSize+=1},popBack:function(){if(null==this.tail)return null;var t=this.tail;this.tail=this.tail.pre,null!=this.tail?this.tail.next=null:this.root=null,this.iSize-=1,t.pre=null,t.next=null;var e=t.data;return t.data=null,this.pool.push(t),e},back:function(){return this.tail?this.tail.data:null},insertBefore:function(t,e){var i=this.pool.length?this.pool.shift():new Object;i.data=e,i.pre=t.pre,i.next=t,t.pre=i,null==i.pre?this.root=i:i.pre.next=i,this.iSize+=1},insertAfter:function(t,e){var i=this.pool.length?this.pool.shift():new Object;i.data=e,i.pre=t,i.next=t.next,t.next=i,null==i.next?this.tail=i:i.next.pre=i,this.iSize+=1},remove:function(t){if(null==t)return null;t.pre&&(t.pre.next=t.next),t.next&&(t.next.pre=t.pre),t==this.root&&(this.root=t.next),t==this.tail&&(this.tail=t.pre),t.pre=null,t.next=null,t.data=null,this.pool.push(t),this.iSize-=1},find:function(t){for(var e=this.root;e;){if(e.data==t)return e;e=e.next}return null}},k.prototype={reset:function(t,e){this.aValidBlockList=new w,this.aValidBlockList.pushBack(new Lt(0,0,t,e))},add:function(t,e){for(var i=this.aValidBlockList.getRoot(),r=null,n=null,a=null;i;){var s=i.data;if(s.width>=t&&s.height>=e){r=new Lt(s.x,s.y,t,e),this.aValidBlockList.remove(i),s.width!=t&&s.height!=e?Math.max(s.height*(s.width-t),t*(s.height-e))>Math.max(s.width*(s.height-e),e*(s.width-t))?(n=new Lt(s.x,s.y+e,t,s.height-e),a=new Lt(s.x+t,s.y,s.width-t,s.height)):(n=new Lt(s.x,s.y+e,s.width,s.height-e),a=new Lt(s.x+t,s.y,s.width-t,e)):s.width!=t?n=new Lt(s.x+t,s.y,s.width-t,s.height):s.height!=e&&(n=new Lt(s.x,s.y+e,s.width,s.height-e));break}i=i.next}return n&&this.appendBlankRect(n),a&&this.appendBlankRect(a),r},remove:function(t){return this.appendBlankRect(t),!0},appendBlankRect:function(t){if(!(null==t||t.width<=0||t.height<=0)){for(var e=this.aValidBlockList.getRoot();e;){var i=e.data;if(i.width*i.height>t.width*t.height){this.aValidBlockList.insertBefore(e,t);break}e=e.next}null==e&&this.aValidBlockList.pushBack(t)}}},N.prototype={object:function(){return this.aObjectArray.length?this.aObjectArray.shift():new Object},_object:function(t){for(var e in t)delete t[e];this.aObjectArray.push(t)},array:function(){return this.aArray.length?this.aArray.shift():new Array},_array:function(t){t.length=0,this.aArray.push(t)},vec2:function(){return this.aVec2.length?this.aVec2.shift():new G},_vec2:function(t){t.x=0,t.y=0,this.aVec3.push(t)},vec3:function(t,e,i){return this.aVec3.length?this.aVec3.shift():new j},_vec3:function(t){t.x=0,t.y=0,t.z=0,this.aVec3.push(t)},vec4:function(){return this.aVec4.length?this.aVec4.shift():new tt},_vec4:function(t){t.x=0,t.y=0,t.z=0,t.w=0,this.aVec4.push(t)},mat3:function(){return this.aMat3.length?this.aMat3.shift():new et},_mat3:function(t){t.m00=1,t.m10=0,t.m20=0,t.m01=0,t.m11=1,t.m21=0,t.m02=0,t.m12=0,t.m22=1,this.aMat3.push(t)},mat4:function(){return this.aMat4.length?this.aMat4.shift():new it},_mat4:function(t){t.m00=1,t.m10=0,t.m20=0,t.m30=0,t.m01=0,t.m11=1,t.m21=0,t.m31=0,t.m02=0,t.m12=0,t.m22=1,t.m32=0,t.m03=0,t.m13=0,t.m23=0,t.m33=1,this.aMat4.push(t)},mat43:function(){return this.aMat43.length?this.aMat43.shift():new lt},_mat43:function(t){t.m00=1,t.m10=0,t.m20=0,t.m01=0,t.m11=1,t.m21=0,t.m02=0,t.m12=0,t.m22=1,t.m03=0,t.m13=0,t.m23=0,this.aMat43.push(t)},quat:function(){return this.aQuat.length?this.aQuat.shift():new xt},_quat:function(t){t.s=1,t.x=0,t.y=0,t.z=0,this.aQuat.push(t)},plane:function(){return this.aPlane.length?this.aPlane.shift():new Mt},_plane:function(t){t.vOrigin.x=0,t.vOrigin.y=0,t.vOrigin.z=0,t.vNormal.x=0,t.vNormal.y=1,t.vNormal.z=0,this.aPlane.push(t)},aabbox:function(){return this.aAABBox.length?this.aAABBox.shift():new bt},_aabbox:function(t){t.set(S.VEC3_ZERO,S.VEC3_ZERO),this.aAABBox.push(t)},sceneNode:function(){return this.aSceneNode.length?this.aSceneNode.shift():new se},_sceneNode:function(t){t.clear(),this.aSceneNode.push(t)},renderBatch:function(){return this.aRenderBatch.length?this.aRenderBatch.shift():new _e},_renderBatch:function(t){t.clear(),this.aRenderBatch.push(t)},particle:function(){return this.aParticle.length?this.aParticle.shift():new ee},_particle:function(t){t.lf=0,t.tlf=0,t.m.identity(),t.v.x=0,t.v.y=0,t.v.z=0,t.ac.x=0,t.ac.y=0,t.ac.z=0,t.s.x=.1,t.s.y=.1,t.s0.x=.1,t.s0.y=.1,t.s1.x=.1,t.s1.y=.1,t.c.x=1,t.c.y=1,t.c.z=1,t.c0.x=1,t.c0.y=1,t.c0.z=1,t.c1.x=1,t.c1.y=1,t.c1.z=1,t.a=0,t.fdi=0,t.fdo=0,this.aParticle.push(t)}};var V=new N;function F(t,e){return Math.abs(t-e)<1e-6}function I(t,e){return t+e-1&~(e-1)}function U(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}function K(t){return 0==(t&t-1)}function G(t,e){this.x=null!=t?t:0,this.y=null!=e?e:0}function j(t,e,i){this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0}function H(t,e){var i=V.vec3();return i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function W(t,e){var i=V.vec3();return i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}function X(t,e){var i=V.vec3();return i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i}function Y(t,e){var i=V.vec3();return i.x=t.x<e.x?t.x:e.x,i.y=t.y<e.y?t.y:e.y,i.z=t.z<e.z?t.z:e.z,i}function Z(t,e){var i=V.vec3();return i.x=t.x>e.x?t.x:e.x,i.y=t.y>e.y?t.y:e.y,i.z=t.z>e.z?t.z:e.z,i}function q(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function Q(t,e){var i=V.vec3();return i.x=t.y*e.z-t.z*e.y,i.y=t.z*e.x-t.x*e.z,i.z=t.x*e.y-t.y*e.x,i}function $(t,e,i){var r=1-i,n=i,a=V.vec3();return a.x=t.x*r+e.x*n,a.y=t.y*r+e.y*n,a.z=t.z*r+e.z*n,a}function J(t,e){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z;return Math.sqrt(i*i+r*r+n*n)}function tt(t,e,i,r){this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0,this.w=null!=r?r:1}function et(t){this.m00=null!=t?t:1,this.m10=0,this.m20=0,this.m01=0,this.m11=null!=t?t:1,this.m21=0,this.m02=0,this.m12=0,this.m22=null!=t?t:1}function it(t){this.m00=null!=t?t:1,this.m10=0,this.m20=0,this.m30=0,this.m01=0,this.m11=null!=t?t:1,this.m21=0,this.m31=0,this.m02=0,this.m12=0,this.m22=null!=t?t:1,this.m32=0,this.m03=0,this.m13=0,this.m23=0,this.m33=null!=t?t:1}function rt(t,e){var i=V.mat4();return i.m00=t.m00*e.m00+t.m01*e.m10+t.m02*e.m20+t.m03*e.m30,i.m10=t.m10*e.m00+t.m11*e.m10+t.m12*e.m20+t.m13*e.m30,i.m20=t.m20*e.m00+t.m21*e.m10+t.m22*e.m20+t.m23*e.m30,i.m30=t.m30*e.m00+t.m31*e.m10+t.m32*e.m20+t.m33*e.m30,i.m01=t.m00*e.m01+t.m01*e.m11+t.m02*e.m21+t.m03*e.m31,i.m11=t.m10*e.m01+t.m11*e.m11+t.m12*e.m21+t.m13*e.m31,i.m21=t.m20*e.m01+t.m21*e.m11+t.m22*e.m21+t.m23*e.m31,i.m31=t.m30*e.m01+t.m31*e.m11+t.m32*e.m21+t.m33*e.m31,i.m02=t.m00*e.m02+t.m01*e.m12+t.m02*e.m22+t.m03*e.m32,i.m12=t.m10*e.m02+t.m11*e.m12+t.m12*e.m22+t.m13*e.m32,i.m22=t.m20*e.m02+t.m21*e.m12+t.m22*e.m22+t.m23*e.m32,i.m32=t.m30*e.m02+t.m31*e.m12+t.m32*e.m22+t.m33*e.m32,i.m03=t.m00*e.m03+t.m01*e.m13+t.m02*e.m23+t.m03*e.m33,i.m13=t.m10*e.m03+t.m11*e.m13+t.m12*e.m23+t.m13*e.m33,i.m23=t.m20*e.m03+t.m21*e.m13+t.m22*e.m23+t.m23*e.m33,i.m33=t.m30*e.m03+t.m31*e.m13+t.m32*e.m23+t.m33*e.m33,i}function nt(t,e){var i=V.vec4();return i.x=t.m00*e.x+t.m01*e.y+t.m02*e.z+t.m03*e.w,i.y=t.m10*e.x+t.m11*e.y+t.m12*e.z+t.m13*e.w,i.z=t.m20*e.x+t.m21*e.y+t.m22*e.z+t.m23*e.w,i.w=t.m30*e.x+t.m31*e.y+t.m32*e.z+t.m33*e.w,i}function at(t,e){var i=V.vec4();i.x=t.m00*e.x+t.m01*e.y+t.m02*e.z+t.m03,i.y=t.m10*e.x+t.m11*e.y+t.m12*e.z+t.m13,i.z=t.m20*e.x+t.m21*e.y+t.m22*e.z+t.m23,i.w=t.m30*e.x+t.m31*e.y+t.m32*e.z+t.m33;var r=1/i.w,n=V.vec3();return n.x=i.x*r,n.y=i.y*r,n.z=i.z*r,n}G.prototype={set:function(t,e){this.x=t,this.y=e},clone:function(t){return(t=t||V.vec2()).x=this.x,t.y=this.y,t},equal:function(t){return F(this.x,t.x)&&F(this.y,t.y)},neg:function(t){var e=t?this:V.vec2();return e.x=-this.x,e.y=-this.y,e},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(t){var e=t?this:V.vec2(),i=1/Math.sqrt(this.x*this.x+this.y*this.y);return e.x=this.x*i,e.y=this.y*i,e},inverse:function(t){var e=t?this:V.vec2();return e.x=1/this.x,e.y=1/this.y,e},translate:function(t,e,i){var r;return t.x?(i=e)?(this.x+=t.x,this.y+=t.y,this):((r=V.vec2()).x=this.x+t.x,r.y=this.y+t.y,r):P(e)?i?(this.x+=t,this.y+=e,this):((r=V.vec2()).x=this.x+t,r.y=this.y+e,r):(i=e)?(this.x+=t,this.y+=t,this):((r=V.vec2()).x=this.x+t,r.y=this.y+t,r)},scale:function(t,e,i){var r;return t.x?(i=e)?(this.x*=t.x,this.y*=t.y,this):((r=V.vec2()).x=this.x*t.x,r.y=this.y*t.y,r):P(e)?i?(this.x*=t,this.y*=e,this):((r=V.vec2()).x=this.x*t,r.y=this.y*e,r):(i=e)?(this.x*=t,this.y*=t,this):((r=V.vec2()).x=this.x*t,r.y=this.y*t,r)},toArray:function(t){return null==t&&(t=V.array()),t.push(this.x,this.y),t}},j.prototype={set:function(t,e,i){this.x=t,this.y=e,this.z=i},clone:function(t){return(t=t||V.vec3()).x=this.x,t.y=this.y,t.z=this.z,t},equal:function(t){return F(this.x,t.x)&&F(this.y,t.y)&&F(this.z,t.z)},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},neg:function(t){var e=t?this:V.vec3();return e.x=-this.x,e.y=-this.y,e.z=-this.z,e},normalize:function(t){var e=t?this:V.vec3(),i=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return e.x=this.x*i,e.y=this.y*i,e.z=this.z*i,e},inverse:function(t){var e=t?this:V.vec3();return e.x=1/this.x,e.y=1/this.y,e.z=1/this.z,e},translate:function(t,e,i,r){var n;return t.x?(r=e)?(this.x+=t.x,this.y+=t.y,this.z+=t.z,this):((n=V.vec3()).x=this.x+t.x,n.y=this.y+t.y,n.z=this.z+t.z,n):null==i?(r=e)?(this.x+=t,this.y+=t,this.z+=t,this):((n=V.vec3()).x=this.x+t,n.y=this.y+t,n.z=this.z+t,n):r?(this.x+=t,this.y+=e,this.z+=i,this):((n=V.vec3()).x=this.x+t,n.y=this.y+e,n.z=this.z+i,n)},scale:function(t,e,i,r){var n;return t.x?(r=e)?(this.x*=t.x,this.y*=t.y,this.z*=t.z,this):((n=V.vec3()).x=this.x*t.x,n.y=this.y*t.y,n.z=this.z*t.z,n):null==i?(r=e)?(this.x*=t,this.y*=t,this.z*=t,this):((n=V.vec3()).x=this.x*t,n.y=this.y*t,n.z=this.z*t,n):r?(this.x*=t,this.y*=e,this.z*=i,this):((n=V.vec3()).x=this.x*t,n.y=this.y*e,n.z=this.z*i,n)},rot:function(t,e,i,r,n){var a=pt(t,e,i,r),s=ct(a,this);return V._mat43(a),n?(this.x=s.x,this.y=s.y,this.z=s.z,V._vec3(s),this):s},rotX:function(t,e){var i=dt(t),r=ct(i,this);return V._mat43(i),e?(this.x=r.x,this.y=r.y,this.z=r.z,V._vec3(r),this):r},rotY:function(t,e){var i=vt(t),r=ct(i,this);return V._mat43(i),e?(this.x=r.x,this.y=r.y,this.z=r.z,V._vec3(r),this):r},rotZ:function(t,e){var i=gt(t),r=ct(i,this);return V._mat43(i),e?(this.x=r.x,this.y=r.y,this.z=r.z,V._vec3(r),this):r},toVec4:function(t){return null==t&&(t=V.vec4()),t.set(this.x,this.y,this.z,1),t},toArray:function(t){return null==t&&(t=V.array()),t.push(this.x,this.y,this.z),t}},tt.prototype={set:function(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r},clone:function(t){return(t=t||V.vec4()).x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,t},equal:function(t){return F(this.x,t.x)&&F(this.y,t.y)&&F(this.z,t.z)&&F(this.w,t.w)},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},neg:function(t){var e=t?this:V.vec4();return e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e},normalize:function(t){var e=t?this:V.vec4(),i=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return e.x=this.x*i,e.y=this.y*i,e.z=this.z*i,e.w=this.w*i,e},inverse:function(t){var e=t?this:V.vec4();return e.x=1/this.x,e.y=1/this.y,e.z=1/this.z,e.w=1/this.w,e},toVec3:function(t){return null==t&&(t=V.vec3()),t.x=this.x/this.w,t.y=this.y/this.w,t.z=this.z/this.w,t},toArray:function(t){return null==t&&(t=V.array()),t.push(this.x,this.y,this.z,this.w),t}},et.prototype={identity:function(){this.m00=1,this.m10=0,this.m20=0,this.m01=0,this.m11=1,this.m21=0,this.m02=0,this.m12=0,this.m22=1},clone:function(t){return(t=t||V.mat3()).m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t},equal:function(t){return F(this.m00,t.m00)&&F(this.m10,t.m10)&&F(this.m20,t.m20)&&F(this.m01,t.m01)&&F(this.m11,t.m11)&&F(this.m21,t.m21)&&F(this.m02,t.m02)&&F(this.m12,t.m12)&&F(this.m22,t.m22)},setColumn:function(t,e,i,r){0==t?P(e)?(this.m00=e,this.m10=i,this.m20=r):(this.m00=e.x,this.m10=e.y,this.m20=e.z):1==t?P(e)?(this.m01=e,this.m11=i,this.m21=r):(this.m01=e.x,this.m11=e.y,this.m21=e.z):2==t&&(P(e)?(this.m02=e,this.m12=i,this.m22=r):(this.m02=e.x,this.m12=e.y,this.m22=e.z))},getColumn:function(t){var e=V.vec3();return 0==t?e.set(this.m00,this.m10,this.m20):1==t?e.set(this.m01,this.m11,this.m21):2==t&&e.set(this.m02,this.m12,this.m22),e},det:function(){var t=this.m00,e=this.m01,i=this.m02,r=this.m10,n=this.m11,a=this.m12,s=this.m20,o=this.m21,h=this.m22;return t*n*h+e*a*s+i*r*o-t*a*o-e*r*h-i*n*s},inverse:function(t){var e=this.m00,i=this.m01,r=this.m02,n=this.m10,a=this.m11,s=this.m12,o=this.m20,h=this.m21,l=this.m22,m=t?this:V.mat3();m.m00=a*l-s*h,m.m01=r*h-i*l,m.m02=i*s-r*a,m.m10=s*o-n*l,m.m11=e*l-r*o,m.m12=r*n-e*s,m.m20=n*h-a*o,m.m21=i*o-e*h,m.m22=e*a-i*n;var c=1/(e*a*l+i*s*o+r*n*h-e*s*h-i*n*l-r*a*o);return m.m00*=c,m.m01*=c,m.m02*=c,m.m10*=c,m.m11*=c,m.m12*=c,m.m20*=c,m.m21*=c,m.m22*=c,m},transpose:function(t){var e=t?this:V.mat3();return e.m00=this.m00,e.m10=this.m01,e.m20=this.m02,e.m01=this.m10,e.m11=this.m11,e.m21=this.m12,e.m02=this.m20,e.m12=this.m21,e.m22=this.m22,e},rot:function(t,e,i,r,n,a){var s=V.vec3();null!=n?(s.x=i,s.y=r,s.z=n):(s.x=i.x,s.y=i.y,s.z=i.z,a=r),s.normalize(!0);var o=e*Math.PI/180,h=Math.cos(.5*o),l=Math.sin(.5*o),m=V.quat();m.s=h,m.x=l*s.x,m.y=l*s.y,m.z=l*s.z,V._vec3(s);var c=V.mat3();m.toMat3(c);var u=this.m00,f=this.m10,d=this.m20,v=this.m01,g=this.m11,p=this.m21,x=this.m02,y=this.m12,_=this.m22,M=a?this:V.mat3();return 2==t?(M.m00=c.m00*u+c.m01*f+c.m02*d,M.m10=c.m10*u+c.m11*f+c.m12*d,M.m20=c.m20*u+c.m21*f+c.m22*d,M.m01=c.m00*v+c.m01*g+c.m02*p,M.m11=c.m10*v+c.m11*g+c.m12*p,M.m21=c.m20*v+c.m21*g+c.m22*p,M.m02=c.m00*x+c.m01*y+c.m02*_,M.m12=c.m10*x+c.m11*y+c.m12*_,M.m22=c.m20*x+c.m21*y+c.m22*_):(M.m00=u*c.m00+v*c.m10+x*c.m20,M.m10=f*c.m00+g*c.m10+y*c.m20,M.m20=d*c.m00+p*c.m10+_*c.m20,M.m01=u*c.m01+v*c.m11+x*c.m21,M.m11=f*c.m01+g*c.m11+y*c.m21,M.m21=d*c.m01+p*c.m11+_*c.m21,M.m02=u*c.m02+v*c.m12+x*c.m22,M.m12=f*c.m02+g*c.m12+y*c.m22,M.m22=d*c.m02+p*c.m12+_*c.m22),V._mat3(c),V._quat(m),M},rotX:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=(this.m00,this.m10),o=this.m20,h=this.m01,l=this.m11,m=this.m21,c=this.m02,u=this.m12,f=this.m22,d=(this.m03,this.m13,this.m23,i?this:this.clone());return 2==t?(d.m10=n*s-a*o,d.m20=a*s+n*o,d.m11=n*l-a*m,d.m21=a*l+n*m,d.m12=n*u-a*f,d.m22=a*u+n*f):(d.m01=h*n+c*a,d.m11=l*n+u*a,d.m21=m*n+f*a,d.m02=h*-a+c*n,d.m12=l*-a+u*n,d.m22=m*-a+f*n),d},rotY:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m01,m=(this.m11,this.m21),c=this.m02,u=this.m12,f=this.m22,d=i?this:this.clone();return 2==t?(d.m00=n*s+a*h,d.m20=-a*s+n*h,d.m01=n*l+a*m,d.m21=-a*l+n*m,d.m02=n*c+a*f,d.m22=-a*c+n*f):(d.m00=s*n+c*-a,d.m10=o*n+u*-a,d.m20=h*n+f*-a,d.m02=s*a+c*n,d.m12=o*a+u*n,d.m22=h*a+f*n),d},rotZ:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m01,m=this.m11,c=this.m21,u=this.m02,f=this.m12,d=(this.m22,this.m03,this.m13,this.m23,i?this:this.clone());return 2==t?(d.m00=n*s+-a*o,d.m10=a*s+n*o,d.m01=n*l+-a*m,d.m11=a*l+n*m,d.m02=n*u+-a*f,d.m12=a*u+n*f):(d.m00=s*n+l*a,d.m10=o*n+m*a,d.m20=h*n+c*a,d.m01=s*-a+l*n,d.m11=o*-a+m*n,d.m21=h*-a+c*n),d},scale:function(t,e,i,r,n){var a,s,o;i?(a=e,s=i,o=r):e.x?(a=e.x,i=e.y,r=e.z,n=i):(a=e,r=e,n=i=e);var h=n?this:this.clone();return 2==t?(h.m00*=a,h.m10*=s,h.m20*=o,h.m01*=a,h.m11*=s,h.m21*=o,h.m02*=a,h.m12*=s,h.m22*=o):(h.m00*=a,h.m10*=a,h.m20*=a,h.m01*=s,h.m11*=s,h.m21*=s,h.m02*=o,h.m12*=o,h.m22*=o),h},toMat4:function(t){return null==t&&(t=V.mat4()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m30=0,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m31=0,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m32=0,t.m03=0,t.m13=0,t.m23=0,t.m33=1,t},toMat43:function(t){return null==t&&(t=V.mat43()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m03=0,t.m13=0,t.m23=0,t},toQuat:function(t){null==t&&(t=V.quat());var e=this.m00+this.m11+this.m22;if(e>0){var i=2*Math.sqrt(e+1);t.s=.25*i,t.x=(this.m21-this.m12)/i,t.y=(this.m02-this.m20)/i,t.z=(this.m10-this.m01)/i}else if(this.m00>this.m11&&this.m00>this.m22){i=2*Math.sqrt(1+this.m00-this.m11-this.m22);t.s=(this.m21-this.m12)/i,t.x=.25*i,t.y=(this.m01+this.m10)/i,t.z=(this.m02+this.m20)/i}else if(this.m11>this.m22){i=2*Math.sqrt(1+this.m11-this.m00-this.m22);t.s=(this.m02-this.m20)/i,t.x=(this.m01+this.m10)/i,t.y=.25*i,t.z=(this.m12+this.m21)/i}else{i=2*Math.sqrt(1+this.m22-this.m00-this.m11);t.s=(this.m10-this.m01)/i,t.x=(this.m02+this.m20)/i,t.y=(this.m12+this.m21)/i,t.z=.25*i}return t},toArray:function(t){return null==t&&(t=V.array()),t.push(this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22,this.m03,this.m13,this.m23),t}},it.prototype={identity:function(){this.m00=1,this.m10=0,this.m20=0,this.m30=0,this.m01=0,this.m11=1,this.m21=0,this.m31=0,this.m02=0,this.m12=0,this.m22=1,this.m32=0,this.m03=0,this.m13=0,this.m23=0,this.m33=1},clone:function(t){return(t=t||V.mat4()).m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m30=this.m30,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m31=this.m31,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m32=this.m32,t.m03=this.m03,t.m13=this.m13,t.m23=this.m23,t.m33=this.m33,t},equal:function(t){return F(this.m00,t.m00)&&F(this.m10,t.m10)&&F(this.m20,t.m20)&&F(this.m30,t.m30)&&F(this.m01,t.m01)&&F(this.m11,t.m11)&&F(this.m21,t.m21)&&F(this.m31,t.m31)&&F(this.m02,t.m02)&&F(this.m12,t.m12)&&F(this.m22,t.m22)&&F(this.m32,t.m32)&&F(this.m03,t.m03)&&F(this.m13,t.m13)&&F(this.m23,t.m23)&&F(this.m33,t.m33)},setColumn:function(t,e,i,r,n){0==t?P(e)?(this.m00=e,this.m10=i,this.m20=r,this.m30=n||this.m30):(this.m00=e.x,this.m10=e.y,this.m20=e.z,this.m30=e.w?e.w:this.m30):1==t?P(e)?(this.m01=e,this.m11=i,this.m21=r,this.m31=n||this.m31):(this.m01=e.x,this.m11=e.y,this.m21=e.z,this.m31=e.w?e.w:this.m31):2==t?P(e)?(this.m02=e,this.m12=i,this.m22=r,this.m32=n||this.m32):(this.m02=e.x,this.m12=e.y,this.m22=e.z,this.m32=e.w?e.w:this.m32):3==t&&(P(e)?(this.m03=e,this.m13=i,this.m23=r,this.m33=n||this.m33):(this.m03=e.x,this.m13=e.y,this.m23=e.z,this.m33=e.w?e.w:this.m33))},getColumn:function(t){var e=V.vec4();return 0==t?e.set(this.m00,this.m10,this.m20,this.m30):1==t?e.set(this.m01,this.m11,this.m21,this.m31):2==t?e.set(this.m02,this.m12,this.m22,this.m32):3==t&&e.set(this.m03,this.m13,this.m23,this.m33),e},det:function(){var t=this.m00,e=this.m01,i=this.m02,r=this.m03,n=this.m10,a=this.m11,s=this.m12,o=this.m13,h=this.m20,l=this.m21,m=this.m22,c=this.m23,u=this.m30,f=this.m31,d=this.m32,v=this.m33;return t*a*m*v+t*s*c*f+t*o*l*d+e*n*c*d+e*s*h*v+e*o*m*u+i*n*l*v+i*a*c*u+i*o*h*f+r*n*m*f+r*a*h*d+r*s*l*u-t*a*c*d-t*s*l*v-t*o*m*f-e*n*m*v-e*s*c*u-e*o*h*d-i*n*c*f-i*a*h*v-i*o*l*u-r*n*l*d-r*a*m*u-r*s*h*f},inverse:function(t){var e=this.m00,i=this.m01,r=this.m02,n=this.m03,a=this.m10,s=this.m11,o=this.m12,h=this.m13,l=this.m20,m=this.m21,c=this.m22,u=this.m23,f=this.m30,d=this.m31,v=this.m32,g=this.m33,p=t?this:V.mat4();p.m00=s*c*g+o*u*d+h*m*v-s*u*v-o*m*g-h*c*d,p.m01=i*u*v+r*m*g+n*c*d-i*c*g-r*u*d-n*m*v,p.m02=i*o*g+r*h*d+n*s*v-i*h*v-r*s*g-n*o*d,p.m03=i*h*c+r*s*u+n*o*m-i*o*u-r*h*m-n*s*c,p.m10=a*u*v+o*l*g+h*c*f-a*c*g-o*u*f-h*l*v,p.m11=e*c*g+r*u*f+n*l*v-e*u*v-r*l*g-n*c*f,p.m12=e*h*v+r*a*g+n*o*f-e*o*g-r*h*f-n*a*v,p.m13=e*o*u+r*h*l+n*a*c-e*h*c-r*a*u-n*o*l,p.m20=a*m*g+s*u*f+h*l*d-a*u*d-s*l*g-h*m*f,p.m21=e*u*d+i*l*g+n*m*f-e*m*g-i*u*f-n*l*d,p.m22=e*s*g+i*h*f+n*a*d-e*h*d-i*a*g-n*s*f,p.m23=e*h*m+i*a*u+n*s*l-e*s*u-i*h*l-n*a*m,p.m30=a*c*d+s*l*v+o*m*f-a*m*v-s*c*f-o*l*d,p.m31=e*m*v+i*c*f+r*l*d-e*c*d-i*l*v-r*m*f,p.m32=e*o*d+i*a*v+r*s*f-e*s*v-i*o*f-r*a*d,p.m33=e*s*c+i*o*l+r*a*m-e*o*m-i*a*c-r*s*l;var x=1/(e*s*c*g+e*o*u*d+e*h*m*v+i*a*u*v+i*o*l*g+i*h*c*f+r*a*m*g+r*s*u*f+r*h*l*d+n*a*c*d+n*s*l*v+n*o*m*f-e*s*u*v-e*o*m*g-e*h*c*d-i*a*c*g-i*o*u*f-i*h*l*v-r*a*u*d-r*s*l*g-r*h*m*f-n*a*m*v-n*s*c*f-n*o*l*d);return p.m00*=x,p.m01*=x,p.m02*=x,p.m03*=x,p.m10*=x,p.m11*=x,p.m12*=x,p.m13*=x,p.m20*=x,p.m21*=x,p.m22*=x,p.m23*=x,p.m30*=x,p.m31*=x,p.m32*=x,p.m33*=x,p},transpose:function(t){var e=t?this:V.mat4();return e.m00=this.m00,e.m10=this.m01,e.m20=this.m02,e.m30=this.m03,e.m01=this.m10,e.m11=this.m11,e.m21=this.m12,e.m31=this.m13,e.m02=this.m20,e.m12=this.m21,e.m22=this.m22,e.m32=this.m23,e.m03=this.m30,e.m13=this.m31,e.m23=this.m32,e.m33=this.m33,e},translate:function(t,e,i,r,n){var a=n?this:this.clone();return 2==t?(a.m00=this.m00+e*this.m30,a.m10=this.m10+i*this.m30,a.m20=this.m20+r*this.m30,a.m01=this.m01+e*this.m31,a.m11=this.m11+i*this.m31,a.m21=this.m21+r*this.m31,a.m02=this.m02+e*this.m32,a.m12=this.m12+i*this.m32,a.m22=this.m22+r*this.m32,a.m03=this.m03+e*this.m33,a.m13=this.m13+i*this.m33,a.m23=this.m23+r*this.m33):(a.m03=this.m03+this.m00*e+this.m01*i+this.m02*r,a.m13=this.m13+this.m10*e+this.m11*i+this.m12*r,a.m23=this.m23+this.m20*e+this.m21*i+this.m22*r,a.m33=this.m33+this.m30*e+this.m31*i+this.m32*r),a},rot:function(t,e,i,r,n,a){var s=V.vec3();null!=n?(s.x=i,s.y=r,s.z=n):(s.x=i.x,s.y=i.y,s.z=i.z,a=r),s.normalize(!0);var o=e*Math.PI/180,h=Math.cos(.5*o),l=Math.sin(.5*o),m=V.quat();m.s=h,m.x=l*s.x,m.y=l*s.y,m.z=l*s.z,V._vec3(s);var c=V.mat4();m.toMat4(c);var u=this.m00,f=this.m10,d=this.m20,v=this.m30,g=this.m01,p=this.m11,x=this.m21,y=this.m31,_=this.m02,M=this.m12,T=this.m22,b=this.m32,A=this.m03,L=this.m13,S=this.m23,C=this.m33,E=a?this:V.mat4();return 2==t?(E.m00=c.m00*u+c.m01*f+c.m02*d+c.m03*v,E.m10=c.m10*u+c.m11*f+c.m12*d+c.m13*v,E.m20=c.m20*u+c.m21*f+c.m22*d+c.m23*v,E.m30=c.m30*u+c.m31*f+c.m32*d+c.m33*v,E.m01=c.m00*g+c.m01*p+c.m02*x+c.m03*y,E.m11=c.m10*g+c.m11*p+c.m12*x+c.m13*y,E.m21=c.m20*g+c.m21*p+c.m22*x+c.m23*y,E.m31=c.m30*g+c.m31*p+c.m32*x+c.m33*y,E.m02=c.m00*_+c.m01*M+c.m02*T+c.m03*b,E.m12=c.m10*_+c.m11*M+c.m12*T+c.m13*b,E.m22=c.m20*_+c.m21*M+c.m22*T+c.m23*b,E.m32=c.m30*_+c.m31*M+c.m32*T+c.m33*b,E.m03=c.m00*A+c.m01*L+c.m02*S+c.m03*C,E.m13=c.m10*A+c.m11*L+c.m12*S+c.m13*C,E.m23=c.m20*A+c.m21*L+c.m22*S+c.m23*C,E.m33=c.m30*A+c.m31*L+c.m32*S+c.m33*C):(E.m00=u*c.m00+g*c.m10+_*c.m20+A*c.m30,E.m10=f*c.m00+p*c.m10+M*c.m20+L*c.m30,E.m20=d*c.m00+x*c.m10+T*c.m20+S*c.m30,E.m30=v*c.m00+y*c.m10+b*c.m20+C*c.m30,E.m01=u*c.m01+g*c.m11+_*c.m21+A*c.m31,E.m11=f*c.m01+p*c.m11+M*c.m21+L*c.m31,E.m21=d*c.m01+x*c.m11+T*c.m21+S*c.m31,E.m31=v*c.m01+y*c.m11+b*c.m21+C*c.m31,E.m02=u*c.m02+g*c.m12+_*c.m22+A*c.m32,E.m12=f*c.m02+p*c.m12+M*c.m22+L*c.m32,E.m22=d*c.m02+x*c.m12+T*c.m22+S*c.m32,E.m32=v*c.m02+y*c.m12+b*c.m22+C*c.m32,E.m03=u*c.m03+g*c.m13+_*c.m23+A*c.m33,E.m13=f*c.m03+p*c.m13+M*c.m23+L*c.m33,E.m23=d*c.m03+x*c.m13+T*c.m23+S*c.m33,E.m33=v*c.m03+y*c.m13+b*c.m23+C*c.m33),V._mat4(c),V._quat(m),E},rotX:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=(this.m00,this.m10),o=this.m20,h=(this.m30,this.m01),l=this.m11,m=this.m21,c=this.m31,u=this.m02,f=this.m12,d=this.m22,v=this.m32,g=this.m03,p=this.m13,x=this.m23,y=(this.m33,i?this:this.clone());return 2==t?(y.m10=n*s-a*o,y.m20=a*s+n*o,y.m11=n*l-a*m,y.m21=a*l+n*m,y.m12=n*f-a*d,y.m22=a*f+n*d,y.m03=g,y.m13=n*p-a*x,y.m23=a*p+n*x):(y.m01=h*n+u*a,y.m11=l*n+f*a,y.m21=m*n+d*a,y.m31=c*n+v*a,y.m02=h*-a+u*n,y.m12=l*-a+f*n,y.m22=m*-a+d*n,y.m32=c*-a+v*n),y},rotY:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m30,m=this.m01,c=(this.m11,this.m21),u=(this.m31,this.m02),f=this.m12,d=this.m22,v=this.m32,g=this.m03,p=(this.m13,this.m23),x=(this.m33,i?this:this.clone());return 2==t?(x.m00=n*s+a*h,x.m20=-a*s+n*h,x.m01=n*m+a*c,x.m21=-a*m+n*c,x.m02=n*u+a*d,x.m22=-a*u+n*d,x.m03=n*g+a*p,x.m23=-a*g+n*p):(x.m00=s*n+u*-a,x.m10=o*n+f*-a,x.m20=h*n+d*-a,x.m30=l*n+v*-a,x.m02=s*a+u*n,x.m12=o*a+f*n,x.m22=h*a+d*n,x.m32=l*a+v*n),x},rotZ:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m30,m=this.m01,c=this.m11,u=this.m21,f=this.m31,d=this.m02,v=this.m12,g=(this.m22,this.m32,this.m03),p=this.m13,x=(this.m23,this.m33,i?this:this.clone());return 2==t?(x.m00=n*s+-a*o,x.m10=a*s+n*o,x.m01=n*m+-a*c,x.m11=a*m+n*c,x.m02=n*d+-a*v,x.m12=a*d+n*v,x.m03=n*g+-a*p,x.m13=a*g+n*p):(x.m00=s*n+m*a,x.m10=o*n+c*a,x.m20=h*n+u*a,x.m30=l*n+f*a,x.m01=s*-a+m*n,x.m11=o*-a+c*n,x.m21=h*-a+u*n,x.m31=l*-a+f*n),x},scale:function(t,e,i,r,n){var a,s,o;r?(a=e,s=i,o=r):e.x?(a=e.x,i=e.y,r=e.z,n=i):(a=e,r=e,n=i=e);var h=n?this:this.clone();return 2==t?(h.m00*=a,h.m10*=s,h.m20*=o,h.m01*=a,h.m11*=s,h.m21*=o,h.m02*=a,h.m12*=s,h.m22*=o,h.m03*=a,h.m13*=s,h.m23*=o):(h.m00*=a,h.m10*=a,h.m20*=a,h.m30*=a,h.m01*=s,h.m11*=s,h.m21*=s,h.m31*=s,h.m02*=o,h.m12*=o,h.m22*=o,h.m32*=o),h},toMat3:function(t){return null==t&&(t=V.mat3()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t},toMat43:function(t){return null==t&&(t=V.mat43()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m03=this.m03,t.m13=this.m13,t.m23=this.m23,t},toQuat:function(t){null==t&&(t=V.quat());var e=this.m00+this.m11+this.m22;if(e>0){var i=2*Math.sqrt(e+1);t.s=.25*i,t.x=(this.m21-this.m12)/i,t.y=(this.m02-this.m20)/i,t.z=(this.m10-this.m01)/i}else if(this.m00>this.m11&&this.m00>this.m22){i=2*Math.sqrt(1+this.m00-this.m11-this.m22);t.s=(this.m21-this.m12)/i,t.x=.25*i,t.y=(this.m01+this.m10)/i,t.z=(this.m02+this.m20)/i}else if(this.m11>this.m22){i=2*Math.sqrt(1+this.m11-this.m00-this.m22);t.s=(this.m02-this.m20)/i,t.x=(this.m01+this.m10)/i,t.y=.25*i,t.z=(this.m12+this.m21)/i}else{i=2*Math.sqrt(1+this.m22-this.m00-this.m11);t.s=(this.m10-this.m01)/i,t.x=(this.m02+this.m20)/i,t.y=(this.m12+this.m21)/i,t.z=.25*i}return t},toArray:function(t){return null==t&&(t=V.array()),t.push(this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33),t}};var st=function(t,e,i){var r=V.vec3();null!=e?(r.x=t,r.y=e,r.z=i):(r.x=t.x,r.y=t.y,r.z=t.z);var n=V.mat4();return n.setColumn(3,r.x,r.y,r.z,1),V._vec3(r),n};var ot=function(t,e,i,r){var n=t*Math.PI/360,a=r-i,s=Math.cos(n)/Math.sin(n),o=V.mat4();return o.m00=s/e,o.m11=s,o.m22=-(r+i)/a,o.m32=-1,o.m23=-2*i*r/a,o.m33=0,o};function ht(t,e,i,r,n,a){var s=V.mat4();return s.m00=2/(e-t),s.m11=2/(i-r),s.m22=-2/(a-n),s.m03=-(e+t)/(e-t),s.m13=-(i+r)/(i-r),s.m23=-(a+n)/(a-n),s}function lt(t){this.m00=null!=t?t:1,this.m10=0,this.m20=0,this.m01=0,this.m11=null!=t?t:1,this.m21=0,this.m02=0,this.m12=0,this.m22=null!=t?t:1,this.m03=0,this.m13=0,this.m23=0}function mt(t,e){var i=V.mat43();return i.m00=t.m00*e.m00+t.m01*e.m10+t.m02*e.m20,i.m10=t.m10*e.m00+t.m11*e.m10+t.m12*e.m20,i.m20=t.m20*e.m00+t.m21*e.m10+t.m22*e.m20,i.m01=t.m00*e.m01+t.m01*e.m11+t.m02*e.m21,i.m11=t.m10*e.m01+t.m11*e.m11+t.m12*e.m21,i.m21=t.m20*e.m01+t.m21*e.m11+t.m22*e.m21,i.m02=t.m00*e.m02+t.m01*e.m12+t.m02*e.m22,i.m12=t.m10*e.m02+t.m11*e.m12+t.m12*e.m22,i.m22=t.m20*e.m02+t.m21*e.m12+t.m22*e.m22,i.m03=t.m00*e.m03+t.m01*e.m13+t.m02*e.m23+t.m03,i.m13=t.m10*e.m03+t.m11*e.m13+t.m12*e.m23+t.m13,i.m23=t.m20*e.m03+t.m21*e.m13+t.m22*e.m23+t.m23,i}function ct(t,e){var i=V.vec3();return i.x=t.m00*e.x+t.m01*e.y+t.m02*e.z+t.m03,i.y=t.m10*e.x+t.m11*e.y+t.m12*e.z+t.m13,i.z=t.m20*e.x+t.m21*e.y+t.m22*e.z+t.m23,i}function ut(t,e,i){var r=V.vec3();null!=e?(r.x=t,r.y=e,r.z=i):(r.x=t.x,r.y=t.y,r.z=t.z);var n=V.mat43();return n.setColumn(3,r.x,r.y,r.z),V._vec3(r),n}function ft(t,e,i){var r=V.vec3();null!=e?(r.x=t,r.y=e,r.z=i):(r.x=t.x,r.y=t.y,r.z=t.z);var n=V.mat43();return n.m00=r.x,n.m11=r.y,n.m22=r.z,V._vec3(r),n}function dt(t){var e=t*Math.PI/180,i=Math.cos(e),r=Math.sin(e),n=V.mat43();return n.m11=i,n.m12=-r,n.m21=r,n.m22=i,n}function vt(t){var e=t*Math.PI/180,i=Math.cos(e),r=Math.sin(e),n=V.mat43();return n.m00=i,n.m02=r,n.m20=-r,n.m22=i,n}function gt(t){var e=t*Math.PI/180,i=Math.cos(e),r=Math.sin(e),n=V.mat43();return n.m00=i,n.m01=-r,n.m10=r,n.m11=i,n}function pt(t,e,i,r){var n=t*Math.PI/180,a=V.vec3();null!=i?(a.x=e,a.y=i,a.z=r):(a.x=e.x,a.y=e.y,a.z=e.z);var s=a.normalize();V._vec3(a);var o=Math.cos(.5*n),h=Math.sin(.5*n),l=new xt;l.s=o,l.x=h*s.x,l.y=h*s.y,l.z=h*s.z,V._vec3(s);var m=V.mat43();return l.toMat43(m),m}function xt(t,e,i,r){this.s=null!=t?t:1,this.x=null!=e?e:0,this.y=null!=i?i:0,this.z=null!=r?r:0}function yt(t,e){var i=V.quat(),r=t.getImVec3(),n=e.getImVec3();i.s=t.s*e.s-q(r,n);var a=Q(r,n),s=X(r,e.s),o=X(n,t.s),h=H(a,s),l=H(h,o);return i.x=l.x,i.y=l.y,i.z=l.z,V._vec3(r),V._vec3(n),V._vec3(a),V._vec3(s),V._vec3(o),V._vec3(h),V._vec3(l),i}function _t(t,e,i){if(t.equal(e))return t.clone();var r,n,a=V.quat(),s=function(t,e){return t.s*e.s+t.x*e.x+t.y*e.y+t.z*e.z}(t,e);if(s<0?(s=-s,a.s=-e.s,a.x=-e.x,a.y=-e.y,a.z=-e.z):(a.s=e.s,a.x=e.x,a.y=e.y,a.z=e.z),s=Math.min(1,s),F(Math.abs(s),1))r=1-i,n=i;else{var o=Math.acos(s),h=Math.sin(o);r=Math.sin((1-i)*o)/h,n=Math.sin(i*o)/h}var l=V.quat();return l.s=r*t.s+n*a.s,l.x=r*t.x+n*a.x,l.y=r*t.y+n*a.y,l.z=r*t.z+n*a.z,V._quat(a),l}function Mt(t,e){this.vOrigin=V.vec3(),this.vNormal=V.vec3(),t&&(this.vOrigin.x=t.x,this.vOrigin.y=t.y,this.vOrigin.z=t.z),e?(this.vNormal.x=e.x,this.vNormal.y=e.y,this.vNormal.z=e.z):(this.vNormal.x=0,this.vNormal.y=1,this.vNormal.z=0)}function Tt(t,e,i){var r=t.vNormal,n=e.vNormal,a=i.vNormal,s=Q(n,a),o=Q(a,r),h=Q(r,n),l=q(t.vOrigin,r),m=q(e.vOrigin,n),c=q(i.vOrigin,a),u=X(s,l),f=X(o,m),d=X(h,c),v=r.x*(n.y*a.z-a.y*n.z)+n.x*(a.y*r.z-r.y*a.z)+a.x*(r.y*n.z-r.z*n.y),g=V.vec3();return g.x=(u.x+f.x+d.x)/v,g.y=(u.y+f.y+d.y)/v,g.z=(u.z+f.z+d.z)/v,V._vec3(s),V._vec3(o),V._vec3(h),V._vec3(u),V._vec3(f),V._vec3(d),g}function bt(t,e){this.vMin=V.vec3(),this.vMax=V.vec3(),null!=t&&(this.vMin.x=t.x,this.vMin.y=t.y,this.vMin.z=t.z),null!=e&&(this.vMax.x=e.x,this.vMax.y=e.y,this.vMax.z=e.z),this.aPointList=[V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3()],this.bPointDirty=!0}function At(){this.mViewProjMat=V.mat4(),this.aPlaneList=[V.plane(),V.plane(),V.plane(),V.plane(),V.plane(),V.plane()],this.aPointList=[V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3(),V.vec3()],this.bPointDirty=!0}function Lt(t,e,i,r){this.x=null!=t?t:0,this.y=null!=e?e:0,this.width=null!=i?i:0,this.height=null!=r?r:0}function St(t){this.element=t,this.childNodes=new Array,this.sText="";for(var e=0;e<this.element.childNodes.length;++e)this.element.childNodes[e].nodeType==Node.ELEMENT_NODE?this.childNodes.push(this.element.childNodes[e]):this.element.childNodes[e].nodeType==Node.TEXT_NODE&&(this.sText+=this.element.childNodes[e].textContent)}lt.prototype={identity:function(){this.m00=1,this.m10=0,this.m20=0,this.m01=0,this.m11=1,this.m21=0,this.m02=0,this.m12=0,this.m22=1,this.m03=0,this.m13=0,this.m23=0},clone:function(t){return(t=t||V.mat43()).m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m03=this.m03,t.m13=this.m13,t.m23=this.m23,t},equal:function(t){return F(this.m00,t.m00)&&F(this.m10,t.m10)&&F(this.m20,t.m20)&&F(this.m01,t.m01)&&F(this.m11,t.m11)&&F(this.m21,t.m21)&&F(this.m02,t.m02)&&F(this.m12,t.m12)&&F(this.m22,t.m22)&&F(this.m03,t.m03)&&F(this.m13,t.m13)&&F(this.m23,t.m23)},setColumn:function(t,e,i,r){0==t?P(e)?(this.m00=e,this.m10=i,this.m20=r):(this.m00=e.x,this.m10=e.y,this.m20=e.z):1==t?P(e)?(this.m01=e,this.m11=i,this.m21=r):(this.m01=e.x,this.m11=e.y,this.m21=e.z):2==t?P(e)?(this.m02=e,this.m12=i,this.m22=r):(this.m02=e.x,this.m12=e.y,this.m22=e.z):3==t&&(P(e)?(this.m03=e,this.m13=i,this.m23=r):(this.m03=e.x,this.m13=e.y,this.m23=e.z))},getColumn:function(t){var e=V.vec3();return 0==t?e.set(this.m00,this.m10,this.m20):1==t?e.set(this.m01,this.m11,this.m21):2==t?e.set(this.m02,this.m12,this.m22):3==t&&e.set(this.m03,this.m13,this.m23),e},det:function(){var t=this.m00,e=this.m01,i=this.m02,r=(this.m03,this.m10),n=this.m11,a=this.m12,s=(this.m13,this.m20),o=this.m21,h=this.m22;this.m23;return t*n*h+e*a*s+i*r*o-t*a*o-e*r*h-i*n*s},inverse:function(t){var e=this.m00,i=this.m01,r=this.m02,n=this.m03,a=this.m10,s=this.m11,o=this.m12,h=this.m13,l=this.m20,m=this.m21,c=this.m22,u=this.m23,f=t?this:V.mat43();f.m00=s*c-o*m,f.m01=r*m-i*c,f.m02=i*o-r*s,f.m03=i*h*c+r*s*u+n*o*m-i*o*u-r*h*m-n*s*c,f.m10=o*l-a*c,f.m11=e*c-r*l,f.m12=r*a-e*o,f.m13=e*o*u+r*h*l+n*a*c-e*h*c-r*a*u-n*o*l,f.m20=a*m-s*l,f.m21=i*l-e*m,f.m22=e*s-i*a,f.m23=e*h*m+i*a*u+n*s*l-e*s*u-i*h*l-n*a*m;var d=1/(e*s*c+i*o*l+r*a*m-e*o*m-i*a*c-r*s*l);return f.m00*=d,f.m01*=d,f.m02*=d,f.m03*=d,f.m10*=d,f.m11*=d,f.m12*=d,f.m13*=d,f.m20*=d,f.m21*=d,f.m22*=d,f.m23*=d,f},transpose:function(t){var e=t?this:V.mat43();return e.m00=this.m00,e.m10=this.m01,e.m20=this.m02,e.m01=this.m10,e.m11=this.m11,e.m21=this.m12,e.m02=this.m20,e.m12=this.m21,e.m22=this.m22,e.m03=0,e.m13=0,e.m23=0,e},translate:function(t,e,i,r,n){e.x?(n=i,r=e.z,i=e.y,e=e.x):null==r&&(n=i,r=e,i=e);var a=this;return n&&(a=this.clone()),2==t?(a.m03+=e,a.m13+=i,a.m23+=r):(a.m03+=this.m00*e+this.m01*i+this.m02*r,a.m13+=this.m10*e+this.m11*i+this.m12*r,a.m23+=this.m20*e+this.m21*i+this.m22*r),a},rot:function(t,e,i,r,n,a){var s=V.vec3();null!=n?(s.x=i,s.y=r,s.z=n):(s.x=i.x,s.y=i.y,s.z=i.z,a=r),s.normalize(!0);var o=e*Math.PI/180,h=Math.cos(.5*o),l=Math.sin(.5*o),m=V.quat();m.s=h,m.x=l*s.x,m.y=l*s.y,m.z=l*s.z,V._vec3(s);var c=V.mat4();m.toMat4(c);var u=this.m00,f=this.m10,d=this.m20,v=this.m01,g=this.m11,p=this.m21,x=this.m02,y=this.m12,_=this.m22,M=this.m03,T=this.m13,b=this.m23,A=a?this:V.mat43();return 2==t?(A.m00=c.m00*u+c.m01*f+c.m02*d,A.m10=c.m10*u+c.m11*f+c.m12*d,A.m20=c.m20*u+c.m21*f+c.m22*d,A.m01=c.m00*v+c.m01*g+c.m02*p,A.m11=c.m10*v+c.m11*g+c.m12*p,A.m21=c.m20*v+c.m21*g+c.m22*p,A.m02=c.m00*x+c.m01*y+c.m02*_,A.m12=c.m10*x+c.m11*y+c.m12*_,A.m22=c.m20*x+c.m21*y+c.m22*_,A.m03=c.m00*M+c.m01*T+c.m02*b+c.m03,A.m13=c.m10*M+c.m11*T+c.m12*b+c.m13,A.m23=c.m20*M+c.m21*T+c.m22*b+c.m23):(A.m00=u*c.m00+v*c.m10+x*c.m20,A.m10=f*c.m00+g*c.m10+y*c.m20,A.m20=d*c.m00+p*c.m10+_*c.m20,A.m01=u*c.m01+v*c.m11+x*c.m21,A.m11=f*c.m01+g*c.m11+y*c.m21,A.m21=d*c.m01+p*c.m11+_*c.m21,A.m02=u*c.m02+v*c.m12+x*c.m22,A.m12=f*c.m02+g*c.m12+y*c.m22,A.m22=d*c.m02+p*c.m12+_*c.m22,A.m03=u*c.m03+v*c.m13+x*c.m23+M,A.m13=f*c.m03+g*c.m13+y*c.m23+T,A.m23=d*c.m03+p*c.m13+_*c.m23+b),V._mat4(c),V._quat(m),A},rotX:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=(this.m00,this.m10),o=this.m20,h=this.m01,l=this.m11,m=this.m21,c=this.m02,u=this.m12,f=this.m22,d=this.m03,v=this.m13,g=this.m23,p=i?this:this.clone();return 2==t?(p.m10=n*s-a*o,p.m20=a*s+n*o,p.m11=n*l-a*m,p.m21=a*l+n*m,p.m12=n*u-a*f,p.m22=a*u+n*f,p.m03=d,p.m13=n*v-a*g,p.m23=a*v+n*g):(p.m01=h*n+c*a,p.m11=l*n+u*a,p.m21=m*n+f*a,p.m02=h*-a+c*n,p.m12=l*-a+u*n,p.m22=m*-a+f*n),p},rotY:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m01,m=(this.m11,this.m21),c=this.m02,u=this.m12,f=this.m22,d=this.m03,v=(this.m13,this.m23),g=i?this:this.clone();return 2==t?(g.m00=n*s+a*h,g.m20=-a*s+n*h,g.m01=n*l+a*m,g.m21=-a*l+n*m,g.m02=n*c+a*f,g.m22=-a*c+n*f,g.m03=n*d+a*v,g.m23=-a*d+n*v):(g.m00=s*n+c*-a,g.m10=o*n+u*-a,g.m20=h*n+f*-a,g.m02=s*a+c*n,g.m12=o*a+u*n,g.m22=h*a+f*n),g},rotZ:function(t,e,i){var r=e*Math.PI/180,n=Math.cos(r),a=Math.sin(r),s=this.m00,o=this.m10,h=this.m20,l=this.m01,m=this.m11,c=this.m21,u=this.m02,f=this.m12,d=(this.m22,this.m03),v=this.m13,g=(this.m23,i?this:this.clone());return 2==t?(g.m00=n*s+-a*o,g.m10=a*s+n*o,g.m01=n*l+-a*m,g.m11=a*l+n*m,g.m02=n*u+-a*f,g.m12=a*u+n*f,g.m03=n*d+-a*v,g.m13=a*d+n*v):(g.m00=s*n+l*a,g.m10=o*n+m*a,g.m20=h*n+c*a,g.m01=s*-a+l*n,g.m11=o*-a+m*n,g.m21=h*-a+c*n),g},scale:function(t,e,i,r,n){var a,s,o;i?(a=e,s=i,o=r):e.x?(a=e.x,i=e.y,r=e.z,n=i):(a=e,r=e,n=i=e);var h=n?this:this.clone();return 2==t?(h.m00*=a,h.m10*=s,h.m20*=o,h.m01*=a,h.m11*=s,h.m21*=o,h.m02*=a,h.m12*=s,h.m22*=o,h.m03*=a,h.m13*=s,h.m23*=o):(h.m00*=a,h.m10*=a,h.m20*=a,h.m01*=s,h.m11*=s,h.m21*=s,h.m02*=o,h.m12*=o,h.m22*=o),h},toMat3:function(t){return null==t&&(t=V.mat3()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m30=0,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m31=0,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m32=0,t},toMat4:function(t){return null==t&&(t=V.mat4()),t.m00=this.m00,t.m10=this.m10,t.m20=this.m20,t.m30=0,t.m01=this.m01,t.m11=this.m11,t.m21=this.m21,t.m31=0,t.m02=this.m02,t.m12=this.m12,t.m22=this.m22,t.m32=0,t.m03=this.m03,t.m13=this.m13,t.m23=this.m23,t.m33=1,t},toQuat:function(t){null==t&&(t=V.quat());var e=this.m00+this.m11+this.m22;if(e>0){var i=2*Math.sqrt(e+1);t.s=.25*i,t.x=(this.m21-this.m12)/i,t.y=(this.m02-this.m20)/i,t.z=(this.m10-this.m01)/i}else if(this.m00>this.m11&&this.m00>this.m22){i=2*Math.sqrt(1+this.m00-this.m11-this.m22);t.s=(this.m21-this.m12)/i,t.x=.25*i,t.y=(this.m01+this.m10)/i,t.z=(this.m02+this.m20)/i}else if(this.m11>this.m22){i=2*Math.sqrt(1+this.m11-this.m00-this.m22);t.s=(this.m02-this.m20)/i,t.x=(this.m01+this.m10)/i,t.y=.25*i,t.z=(this.m12+this.m21)/i}else{i=2*Math.sqrt(1+this.m22-this.m00-this.m11);t.s=(this.m10-this.m01)/i,t.x=(this.m02+this.m20)/i,t.y=(this.m12+this.m21)/i,t.z=.25*i}return t},toArray:function(t){return null==t&&(t=V.array()),t.push(this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22,this.m03,this.m13,this.m23),t}},xt.prototype={set:function(t,e,i,r){this.s=t,this.x=e,this.y=i,this.z=r},clone:function(t){return(t=t||V.quat()).s=this.s,t.x=this.x,t.y=this.y,t.z=this.z,t},equal:function(t){return F(this.s,t.s)&&F(this.x,t.x)&&F(this.y,t.y)&&F(this.z,t.z)},getImVec3:function(){var t=V.vec3();return t.x=this.x,t.y=this.y,t.z=this.z,t},len:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},lenSquare:function(){return this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(t){if(!t){var e=V.quat();i=1/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);return e.s=this.s*i,e.x=this.x*i,e.y=this.y*i,e.z=this.z*i,e}var i=1/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);this.s*=i,this.x*=i,this.y*=i,this.z*=i},conjugate:function(t){var e=t?this:V.quat();return e.set(this.s,-this.x,-this.y,-this.z),e},inverse:function(t){var e=this.conjugate(),i=1/(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z),r=t?this:V.quat();return r.set(e.s*i,e.x*i,e.y*i,e.z*i),V._quat(e),r},toMat3:function(t){var e=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);return null==t&&(t=V.mat3()),t.m00=1-e*(this.y*this.y+this.z*this.z),t.m10=e*this.x*this.y+e*this.s*this.z,t.m20=-e*this.s*this.y+e*this.x*this.z,t.m01=e*this.x*this.y-e*this.s*this.z,t.m11=1-e*(this.x*this.x+this.z*this.z),t.m21=e*this.s*this.x+e*this.y*this.z,t.m02=e*this.s*this.y+e*this.x*this.z,t.m12=-e*this.s*this.x+e*this.y*this.z,t.m22=1-e*(this.x*this.x+this.y*this.y),t},toMat4:function(t){var e=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);return null==t&&(t=V.mat4()),t.m00=1-e*(this.y*this.y+this.z*this.z),t.m10=e*this.x*this.y+e*this.s*this.z,t.m20=-e*this.s*this.y+e*this.x*this.z,t.m01=e*this.x*this.y-e*this.s*this.z,t.m11=1-e*(this.x*this.x+this.z*this.z),t.m21=e*this.s*this.x+e*this.y*this.z,t.m02=e*this.s*this.y+e*this.x*this.z,t.m12=-e*this.s*this.x+e*this.y*this.z,t.m22=1-e*(this.x*this.x+this.y*this.y),t},toMat43:function(t){var e=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);return null==t&&(t=V.mat43()),t.m00=1-e*(this.y*this.y+this.z*this.z),t.m10=e*this.x*this.y+e*this.s*this.z,t.m20=-e*this.s*this.y+e*this.x*this.z,t.m01=e*this.x*this.y-e*this.s*this.z,t.m11=1-e*(this.x*this.x+this.z*this.z),t.m21=e*this.s*this.x+e*this.y*this.z,t.m02=e*this.s*this.y+e*this.x*this.z,t.m12=-e*this.s*this.x+e*this.y*this.z,t.m22=1-e*(this.x*this.x+this.y*this.y),t}},Mt.prototype={clone:function(t){return(t=t||V.plane()).vOrigin.x=this.vOrigin.x,t.vOrigin.y=this.vOrigin.y,t.vOrigin.z=this.vOrigin.z,t.vNormal.x=this.vNormal.x,t.vNormal.y=this.vNormal.y,t.vNormal.z=this.vNormal.z,t},set:function(t,e){this.vOrigin.x=t.x,this.vOrigin.y=t.y,this.vOrigin.z=t.z;var i=1/Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);this.vNormal.x=e.x*i,this.vNormal.y=e.y*i,this.vNormal.z=e.z*i},setOrigin:function(t){this.vOrigin.x=t.x,this.vOrigin.y=t.y,this.vOrigin.z=t.z},setNormal:function(t){var e=1/Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z);this.vNormal.x=t.x*e,this.vNormal.y=t.y*e,this.vNormal.z=t.z*e},setByCoefficients:function(t,e,i,r){var n=1/Math.sqrt(t*t+e*e+i*i);this.vNormal.x=t*n,this.vNormal.y=e*n,this.vNormal.z=i*n,F(t,0)?F(e,0)?(this.vOrigin.x=0,this.vOrigin.y=0,this.vOrigin.z=-r/i):(this.vOrigin.x=0,this.vOrigin.y=-r/e,this.vOrigin.z=0):(this.vOrigin.x=-r/t,this.vOrigin.y=0,this.vOrigin.z=0)},collideVertex:function(t){var e=this.vNormal.x*this.vOrigin.x+this.vNormal.y*this.vOrigin.y+this.vNormal.z*this.vOrigin.z,i=this.vNormal.x*t.x+this.vNormal.y*t.y+this.vNormal.z*t.z;return F(i,e)?2:i>e?1:0},collideLine:function(t,e,i){var r=(e.x-t.x)*this.vNormal.x+(e.y-t.y)*this.vNormal.y+(e.z-t.z)*this.vNormal.z;if(F(r,0))return 2==this.collideVertex(t)?2:0;var n=W(this.vOrigin,t),a=q(this.vNormal,n)/r;return V._vec3(n),null!=i&&(i.fT=a),1},collideRay:function(t,e,i){var r=q(e,this.vNormal);if(F(r,0))return 2==this.collideVertex(t)?2:0;var n=W(this.vOrigin,t),a=q(this.vNormal,n)/r;return V._vec3(n),a<0?0:(null!=i&&(i.fT=a),1)}},bt.prototype={clone:function(t){var e=t||V.aabbox();return e.set(this.vMin,this.vMax),e},set:function(t,e){this.vMin.x=t.x,this.vMin.y=t.y,this.vMin.z=t.z,this.vMax.x=e.x,this.vMax.y=e.y,this.vMax.z=e.z,this.bPointDirty=!0},setMin:function(t,e,i){null==e?(this.vMin.x=t.x,this.vMin.y=t.y,this.vMin.z=t.z):(this.vMin.x=t,this.vMin.y=e,this.vMin.z=i),this.bPointDirty=!0},setMax:function(t,e,i){null==e?(this.vMax.x=t.x,this.vMax.y=t.y,this.vMax.z=t.z):(this.vMax.x=t,this.vMax.y=e,this.vMax.z=i),this.bPointDirty=!0},union:function(t){var e=Y(this.vMin,t.vMin),i=Z(this.vMax,t.vMax),r=V.aabbox();return r.set(e,i),V._vec3(e),V._vec3(i),r},intersect:function(t){var e=Z(this.vMin,t.vMin),i=Y(this.vMax,t.vMax),r=Z(this.vMin,i),n=V.aabbox();return n.set(e,r),V._vec3(e),V._vec3(i),V._vec3(r),n},getExtent:function(t){return 1==t?Math.max(0,this.vMax.x-this.vMin.x):2==t?Math.max(0,this.vMax.y-this.vMin.z):Math.max(0,this.vMax.z-this.vMin.z)},getVolume:function(){return Math.max(0,this.vMax.x-this.vMin.x)*Math.max(0,this.vMax.y-this.vMin.y)*Math.max(0,this.vMax.z-this.vMin.z)},getPoint:function(t){if(this.bPointDirty){var e=this.aPointList[0];e.x=this.vMin.x,e.y=this.vMin.y,e.z=this.vMin.z;var i=this.aPointList[1];i.x=this.vMax.x,i.y=this.vMin.y,i.z=this.vMin.z;var r=this.aPointList[2];r.x=this.vMax.x,r.y=this.vMax.y,r.z=this.vMin.z;var n=this.aPointList[3];n.x=this.vMin.x,n.y=this.vMax.y,n.z=this.vMin.z;var a=this.aPointList[4];a.x=this.vMin.x,a.y=this.vMin.y,a.z=this.vMax.z;var s=this.aPointList[5];s.x=this.vMax.x,s.y=this.vMin.y,s.z=this.vMax.z;var o=this.aPointList[6];o.x=this.vMax.x,o.y=this.vMax.y,o.z=this.vMax.z;var h=this.aPointList[7];h.x=this.vMin.x,h.y=this.vMax.y,h.z=this.vMax.z,this.bPointDirty=!1}var l=this.aPointList[t],m=V.vec3();return m.x=l.x,m.y=l.y,m.z=l.z,m},transformMat4:function(t){var e=V.vec3(),i=V.vec3(),r=V.vec3();r.x=this.vMin.x,r.y=this.vMin.y,r.z=this.vMin.z;var n=at(t,r);e.x=n.x,e.y=n.y,e.z=n.z,i.x=n.x,i.y=n.y,i.z=n.z,V._vec3(n),r.x=this.vMax.x,r.y=this.vMin.y,r.z=this.vMin.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMax.y,r.z=this.vMin.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMin.y,r.z=this.vMax.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMax.y,r.z=this.vMin.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMin.y,r.z=this.vMax.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMax.y,r.z=this.vMax.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMax.y,r.z=this.vMax.z,n=at(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),this.vMin.x=e.x,this.vMin.y=e.y,this.vMin.z=e.z,this.vMax.x=i.x,this.vMax.y=i.y,this.vMax.z=i.z,V._vec3(e),V._vec3(i),this.bPointDirty=!0},transformMat43:function(t){var e=V.vec3(),i=V.vec3(),r=V.vec3();r.x=this.vMin.x,r.y=this.vMin.y,r.z=this.vMin.z;var n=ct(t,r);e.x=n.x,e.y=n.y,e.z=n.z,i.x=n.x,i.y=n.y,i.z=n.z,V._vec3(n),r.x=this.vMax.x,r.y=this.vMin.y,r.z=this.vMin.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMax.y,r.z=this.vMin.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMin.y,r.z=this.vMax.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMax.y,r.z=this.vMin.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMin.y,r.z=this.vMax.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMin.x,r.y=this.vMax.y,r.z=this.vMax.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),r.x=this.vMax.x,r.y=this.vMax.y,r.z=this.vMax.z,n=ct(t,r),e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.z=Math.min(e.z,n.z),i.x=Math.max(i.x,n.x),i.y=Math.max(i.y,n.y),i.z=Math.max(i.z,n.z),V._vec3(n),this.vMin.x=e.x,this.vMin.y=e.y,this.vMin.z=e.z,this.vMax.x=i.x,this.vMax.y=i.y,this.vMax.z=i.z,V._vec3(e),V._vec3(i),this.bPointDirty=!0},collideVertex:function(t){return t.x>=this.vMin.x&&t.x<=this.vMax.x&&t.y>=this.vMin.y&&t.y<=this.vMax.y&&t.z>=this.vMin.z&&t.z<=this.vMax.z?1:0},collideRay:function(t,e,i){var r=V.vec3();r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z;var n=S.VEC3_X,a=S.VEC3_Y,s=S.VEC3_Z,o=V.plane();o.set(this.vMin,n);var h=V.plane();h.set(this.vMax,n);var l=V.plane();l.set(this.vMin,a);var m=V.plane();m.set(this.vMax,a);var c=V.plane();c.set(this.vMin,s);var u,f,d=V.plane();d.set(this.vMax,s);var v=new Object,g=new Object;return 1==o.collideLine(t,r,v)&&(h.collideLine(t,r,g),u=Math.min(v.fT,g.fT),f=Math.max(v.fT,g.fT)),1==l.collideLine(t,r,v)&&(m.collideLine(t,r,g),null!=u?(u=Math.max(u,Math.min(v.fT,g.fT)),f=Math.min(f,Math.max(v.fT,g.fT))):(u=Math.min(v.fT,g.fT),f=Math.max(v.fT,g.fT))),1==c.collideLine(t,r,v)&&(d.collideLine(t,r,g),null!=u?(u=Math.max(u,Math.min(v.fT,g.fT)),f=Math.min(f,Math.max(v.fT,g.fT))):(u=Math.min(v.fT,g.fT),f=Math.max(v.fT,g.fT))),V._plane(o),V._plane(h),V._plane(l),V._plane(m),V._plane(c),V._plane(d),V._vec3(r),u<=f&&f>=0?(i&&(i.fT0=u,i.fT1=f),1):0},collideAABBox:function(t){var e=Z(this.vMin,t.vMin),i=Y(this.vMax,t.vMax),r=0;return r=e.x>i.x||e.y>i.y||e.z>i.z?0:e.equal(t.vMin)&&i.equal(t.vMax)?2:1,V._vec3(e),V._vec3(i),r}},At.prototype={setByViewProjMat:function(t){t.clone(this.mViewProjMat),this.aPlaneList[3].setByCoefficients(t.m30-t.m00,t.m31-t.m01,t.m32-t.m02,t.m33-t.m03),this.aPlaneList[2].setByCoefficients(t.m30+t.m00,t.m31+t.m01,t.m32+t.m02,t.m33+t.m03),this.aPlaneList[5].setByCoefficients(t.m30+t.m10,t.m31+t.m11,t.m32+t.m12,t.m33+t.m13),this.aPlaneList[4].setByCoefficients(t.m30-t.m10,t.m31-t.m11,t.m32-t.m12,t.m33-t.m13),this.aPlaneList[1].setByCoefficients(t.m30-t.m20,t.m31-t.m21,t.m32-t.m22,t.m33-t.m23),this.aPlaneList[0].setByCoefficients(t.m30+t.m20,t.m31+t.m21,t.m32+t.m22,t.m33+t.m23),this.bPointDirty=!0},getPlane:function(t){return this.aPlaneList[t]},setPlane:function(t,e){e.clone(this.aPlaneList[t]),this.bPointDirty=!0},getPoint:function(t){return this.bPointDirty&&(this._genPointList(),this.bPointDirty=!1),this.aPointList[t]},collideVertex:function(t){return 0==this.aPlaneList[0].collideVertex(t)||0==this.aPlaneList[1].collideVertex(t)||0==this.aPlaneList[2].collideVertex(t)||0==this.aPlaneList[3].collideVertex(t)||0==this.aPlaneList[4].collideVertex(t)||0==this.aPlaneList[5].collideVertex(t)?0:1},collideAABBox:function(t){t.getPoint(0);var e,i,r,n=t.aPointList,a=n[0],s=n[1],o=n[2],h=n[3],l=n[4],m=n[5],c=n[6],u=n[7],f=!0,d=!0;return r=(e=this.aPlaneList[0]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:(d=!0,r=(e=this.aPlaneList[1]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:(d=!0,r=(e=this.aPlaneList[2]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:(d=!0,r=(e=this.aPlaneList[3]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:(d=!0,r=(e=this.aPlaneList[4]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:(d=!0,r=(e=this.aPlaneList[5]).vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*a.x+e.vNormal.y*a.y+e.vNormal.z*a.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*s.x+e.vNormal.y*s.y+e.vNormal.z*s.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*o.x+e.vNormal.y*o.y+e.vNormal.z*o.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*h.x+e.vNormal.y*h.y+e.vNormal.z*h.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*l.x+e.vNormal.y*l.y+e.vNormal.z*l.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*m.x+e.vNormal.y*m.y+e.vNormal.z*m.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*c.x+e.vNormal.y*c.y+e.vNormal.z*c.z,f=f&&i>=r,d=d&&i<r,r=e.vNormal.x*e.vOrigin.x+e.vNormal.y*e.vOrigin.y+e.vNormal.z*e.vOrigin.z,i=e.vNormal.x*u.x+e.vNormal.y*u.y+e.vNormal.z*u.z,f=f&&i>=r,(d=d&&i<r)?0:f?2:1)))))},_genPointList:function(){this.aPointList[0]=Tt(this.aPlaneList[0],this.aPlaneList[5],this.aPlaneList[2]),this.aPointList[1]=Tt(this.aPlaneList[0],this.aPlaneList[5],this.aPlaneList[3]),this.aPointList[2]=Tt(this.aPlaneList[0],this.aPlaneList[4],this.aPlaneList[3]),this.aPointList[3]=Tt(this.aPlaneList[0],this.aPlaneList[4],this.aPlaneList[2]),this.aPointList[4]=Tt(this.aPlaneList[1],this.aPlaneList[5],this.aPlaneList[2]),this.aPointList[5]=Tt(this.aPlaneList[1],this.aPlaneList[5],this.aPlaneList[3]),this.aPointList[6]=Tt(this.aPlaneList[1],this.aPlaneList[4],this.aPlaneList[3]),this.aPointList[7]=Tt(this.aPlaneList[1],this.aPlaneList[4],this.aPlaneList[2])}},Lt.prototype={set:function(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r},clone:function(t){return(t=t||new Lt).set(this.x,this.y,this.width,this.height),t}},S.VEC2_ZERO=new G(0,0),S.VEC2_ONE=new G(1,1),S.VEC2_X=new G(1,0),S.VEC2_Y=new G(0,1),S.VEC3_ZERO=new j(0,0,0),S.VEC3_ONE=new j(1,1,1),S.VEC3_X=new j(1,0,0),S.VEC3_Y=new j(0,1,0),S.VEC3_Z=new j(0,0,1),S.VEC3_RED=S.VEC3_X,S.VEC3_GREEN=S.VEC3_Y,S.VEC3_BLUE=S.VEC3_Z,S.VEC3_YELLOW=new j(1,1,0),S.VEC3_BLACK=S.VEC3_ZERO,S.VEC3_WHITE=S.VEC3_ONE,S.VEC4_ZERO=new tt(0,0,0,0),S.VEC4_ONE=new tt(1,1,1,1),S.VEC4_X=new j(1,0,0,0),S.VEC4_Y=new j(0,1,0,0),S.VEC4_Z=new j(0,0,1,0),S.VEC4_W=new j(0,0,0,1),S.MAT3_ZERO=new et(0),S.MAT3_I=new it(1),S.MAT4_ZERO=new it(0),S.MAT4_I=new it(1),S.MAT43_ZERO=new lt(0),S.MAT43_I=new lt(1),St.prototype={getName:function(){return this.element.nodeName},getText:function(){return this.sText},getChildNum:function(){return this.childNodes.length},getChild:function(t,e){if(P(t))return new St(this.childNodes[t]);e&&(t=t.toLowerCase());for(var i=0;i<this.childNodes.length;++i){if(e?this.childNodes[i].nodeName.toLowerCase()==t:this.childNodes[i].nodeName==t)return new St(this.childNodes[i])}return null},getAttribNum:function(){return this.element.attributes.length},getAttribName:function(t){return this.element.attributes[t].name},getAttribValueString:function(t,e){if(P(t))return this.element.attributes[t].value;e&&(t=t.toLowerCase());for(var i=0;i<this.element.attributes.length;++i){if(e?this.element.attributes[i].name.toLowerCase()==t:this.element.attributes[i].name==t)return this.element.attributes[i].value}return null},getAttribValueInt:function(t,e){if(P(t))return parseInt(this.element.attributes[t].value);e&&(t=t.toLowerCase());for(var i=0;i<this.element.attributes.length;++i){if(e?this.element.attributes[i].name.toLowerCase()==t:this.element.attributes[i].name==t)return parseInt(this.element.attributes[i].value)}return null},getAttribValueFloat:function(t,e){if(P(t))return parseFloat(this.element.attributes[t].value);e&&(t=t.toLowerCase());for(var i=0;i<this.element.attributes.length;++i){if(e?this.element.attributes[i].name.toLowerCase()==t:this.element.attributes[i].name==t)return parseFloat(this.element.attributes[i].value)}return null},getAttribValueVec2:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.vec2()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.vec2()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n}}return null},getAttribValueVec3:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.vec3()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n.z=parseFloat(i[2]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.vec3()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n.z=parseFloat(i[2]),n}}return null},getAttribValueVec4:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.vec4()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n.z=parseFloat(i[2]),n.w=parseFloat(i[3]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.vec3()).x=parseFloat(i[0]),n.y=parseFloat(i[1]),n.z=parseFloat(i[2]),n.w=parseFloat(i[3]),n}}return null},getAttribValueMat4:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.mat4()).m00=parseFloat(i[0]),n.m10=parseFloat(i[1]),n.m20=parseFloat(i[2]),n.m30=parseFloat(i[3]),n.m01=parseFloat(i[4]),n.m11=parseFloat(i[5]),n.m21=parseFloat(i[6]),n.m31=parseFloat(i[7]),n.m02=parseFloat(i[8]),n.m12=parseFloat(i[9]),n.m22=parseFloat(i[10]),n.m32=parseFloat(i[11]),n.m03=parseFloat(i[12]),n.m13=parseFloat(i[13]),n.m23=parseFloat(i[14]),n.m33=parseFloat(i[15]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.mat4()).m00=parseFloat(i[0]),n.m10=parseFloat(i[1]),n.m20=parseFloat(i[2]),n.m30=parseFloat(i[3]),n.m01=parseFloat(i[4]),n.m11=parseFloat(i[5]),n.m21=parseFloat(i[6]),n.m31=parseFloat(i[7]),n.m02=parseFloat(i[8]),n.m12=parseFloat(i[9]),n.m22=parseFloat(i[10]),n.m32=parseFloat(i[11]),n.m03=parseFloat(i[12]),n.m13=parseFloat(i[13]),n.m23=parseFloat(i[14]),n.m33=parseFloat(i[15]),n}}return null},getAttribValueMat43:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.mat43()).m00=parseFloat(i[0]),n.m10=parseFloat(i[1]),n.m20=parseFloat(i[2]),n.m01=parseFloat(i[3]),n.m11=parseFloat(i[4]),n.m21=parseFloat(i[5]),n.m02=parseFloat(i[6]),n.m12=parseFloat(i[7]),n.m22=parseFloat(i[8]),n.m03=parseFloat(i[9]),n.m13=parseFloat(i[10]),n.m23=parseFloat(i[11]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.mat43()).m00=parseFloat(i[0]),n.m10=parseFloat(i[1]),n.m20=parseFloat(i[2]),n.m01=parseFloat(i[3]),n.m11=parseFloat(i[4]),n.m21=parseFloat(i[5]),n.m02=parseFloat(i[6]),n.m12=parseFloat(i[7]),n.m22=parseFloat(i[8]),n.m03=parseFloat(i[9]),n.m13=parseFloat(i[10]),n.m23=parseFloat(i[11]),n}}return null},getAttribValueQuat:function(t,e){if(P(t)){var i=this.element.attributes[t].value.split(" ");return(n=V.quat()).s=parseFloat(i[0]),n.x=parseFloat(i[1]),n.y=parseFloat(i[2]),n.z=parseFloat(i[3]),n}e&&(t=t.toLowerCase());for(var r=0;r<this.element.attributes.length;++r){if(e?this.element.attributes[r].name.toLowerCase()==t:this.element.attributes[r].name==t){var n;i=this.element.attributes[r].value.split(" ");return(n=V.quat()).s=parseFloat(i[0]),n.x=parseFloat(i[1]),n.y=parseFloat(i[2]),n.z=parseFloat(i[3]),n}}return null},getAttribValueIntArray:function(t,e){if(P(t)){for(var i=this.element.attributes[t].value.split(" "),r=V.array(),n=0;n<i.length;++n)r.push(parseInt(i[n]));return r}e&&(t=t.toLowerCase());for(n=0;n<this.element.attributes.length;++n){if(e?this.element.attributes[n].name.toLowerCase()==t:this.element.attributes[n].name==t){for(i=this.element.attributes[n].value.split(" "),r=V.array(),n=0;n<i.length;++n)r.push(parseInt(i[n]));return r}}return null},getAttribValueFloatArray:function(t,e){if(P(t)){for(var i=this.element.attributes[t].value.split(" "),r=V.array(),n=0;n<i.length;++n)r.push(parseFloat(i[n]));return r}e&&(t=t.toLowerCase());for(n=0;n<this.element.attributes.length;++n){if(e?this.element.attributes[n].name.toLowerCase()==t:this.element.attributes[n].name==t){for(i=this.element.attributes[n].value.split(" "),r=V.array(),n=0;n<i.length;++n)r.push(parseFloat(i[n]));return r}}return null},getAttribValueStringArray:function(t,e){if(P(t))return this.element.attributes[t].value.split(" ");e&&(t=t.toLowerCase());for(var i=0;i<this.element.attributes.length;++i){if(e?this.element.attributes[i].name.toLowerCase()==t:this.element.attributes[i].name==t)return this.element.attributes[i].value.split(" ")}return null}};var Ct=new Object;function Et(t){this.rc=t,this.glArrayBuffer=null,this.iBufferType=0,this.iDataType=0,this.iDataSize=0,this.iBufferLength=0}function Ot(t){this.rc=t,this.glRenderBufferObj=null,this.iBufferFormat=0,this.iWidth=0,this.iHeight=0}function Pt(t){this.rc=t,this.glFrameBufferObj=null}function Bt(t,e){this.iShaderType=e,this.rc=t,this.glShaderObj=this.rc.createShader(this.iShaderType),this.sShaderSource="",this.sFloatPrecision="mediump"}function wt(t){this.rc=t,this.glProgramObj=this.rc.createProgram(),this.vertexShader=null,this.fragmentShader=null,this.aAddrA=null,this.aAddrU=null,this.aTexBind=null,this.tempFloat3x3Array=[0,0,0,0,0,0,0,0,0],this.tempFloat4x3Array=[0,0,0,0,0,0,0,0,0,0,0,0],this.tempFloat4x4Array=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.tempArray=new Array}function kt(t){this.rc=t,this.glTextureObj=null,this.iType=0,this.iSizeU=0,this.iSizeV=0,this.iFormat=0,this.bMipMap=!1,this.video=null}function Rt(t){this.rc=t,this.sName="",this.mCamMat=new lt(1),this.mViewMat=new lt(1),this.bViewMatDirty=!0,this.iProjMode=1,this.mProjMat=new it(1),this.bProjDirty=!0,this.mViewProjMat=new it(1),this.mViewProjInvMat=new it(1),this.bViewProjDirty=!0,this.frustum=new At,this.bFrustumDirty=!0,this.iViewportX=0,this.iViewportY=0,this.iViewportWidth=0,this.iViewportHeight=0,this.vBackColor=new j(0,0,0),this.fFov=45,this.fZNear=1,this.fZFar=1e4}function zt(){this.vEmissive=new j(0,0,0),this.vAmbient=new j(0,0,0),this.vDiffuse=new j(0,0,0),this.vSpecular=new j(0,0,0),this.fSpecularLevel=0,this.fGlossiness=8,this.fAlpha=1,this.bBlend=!1,this.iBlendEquation=32774,this.iBlendEquationAlpha=32774,this.iBlendSrc=770,this.iBlendDest=771,this.iBlendSrcAlpha=1,this.iBlendDestAlpha=1,this.bAlphaTest=!1,this.fAlphaTestValue=0,this.bDynamicLighting=!0,this.bWireframe=!1,this.fLineWidth=1,this.bVertexColor=!1,this.bDepthTest=!0,this.bDepthWrite=!0,this.bTwoSide=!1,this.vGlowColor=new j(1,1,1),this.bGlow=!1,this.bFog=!0,this.aTextureList=["","","","","","",""],this.aTextureTypeList=[3553,3553,3553,3553,3553,3553,3553],this.aTextureFilterList=[9729,9729,9729,9729,9729,9729,9729],this.aTextureWrapUList=[33071,33071,33071,33071,33071,33071,33071],this.aTextureWrapVList=[33071,33071,33071,33071,33071,33071,33071],this.aUvAttribList=["","","","","","",""],this.aTangentAttribList=["","","","","","",""],this.aBinormalAttribList=["","","","","","",""],this.bEmissiveScript=!0,this.bDiffuseScript=!0,this.bDiffusePowerScript=!0,this.bSpecularScript=!0,this.bSpecularPowerScript=!0,this.bNormalScript=!0,this.bAlphaScript=!0,this.bGlowScript=!0,this.bDctLightScript=!0,this.bPointLightScript=!0,this.bSpotLightScript=!0,this.sEmissiveScript="",this.sDiffuseScript="",this.sDiffusePowerScript="",this.sSpecularScript="",this.sSpecularPowerScript="",this.sNormalScript="",this.sAlphaScript="",this.sGlowScript="",this.sDctLightScript="",this.sPointLightScript="",this.sSpotLightScript="",this.sPackedEmissiveScript="",this.sPackedDiffuseScript="",this.sPackedDiffusePowerScript="",this.sPackedSpecularScript="",this.sPackedSpecularPowerScript="",this.sPackedNormalScript="",this.sPackedAlphaScript="",this.sPackedGlowScript="",this.sPackedDctLightScript="",this.sPackedPointLightScript="",this.sPackedSpotLightScript="",this.entity=null,this.aTextureResIdList=[-1,-1,-1,-1,-1,-1,-1]}function Dt(){this.aBoneNameList=new Array,this.aBoneNameIdxMap=new Object,this.aBoneSkinMatList=new Array,this.bbox=new bt(new j(1e10,1e10,1e10),new j(-1e10,-1e10,-1e10)),this.sVertexBoneIdxAttribName="",this.sVertexBoneWeightAttribName=""}function Nt(t){this.rc=t,this.sName="",this.material=new zt(t),this.bbox=new bt,this.aAttribDataList=V.object(),this.aAttribArrayBufferList=V.object(),this.iAttribCount=0,this.iVertexCount=0,this.aIndexDataList=V.object(),this.aIndexArrayBufferList=V.object(),this.aIndexTopologyList=V.object(),this.iIndexCount=0,this.animSkin=new Dt}function Vt(t){this.rc=t,this.aMeshMap=new Object,this.iMeshCount=0,this.bbox=new bt(S.VEC3_ZERO,S.VEC3_ZERO)}function Ft(){this.sName="",this.aKeyTransList=new Array,this.aKeyQuatList=new Array,this.parent=null,this.mCurMat=V.mat43(),this.bCurMatDirty=!0}function It(){this.aKeyFrameList=new Array,this.bbox=new bt,this.aBoneList=new Object,this.iBoneNum=0,this.iFrameNum=0,this.iTick=33,this.iCurTime=-1,this.iLerpKeyStart=-1,this.iLerpKeyEnd=-1,this.fLerpT=0}function Ut(){this.attachedAnim=null,this.bLoop=!1,this.fSpeed=1,this.iCurTime=0}function Kt(){this.bActive=!1,this.mainChannel=new Ut,this.transChannel=new Ut,this.iTransTime=0,this.iCurTransTime=0}function Gt(){this.skinInfo=null,this.aBoneMatList=new Array,this.bBoneMatDirty=!1,this.aBoneFinalMatList=new Array,this.bBoneFinalMatDirty=!1,this.aChannelList=new Array,this.aChannelList.push(new Kt),this.aChannelList.push(new Kt),this.iBlendMode=1,this.bbox=new bt,this.bBBoxDirty=!0}function jt(t,e,i,r,n){this.code=0,this.tex=t,this.x=e,this.y=i,this.width=r,this.height=n}function Ht(t,e,i){this.rc=t,this.width=e,this.height=i,this.ok2DLayoutHelper=new k(e,i),this.texData=new kt(t),this.texData.createTexture(3553,e,i,6408,5121),this.charsList=new w}function Wt(){this.fontFamily="",this.fontSize=40,this.fontWeight="normal",this.fontVariant="",this.fontStyle="normal",this.bAutoWrap=!0,this.texWidth=512,this.texHeight=512,this.rc=null,this.maxTexNumber=5,this.texArray=new Array,this.texDynamicList=new w,this.codePages=new Object,this.program=null}Ct._parseMaterialXML=function(t,e,i){for(var r=t.getAttribNum(),n=0;n<r;++n){switch(t.getAttribName(n).toLowerCase()){case"emissive":e.setEmissive(t.getAttribValueVec3(n));break;case"ambient":e.setAmbient(t.getAttribValueVec3(n));break;case"diffuse":e.setDiffuse(t.getAttribValueVec3(n));break;case"specular":e.setSpecular(t.getAttribValueVec3(n));break;case"specularlevel":e.setSpecularLevel(t.getAttribValueFloat(n));break;case"glossiness":e.setGlossiness(t.getAttribValueFloat(n));break;case"alpha":e.setAlpha(t.getAttribValueFloat(n));break;case"blend":e.enableBlend("true"==t.getAttribValueString(n).toLowerCase());break;case"alphatest":e.enableAlphaTest("true"==t.getAttribValueString(n).toLowerCase());break;case"alphatestvalue":e.setAlphaTestValue(t.getAttribValueFloat(n));break;case"dynamiclighting":e.enableDynamicLighting("true"==t.getAttribValueString(n).toLowerCase());break;case"wireframe":e.enableWireframe("true"==t.getAttribValueString(n).toLowerCase());break;case"vertexcolor":e.enableVertexColor("true"==t.getAttribValueString(n).toLowerCase());break;case"depthtest":e.enableDepthTest("true"==t.getAttribValueString(n).toLowerCase());break;case"twoside":e.enableTwoSide("true"==t.getAttribValueString(n).toLowerCase())}}for(n=0;n<t.getChildNum();++n){var a=t.getChild(n);if("Texture"==a.getName()){var s=a.getAttribValueString("channel",!0).toLowerCase(),o=0;"albedo1"==s?o=0:"albedo2"==s?o=1:"albedo3"==s?o=2:"albedo4"==s?o=3:"normal"==s?o=4:"opacity"==s?o=5:"specularlevel"==s&&(o=6);r=a.getAttribNum();for(var h=0;h<r;++h){switch(a.getAttribName(h).toLowerCase()){case"name":e.setTextureName(o,a.getAttribValueString(h));break;case"texcoord":e.setTextureCoord(o,a.getAttribValueString(h));break;case"type":var l=a.getAttribValueString(h).toLowerCase();"2d"==l?e.setTextureType(o,3553):"cube"==l&&e.setTextureType(o,34067);break;case"filter":var m=a.getAttribValueString(h).toLowerCase();"linear"==m?e.setTextureFilter(o,9729):"nearest"==m&&e.setTextureFilter(o,9728);break;case"wrap":"repeat"==(c=a.getAttribValueString(h).toLowerCase())?e.setTextureWrap(o,10497):"clamp"==c?e.setTextureWrap(o,33071):"mirror"==c&&e.setTextureWrap(o,33648);break;case"wrapu":"repeat"==(c=a.getAttribValueString(h).toLowerCase())?e.setTextureWrapU(o,10497):"clamp"==c?e.setTextureWrapU(o,33071):"mirror"==c&&e.setTextureWrapU(o,33648);break;case"wrapv":var c;"repeat"==(c=a.getAttribValueString(h).toLowerCase())?e.setTextureWrapV(o,10497):"clamp"==c?e.setTextureWrapV(o,33071):"mirror"==c&&e.setTextureWrapV(o,33648);break;case"tangent":e.setTextureTangent(o,a.getAttribValueString(h));break;case"binormal":e.setTextureBinormal(o,a.getAttribValueString(h))}}}else if(a.getName().toLowerCase()=="Script".toLowerCase())for(h=0;h<a.getChildNum();++h){var u=a.getChild(h),f=u.getName().toLowerCase(),d=u.getAttribValueString("Code",!0);null==d&&(d=u.getText());var v=u.getAttribValueString("Enable",!0);"emissive"==f?(d&&e.setEmissiveScript(d),v&&e.enableEmissiveScript("true"==v.toLowerCase())):"diffuse"==f?(d&&e.setDiffuseScript(d),v&&e.enableDiffuseScript("true"==v.toLowerCase())):"specular"==f?(d&&e.setSpecularScript(d),v&&e.enableSpecularScript("true"==v.toLowerCase())):"specularpower"==f?(d&&e.setSpecularPowerScript(d),v&&e.enableSpecularPowerScript("true"==v.toLowerCase())):"normal"==f?(d&&e.setNormalScript(d),v&&e.enableNormalScript("true"==v.toLowerCase())):"alpha"==f?(d&&e.setAlphaScript(d),v&&e.enableAlphaScript("true"==v.toLowerCase())):"dctlight"==f?(d&&e.setDctLightScript(d),v&&e.enableDctLightScript("true"==v.toLowerCase())):"pointlight"==f?(d&&e.setPointLightScript(d),v&&e.enablePointLightScript("true"==v.toLowerCase())):"spotlight"==f&&(d&&e.setSpotLightScript(d),v&&e.enableSpotLightScript("true"==v.toLowerCase()))}}return!0},Ct._packMeshAttributes=function(t,e,i,r){var n=new w;for(var a in e)"position"==a.toLowerCase()||0==a.toLowerCase().indexOf("position/")?n.pushFront(a):"Texcoord1"!=a&&"Texcoord2"!=a&&"Texcoord3"!=a&&"Texcoord4"!=a&&n.pushBack(a);e.Texcoord1&&n.pushBack("Texcoord1"),e.Texcoord2&&n.pushBack("Texcoord2"),e.Texcoord3&&n.pushBack("Texcoord3"),e.Texcoord4&&n.pushBack("Texcoord4");for(var s=0;s<t;++s)for(var o=n.getRoot();o;){for(var h=e[a=o.data],l=i[a],m=0;m<l;++m)r.push(h[s*l+m]);o=o.next}var c="";for(o=n.getRoot();o;)c+=(""!=c?"/":"")+o.data,o=o.next;return c},Ct._parseMeshXML=function(t,e,i,r,n,a){if("Mesh"!=t.getName())return!1;for(var s=t.getAttribValueString("Name",!0),o=V.array(),h=t.getAttribValueInt("VertexCount",!0)?t.getAttribValueInt("VertexCount",!0):0,l=t.getChild("IndexList",!0)?t.getChild("IndexList",!0).getChildNum():0,m=V.object(),c=V.object(),u=V.object(),f=V.object(),d=V.object(),v={triangles:4,trianglestrip:5,trianglefan:6,lines:1,linestrip:3,lineloop:2,points:0},g={triangles:3,trianglestrip:0,trianglefan:0,lines:2,linestrip:0,lineloop:0,points:1},p=t.getChild("AttributeList",!0),x=0;x<p.getChildNum();++x){var y=p.getChild(x);if("attribute"==y.getName().toLowerCase()){var _=y.getAttribValueString("Name",!0);if((X=(b=y.getAttribValueFloatArray("Data",!0)).length/h)-Math.floor(X)!=0)return!1;m[_]=b,c[_]=X}}var M=t.getChild("IndexList",!0);for(x=0;x<M.getChildNum();++x){var T=M.getChild(x);if("index"==T.getName().toLowerCase()){_=T.getAttribValueString("Name",!0);var b=T.getAttribValueIntArray("Data",!0),A=T.getAttribValueIntArray("Topology",!0);u[_]=b,f[_]=v[A||"triangles"],d[_]=g[A||"triangles"]}}if(a){var L=V.array(),S=Ct._packMeshAttributes(h,m,c,L);V._object(m),(m=V.object())[S]=L,V._object(c),(c=V.object())[S]=L.length/h}var C="",E=null,O=0,P=0,B=0;for(var w in f){C=w,B=(E=u[w]).length,O=f[w],P=d[w];break}if(h>65536&&1==l&&(4==O||1==O||0==O))for(var k=0;k<B;){for(var R=0;null!=r[s+"_SV_"+R];)R++;r[s+"_SV_"+R]=!0;for(var z=e.createMesh(s+"_SV_"+R),D=0,N=new Array,F=0;F<h;++F)N.push(-1);var I=V.object();for(var U in m)I[U]=V.array();for(var K=V.array();k<B;){var G=k,j=Math.min(k+P,B),H=D;for(F=G;F<j;++F){var W=E[F];if(-1==N[W]){for(var U in N[W]=D,I){var X=c[U],Y=m[U],Z=I[U];for(x=0;x<X;++x)Z.push(Y[W*X+x])}D+=1}K.push(N[W])}if(D>65536){for(var U in D=H,I)for(Z=I[U],X=c[U];Z.length>65536*X;)Z.pop();for(F=G;F<j;++F)K.pop();break}k+=P}for(var U in I){(q=I[U]).length>0&&z.createAttribute(U,q.length,q)}K.length>0&&z.createIndex(C,K.length,K,35044,O),z.setVertexNum(D),o.push(z)}else{z=e.createMesh(s);for(var U in m){var q;(q=m[U]).length>0&&z.createAttribute(U,q.length,q)}for(var w in u){var Q=u[w];Q.length>0&&z.createIndex(w,Q.length,Q,35044,f[w])}z.setVertexNum(h),o.push(z)}V._object(m),V._object(c),V._object(u),V._object(f),V._object(d);for(F=0;F<t.getChildNum();++F){switch((tt=t.getChild(F)).getName()){case"Skin":var $=tt;for(var s in o){var J=(z=o[s]).getSkin();J.clear();for(x=0;x<$.getChildNum();++x){var tt;"Bone"==(tt=$.getChild(x)).getName()?J.addBone(tt.getAttribValueString("Name"),tt.getAttribValueMat43("InitMatrix")):"BoundingBox"==tt.getName()&&J.setBoundingBox(tt.getAttribValueVec3("Min"),tt.getAttribValueVec3("Max"))}J.setRefAttributeName($.getAttribValueString("VertexBoneIndexAttribName"),$.getAttribValueString("VertexBoneWeightAttribName"))}break;case"BoundingBox":for(var s in o){(z=o[s]).setBoundingBox(tt.getAttribValueVec3("Min"),tt.getAttribValueVec3("Max"))}}}var et=t.getAttribValueString("Material");if(""!=et)for(var s in o){z=o[s];i[et].clone(z.getMaterial())}if(0!=n)for(var s in o){for(var it=(z=o[s]).getIndexArray("Default"),rt=new Array,nt=it.length/3,at=0;at<nt;++at){var st=it[3*at],ot=it[3*at+1],ht=it[3*at+2];rt.push(st,ot,ot,ht,ht,st)}z.createIndex("Wireframe",rt.length,rt)}},Ct.loadTextureFromImage=function(t,e,i){if(!K(e.width)||!K(e.height)){if(C(this.texSupportedCanvas)&&(this.texSupportedCanvas=document.createElement("canvas")),!this.texSupportedCanvas)return!1;this.texSupportedCanvas.width=U(e.width),this.texSupportedCanvas.height=U(e.height),this.texSupportedCanvas.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.texSupportedCanvas.width,this.texSupportedCanvas.height),e=this.texSupportedCanvas}return t.createTexture(3553,e.width,e.height,i,5121,e),!0},Ct.loadTextureFromVideo=function(t,e,i){return t.createTexture(3553,e.width,e.height,i,5121,e),!0},Ct.loadTerrainFromBmp=function(t){t.width,t.height},Et.prototype={createBuffer:function(t,e,i,r){this.releaseBuffer(),this.glArrayBuffer=this.rc.createBuffer(),this.iBufferType=t,this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer),this.iDataType=e,this.iDataSize=5123==e?2:4,P(r)?(this.iBufferLength=r,this.rc.bufferData(this.iBufferType,r*this.iDataSize,i)):(this.iBufferLength=r.length,O(r)?5126==e?this.rc.bufferData(this.iBufferType,new Float32Array(r),i):5123==e&&this.rc.bufferData(this.iBufferType,new Uint16Array(r),i):this.rc.bufferData(this.iBufferType,r,i))},releaseBuffer:function(){null!=this.glArrayBuffer&&this.rc.deleteBuffer(this.glArrayBuffer),this.glArrayBuffer=null},updateBuffer:function(t,e,i){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer),O(i)?5126==this.iDataType?this.rc.bufferSubData(this.iBufferType,t*this.iDataSize,new Float32Array(i)):5123==this.iDataType&&this.rc.bufferSubData(this.iBufferType,t*this.iDataSize,new Uint16Array(i)):this.rc.bufferSubData(this.iBufferType,t*this.iDataSize,i)},getLength:function(){return this.iBufferLength},bindAttrib:function(t,e,i,r){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer),this.rc.enableVertexAttribArray(t),this.rc.vertexAttribPointer(t,e,this.iDataType,!1,r*this.iDataSize,i*this.iDataSize)},bind:function(){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer)},drawIndex:function(t,e,i){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer),this.rc.drawElements(t,i||this.iBufferLength,this.iDataType,e?e*this.iDataSize:0)}},Ot.prototype={createBuffer:function(t,e,i){this.releaseBuffer(),this.glRenderBufferObj=this.rc.createRenderbuffer(),this.rc.bindRenderbuffer(36161,this.glRenderBufferObj),this.rc.renderbufferStorage(36161,t,e,i),this.iBufferFormat=t,this.iWidth=e,this.iHeight=i},releaseBuffer:function(){null!=this.glRenderBufferObj&&this.rc.deleteRenderbuffer(this.glRenderBufferObj),this.glRenderBufferObj=null,this.iBufferFormat=0,this.iWidth=0,this.iHeight=0}},Pt.prototype={createBuffer:function(){this.glFrameBufferObj=this.rc.createFramebuffer()},releaseBuffer:function(){null!=this.glFrameBufferObj&&this.rc.deleteFramebuffer(this.glFrameBufferObj),this.glFrameBufferObj=null},bind:function(){this.rc.bindFramebuffer(36160,this.glFrameBufferObj)},unbind:function(){this.rc.bindFramebuffer(36160,null)},attachRenderTexture:function(t,e){this.rc.framebufferTexture2D(36160,36064+t,3553,e?e.glTextureObj:null,0)},attachDepthBuffer:function(t){this.rc.framebufferRenderbuffer(36160,36096,36161,t.glRenderBufferObj)},attachStencilBuffer:function(t){this.rc.framebufferRenderbuffer(36160,36128,36161,t.glRenderBufferObj)},attachDepthStencilBuffer:function(t){this.rc.framebufferRenderbuffer(36160,33306,36161,t?t.glRenderBufferObj:null)}},Bt.prototype={releaseShader:function(){null!=this.glShaderObj&&this.rc.deleteShader(this.glShaderObj),this.glShaderObj=null},releaseSource:function(){this.sShaderSource=""},loadSource:function(t){this.sShaderSource=t.substr(0,t.length)},setFloatPrecision:function(t){this.sFloatPrecision=t},compile:function(t,e){var i="";if(null!=t)for(var r in t)i+="\n#define "+r+" "+t[r]+"\n";var n="";35632==this.iShaderType&&(n="\nprecision "+this.sFloatPrecision+" float;\n"),null==this.glShaderObj&&(this.glShaderObj=this.rc.createShader(this.iShaderType));var a=n+(null!=t?i+this.sShaderSource:this.sShaderSource);if(this.rc.shaderSource(this.glShaderObj,a),this.rc.compileShader(this.glShaderObj),!this.rc.getShaderParameter(this.glShaderObj,35713)){var s=this.rc.getShaderInfoLog(this.glShaderObj);return S._SOURCE?alert("[Oak3D Error]\n"+s+"\n[Source]\n"+a):e&&(e.errorMsg=s),!1}return!0}},wt.prototype={releaseProgram:function(){null!=this.glProgramObj&&this.rc.deleteProgram(this.glProgramObj),this.glProgramObj=null},attachVertexShader:function(t){this.vertexShader=t},attachFragmentShader:function(t){this.fragmentShader=t},link:function(t){if(null==this.glProgramObj&&(this.glProgramObj=this.rc.createProgram()),this.rc.attachShader(this.glProgramObj,this.vertexShader.glShaderObj),this.rc.attachShader(this.glProgramObj,this.fragmentShader.glShaderObj),this.rc.linkProgram(this.glProgramObj),!this.rc.getProgramParameter(this.glProgramObj,35714)){if(S._SOURCE){var e=this.rc.getProgramInfoLog(this.glProgramObj);alert("[Oak3D Error]\n"+e)}else t&&(t.errorMsg=e);return!1}this.aAddrA=new Object,this.aAddrU=new Object,this.aTexBind=new Object;for(var i=this.rc.getProgramParameter(this.glProgramObj,35721),r=this.rc.getProgramParameter(this.glProgramObj,35718),n=0;n<i;++n){var a=(o=this.rc.getActiveAttrib(this.glProgramObj,n)).name.replace(/\[\d*\]/g,"");this.aAddrA[a]=this.rc.getAttribLocation(this.glProgramObj,a)}var s=0;for(n=0;n<r;++n){var o;a=(o=this.rc.getActiveUniform(this.glProgramObj,n)).name.replace(/\[\d*\]/g,"");this.aAddrU[a]=this.rc.getUniformLocation(this.glProgramObj,a),35678!=o.type&&35680!=o.type||(this.aTexBind[a]=s,s+=o.size)}return!0},setUniformInt:function(t,e){this.rc.uniform1i(this.aAddrU[t],e)},setUniformInt2:function(t,e,i){"number"==typeof e?this.rc.uniform2i(this.aAddrU[t],e,i):this.rc.uniform2i(this.aAddrU[t],e.x,e.y)},setUniformInt3:function(t,e,i,r){"number"==typeof e?this.rc.uniform3i(this.aAddrU[t],e,i,r):this.rc.uniform3i(this.aAddrU[t],e.x,e.y,e.z)},setUniformInt4:function(t,e,i,r,n){"number"==typeof e?this.rc.uniform4i(this.aAddrU[t],e,i,r,n):this.rc.uniform4i(this.aAddrU[t],e.x,e.y,e.z,e.w)},setUniformIntArray:function(t,e){this.rc.uniform1iv(this.aAddrU[t],e)},setUniformInt2Array:function(t,e){this.rc.uniform2iv(this.aAddrU[t],e)},setUniformInt3Array:function(t,e){this.rc.uniform3iv(this.aAddrU[t],e)},setUniformInt4Array:function(t,e){this.rc.uniform4iv(this.aAddrU[t],e)},setUniformFloat:function(t,e){this.rc.uniform1f(this.aAddrU[t],e)},setUniformFloat2:function(t,e,i){"number"==typeof e?this.rc.uniform2f(this.aAddrU[t],e,i):this.rc.uniform2f(this.aAddrU[t],e.x,e.y)},setUniformFloat3:function(t,e,i,r){"number"==typeof e?this.rc.uniform3f(this.aAddrU[t],e,i,r):this.rc.uniform3f(this.aAddrU[t],e.x,e.y,e.z)},setUniformFloat4:function(t,e,i,r,n){"number"==typeof e?this.rc.uniform4f(this.aAddrU[t],e,i,r,n):this.rc.uniform4f(this.aAddrU[t],e.x,e.y,e.z,e.w)},setUniformFloatArray:function(t,e){this.rc.uniform1fv(this.aAddrU[t],e)},setUniformFloat2Array:function(t,e){this.rc.uniform2fv(this.aAddrU[t],e)},setUniformFloat3Array:function(t,e){this.rc.uniform3fv(this.aAddrU[t],e)},setUniformFloat4Array:function(t,e){this.rc.uniform4fv(this.aAddrU[t],e)},setUniformVec2Array:function(t,e){for(var i=V.array(),r=e.length,n=0;n<r;++n){var a=e[n];i.push(a.x,a.y)}this.rc.uniform2fv(this.aAddrU[t],i),V._array(i)},setUniformVec3Array:function(t,e){for(var i=V.array(),r=e.length,n=0;n<r;++n){var a=e[n];i.push(a.x,a.y,a.z)}this.rc.uniform3fv(this.aAddrU[t],i),V._array(i)},setUniformVec4Array:function(t,e){for(var i=V.array(),r=e.length,n=0;n<r;++n){var a=e[n];i.push(a.x,a.y,a.z,a.w)}this.rc.uniform4fv(this.aAddrU[t],i),V._array(i)},setUniformMat3:function(t,e){var i=this.tempFloat3x3Array;i[0]=e.m00,i[1]=e.m10,i[2]=e.m20,i[3]=e.m01,i[4]=e.m11,i[5]=e.m21,i[6]=e.m02,i[7]=e.m12,i[8]=e.m22,this.rc.uniformMatrix3fv(this.aAddrU[t],!1,i)},setUniformMat3Array:function(t,e){var i=this.tempArray;i.length=0;for(var r=e.length,n=0;n<r;++n)i.push(e[n].m00,e[n].m10,e[n].m20,e[n].m01,e[n].m11,e[n].m21,e[n].m02,e[n].m12,e[n].m22);this.rc.uniformMatrix3fv(this.aAddrU[t],!1,i)},setUniformMat4:function(t,e){var i=this.tempFloat4x4Array;i[0]=e.m00,i[1]=e.m10,i[2]=e.m20,i[3]=e.m30,i[4]=e.m01,i[5]=e.m11,i[6]=e.m21,i[7]=e.m31,i[8]=e.m02,i[9]=e.m12,i[10]=e.m22,i[11]=e.m32,i[12]=e.m03,i[13]=e.m13,i[14]=e.m23,i[15]=e.m33,this.rc.uniformMatrix4fv(this.aAddrU[t],!1,i)},setUniformMat4Array:function(t,e){var i=this.tempArray;i.length=0;for(var r=e.length,n=0;n<r;++n)i.push(e[n].m00,e[n].m10,e[n].m20,e[n].m30,e[n].m01,e[n].m11,e[n].m21,e[n].m31,e[n].m02,e[n].m12,e[n].m22,e[n].m32,e[n].m03,e[n].m13,e[n].m23,e[n].m33);this.rc.uniformMatrix4fv(this.aAddrU[t],!1,i)},setUniformMat43:function(t,e,i){var r;i?((r=this.tempFloat4x4Array)[0]=e.m00,r[1]=e.m10,r[2]=e.m20,r[3]=0,r[4]=e.m01,r[5]=e.m11,r[6]=e.m21,r[7]=0,r[8]=e.m02,r[9]=e.m12,r[10]=e.m22,r[11]=0,r[12]=e.m03,r[13]=e.m13,r[14]=e.m23,r[15]=1,this.rc.uniformMatrix4fv(this.aAddrU[t],!1,r)):((r=this.tempFloat4x3Array)[0]=e.m00,r[1]=e.m01,r[2]=e.m02,r[3]=e.m03,r[4]=e.m10,r[5]=e.m11,r[6]=e.m12,r[7]=e.m13,r[8]=e.m20,r[9]=e.m21,r[10]=e.m22,r[11]=e.m23,this.rc.uniform4fv(this.aAddrU[t],r))},setUniformMat43Array:function(t,e,i){var r=this.tempArray;if(r.length=0,i){for(n=e.length,a=0;a<n;++a)r.push(e[a].m00,e[a].m10,e[a].m20,0,e[a].m01,e[a].m11,e[a].m21,0,e[a].m02,e[a].m12,e[a].m22,0,e[a].m03,e[a].m13,e[a].m23,1);this.rc.uniformMatrix4fv(this.aAddrU[t],!1,r)}else{for(var n=e.length,a=0;a<n;++a)r.push(e[a].m00,e[a].m01,e[a].m02,e[a].m03,e[a].m10,e[a].m11,e[a].m12,e[a].m13,e[a].m20,e[a].m21,e[a].m22,e[a].m23);this.rc.uniform4fv(this.aAddrU[t],r)}},setSampler:function(t,e){this.rc.uniform1i(this.aAddrU[t],e)},setSamplerArray:function(t,e){this.rc.uniform1iv(this.aAddrU[t],e)},setTexture:function(t,e,i,r,n){if(e){this.aAddrU[t];var a=this.aTexBind[t];this.rc.uniform1i(this.aAddrU[t],a),e.bind(a);var s=e.getType();i=i||10497,this.rc.texParameteri(s,10242,i),this.rc.texParameteri(s,10243,i),e.isMipMap()?9728==r||9729==r?r+=256:null==r&&(r=9985):r=r||9729,this.rc.texParameteri(s,10241,r),n=n||9729,this.rc.texParameteri(s,10240,n)}},setTextureArray:function(t,e,i,r,n){this.aAddrU[t];for(var a=this.aTexBind[t],s=V.array(),o=(a=this.aTexBind[t],e.length),h=0;h<o;++h){var l=e[h],m=i?P(i)?i:i[h]:null,c=r?P(r)?r:r[h]:null,u=n?P(n)?n:n[h]:null;l.bind(a);var f=l.getType();m=m||10497,this.rc.texParameteri(f,10242,m),this.rc.texParameteri(f,10243,m),l.isMipMap()?9728==c||9729==c?c+=256:null==c&&(c=9985):c=c||9729,this.rc.texParameteri(f,10241,c),u=u||9729,this.rc.texParameteri(f,10240,u),s.push(a++)}this.rc.uniform1iv(this.aAddrU[t],s),V._array(s)},setAttribute:function(t,e,i,r,n){var a=this.aAddrA[t];null!=a&&e.bindAttrib(a,i,null!=r?r:0,null!=n?n:0)},bind:function(){this.rc.useProgram(this.glProgramObj)}},kt.prototype={isValid:function(){return null!=this.glTextureObj},getType:function(){return this.iType},createTexture:function(t,e,i,r,n,a,s,o,h,l,m){this.releaseTexture(),this.glTextureObj=this.rc.createTexture(),this.iType=t,this.iSizeU=e,this.iSizeV=i,this.iFormat=r,this.bMipMap=!1,3553==t?(this.rc.bindTexture(3553,this.glTextureObj),null==a||O(a)?this.rc.texImage2D(3553,0,r,e,i,0,r,n||5121,a?new Uint8Array(a):null):this.rc.texImage2D(3553,0,r,r,n||5121,a)):34067==t&&(this.rc.bindTexture(34067,this.glTextureObj),null==a||O(a)?this.rc.texImage2D(34069,0,r,e,i,0,r,n||5121,a?new Uint8Array(a):null):this.rc.texImage2D(34069,0,r,r,n||5121,a),null==s||O(s)?this.rc.texImage2D(34070,0,r,e,i,0,r,n||5121,s?new Uint8Array(s):null):this.rc.texImage2D(34070,0,r,r,n||5121,s),null==o||O(o)?this.rc.texImage2D(34071,0,r,e,i,0,r,n||5121,o?new Uint8Array(o):null):this.rc.texImage2D(34071,0,r,r,n||5121,o),null==h||O(h)?this.rc.texImage2D(34072,0,r,e,i,0,r,n||5121,h?new Uint8Array(h):null):this.rc.texImage2D(34072,0,r,r,n||5121,h),null==l||O(l)?this.rc.texImage2D(34073,0,r,e,i,0,r,n||5121,l?new Uint8Array(l):null):this.rc.texImage2D(34073,0,r,r,n||5121,l),null==m||O(m)?this.rc.texImage2D(34074,0,r,e,i,0,r,n||5121,m?new Uint8Array(m):null):this.rc.texImage2D(34074,0,r,r,n||5121,m))},releaseTexture:function(){null!=this.glTextureObj&&(this.rc.deleteTexture(this.glTextureObj),this.glTextureObj=null),this.iType=0,this.iSizeU=0,this.iSizeV=0,this.iFormat=0,this.bMipMap=!1},updateTexture:function(t,e,i,r,n,a,s,o,h,l,m){3553==this.iType?(this.rc.bindTexture(3553,this.glTextureObj),O(a)?this.rc.texSubImage2D(3553,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(a)):this.rc.texSubImage2D(3553,0,t,e,this.iFormat,n||5121,a)):34067==this.iType&&(this.rc.bindTexture(34067,this.glTextureObj),a&&(O(a)?this.rc.texSubImage2D(34069,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(a)):this.rc.texSubImage2D(34069,0,t,e,this.iFormat,n||5121,a)),s&&(O(s)?this.rc.texSubImage2D(34070,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(s)):this.rc.texSubImage2D(34070,0,t,e,this.iFormat,n||5121,s)),o&&(O(o)?this.rc.texSubImage2D(34071,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(o)):this.rc.texSubImage2D(34071,0,t,e,this.iFormat,n||5121,o)),h&&(O(h)?this.rc.texSubImage2D(34072,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(h)):this.rc.texSubImage2D(34072,0,t,e,this.iFormat,n||5121,h)),l&&(O(l)?this.rc.texSubImage2D(34073,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(l)):this.rc.texSubImage2D(34073,0,t,e,this.iFormat,n||5121,l)),m&&(O(m)?this.rc.texSubImage2D(34074,0,t,e,i,r,this.iFormat,n||5121,new Uint8Array(m)):this.rc.texSubImage2D(34074,0,t,e,this.iFormat,n||5121,m)))},getSizeU:function(t){var e=this.iSizeU>>(null!=t?t:0);return e>0?e:1},getSizeV:function(t){var e=this.iSizeV>>(null!=t?t:0);return e>0?e:1},bind:function(t){this.rc.activeTexture(33984+(null!=t?t:0)),this.rc.bindTexture(this.iType,this.glTextureObj)},updateVideoTexture:function(){this.video&&this.video.readyState===this.video.HAVE_ENOUGH_DATA&&(this.updateTexture(0,0,0,0,5121,this.video),this.rc.texParameteri(3553,10242,33071),this.rc.texParameteri(3553,10243,33071),this.rc.texParameteri(3553,10240,9729),this.rc.texParameteri(3553,10241,9729))},isVideoTexture:function(){return!!this.video},genMipMap:function(){this.rc.generateMipmap(this.iType),this.bMipMap=!0},isMipMap:function(){return this.bMipMap}},Rt.prototype={reset:function(t,e){0!=t&&this.mCamMat.setColumn(3,0,0,0),0!=e&&(this.mCamMat.setColumn(0,1,0,0),this.mCamMat.setColumn(1,0,1,0),this.mCamMat.setColumn(2,0,0,1)),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},setName:function(t){this.sName=t},getName:function(){return this.sName},setMat:function(t){t.clone(this.mCamMat),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},setPos:function(t,e,i){null!=t&&null!=i?(this.mCamMat.m03=t,this.mCamMat.m13=e,this.mCamMat.m23=i):(this.mCamMat.m03=t.x,this.mCamMat.m13=t.y,this.mCamMat.m23=t.z),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},getPos:function(){return this.mCamMat.getColumn(3)},move:function(t,e,i,r){2==t?null!=e&&null!=r?(this.mCamMat.m03+=e,this.mCamMat.m13+=i,this.mCamMat.m23+=r):(this.mCamMat.m03+=e.x,this.mCamMat.m13+=e.y,this.mCamMat.m23+=e.z):null!=e&&null!=r?(this.mCamMat.m03+=e*this.mCamMat.m00+i*this.mCamMat.m01+r*this.mCamMat.m02,this.mCamMat.m13+=e*this.mCamMat.m10+i*this.mCamMat.m11+r*this.mCamMat.m12,this.mCamMat.m23+=e*this.mCamMat.m20+i*this.mCamMat.m21+r*this.mCamMat.m22):(this.mCamMat.m03+=e.x*this.mCamMat.m00+e.y*this.mCamMat.m01+e.z*this.mCamMat.m02,this.mCamMat.m13+=e.x*this.mCamMat.m10+e.y*this.mCamMat.m11+e.z*this.mCamMat.m12,this.mCamMat.m23+=e.x*this.mCamMat.m20+e.y*this.mCamMat.m21+e.z*this.mCamMat.m22),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},moveRight:function(t){this.mCamMat.m03+=t*this.mCamMat.m00,this.mCamMat.m13+=t*this.mCamMat.m10,this.mCamMat.m23+=t*this.mCamMat.m20,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},moveUp:function(t){this.mCamMat.m03+=t*this.mCamMat.m01,this.mCamMat.m13+=t*this.mCamMat.m11,this.mCamMat.m23+=t*this.mCamMat.m21,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},moveForward:function(t){this.mCamMat.m03-=t*this.mCamMat.m02,this.mCamMat.m13-=t*this.mCamMat.m12,this.mCamMat.m23-=t*this.mCamMat.m22,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotX:function(t,e){var i=dt(e);if(2==t){var r=this.mCamMat.m03,n=this.mCamMat.m13,a=this.mCamMat.m23,s=mt(i,this.mCamMat);V._mat43(this.mCamMat),this.mCamMat=s,this.mCamMat.m03=r,this.mCamMat.m13=n,this.mCamMat.m23=a}else{s=mt(this.mCamMat,i);V._mat43(this.mCamMat),this.mCamMat=s}V._mat43(i),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotY:function(t,e){var i=vt(e);if(2==t){var r=this.mCamMat.m03,n=this.mCamMat.m13,a=this.mCamMat.m23,s=mt(i,this.mCamMat);V._mat43(this.mCamMat),this.mCamMat=s,this.mCamMat.m03=r,this.mCamMat.m13=n,this.mCamMat.m23=a}else{s=mt(this.mCamMat,i);V._mat43(this.mCamMat),this.mCamMat=s}V._mat43(i),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotZ:function(t,e){var i=gt(e);if(2==t){var r=this.mCamMat.m03,n=this.mCamMat.m13,a=this.mCamMat.m23,s=mt(i,this.mCamMat);V._mat43(this.mCamMat),this.mCamMat=s,this.mCamMat.m03=r,this.mCamMat.m13=n,this.mCamMat.m23=a}else{s=mt(this.mCamMat,i);V._mat43(this.mCamMat),this.mCamMat=s}V._mat43(i),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotRight:function(t){var e=dt(t),i=mt(this.mCamMat,e);V._mat43(this.mCamMat),this.mCamMat=i,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotUp:function(t){var e=vt(t),i=mt(this.mCamMat,e);V._mat43(this.mCamMat),this.mCamMat=i,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotForward:function(t){var e=gt(-t),i=mt(this.mCamMat,e);V._mat43(this.mCamMat),this.mCamMat=i,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},rotTarget:function(t,e,i){var r=V.mat43();this.mCamMat.clone(r),r.m03-=e.x,r.m13-=e.y,r.m23-=e.z;var n=mt(pt(t,i),r);V._mat43(r),n.m03+=e.x,n.m13+=e.y,n.m23+=e.z,n.clone(this.mCamMat),V._mat43(n),this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},getRightDir:function(){var t=V.vec3();return t.x=this.mCamMat.m00,t.y=this.mCamMat.m10,t.z=this.mCamMat.m20,t},getUpDir:function(){var t=V.vec3();return t.x=this.mCamMat.m01,t.y=this.mCamMat.m11,t.z=this.mCamMat.m21,t},getForwardDir:function(){var t=V.vec3();return t.x=-this.mCamMat.m02,t.y=-this.mCamMat.m12,t.z=-this.mCamMat.m22,t},lookAt:function(t,e,i,r,n,a){var s=V.vec3(),o=V.vec3();"number"==typeof t?(s.x=t,s.y=e,s.z=i,n?(o.x=r,o.y=n,o.z=a):r?(o.x=r.x,o.y=r.y,o.z=r.z):(o.x=this.mCamMat.m01,o.y=this.mCamMat.m11,o.z=this.mCamMat.m21)):(s.x=t.x,s.y=t.y,s.z=t.z,i?(o.x=e,o.y=i,o.z=r):e?(o.x=e.x,o.y=e.y,o.z=e.z):(o.x=this.mCamMat.m01,o.y=this.mCamMat.m11,o.z=this.mCamMat.m21));var h=V.vec3();h.x=this.mCamMat.m03-s.x,h.y=this.mCamMat.m13-s.y,h.z=this.mCamMat.m23-s.z,h.normalize(!0);var l=Q(o,h);l.equal(S.VEC3_ZERO)?(l.x=this.mCamMat.m00,l.y=this.mCamMat.m10,l.z=this.mCamMat.m20,l.normalize(!0),o=Q(h,l),V._vec3(l),l=Q(o,h)):(V._vec3(o),o=Q(h,l)),l.normalize(!0),o.normalize(!0),this.mCamMat.m00=l.x,this.mCamMat.m10=l.y,this.mCamMat.m20=l.z,this.mCamMat.m01=o.x,this.mCamMat.m11=o.y,this.mCamMat.m21=o.z,this.mCamMat.m02=h.x,this.mCamMat.m12=h.y,this.mCamMat.m22=h.z,this.bViewMatDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},getViewMat4:function(){this.bViewMatDirty&&(V._mat43(this.mViewMat),this.mViewMat=this.mCamMat.inverse(),this.bViewMatDirty=!1);var t=V.mat4();return this.mViewMat.toMat4(t),t},getViewMat43:function(){this.bViewMatDirty&&(V._mat43(this.mViewMat),this.mViewMat=this.mCamMat.inverse(),this.bViewMatDirty=!1);var t=V.mat43();return this.mViewMat.clone(t),t},getMat4:function(){var t=V.mat4();return this.mCamMat.toMat4(t),t},getMat43:function(){var t=V.mat43();return this.mCamMat.clone(t),t},getViewInvMat4:function(){var t=V.mat4();return this.mCamMat.toMat4(t),t},getViewInvMat43:function(){var t=V.mat43();return this.mCamMat.clone(t),t},setViewport:function(t,e,i,r){this.iViewportX=t,this.iViewportY=e,this.iViewportWidth=i,this.iViewportHeight=r,this.bProjDirty=!0,this.bViewProjDirty=!0,this.bFrustumDirty=!0},getViewportLeft:function(){return this.iViewportX},getViewportTop:function(){return this.iViewportY},getViewportWidth:function(){return this.iViewportWidth},getViewportHeight:function(){return this.iViewportHeight},bindViewport:function(){var t=this.rc.canvas.clientHeight;this.rc.viewport(this.iViewportX,t-(this.iViewportY+this.iViewportHeight),this.iViewportWidth,this.iViewportHeight),this.rc.scissor(this.iViewportX,t-(this.iViewportY+this.iViewportHeight),this.iViewportWidth,this.iViewportHeight)},setBackColor:function(t,e,i,r){null==e?(this.vBackColor.x=t.x,this.vBackColor.y=t.y,this.vBackColor.z=t.z,this.vBackColor.w=t.w):(this.vBackColor.x=t,this.vBackColor.y=e,this.vBackColor.z=i,this.vBackColor.w=r)},getBackColor:function(){return this.vBackColor},setFov:function(t){this.fFov=t,this.bProjDirty=!0,this.bViewProjDirty=!0},getFov:function(){return this.fFov},setVisibleRange:function(t,e){this.fZNear=Math.max(.01,t),this.fZFar=e,this.bProjDirty=!0,this.bViewProjDirty=!0},setVisibleNear:function(t){this.fZNear=t},setVisibleFar:function(t){this.fZFar=t},getVisibleNear:function(){return this.fZNear},getVisibleFar:function(){return this.fZFar},setProjMode:function(t){this.iProjMode=t,this.bProjDirty=!0,this.bViewProjDirty=!0},getProjMode:function(){return this.iProjMode},getProjMat4:function(){return this.bProjDirty&&(1==this.iProjMode?(V._mat4(this.mProjMat),this.mProjMat=ot(this.fFov,this.iViewportWidth/this.iViewportHeight,this.fZNear,this.fZFar),this.bProjDirty=!1):(V._mat4(this.mProjMat),this.mProjMat=ht(-1,1,1,-1,this.fZNear,this.fZFar),this.bProjDirty=!1)),this.mProjMat},getViewProjMat4:function(){return this.bViewProjDirty&&(V._mat4(this.mViewProjMat),V._mat4(this.mViewProjInvMat),this.mViewProjMat=rt(this.getProjMat4(),this.getViewMat4()),this.mViewProjInvMat=this.mViewProjMat.inverse(),this.bViewProjDirty=!1),this.mViewProjMat},getViewProjInvMat4:function(){return this.bViewProjDirty&&(V._mat4(this.mViewProjMat),V._mat4(this.mViewProjInvMat),this.mViewProjMat=rt(this.getProjMat4(),this.getViewMat4()),this.mViewProjInvMat=this.mViewProjMat.inverse(),this.bViewProjDirty=!1),this.mViewProjInvMat},getFrustum:function(){return this.bFrustumDirty&&(this.frustum.setByViewProjMat(this.getViewProjMat4()),this.bFrustumDirty=!1),this.frustum},getPickPoint:function(t,e){var i=t-this.iViewportX,r=this.iViewportHeight-(e-this.iViewportY),n=V.vec3();n.x=i/this.iViewportWidth*2-1,n.y=r/this.iViewportHeight*2-1,n.z=-.99;var a=at(this.getViewProjInvMat4(),n);return V._vec3(n),a},getPickDir:function(t,e){var i=t-this.iViewportX,r=this.iViewportHeight-(e-this.iViewportY),n=V.vec3();n.x=i/this.iViewportWidth*2-1,n.y=r/this.iViewportHeight*2-1,n.z=0;var a=at(this.getViewProjInvMat4(),n),s=V.vec3();return s.x=a.x-this.mCamMat.m03,s.y=a.y-this.mCamMat.m13,s.z=a.z-this.mCamMat.m23,V._vec3(n),V._vec3(a),s},getPickFrustum:function(t,e,i,r){var n=t+(i>0?0:i),a=e+(r>0?0:r);i=i>0?i:-i,r=r>0?r:-r;var s=V.vec3();s.x=this.mCamMat.m03,s.y=this.mCamMat.m13,s.z=this.mCamMat.m23;var o=this.getPickPoint(n,a),h=this.getPickPoint(n+i,a),l=this.getPickPoint(n+i,a+r),m=this.getPickPoint(n,a+r),c=V.vec3(),u=V.vec3(),f=V.vec3(),d=V.vec3();c.x=o.x-s.x,c.y=o.y-s.y,c.z=o.z-s.z,u.x=h.x-s.x,u.y=h.y-s.y,u.z=h.z-s.z,f.x=l.x-s.x,f.y=l.y-s.y,f.z=l.z-s.z,d.x=m.x-s.x,d.y=m.y-s.y,d.z=m.z-s.z;var v=new At;v.setByViewProjMat(this.getViewProjMat4());var g=V.plane(),p=Q(c,u);g.set(s,p),V._vec3(p),v.setPlane(4,g);p=Q(f,d);g.set(s,p),V._vec3(p),v.setPlane(5,g);p=Q(d,c);g.set(s,p),V._vec3(p),v.setPlane(2,g);p=Q(u,f);return g.set(s,p),V._vec3(p),v.setPlane(3,g),V._vec3(s),V._vec3(o),V._vec3(h),V._vec3(l),V._vec3(m),V._vec3(c),V._vec3(u),V._vec3(f),V._vec3(d),v}},zt.prototype={clear:function(){this.vEmissive.set(0,0,0),this.vAmbient.set(0,0,0),this.vDiffuse.set(0,0,0),this.vSpecular.set(0,0,0),this.fSpecularLevel=0,this.fGlossiness=0,this.fAlpha=1,this.bBlend=!1,this.iBlendEquation=32774,this.iBlendEquationAlpha=32774,this.iBlendSrc=770,this.iBlendDest=771,this.iBlendSrcAlpha=1,this.iBlendDestAlpha=1,this.bAlphaTest=!1,this.fAlphaTestValue=0,this.bDynamicLighting=!0,this.bWireframe=!1,this.fLineWidth=1,this.bVertexColor=!1,this.bDepthTest=!0,this.bDepthWrite=!0,this.bTwoSide=!1,this.vGlowColor.set(1,1,1),this.bGlow=!1,this.bFog=!0;for(var t=0;t<7;++t)this.aTextureList[t]="",this.aTextureTypeList[t]=3553,this.aTextureFilterList[t]=9729,this.aTextureWrapUList[t]=33071,this.aTextureWrapVList[t]=33071,this.aUvAttribList[t]="",this.aTangentAttribList[t]="",this.aBinormalAttribList[t]="";this.bEmissiveScript=!0,this.bDiffuseScript=!0,this.bDiffusePowerScript=!0,this.bSpecularScript=!0,this.bSpecularPowerScript=!0,this.bNormalScript=!0,this.bAlphaScript=!0,this.bGlowScript=!0,this.bDctLightScript=!0,this.bPointLightScript=!0,this.bSpotLightScript=!0,this.sEmissiveScript="",this.sDiffuseScript="",this.sDiffusePowerScript="",this.sSpecularScript="",this.sSpecularPowerScript="",this.sNormalScript="",this.sAlphaScript="",this.sGlowScript="",this.sDctLightScript="",this.sPointLightScript="",this.sSpotLightScript="",this.sPackedEmissiveScript="",this.sPackedDiffuseScript="",this.sPackedDiffusePowerScript="",this.sPackedSpecularScript="",this.sPackedSpecularPowerScript="",this.sPackedNormalScript="",this.sPackedAlphaScript="",this.sPackedGlowScript="",this.sPackedDctLightScript="",this.sPackedPointLightScript="",this.sPackedSpotLightScript="";for(t=0;t<7;++t)this.aTextureResIdList[t]=-1},clone:function(t){(t=t||new zt).vEmissive=this.vEmissive.clone(),t.vAmbient=this.vAmbient.clone(),t.vDiffuse=this.vDiffuse.clone(),t.vSpecular=this.vSpecular.clone(),t.fSpecularLevel=this.fSpecularLevel,t.fGlossiness=this.fGlossiness,t.fAlpha=this.fAlpha,t.bBlend=this.bBlend,t.iBlendEquation=this.iBlendEquation,t.iBlendEquationAlpha=this.iBlendEquationAlpha,t.iBlendSrc=this.iBlendSrc,t.iBlendDest=this.iBlendDest,t.iBlendSrcAlpha=this.iBlendSrcAlpha,t.iBlendDestAlpha=this.iBlendDestAlpha,t.bAlphaTest=this.bAlphaTest,t.fAlphaTestValue=this.fAlphaTestValue,t.bDynamicLighting=this.bDynamicLighting,t.bWireframe=this.bWireframe,t.fLineWidth=this.fLineWidth,t.bVertexColor=this.bVertexColor,t.bDepthTest=this.bDepthTest,t.bDepthWrite=this.bDepthWrite,t.bTwoSide=this.bTwoSide,this.vGlowColor.clone(t.vGlowColor),t.bGlow=this.bGlow,t.bFog=this.bFog;for(var e=0;e<7;++e)t.setTextureName(e,this.aTextureList[e]),t.setTextureType(e,this.aTextureTypeList[e]),t.setTextureFilter(e,this.aTextureFilterList[e]),t.setTextureWrapU(e,this.aTextureWrapUList[e]),t.setTextureWrapV(e,this.aTextureWrapVList[e]),t.setTextureCoord(e,this.aUvAttribList[e]),t.setTextureTangent(e,this.aTangentAttribList[e]),t.setTextureBinormal(e,this.aBinormalAttribList[e]);return t.bEmissiveScript=this.bEmissiveScript,t.bDiffuseScript=this.bDiffuseScript,t.bDiffusePowerScript=this.bDiffusePowerScript,t.bSpecularScript=this.bSpecularScript,t.bGlossinessScript=this.bGlossinessScript,t.bAlphaScript=this.bAlphaScript,t.bNormalScript=this.bNormalScript,t.bGlowScript=this.bGlowScript,t.bDctLightScript=this.bDctLightScript,t.bPointLightScript=this.bPointLightScript,t.bSpotLightScript=this.bSpotLightScript,t.sEmissiveScript=this.sEmissiveScript,t.sDiffuseScript=this.sDiffuseScript,t.sDiffusePowerScript=this.sDiffusePowerScript,t.sSpecularScript=this.sSpecularScript,t.sSpecularPowerScript=this.sSpecularPowerScript,t.sAlphaScript=this.sAlphaScript,t.sNormalScript=this.sNormalScript,t.sGlowScript=this.sGlowScript,t.sDctLightScript=this.sDctLightScript,t.sPointLightScript=this.sPointLightScript,t.sSpotLightScript=this.sSpotLightScript,t.sPackedEmissiveScript=this.sPackedEmissiveScript,t.sPackedDiffuseScript=this.sPackedDiffuseScript,t.sPackedDiffusePowerScript=this.sPackedDiffusePowerScript,t.sPackedSpecularScript=this.sPackedSpecularScript,t.sPackedSpecularPowerScript=this.sPackedSpecularPowerScript,t.sPackedAlphaScript=this.sPackedAlphaScript,t.sPackedNormalScript=this.sPackedNormalScript,t.sPackedGlowScript=this.sPackedGlowScript,t.sPackedDctLightScript=this.sPackedDctLightScript,t.sPackedPointLightScript=this.sPackedPointLightScript,t.sPackedSpotLightScript=this.sPackedSpotLightScript,t},setEmissive:function(t,e,i){null!=e&&null!=i?this.vEmissive.set(t,e,i):this.vEmissive=t.clone()},getEmissive:function(){return this.vEmissive.clone()},setAmbient:function(t,e,i){null!=e&&null!=i?this.vAmbient.set(t,e,i):this.vAmbient=t.clone()},getAmbient:function(){return this.vAmbient.clone()},setDiffuse:function(t,e,i){null!=e&&null!=i?this.vDiffuse.set(t,e,i):this.vDiffuse=t.clone()},getDiffuse:function(){return this.vDiffuse.clone()},setSpecular:function(t,e,i){null!=e&&null!=i?this.vSpecular.set(t,e,i):this.vSpecular=t.clone()},getSpecular:function(){return this.vSpecular.clone()},setSpecularLevel:function(t){this.fSpecularLevel=t},getSpecularLevel:function(){return this.fSpecularLevel},setGlossiness:function(t){this.fGlossiness=t},getGlossiness:function(){return this.fGlossiness},setAlpha:function(t){this.fAlpha=t},getAlpha:function(){return this.fAlpha},enableBlend:function(t){this.bBlend=t},isBlend:function(){return this.bBlend},isBlendEnabled:function(){return this.bBlend},setBlendEquation:function(t,e){3!=t&&1!=t||(this.iBlendEquation=e),3!=t&&2!=t||(this.iBlendEquationAlpha=e)},getBlendEquation:function(t){return 1==t||3==t?this.iBlendEquation:2==t?this.iBlendEquationAlpha:void 0},setBlendFunc:function(t,e,i){3!=t&&1!=t||(this.iBlendSrc=e,this.iBlendDest=i),3!=t&&2!=t||(this.iBlendSrcAlpha=e,this.iBlendDestAlpha=i)},getBlendFuncSrc:function(t){return 1==t||3==t?this.iBlendSrc:2==t?this.iBlendSrcAlpha:void 0},getBlendFuncDest:function(t){return 1==t||3==t?this.iBlendDest:2==t?this.iBlendDestAlpha:void 0},enableFog:function(t){this.bFog=t},isFogEnabled:function(){return this.bFog},enableAlphaTest:function(t){this.bAlphaTest=t},isAlphaTest:function(){return this.bAlphaTest},isAlphaTestEnabled:function(){return this.bAlphaTest},setAlphaTestValue:function(t){this.fAlphaTestValue=t},getAlphaTestValue:function(t){return this.fAlphaTestValue},enableDynamicLighting:function(t){this.bDynamicLighting=t},isDynamicLighting:function(){return this.bDynamicLighting},isDynamicLightingEnabled:function(){return this.bDynamicLighting},enableWireframe:function(t){this.bWireframe=t},isWireframe:function(){return this.bWireframe},isWireframeEnabled:function(){return this.bWireframe},setLineWidth:function(t){this.fLineWidth=t},getLineWidth:function(){return this.fLineWidth},enableVertexColor:function(t){this.bVertexColor=t},isVertexColor:function(){return this.bVertexColor},isVertexColorEnabled:function(){return this.bVertexColor},enableDepthTest:function(t){this.bDepthTest=t},isDepthTest:function(){return this.bDepthTest},isDepthTestEnabled:function(){return this.bDepthTest},enableDepthWrite:function(t){this.bDepthWrite=t},isDepthWrite:function(){return this.bDepthWrite},isDepthWriteEnabled:function(){return this.bDepthWrite},enableTwoSide:function(t){this.bTwoSide=t},isTwoSide:function(){return this.bTwoSide},isTwoSideEnabled:function(){return this.bTwoSide},enableGlow:function(t){this.bGlow=t},isGlow:function(){return this.bGlow},isGlowEnabled:function(){return this.bGlow},setGlowColor:function(t,e,i){null!=e&&null!=i?this.vGlowColor.set(t,e,i):t.clone(this.vGlowColor)},getGlowColor:function(){return this.vGlowColor},setTextureName:function(t,e){(e=(e=e.replace(/\\/g,"/")).replace(/^\/+/g,""),this.aTextureList[t]=e,""!=e)&&(6==e.split(" ").length&&(this.aTextureTypeList[t]=34067));if(null!=this.entity){var i=this.entity,r=i.zone.scene.resourceManager;if(""!=e){var n=i.zone.scene._packTextureUrl(e),a=r.createResource(2,n);if(i.addResourceRef(a),this.aTextureResIdList[t]=a,2==r.getResourceState(a))if(3553==this.aTextureTypeList[t])r.loadTextureByUrl(a,n,6408);else if(34067==this.aTextureTypeList[t])e.split(" ")}else this.aTextureResIdList[t]=-1}},getTextureName:function(t){return this.aTextureList[t]},getTextureResourceId:function(t){return this.aTextureResIdList[t]},setTextureType:function(t,e){this.aTextureTypeList[t]=e,""!=this.aTextureList[t]&&this.setTextureName(t,this.aTextureList[t]),this.sPackedEmissiveScript="",this.sPackedDiffuseScript="",this.sPackedDiffusePowerScript="",this.sPackedSpecularScript="",this.sPackedSpecularPowerScript="",this.sPackedNormalScript="",this.sPackedAlphaScript="",this.sPackedDctLightScript="",this.sPackedPointLightScript="",this.sPackedSpotLightScript=""},getTextureType:function(t){return this.aTextureTypeList[t]},setTextureFilter:function(t,e){this.aTextureFilterList[t]=e},getTextureFilter:function(t){return this.aTextureFilterList[t]},setTextureWrap:function(t,e){this.aTextureWrapUList[t]=e,this.aTextureWrapVList[t]=e},setTextureWrapU:function(t,e){this.aTextureWrapUList[t]=e},setTextureWrapV:function(t,e){this.aTextureWrapVList[t]=e},getTextureWrapU:function(t){return this.aTextureWrapUList[t]},getTextureWrapV:function(t){return this.aTextureWrapVList[t]},setTextureCoord:function(t,e){this.aUvAttribList[t]=e},getTextureCoord:function(t){return this.aUvAttribList[t]},setTextureTangent:function(t,e){this.aTangentAttribList[t]=e},getTextureTangent:function(t){return this.aTangentAttribList[t]},setTextureBinormal:function(t,e){this.aBinormalAttribList[t]=e},getTextureBinormal:function(t){return this.aBinormalAttribList[t]},enableEmissiveScript:function(t){this.bEmissiveScript=t},isEmissiveScriptEnabled:function(){return this.bEmissiveScript},enableDiffuseScript:function(t){this.bDiffuseScript=t},isDiffuseScriptEnabled:function(){return this.bDiffuseScript},enableDiffusePowerScript:function(t){this.bDiffusePowerScript=t},isDiffusePowerScriptEnabled:function(){return this.bDiffusePowerScript},enableSpecularScript:function(t){this.bSpecularScript=t},isSpecularScriptEnabled:function(){return this.bSpecularScript},enableSpecularPowerScript:function(t){this.bSpecularPowerScript=t},isSpecularPowerScriptEnabled:function(){return this.bSpecularPowerScript},enableAlphaScript:function(t){this.bAlphaScript=t},isAlphaScriptEnabled:function(){return this.bAlphaScript},enableNormalScript:function(t){this.bNormalScript=t},isNormalScriptEnabled:function(){return this.bNormalScript},enableDctLightScript:function(t){this.bDctLightScript=t},isDctLightScriptEnabled:function(){return this.bDctLightScript},enablePointLightScript:function(t){this.bPointLightScript=t},isPointLightScriptEnabled:function(){return this.bPointLightScript},enableSpotLightScript:function(t){this.bSpotLightScript=t},isSpotLightScriptEnabled:function(){return this.bSpotLightScript},setEmissiveScript:function(t){this.sEmissiveScript=t,this.sPackedEmissiveScript=this._ProcessScript(t,!0,"vec3")},getEmissiveScript:function(){return this.sEmissiveScript},getPackedEmissiveScript:function(){return""!=this.sEmissiveScript&&""==this.sPackedEmissiveScript&&(this.sPackedEmissiveScript=this._ProcessScript(this.sEmissiveScript,!0,"vec3")),this.sPackedEmissiveScript},setDiffuseScript:function(t){this.sDiffuseScript=t,this.sPackedDiffuseScript=this._ProcessScript(t,!0,"vec3")},getDiffuseScript:function(){return this.sDiffuseScript},getPackedDiffuseScript:function(){return""!=this.sDiffuseScript&&""==this.sPackedDiffuseScript&&(this.sPackedDiffuseScript=this._ProcessScript(this.sDiffuseScript,!0,"vec3")),this.sPackedDiffuseScript},setDiffusePowerScript:function(t){this.sDiffusePowerScript=t,this.sPackedDiffusePowerScript=this._ProcessScript(t,!0,"float")},getDiffusePowerScript:function(){return this.sDiffusePowerScript},getPackedDiffusePowerScript:function(){return""!=this.sDiffusePowerScript&&""==this.sPackedDiffusePowerScript&&(this.sPackedDiffusePowerScript=this._ProcessScript(this.sDiffusePowerScript,!0,"float")),this.sPackedDiffusePowerScript},setSpecularScript:function(t){this.sSpecularScript=t,this.sPackedSpecularScript=this._ProcessScript(t,!0,"vec3")},getSpecularScript:function(){return this.sSpecularScript},getPackedSpecularScript:function(){return""!=this.sSpecularScript&&""==this.sPackedSpecularScript&&(this.sPackedSpecularScript=this._ProcessScript(this.sSpecularScript,!0,"vec3")),this.sPackedSpecularScript},setSpecularPowerScript:function(t){this.sSpecularPowerScript=t,this.sPackedSpecularPowerScript=this._ProcessScript(t,!0,"float")},getSpecularPowerScript:function(){return this.sSpecularPowerScript},getPackedSpecularPowerScript:function(){return""!=this.sSpecularPowerScript&&""==this.sPackedSpecularPowerScript&&(this.sPackedSpecularPowerScript=this._ProcessScript(this.sSpecularPowerScript,!0,"float")),this.sPackedSpecularPowerScript},setNormalScript:function(t){this.sNormalScript=t,this.sPackedNormalScript=this._ProcessScript(t,!0,"vec3")},getNormalScript:function(){return this.sNormalScript},getPackedNormalScript:function(){return""!=this.sNormalScript&&""==this.sPackedNormalScript&&(this.sPackedNormalScript=this._ProcessScript(this.sNormalScript,!0,"vec3")),this.sPackedNormalScript},setAlphaScript:function(t){this.sAlphaScript=t,this.sPackedAlphaScript=this._ProcessScript(t,!0,"float")},getAlphaScript:function(){return this.sAlphaScript},getPackedAlphaScript:function(){return""!=this.sAlphaScript&&""==this.sPackedAlphaScript&&(this.sPackedAlphaScript=this._ProcessScript(this.sAlphaScript,!0,"float")),this.sPackedAlphaScript},setDctLightScript:function(t){this.sDctLightScript=t,this.sPackedDctLightScript=this._ProcessScript(t,!1)},getDctLightScript:function(){return this.sDctLightScript},getPackedDctLightScript:function(){return""!=this.sDctLightScript&&""==this.sPackedDctLightScript&&(this.sPackedDctLightScript=this._ProcessScript(this.sDctLightScript,!1)),this.sPackedDctLightScript},setPointLightScript:function(t){this.sPointLightScript=t,this.sPackedPointLightScript=this._ProcessScript(t,!1)},getPointLightScript:function(){return this.sPointLightScript},getPackedPointLightScript:function(){return""!=this.sPointLightScript&&""==this.sPackedPointLightScript&&(this.sPackedPointLightScript=this._ProcessScript(this.sPointLightScript,!1)),this.sPackedPointLightScript},setSpotLightScript:function(t){this.sSpotLightScript=t,this.sPackedSpotLightScript=this._ProcessScript(t,!1)},getSpotLightScript:function(){return this.sSpotLightScript},getPackedSpotLightScript:function(){return""!=this.sSpotLightScript&&""==this.sPackedSpotLightScript&&(this.sPackedSpotLightScript=this._ProcessScript(this.sSpotLightScript,!1)),this.sPackedSpotLightScript},_setEntity:function(t){this.entity=t},_ProcessScript:function(t,e,i){for(var r="",n=t.length,a=!1,s=0;s<n;++s){var o=t.charAt(s);if("\n"!=o){if(!a)if(" "==o){if(r.length>0&&s<n-1){var h=r.charCodeAt(r.length-1),l=t.charCodeAt(s+1);(h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122)&&(l>=48&&l<=57||l>=65&&l<=90||l>=97&&l<=122)&&(r+=" ")}}else"/"==o?s==n-1?r+="/":"/"==t.charAt(s+1)?a=!0:r+="/":r+=o}else a=!1}if(""==r)return"";e&&(null==r.match(/\breturn\b/g)&&(r="return "+i+"("+r+");"));r=(r=r.replace(/(^|[^a-zA-Z0-9_\.])(\d+)(?![0-9]|\.)/g,"$1$2.0")).replace(/\[(\d+)\.(\d*)\]/g,"[$1]"),this.aTextureList[0]&&(r=34067==this.aTextureTypeList[0]?r.replace(/\(ALBEDO1,/g,"okFunc_FetchTexture(okUni_SamplerCube[0],"):r.replace(/\(ALBEDO1,/g,"okFunc_FetchTexture(okUni_Sampler2D[0],")),this.aTextureList[1]&&(r=34067==this.aTextureTypeList[1]?r.replace(/\(ALBEDO2,/g,"okFunc_FetchTexture(okUni_SamplerCube[1],"):r.replace(/\(ALBEDO2,/g,"okFunc_FetchTexture(okUni_Sampler2D[1],")),this.aTextureList[2]&&(r=34067==this.aTextureTypeList[2]?r.replace(/\(ALBEDO3,/g,"okFunc_FetchTexture(okUni_SamplerCube[2],"):r.replace(/\(ALBEDO3,/g,"okFunc_FetchTexture(okUni_Sampler2D[2],")),this.aTextureList[3]&&(r=34067==this.aTextureTypeList[3]?r.replace(/\(ALBEDO4,/g,"okFunc_FetchTexture(okUni_SamplerCube[3],"):r.replace(/\(ALBEDO4,/g,"okFunc_FetchTexture(okUni_Sampler2D[3],")),this.aTextureList[4]&&(r=r.replace(/\(NORMAL,/g,"okFunc_FetchTexture(okUni_Sampler2D[4],")),this.aTextureList[5]&&(r=r.replace(/\(OPACITY,/g,"okFunc_FetchTexture(okUni_Sampler2D[5],")),this.aTextureList[6]&&(r=r.replace(/\(SPECULARLEVEL,/g,"okFunc_FetchTexture(okUni_Sampler2D[6],")),r=(r=(r=(r=r.replace(/texture2Dtexture2D\(/g,"texture2D(")).replace(/textureCubetextureCube\(/g,"textureCube(")).replace(/texture2DtextureCube\(/g,"textureCube(")).replace(/textureCubetexture2D\(/g,"texture2D(");var m=V.array(),c=V.array(),u=V.array(),f=-1,d=-1;for(n=r.length,s=0;s<n;++s)switch(r.charAt(s)){case"[":m.push("["),u.push(f),c.push(d),f=0,d=m.length-1;break;case"]":if(-1==d)return"";if(f>=1?(m[d]="vec"+(f+1)+"(",m.push(")")):m.push("]"),!(c.length>0))return"";d=c.pop(),f=u.pop();break;case"(":m.push("("),u.push(f),c.push(d),f=0,d=m.length-1;break;case")":if(-1==d)return"";if(m.push(")"),!(c.length>0))return"";d=c.pop(),f=u.pop();break;case",":f+=1,m.push(",");break;default:m.push(r.charAt(s))}return r=m.join(""),V._array(m),V._array(u),V._array(c),r}},Dt.prototype={clear:function(){this.aBoneNameList=new Array,this.aBoneNameIdxMap=new Object,this.aBoneSkinMatList=new Array,this.bbox.set(new j(1e10,1e10,1e10),new j(-1e10,-1e10,-1e10)),this.sVertexBoneIdxAttribName="",this.sVertexBoneWeightAttribName=""},setBoundingBox:function(t,e){this.bbox.set(t,e)},getBoundingBox:function(){return this.bbox},addBone:function(t,e){this.aBoneNameIdxMap[t]=this.aBoneNameList.length,this.aBoneNameList.push(t),this.aBoneSkinMatList.push(e.clone())},getBoneNum:function(){return this.aBoneNameList.length},setRefAttributeName:function(t,e){this.sVertexBoneIdxAttribName=t,this.sVertexBoneWeightAttribName=e},getVertexBoneIdxAttribName:function(){return this.sVertexBoneIdxAttribName},getVertexBoneWeightAttribName:function(){return this.sVertexBoneWeightAttribName},getBoneNameArray:function(){return this.aBoneNameList},getSkinMat:function(t){return this.aBoneSkinMatList[this.aBoneNameIdxMap[t]]},getSkinMatArray:function(){return this.aBoneSkinMatList}},Nt.prototype={clear:function(){this.sName="",this.material=new zt(this.rc),this.bbox.set(S.VEC3_ZERO,S.VEC3_ZERO),this.iVertexCount=0,this.deleteAttribute(),this.deleteIndex(),this.animSkin.clear()},setVertexNum:function(t){this.iVertexCount=t},getVertexNum:function(){return this.iVertexCount},createAttribute:function(t,e,i,r){null==this.aAttribDataList[t]&&(this.iAttribCount+=1);var n=new Array(e);if(this.aAttribDataList[t]=n,i)for(var a=0;a<e;++a)n[a]=i[a];var s=new Et(this.rc);s.createBuffer(34962,5126,null!=r?r:35044,i?n:e),this.aAttribArrayBufferList[t]&&this.aAttribArrayBufferList[t].releaseBuffer(),this.aAttribArrayBufferList[t]=s},loadAttribute:function(t,e,i,r){var n=this.aAttribDataList[t];if(n){i<0&&(i=n.length-e);for(var a=e;a<e+i;++a)n[a]=r[a-e];this.aAttribArrayBufferList[t].updateBuffer(e,i,r)}},deleteAttribute:function(t){},createIndex:function(t,e,i,r,n){null==this.aIndexDataList[t]&&(this.iIndexCount+=1);var a=new Array(e);if(this.aIndexDataList[t]=a,i)for(var s=0;s<e;++s)a[s]=i[s];var o=new Et(this.rc);o.createBuffer(34963,5123,null!=r?r:35044,i?a:e),this.aIndexArrayBufferList[t]&&this.aIndexArrayBufferList[t].releaseBuffer(),this.aIndexArrayBufferList[t]=o,this.aIndexTopologyList[t]=null!=n?n:4},loadIndex:function(t,e,i,r){var n=this.aIndexDataList[t];if(n){i<0&&(i=n.length-e);for(var a=e;a<e+i;++a)n[a]=r[a-e];this.aIndexArrayBufferList[t].updateBuffer(e,i,r)}},setIndexTopology:function(t,e){this.aIndexTopologyList[t]&&(this.aIndexTopologyList[t]=e)},getIndexTopology:function(t){return this.aIndexTopologyList[t]},setName:function(t){this.sName=t},getName:function(){return this.sName},getAttributeNum:function(){return this.iAttribCount},getIndexNum:function(){return this.iIndexCount},getAttributeArray:function(t){return this.aAttribDataList[t]},getAttributeArrayBuffer:function(t){return this.aAttribArrayBufferList[t]},getIndexArray:function(t){return this.aIndexDataList[t]},getIndexArrayBuffer:function(t){return this.aIndexArrayBufferList[t]},getMaterial:function(){return this.material},computeBoundingInfo:function(){for(var t in this.bbox.set(S.VEC3_ZERO,S.VEC3_ZERO),this.aAttribDataList)if(0==t.indexOf("Position")){for(var e=new j(1e5,1e5,1e5),i=new j(-1e5,-1e5,-1e5),r=this.aAttribDataList[t],n=this.iVertexCount?r.length/this.iVertexCount:3,a=0;a<r.length;a+=n){var s=new j(r[a],r[a+1],r[a+2]);e=Y(e,s),i=Z(i,s)}return void this.bbox.set(e,i)}},setBoundingBox:function(t,e){null==e?t.clone(this.bbox):this.bbox.set(t,e)},getBoundingBox:function(){return this.bbox},getBoundingSphereCenter:function(){return X(H(this.bbox.vMin,this.bbox.vMax),.5)},getBoundingSphereRadius:function(){return.5*W(this.bbox.vMax,this.bbox.vMin).len()},getSkin:function(){return this.animSkin},draw:function(t,e,i,r){t=null!=t?t:"Default";this.aIndexArrayBufferList[t].drawIndex(null!=e?e:this.aIndexTopologyList[t],i,r)}},Vt.prototype={clear:function(){for(var t in this.aMeshMap)this.aMeshMap[t].clear();this.aMeshMap=new Object,this.iMeshCount=0,this.bbox=new bt(S.VEC3_ZERO,S.VEC3_ZERO)},createMesh:function(t){if(null==this.aMeshMap[t]){var e=new Nt(this.rc);e.sName=t,this.aMeshMap[t]=e,this.iMeshCount+=1}return this.aMeshMap[t]},deleteMesh:function(t){for(var e in this.aMeshMap)null!=t&&e!=t||(this.aMeshMap[e].clear(),delete this.aMeshMap[e])},getMesh:function(t){if(t)return this.aMeshMap[t];for(var e in this.aMeshMap)return this.aMeshMap[e];return null},getMeshMap:function(){return this.aMeshMap},getMeshNum:function(){return this.iMeshCount},computeBoundingInfo:function(){if(0!=this.iMeshCount){var t=new j(1e5,1e5,1e5),e=new j(-1e5,-1e5,-1e5);for(var i in this.aMeshMap){var r=this.aMeshMap[i];t=Y(t,r.getBoundingBox().vMin),e=Z(e,r.getBoundingBox().vMax)}this.bbox.set(t,e)}else this.bbox.set(S.VEC3_ZERO,S.VEC3_ZERO)},setBoundingBox:function(t,e){null==e?t.clone(this.bbox):this.bbox.set(t,e)},getBoundingBox:function(){return this.bbox},getBoundingSphereCenter:function(){return X(H(this.bbox.vMin,this.bbox.vMax),.5)},getBoundingSphereRadius:function(){return.5*W(this.bbox.vMax,this.bbox.vMin).len()}},Ft.prototype={clone:function(){var t=new Ft;t.sName=this.sName;for(var e=0;e<this.mMtList.length;++e)t.aKeyTransList.push(this.aKeyTransList[e].clone()),t.aKeyQuatList.push(this.aKeyQuatList[e].clone());t.parent=this.parent,t.mCurMat=new it,t.bCurMatDirty=!0},clear:function(){this.sName="",this.aKeyTransList.clear(),this.aKeyQuatList.clear(),this.parent=null,this.mCurMat.identity(),this.bCurMatDirty=!0},setName:function(t){this.sName=t},getName:function(){return this.sName},setParent:function(t){this.parent=t},getParent:function(){return this.parent},loadKeyTranslateList:function(t){this.aKeyTransList=new Array;for(var e=0;e<t.length;++e)this.aKeyTransList.push(t[e].clone())},loadKeyQuaternionList:function(t){this.aKeyQuatList=new Array;for(var e=0;e<t.length;++e)this.aKeyQuatList.push(t[e].normalize())},dirty:function(){this.bCurMatDirty=!0},update:function(t,e,i){if(this.bCurMatDirty){var r=$(this.aKeyTransList[t],this.aKeyTransList[e],i),n=_t(this.aKeyQuatList[t],this.aKeyQuatList[e],i),a=n.normalize();if(V._quat(n),(n=a).toMat43(this.mCurMat),this.mCurMat.m03=r.x,this.mCurMat.m13=r.y,this.mCurMat.m23=r.z,V._vec3(r),this.parent){this.parent.bCurMatDirty&&this.parent.update(t,e,i);a=mt(this.parent.mCurMat,this.mCurMat);V._mat43(this.mCurMat),this.mCurMat=a}this.bCurMatDirty=!1}},getMat43:function(){var t=new lt;return this.mCurMat.clone(t),t},getMat4:function(){var t=new it;return this.mCurMat.toMat4(t),t}},It.prototype={clear:function(){this.aKeyFrameList=new Array,this.bbox=new bt,this.aBoneList=new Object,this.iBoneNum=0,this.iFrameNum=0,this.iTick=33,this.iCurTime=-1,this.iLerpKeyStart=-1,this.iLerpKeyEnd=-1,this.fLerpT=0},setBoundingBox:function(t,e){this.bbox.set(t,e)},getBoundingBox:function(){return this.bbox},loadKeyFrameList:function(t){this.aKeyFrameList=new Array;for(var e=0;e<t.length;++e)this.aKeyFrameList.push(t[e])},addBone:function(t){null==this.aBoneList[t.getName()]&&(this.iBoneNum+=1),this.aBoneList[t.getName()]=t},getBone:function(t){return this.aBoneList[t]},getBoneMat43:function(t){return this.aBoneList[t].getMat43()},getBoneMat4:function(t){return this.aBoneList[t].getMat4()},getBoneNum:function(){return this.iBoneNum},getBoneList:function(){return this.aBoneList},setFrameNum:function(t){this.iFrameNum=t},getFrameNum:function(){return this.iFrameNum},setTickTime:function(t){this.iTick=t},getTickTime:function(){return this.iTick},getAnimLength:function(){return this.iFrameNum*this.iTick},setCurTime:function(t){if(this.iCurTime!=t){for(var e in this.iCurTime=t,this.aBoneList)this.aBoneList[e].dirty();this._updateBoneList(this.iCurTime/this.iTick)}},setCurFrame:function(t){if(this.iCurTime!=t*this.iTick){for(var e in this.iCurTime=t*this.iTick,this.aBoneList)this.aBoneList[e].dirty();this._updateBoneList(t)}},getCurTime:function(){return this.iCurTime},_lerpFrame:function(t){for(var e=0;e<this.aKeyFrameList.length;++e)if(this.aKeyFrameList[e]>t)return e>0?(this.iLerpKeyStart=e-1,this.iLerpKeyEnd=e):this.iLerpKeyStart=this.iLerpKeyEnd=0,void(this.fLerpT=(t-this.aKeyFrameList[e-1])/(this.aKeyFrameList[e]-this.aKeyFrameList[e-1]));this.iLerpKeyStart=this.iLerpKeyEnd=this.aKeyFrameList.length-1,this.fLerpT=0},_updateBoneList:function(t){for(var e in this._lerpFrame(t),this.aBoneList)this.aBoneList[e].update(this.iLerpKeyStart,this.iLerpKeyEnd,this.fLerpT)}},Ut.prototype={clone:function(t){return(t=t||new Ut).attachedAnim=this.attachedAnim,t.bLoop=this.bLoop,t.fSpeed=this.fSpeed,t.iCurTime=this.iCurTime,t},attachAnim:function(t){this.attachedAnim=t},getAnim:function(){return this.attachedAnim},isActive:function(){return null!=this.attachedAnim&&this.iCurTime<this.attachedAnim.getAnimLength()},setSpeed:function(t){this.fSpeed=t},getSpeed:function(){return this.fSpeed},enableLoop:function(t){this.bLoop=t},isLoop:function(){return this.bLoop},getTickTime:function(){return this.attachedAnim?this.attachedAnim.getTickTime():0},setCurTime:function(t){this.iCurTime=t,this.attachedAnim&&this.attachedAnim.setCurTime(t)},update:function(t){this.attachedAnim&&(this.iCurTime+=t*this.fSpeed,this.attachedAnim.setCurTime(this.bLoop?this.iCurTime%this.attachedAnim.getAnimLength():this.iCurTime))},getBoneMat43:function(t){return this.attachedAnim?this.attachedAnim.getBoneMat43(t):new it(1)}},Kt.prototype={clone:function(t){return(t=t||new Kt).bActive=this.bActive,this.mainChannel.clone(t.mainChannel),this.transChannel.clone(t.transChannel),t.iTransTime=this.iTransTime,t.iCurTransTime=this.iCurTransTime,t},activate:function(t){this.bActive=t},isActive:function(){return this.bActive},attachAnim:function(t,e){this.mainChannel.clone(this.transChannel),this.iTransTime=null!=e?e:0,this.iCurTransTime=0,this.mainChannel.attachAnim(t)},getAnim:function(){return this.mainChannel.getAnim()},setSpeed:function(t){this.mainChannel.setSpeed(t)},getSpeed:function(){return this.mainChannel.getSpeed()},enableLoop:function(t){this.mainChannel.enableLoop(t)},isLoop:function(){return this.mainChannel.isLoop()},getTickTime:function(){return this.mainChannel?this.mainChannel.getTickTime():0},setCurTime:function(t){this.mainChannel.setCurTime(t)},update:function(t){this.mainChannel.update(t),this.iCurTransTime<this.iTransTime&&this.transChannel.update(t),this.iCurTransTime=Math.min(this.iCurTransTime+t,this.iTransTime)},getBoneMat43:function(t){var e=this.mainChannel.getBoneMat43(t);if(this.iCurTransTime>=this.iTransTime||!this.transChannel.isActive())return e;var i=this.transChannel.getBoneMat43(t),r=new xt,n=new xt;e.toQuat(r),i.toQuat(n);var a=this.iCurTransTime/this.iTransTime,s=_t(n,r,a),o=$(i.getColumn(3),e.getColumn(3),a),h=new lt;return s.toMat43(h),h.setColumn(3,o),h}},Gt.prototype={clear:function(){this.skinInfo=null,this.aBoneMatList=new Array,this.bBoneMatDirty=!1,this.aBoneFinalMatList=new Array,this.bBoneFinalMatDirty=!1,this.aChannelList=new Array,this.aChannelList.push(new Kt),this.aChannelList.push(new Kt),this.iBlendMode=1,this.bbox.set(S.VEC3_ZERO,S.VEC3_ZERO),this.bBBoxDirty=!0},clone:function(t){return(t=t||new Gt).skinInfo=this.skinInfo,t.bBoneMatDirty=!0,t.bBoneFinalMatDirty=!0,t.aChannelList=[this.aChannelList[0].clone(),this.aChannelList[1].clone()],t.iBlendMode=this.iBlendMode,t.bBBoxDirty=this.bBBoxDirty,t},setSkin:function(t){this.skinInfo=t,this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0,this.update(-1,0),this.bBBoxDirty=!0},getSkin:function(){return this.skinInfo},getBoundingBox:function(){if(this.bBBoxDirty){this.bbox.set(new j(1e10,1e10,1e10),new j(-1e10,-1e10,-1e10)),this.aChannelList[0].isActive()&&this.aChannelList[0].getAnim()&&(this.bbox=this.bbox.union(this.aChannelList[0].getAnim().getBoundingBox())),this.aChannelList[1].isActive()&&this.aChannelList[1].getAnim()&&(this.bbox=this.bbox.union(this.aChannelList[1].getAnim().getBoundingBox()));var t=this.bbox.union(this.skinInfo.getBoundingBox()),e=Math.max(Math.abs(t.vMin.x),Math.max(Math.abs(t.vMin.y),Math.max(Math.abs(t.vMin.z),Math.max(Math.abs(t.vMax.x),Math.max(Math.abs(t.vMax.y),Math.max(Math.abs(t.vMax.z)))))));this.bbox.vMin.x-=e,this.bbox.vMin.y-=e,this.bbox.vMin.z-=e,this.bbox.vMax.x+=e,this.bbox.vMax.y+=e,this.bbox.vMax.z+=e,this.bBBoxDirty=!1}return this.bbox},activateChannel:function(t,e){this.aChannelList[t].activate(e),this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0,this.bBBoxDirty=!0},isActive:function(t){return this.aChannelList[t].isActive()},attachAnim:function(t,e,i){this.aChannelList[t].attachAnim(e,i),this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0,this.bBBoxDirty=!0},getAnim:function(t){return this.aChannelList[t].getAnim()},setSpeed:function(t,e){this.aChannelList[t].setSpeed(e)},getSpeed:function(t){return this.aChannelList[t].getSpeed()},enableLoop:function(t,e){this.aChannelList[t].enableLoop(e)},isLoop:function(t){return this.aChannelList[t].isLoop()},setBlendMode:function(t){this.iBlendMode=t,this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0},getBlendMode:function(){return this.iBlendMode},getTickTime:function(t){return this.aChannelList[t]?this.aChannelList[t].getTickTime():0},setTime:function(t,e){if(-1==t)for(var i=0;i<this.aChannelList.length;++i)this.aChannelList[i].isActive()&&this.aChannelList[i].setCurTime(e);else this.aChannelList[t].setCurTime(e);this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0},update:function(t,e){if(-1==t)for(var i=0;i<this.aChannelList.length;++i)this.aChannelList[i].isActive()&&this.aChannelList[i].update(e);else this.aChannelList[t].update(e);this.bBoneMatDirty=!0,this.bBoneFinalMatDirty=!0},getBoneMat43:function(t){var e=this.aChannelList[0].isActive(),i=this.aChannelList[1].isActive();if(e&&!i)return this.aChannelList[0].getBoneMat43(t);if(!e&&i)return this.aChannelList[1].getBoneMat43(t);if(!e&&!i)return new it;var r=new lt;if(1==this.iBlendMode){var n=this.aChannelList[0].getBoneMat43(t),a=this.aChannelList[1].getBoneMat43(t),s=H(n.getColumn(3),a.getColumn(3)),o=new xt,h=new xt;n.toQuat(o),a.toQuat(h),yt(h,o).toMat43(r),r.setColumn(3,s)}else if(2==this.iBlendMode){n=this.aChannelList[0].getBoneMat43(t),a=this.aChannelList[1].getBoneMat43(t),s=$(n.getColumn(3),a.getColumn(3),.5),o=new xt,h=new xt;n.toQuat(o),a.toQuat(h),_t(h,o,.5).toMat43(r),r.setColumn(3,s)}return r},getBoneMat43Array:function(){var t=this.skinInfo.getBoneNameArray();if(this.bBoneMatDirty){this.aBoneMatList.length=0;for(var e=0;e<t.length;++e)this.aBoneMatList.push(this.getBoneMat43(t[e]));this.bBoneMatDirty=!1}return this.aBoneMatList},getBoneFinalMat43:function(t){var e=this.aChannelList[0].isActive(),i=this.aChannelList[1].isActive();if(e&&!i)return mt(this.aChannelList[0].getBoneMat43(t),this.skinInfo?this.skinInfo.getSkinMat(t):new lt);if(!e&&i)return mt(this.aChannelList[1].getBoneMat43(t),this.skinInfo?this.skinInfo.getSkinMat(t):new lt);if(!e&&!i)return this.skinInfo?this.skinInfo.getSkinMat(t):new lt;var r=new lt;if(1==this.iBlendMode){var n=this.aChannelList[0].getBoneMat43(t),a=this.aChannelList[1].getBoneMat43(t),s=H(n.getColumn(3),a.getColumn(3)),o=new xt,h=new xt;n.toQuat(o),a.toQuat(h),yt(h,o).toMat43(r),r.setColumn(3,s)}else if(2==this.iBlendMode){n=this.aChannelList[0].getBoneMat43(t),a=this.aChannelList[1].getBoneMat43(t),s=$(n.getColumn(3),a.getColumn(3),.5),o=new xt,h=new xt;n.toQuat(o),a.toQuat(h),_t(h,o,.5).toMat43(r),r.setColumn(3,s)}return this.skinInfo?mt(r,this.skinInfo.getSkinMat(t)):r},getBoneFinalMat43Array:function(){var t=this.skinInfo.getBoneNameArray();if(this.bBoneFinalMatDirty){this.aBoneFinalMatList.length=0;for(var e=0;e<t.length;++e)this.aBoneFinalMatList.push(this.getBoneFinalMat43(t[e]));this.bBoneFinalMatDirty=!1}return this.aBoneFinalMatList}},jt.prototype={clone:function(){var t=new this.constructor;for(var e in this)t[e]!=this[e]&&(t[e]=this[e]);return t}},Ht.prototype={addTex:function(t,e,i){var r=this.ok2DLayoutHelper.add(e,i);if(null!=r){for(var n=new Array,a=0;a<t.length;++a)n.push(t[a]);this.texData.updateTexture(r.x,r.y,r.width,r.height,5121,n);var s=new jt(this,r.x,r.y,e,i);return this.charsList.pushFront(s),this.charsList.getRoot()}return null},updateCharNode:function(t){var e=t.data;return this.charsList.remove(t),this.charsList.pushFront(e),this.charsList.getRoot()},clearRoom:function(){var t=this.charsList.getTail();if(null!=t){var e=t.data,i=new Lt(e.x,e.y,e.width,e.height);if(this.ok2DLayoutHelper.remove(i))return this.charsList.popBack(),{opFlag:!0,codeRemoved:e.code}}return{opFlag:!1}}},Wt.prototype={setTextureWidth:function(t){this.texWidth=t},setTextureHeight:function(t){this.texHeight=t},setTextureMaxNumber:function(t){this.maxTexNumber=t},setAutoWrap:function(t){this.bAutoWrap=t},getFontName:function(){return this.fontStyle+" "+this.fontWeight+" "+this.fontSize+" "+this.fontVariant+" "+this.fontFamily},isTexFull:function(){return this.texArray.length>=this.maxTexNumber},increaseFontTex:function(){if(this.isTexFull())return!1;var t=new Ht(this.rc,this.texWidth,this.texHeight);return this.texArray.push(t),!0},getFirstBlankTex:function(){return this.texArray.length<=0&&!this.increaseFontTex()?null:this.texArray[this.texArray.length-1]},getFirstReplacableTex:function(){return this.texArray.length<=0?null:null!=this.texDynamicList.getRoot()?this.texDynamicList.getRoot().data:this.texArray[0]},addIndividualCode:function(t,e){if(C(this.codePages[t.toString()])){var i=Xt.get2DContext();Xt.clear2DContext();var r=i.font;i.font=this.getFontName(),i.fillText(t,0,0);var n=i.measureText(t).width;n<=0&&(n=1);var a=i.getImageData(0,0,n,this.fontSize);i.font=r;var s=this.getFirstBlankTex();if(null==s)return!1;var o=s.addTex(a.data,a.width,a.height);if(null==o)if(this.increaseFontTex())o=(s=this.getFirstBlankTex()).addTex(a.data,a.width,a.height);else{var h=!0;if(null==e||C(e)||(h=e),h&&(s=this.getFirstReplacableTex()))do{var l=s.clearRoom();if(!l.opFlag)break;delete this.codePages[l.codeRemoved],o=s.addTex(a.data,a.width,a.height)}while(null==o)}if(null==o)return!1;o.data.code=t.toString(),this.codePages[t.toString()]=o}return!0},getTexture:function(t){var e=this.getCharTextureInfo(t);return null!=e?e.tex:null},updateTexTimeStamp:function(t){var e=this.texDynamicList.find(t);this.texDynamicList.remove(e),this.texDynamicList.pushFront(t)},getCharTextureInfo:function(t,e){var i=this.codePages[t.toString()];if(C(i)){if(!this.addIndividualCode(t,e))return null;i=this.codePages[t.toString()]}var r=i.data,n=r.tex;return this.updateTexTimeStamp(n),this.codePages[t.toString()]=n.updateCharNode(i),r.clone()},initProgram:function(){var t=new Bt(this.rc,35633);t.loadSource("                       attribute vec3 position;                       attribute vec2 vertex_coord;                       uniform mat4 matWorld, matProj;                       varying vec2 pixel_coord;                       void main(void) {                            gl_Position = matProj * matWorld * vec4(position, 1.0);                            pixel_coord = vertex_coord;                       }                       "),t.compile();var e=new Bt(this.rc,35632);e.loadSource("                        precision highp float;                        varying vec2 pixel_coord;                        uniform sampler2D tex;                        uniform mat4 matColor;                        void main(void) {                        gl_FragColor = texture2D(tex, pixel_coord) * matColor;                         }                      "),e.compile(),this.program=new wt(this.rc),this.program.attachVertexShader(t),this.program.attachFragmentShader(e),this.program.link()},drawText:function(t,e,i,r,n){var a,s,o=this.rc.canvas.clientWidth,h=this.rc.canvas.clientHeight;if(null!=n&&(o=n.iSizeU,h=n.iSizeV,(a=new Pt(this.rc)).createBuffer(),a.bind(),a.attachRenderTexture(0,n)),null==t)s=new Lt(0,0,o,h);else{if(t.width<=0||t.height<=0)return;s=new Lt(t.x,t.y,t.x+t.width,t.y+t.height)}this.program.bind();var l=st(0,0,-3);this.program.setUniformMat4("matWorld",l);var m=ht(0,o,0,h,.1,10);this.program.setUniformMat4("matProj",m);var c=new it(1);null!=i&&(c.m00=i.x,c.m11=i.y,c.m22=i.z),null!=r&&(c.m33=r),this.program.setUniformMat4("matColor",c);for(var u,f,d,v,g=new G(s.x,s.y),p=new G(0,0),x=new G(0,0),y=new G(0,0),_=new Array,M=0,T=null,b=0;b<e.length;++b)if("\n"!=e[b]){if(null==(T=this.getCharTextureInfo(e[b],!1))){for(var A=0;A<_.length;++A)(d=new Et(this.rc)).createBuffer(34962,5126,35044,_[A].vertexArray),(v=new Et(this.rc)).createBuffer(34962,5126,35044,_[A].coordArray),this.program.setAttribute("position",d,3),this.program.setAttribute("vertex_coord",v,2),this.program.setSampler("tex",0),_[A].okTex.bind(0),this.rc.texParameteri(3553,10240,9729),this.rc.texParameteri(3553,10241,9729),this.rc.drawArrays(4,0,_[A].vertexArray.length/3);_.splice(0,_.length),this.addIndividualCode(e[b]),--b;continue}if(p.x=g.x+T.width-1,p.y=g.y+T.height-1,p.x>=s.width){if(this.bAutoWrap){var L=s.x;if(g.x-L>1e-6){if(g.x=s.x,g.y+=M,M=0,g.y>=s.height)break;--b;continue}}p.x=s.width-1}p.y>=s.height&&(p.y=s.height-1),u=[p.x,g.y,0,g.x,g.y,0,p.x,p.y,0,g.x,g.y,0,g.x,p.y,0,p.x,p.y,0],x.x=T.x/T.tex.width,x.y=T.y/T.tex.height,y.x=(T.x+p.x-g.x)/T.tex.width,y.y=(T.y+p.y-g.y)/T.tex.height,f=[y.x,x.y,x.x,x.y,y.x,y.y,x.x,x.y,x.x,y.y,y.x,y.y];for(var S=0;S<_.length&&_[S].fontTex!==T.tex;++S);if(S==_.length){var C=new Object;C.okTex=T.tex.texData,C.fontTex=T.tex,C.vertexArray=new Array,C.coordArray=new Array,_.push(C)}for(var E=0;E<u.length;++E)_[S].vertexArray.push(u[E]);for(E=0;E<f.length;++E)_[S].coordArray.push(f[E]);if(M<T.height&&(M=T.height),p.x>=s.width)if(this.bAutoWrap){if(g.x=s.x,g.y+=M,M=0,g.y>=s.height)break}else for(b+=1;b<e.length&&"\n"!=e[b];++b);else g.x+=T.width}else if(g.x=s.x,g.y+=M,M=0,g.y>=s.height)break;if(_.length>0)for(A=0;A<_.length;++A)(d=new Et(this.rc)).createBuffer(34962,5126,35044,_[A].vertexArray),(v=new Et(this.rc)).createBuffer(34962,5126,35044,_[A].coordArray),this.program.setAttribute("position",d,3),this.program.setAttribute("vertex_coord",v,2),this.program.setSampler("tex",0),_[A].okTex.bind(0),this.rc.texParameteri(3553,10240,9729),this.rc.texParameteri(3553,10241,9729),this.rc.drawArrays(4,0,_[A].vertexArray.length/3);null!=n&&a.unbind()}};var Xt=function(){var t={},e=null,i=null;return{addFont:function(e,i,r,n,a,s){var o=new Wt;o.fontFamily=i,o.fontSize=r,o.fontWeight=n,o.fontVariant=a,o.fontStyle=s,o.rc=e;var h=e.canvas.getAttribute("ID")+o.getFontName();return void 0!=t[h]?t[h]:(o.rc=e,o.initProgram(),t[h]=o,o)},get2DContext:function(){return null==i&&((e=document.createElement("canvas")).width=512,e.height=512,(i=e.getContext("2d")).fillStyle="#ffffff",i.strokeStyle="#ffffff",i.textBaseline="top"),i},clear2DContext:function(){i.clearRect(0,0,e.width,e.height)}}}();function Yt(){this.rc=null,this.camera=null,this.scene=null,this.canvas=null,this.iCanvasWidth=0,this.iCanvasHeight=0,this.vSkyColor=new j(1,1,1),this.vGroundColor=new j(.3,.3,.3),this.bFogEnable=!1,this.vFogColor=new j(1,1,1),this.fFogDensity=3.5,this.fFogDistNear=.1,this.fFogDistFar=1,this.bShadow=!0,this.aStageEnableList=[!0,!0,!0],this.iStartTime=0,this.iCurTime=0,this.fRandom=0}function Zt(t){this.iType=0,this.iId=-1,this.zone=t,this.resourceManager=t.scene.resourceManager,this.sName="",this.mMat=V.mat43(),this.mMatN=V.mat43(),this.mMatInv=V.mat43(),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bbox=new bt,this.bBBoxDirty=!0,this.aResRefMap=V.object()}function qt(t){D(this,t),this.iType=483,this.bVisible=!0,this.fVisibleDistance=-1,this.bCastShadow=!1,this.bReceiveShadow=!0,this.fShadowFadeFactor=1e-4,this.fShadowResolution=1,this.bSkybox=!1}function Qt(t){D(this,t),this.iType=28,this.bVisible=!0,this.vColor=new j(1,1,1),this.bCastShadow=!1,this.vShadowColor=new j(.5,.5,.5),this.iShadowIdx=3,this.fShadowFadeFactor=.006}function $t(t){D(this,t),this.iType=512,this.vSkyColor=new j(.3,.3,.3),this.vGroundColor=new j(.3,.3,.3),this.bShadow=!0,this.bFogEnable=!1,this.vFogColor=new j(1,1,1),this.fFogDensity=3.5,this.fFogDistNear=.1,this.fFogDistFar=1}function Jt(t){D(this,t),this.iType=1,this.iModelId=-1,this.aMtrlMap=new Object}function te(t){D(this,t),this.iType=2,this.iModelId=-1,this.aMtrlMap=new Object,this.defaultPlayer=new Gt,this.aPlayerMap=new Object,this.bboxL=new bt,this.bLocalBoundingBoxDirty=!0}function ee(){this.lf=0,this.tlf=0,this.m=new lt,this.v=new j,this.ac=new j,this.s=new G(.1,.1),this.s0=new G(.1,.1),this.s1=new G(.1,.1),this.c=new j(1,1,1),this.c0=new j,this.c1=new j,this.a=0,this.fdi=0,this.fdo=0}function ie(t){D(this,t),this.iType=256,this.mesh=new Nt(this.resourceManager.rc),this.sTexName="";var e=this.mesh.getMaterial();e.entity=this,e.setEmissive(0,0,0),e.setDiffuse(1,1,1),e.enableBlend(!0),e.enableDynamicLighting(!1),e.enableTwoSide(!0),e.enableDepthWrite(!1),e.setDiffuseScript("VC"),e.setAlphaScript("TC2.x * ALPHA"),this.aParticles=new w,this.iMaxCount=0,this.aLife=[3e3,3e3],this.fEmitCycle=50,this.iEmitFlow=1,this.fEmitLastTime=50,this.aEmitDirRange=[0,30],this.aEmitPosRange=[new j(0,0,0),new j(0,0,0)],this.aEmitV=[1,1],this.aA=[new j(0,0,0),new j(0,0,0)],this.aSize0=[new G(.5,.5),new G(.5,.5)],this.aSize1=[new G(.5,.5),new G(.5,.5)],this.bVarySize=!1,this.aColor0=[new j(1,1,1),new j(1,1,1)],this.aColor1=[new j(1,1,1),new j(1,1,1)],this.bVaryColor=!1,this.aFadeIn=[1e3,1e3],this.aFadeOut=[1e3,1e3],this.iAnimWidth=1,this.iAnimHeight=1,this.iAnimCount=1,this.aAttribFmt=V.object(),this.aAttribFmt.Position=new ye,this.aAttribFmt.Color=new ye,this.aAttribFmt.Texcoord1=new ye,this.aAttribFmt.Texcoord2=new ye,this.aAttribFmt.Position=new ye,this.aAttribFmt.Position.sName="Position",this.aAttribFmt.Position.iIdx=0,this.aAttribFmt.Position.iOffset=0,this.aAttribFmt.Position.iSize=3,this.aAttribFmt.Position.iStride=3,this.aAttribFmt.Color=new ye,this.aAttribFmt.Color.sName="Color",this.aAttribFmt.Color.iIdx=0,this.aAttribFmt.Color.iOffset=0,this.aAttribFmt.Color.iSize=3,this.aAttribFmt.Color.iStride=7,this.aAttribFmt.Texcoord1=new ye,this.aAttribFmt.Texcoord1.sName="Texcoord1",this.aAttribFmt.Texcoord1.iIdx=1,this.aAttribFmt.Texcoord1.iOffset=3,this.aAttribFmt.Texcoord1.iSize=2,this.aAttribFmt.Texcoord1.iStride=7,this.aAttribFmt.Texcoord2=new ye,this.aAttribFmt.Texcoord2.sName="Texcoord2",this.aAttribFmt.Texcoord2.iIdx=2,this.aAttribFmt.Texcoord2.iOffset=5,this.aAttribFmt.Texcoord2.iSize=2,this.aAttribFmt.Texcoord2.iStride=7,this.bActive=!0}function re(t){D(this,t),this.iType=4}function ne(t){D(this,t),this.iType=8,this.fRange=10}function ae(t){D(this,t),this.iType=16,this.mMat.identity(),this.mMat.setColumn(0,1,0,0),this.mMat.setColumn(1,0,0,-1),this.mMat.setColumn(2,0,1,0),this.fRange=10,this.fInnerCone=60*Math.PI/180,this.fOuterCone=75*Math.PI/180,this.frustum=new At,this.bFrustumDirty=!0}function se(){this.parent=null,this.iParentIdx=-1,this.aChildrenList=[null,null,null,null,null,null,null,null],this.iChildCount=0,this.bbox=V.aabbox(),this.aChildrenBBox=[V.aabbox(),V.aabbox(),V.aabbox(),V.aabbox(),V.aabbox(),V.aabbox(),V.aabbox(),V.aabbox()],this.aEntityList=new w,this.iLevel=0}function oe(t){this.sName="",this.scene=t,this.iMaxLevel=4,this.iGranularity=1,this.rootNode=V.sceneNode(),this.aEntityList=new B,this.aLightList=new w,this.aForceVisibleEntityMap=new Object,this.aDirtyEntityMap=new Object,this.aUpdateEntityList=new w,this.iCurVisitFlag=0}function he(t,e){this.resourceManager=e,this.sName=t,this.aZoneList=new Object;var i=new oe(this);i.setName("Default"),this.aZoneList.Default=i,this.sBasePath="",this.sModelPath="",this.sAnimationPath="",this.sTerrainPath="",this.sTexturePath="",this.aCameraList=new w}function le(t,e){this.resourceManager=e,this.aSceneList=new Object}function me(){this.iType=0,this.data=null,this.sKey=null,this.iRef=0,this.iState=1,this.bCustom=!1,this.aListenerList=new w}function ce(t,e){this.rc=e,this.aResList=new B,this.aKeyIdMap=new Object,this.bAsyncLoad=t.bAsyncLoad}function ue(t){this.rc=t,this.sShaderSourcePath="",this.sFloatPrecision="mediump",this.aVertexShaderMap=new Object,this.aFragmentShaderMap=new Object,this.aProgramMap=new Object,this.aVertexSourceMap=new Object,this.aFragmentSourceMap=new Object,this.aVertexSourceMap.Common="",this.aFragmentSourceMap.Common="",this.aVertexSourceMap.Depth="#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\nattribute vec3 okAttr_Pos;\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nattribute vec3 okAttr_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nattribute vec3 okAttr_Color;\n#endif\n#ifdef OK_TC12\nattribute vec4 okAttr_TC12;\n#else\n#ifdef OK_TC1\nattribute vec2 okAttr_TC1;\n#endif\n#ifdef OK_TC2\nattribute vec2 okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nattribute vec4 okAttr_TC34;\n#else\n#ifdef OK_TC3\nattribute vec2 okAttr_TC3;\n#endif\n#ifdef OK_TC4\nattribute vec2 okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nattribute vec3 okAttr_Tangent;\n#endif\n#ifdef OK_BINORMAL\nattribute vec3 okAttr_Binormal;\n#endif\n#endif\n#ifdef OK_SKANIMATION\nattribute vec4 okAttr_BoneIdx;attribute vec4 okAttr_BoneWeight;uniform vec4 okUni_BoneMat[32*3];\n#endif\nuniform mat4 okUni_TransMat[4];void main(void){\n#ifdef OK_SKANIMATION\nmat4 a=mat4(0.0);{int c=int(okAttr_BoneIdx[0])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[0]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[1])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[1]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[2])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[2]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[3])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[3]*mat4(d,e,f,g);}\n#endif\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nokVary_Normal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Normal,0.0)).xyz;\n#endif\n#ifdef OK_VERTEX_COLOR\nokVary_Color=okAttr_Color;\n#endif\n#ifdef OK_TC12\nokVary_TC12=okAttr_TC12;\n#else\n#ifdef OK_TC1\nokVary_TC1=okAttr_TC1;\n#endif\n#ifdef OK_TC2\nokVary_TC2=okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nokVary_TC34=okAttr_TC34;\n#else\n#ifdef OK_TC3\nokVary_TC3=okAttr_TC3;\n#endif\n#ifdef OK_TC4\nokVary_TC4=okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nokVary_Tangent=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Tangent,0.0)).xyz;\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Binormal,0.0)).xyz;;\n#endif\n#endif\nvec4 b=\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[0]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Pos,1.0);\n#ifdef OK_ALPHA_TEST\nokVary_Pos=b.xyz/b.w;\n#endif\ngl_Position=okUni_TransMat[2]*b;}",this.aFragmentSourceMap.Depth="#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\n#ifdef OK_ALPHA_TEST\nuniform vec4 okUni_General[8];uniform sampler2D okUni_Sampler2D[7];uniform samplerCube okUni_SamplerCube[4];vec3 okGlb_P;vec3 okGlb_N;vec3 okGlb_V;vec3 okGlb_R;\n#define P okGlb_P\n#define CP okUni_General[7].xyz\n#define N okGlb_N\n#define V okGlb_V\n#define R okGlb_R\n#define T okUni_General[4].w\n#define RAND okUni_General[5].w\n#define EMI okUni_General[0].xyz\n#define AMB okUni_General[1].xyz\n#define DIF okUni_General[2].xyz\n#define SPE okUni_General[3].xyz\n#define GLO okUni_General[0].w\n#define ALPHA okUni_General[2].w\n#define GROUND okUni_General[4].xyz\n#define SKY okUni_General[5].xyz\n#ifdef OK_VERTEX_COLOR\n#define VC okVary_Color\n#else\n#define VC vec3(0.0)\n#endif\n#ifdef OK_TC12\n#define TC1 okVary_TC12.xy\n#define TC2 okVary_TC12.zw\n#else\n#ifdef OK_TC1\n#define TC1 okVary_TC1\n#endif\n#ifdef OK_TC2\n#define TC2 okVary_TC2\n#endif\n#endif\n#ifdef OK_TC34\n#define TC3 okVary_TC34.xy\n#define TC4 okVary_TC34.zw\n#else\n#ifdef OK_TC3\n#define TC3 okVary_TC3\n#endif\n#ifdef OK_TC4\n#define TC4 okVary_TC4\n#endif\n#endif\nvec2 okRotTC(vec2 d,float e){float a=cos(e);float b=sin(e);mat2 c=mat2(a,b,-b,a);return(c*(d-0.5))+0.5;}float okFunc_GetMaterialAlpha(){\n#ifdef OK_SCRIPT_ALPHA_CODE\nOK_SCRIPT_ALPHA_CODE\n#else\n#ifdef OK_TEX_OPACITY\nreturn texture2D(okUni_Sampler2D[5],OK_OPACITY_TC).a;\n#else\nreturn okUni_General[2].a;\n#endif\n#endif\n}\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 okFunc_GetNormalScript(){OK_SCRIPT_NORMAL_CODE}\n#endif\nvec3 okFunc_GetMaterialNormal(){\n#ifdef OK_NORMAL\nvec3 vertexNormal=okVary_Normal;\n#else\nvec3 vertexNormal=vec3(0.0,1.0,0.0);\n#endif\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 normalT=okFunc_GetNormalScript();mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\n#ifdef OK_TEX_NORMALMAP\nvec3 normalT=texture2D(okUni_Sampler2D[4],OK_NORMALMAP_TC).xyz;normalT=normalT*2.0-1.0;mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\nreturn normalize(vertexNormal);\n#endif\n#endif\n}\n#endif\nvec4 encodeFloat(float f){vec4 bitSh=vec4(256*256*256,256*256,256,1);vec4 bitMsk=vec4(0,1.0/256.0,1.0/256.0,1.0/256.0);vec4 comp=fract(f*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main(void){\n#ifdef OK_ALPHA_TEST\nP=okVary_Pos;vec3 normal=okFunc_GetMaterialNormal();N=normal;vec3 camVec=normalize(okUni_General[7].xyz-okVary_Pos);V=-camVec;vec3 reflectVec=normalize(reflect(-camVec,normal));R=reflectVec;if(okFunc_GetMaterialAlpha()<=okUni_General[3].w)discard;\n#endif\ngl_FragColor=encodeFloat(gl_FragCoord.z);}",this.aVertexSourceMap.DepthDefault="attribute vec3 okAttr_Pos;uniform mat4 okUni_TransMat[3];void main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}",this.aFragmentSourceMap.DepthDefault="vec4 e(float d){vec4 a=vec4(256*256*256,256*256,256,1);vec4 b=vec4(0,1.0/256.0,1.0/256.0,1.0/256.0);vec4 c=fract(d*a);c-=c.xxyz*b;return c;}void main(void){gl_FragColor=e(gl_FragCoord.z);}",this.aVertexSourceMap.FlatColor="#if TEX\nvarying vec2 fragmentTexCoord;\n#endif\nattribute vec3 position;\n#if TEX\nattribute vec2 texcoord;\n#endif\nuniform mat4 matWorld;uniform mat4 matViewProj;void main(void){\n#if TEX\nfragmentTexCoord=texcoord;\n#endif\ngl_Position=matViewProj*matWorld*vec4(position,1.0);}",this.aFragmentSourceMap.FlatColor="#if TEX\nvarying vec2 fragmentTexCoord;\n#endif\nuniform vec3 color;\n#if TEX\nuniform sampler2D texSampler;\n#endif\nvoid main(void){\n#if TEX\nvec3 a=color*texture2D(texSampler,fragmentTexCoord).xyz;\n#else\nvec3 a=color;\n#endif\ngl_FragColor=vec4(a,1.0);}",this.aVertexSourceMap.GaussianFilter="varying vec2 okVary_ScrTC;attribute vec3 okAttr_Pos;void main(void){gl_Position=vec4(okAttr_Pos,1.0);okVary_ScrTC=(gl_Position.xy+1.0)*0.5;}",this.aFragmentSourceMap.GaussianFilter="varying vec2 okVary_ScrTC;uniform vec4 okUni_ScreenPosOffsetAndScale;uniform vec2 okUni_TexelSize;uniform sampler2D okUni_Tex;void main(void){vec2 a=okUni_ScreenPosOffsetAndScale.xy+okVary_ScrTC*okUni_ScreenPosOffsetAndScale.zw;vec2 b[12];b[0]=vec2(-0.326212,-0.405805);b[1]=vec2(-0.840144,-0.073580);b[2]=vec2(-0.695914,0.457137);b[3]=vec2(-0.203345,0.620716);b[4]=vec2(0.962340,-0.194983);b[5]=vec2(0.473434,-0.480026);b[6]=vec2(0.519456,0.767022);b[7]=vec2(0.185461,-0.893124);b[8]=vec2(0.507431,0.064425);b[9]=vec2(0.896420,0.412458);b[10]=vec2(-0.321940,-0.932615);b[11]=vec2(-0.791559,-0.597705);vec4 c=texture2D(okUni_Tex,a);for(int i=0;i<12;i++){c+=texture2D(okUni_Tex,a+okUni_TexelSize*8.0*b[i]);}gl_FragColor=c/12.0;}",this.aVertexSourceMap.Glow="#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\nattribute vec3 okAttr_Pos;\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nattribute vec3 okAttr_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nattribute vec3 okAttr_Color;\n#endif\n#ifdef OK_TC12\nattribute vec4 okAttr_TC12;\n#else\n#ifdef OK_TC1\nattribute vec2 okAttr_TC1;\n#endif\n#ifdef OK_TC2\nattribute vec2 okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nattribute vec4 okAttr_TC34;\n#else\n#ifdef OK_TC3\nattribute vec2 okAttr_TC3;\n#endif\n#ifdef OK_TC4\nattribute vec2 okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nattribute vec3 okAttr_Tangent;\n#endif\n#ifdef OK_BINORMAL\nattribute vec3 okAttr_Binormal;\n#endif\n#endif\n#ifdef OK_SKANIMATION\nattribute vec4 okAttr_BoneIdx;attribute vec4 okAttr_BoneWeight;uniform vec4 okUni_BoneMat[32*3];\n#endif\nuniform mat4 okUni_TransMat[4];void main(void){\n#ifdef OK_SKANIMATION\nmat4 a=mat4(0.0);{int c=int(okAttr_BoneIdx[0])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[0]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[1])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[1]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[2])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[2]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[3])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[3]*mat4(d,e,f,g);}\n#endif\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nokVary_Normal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Normal,0.0)).xyz;\n#endif\n#ifdef OK_VERTEX_COLOR\nokVary_Color=okAttr_Color;\n#endif\n#ifdef OK_TC12\nokVary_TC12=okAttr_TC12;\n#else\n#ifdef OK_TC1\nokVary_TC1=okAttr_TC1;\n#endif\n#ifdef OK_TC2\nokVary_TC2=okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nokVary_TC34=okAttr_TC34;\n#else\n#ifdef OK_TC3\nokVary_TC3=okAttr_TC3;\n#endif\n#ifdef OK_TC4\nokVary_TC4=okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nokVary_Tangent=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Tangent,0.0)).xyz;\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Binormal,0.0)).xyz;;\n#endif\n#endif\nvec4 b=\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[0]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Pos,1.0);\n#ifdef OK_ALPHA_TEST\nokVary_Pos=b.xyz/b.w;\n#endif\ngl_Position=okUni_TransMat[2]*b;}",this.aFragmentSourceMap.Glow="#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\nuniform vec4 okUni_General[43];\n#ifdef OK_ALPHA_TEST\nuniform sampler2D okUni_Sampler2D[7];uniform samplerCube okUni_SamplerCube[4];vec3 okGlb_P;vec3 okGlb_N;vec3 okGlb_V;vec3 okGlb_R;\n#define P okGlb_P\n#define CP okUni_General[7].xyz\n#define N okGlb_N\n#define V okGlb_V\n#define R okGlb_R\n#define T okUni_General[4].w\n#define RAND okUni_General[5].w\n#define EMI okUni_General[0].xyz\n#define AMB okUni_General[1].xyz\n#define DIF okUni_General[2].xyz\n#define SPE okUni_General[3].xyz\n#define GLO okUni_General[0].w\n#define ALPHA okUni_General[2].w\n#define GROUND okUni_General[4].xyz\n#define SKY okUni_General[5].xyz\n#ifdef OK_VERTEX_COLOR\n#define VC okVary_Color\n#else\n#define VC vec3(0.0)\n#endif\n#ifdef OK_TC12\n#define TC1 okVary_TC12.xy\n#define TC2 okVary_TC12.zw\n#else\n#ifdef OK_TC1\n#define TC1 okVary_TC1\n#endif\n#ifdef OK_TC2\n#define TC2 okVary_TC2\n#endif\n#endif\n#ifdef OK_TC34\n#define TC3 okVary_TC34.xy\n#define TC4 okVary_TC34.zw\n#else\n#ifdef OK_TC3\n#define TC3 okVary_TC3\n#endif\n#ifdef OK_TC4\n#define TC4 okVary_TC4\n#endif\n#endif\nvec2 okRotTC(vec2 d,float e){float a=cos(e);float b=sin(e);mat2 c=mat2(a,b,-b,a);return(c*(d-0.5))+0.5;}float okFunc_GetMaterialAlpha(){\n#ifdef OK_SCRIPT_ALPHA_CODE\nOK_SCRIPT_ALPHA_CODE\n#else\n#ifdef OK_TEX_OPACITY\nreturn texture2D(okUni_Sampler2D[5],OK_OPACITY_TC).a;\n#else\nreturn okUni_General[2].a;\n#endif\n#endif\n}\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 okFunc_GetNormalScript(){OK_SCRIPT_NORMAL_CODE}\n#endif\nvec3 okFunc_GetMaterialNormal(){\n#ifdef OK_NORMAL\nvec3 vertexNormal=okVary_Normal;\n#else\nvec3 vertexNormal=vec3(0.0,1.0,0.0);\n#endif\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 normalT=okFunc_GetNormalScript();mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\n#ifdef OK_TEX_NORMALMAP\nvec3 normalT=texture2D(okUni_Sampler2D[4],OK_NORMALMAP_TC).xyz;normalT=normalT*2.0-1.0;mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\nreturn normalize(vertexNormal);\n#endif\n#endif\n}\n#endif\nvoid main(void){\n#ifdef OK_ALPHA_TEST\nP=okVary_Pos;vec3 normal=okFunc_GetMaterialNormal();N=normal;vec3 camVec=normalize(okUni_General[7].xyz-okVary_Pos);V=-camVec;vec3 reflectVec=normalize(reflect(-camVec,normal));R=reflectVec;if(okFunc_GetMaterialAlpha()<=okUni_General[3].w)discard;\n#endif\ngl_FragColor=vec4(okUni_General[42].xyz,1.0);}",this.aVertexSourceMap.GlowDefault="attribute vec3 okAttr_Pos;uniform mat4 okUni_TransMat[3];void main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}",this.aFragmentSourceMap.GlowDefault="void main(void){gl_FragColor=vec4(0.0,0.0,0.0,0.0);}",this.aVertexSourceMap.Lighting="varying vec3 okVary_Pos;varying vec4 okVary_ScrPos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\nattribute vec3 okAttr_Pos;\n#ifdef OK_NORMAL\nattribute vec3 okAttr_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nattribute vec3 okAttr_Color;\n#endif\n#ifdef OK_TC12\nattribute vec4 okAttr_TC12;\n#else\n#ifdef OK_TC1\nattribute vec2 okAttr_TC1;\n#endif\n#ifdef OK_TC2\nattribute vec2 okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nattribute vec4 okAttr_TC34;\n#else\n#ifdef OK_TC3\nattribute vec2 okAttr_TC3;\n#endif\n#ifdef OK_TC4\nattribute vec2 okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nattribute vec3 okAttr_Tangent;\n#endif\n#ifdef OK_BINORMAL\nattribute vec3 okAttr_Binormal;\n#endif\n#ifdef OK_SKANIMATION\nattribute vec4 okAttr_BoneIdx;attribute vec4 okAttr_BoneWeight;uniform vec4 okUni_BoneMat[32*3];\n#endif\nuniform mat4 okUni_TransMat[4];void main(void){\n#ifdef OK_SKANIMATION\nmat4 a=mat4(0.0);{int c=int(okAttr_BoneIdx[0])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[0]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[1])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[1]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[2])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[2]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[3])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[3]*mat4(d,e,f,g);}\n#endif\n#ifdef OK_NORMAL\nokVary_Normal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Normal,0.0)).xyz;\n#endif\n#ifdef OK_VERTEX_COLOR\nokVary_Color=okAttr_Color;\n#endif\n#ifdef OK_TC12\nokVary_TC12=okAttr_TC12;\n#else\n#ifdef OK_TC1\nokVary_TC1=okAttr_TC1;\n#endif\n#ifdef OK_TC2\nokVary_TC2=okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nokVary_TC34=okAttr_TC34;\n#else\n#ifdef OK_TC3\nokVary_TC3=okAttr_TC3;\n#endif\n#ifdef OK_TC4\nokVary_TC4=okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nokVary_Tangent=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Tangent,0.0)).xyz;\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Binormal,0.0)).xyz;\n#endif\nvec4 b=\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[0]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Pos,1.0);okVary_Pos=b.xyz/b.w;gl_Position=okUni_TransMat[2]*b;okVary_ScrPos=gl_Position;}",this.aFragmentSourceMap.Lighting="varying vec3 okVary_Pos;varying vec4 okVary_ScrPos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\nuniform vec4 okUni_General[43];\n#ifdef OK_DYNAMICSHADOW\nuniform sampler2D okUni_shadowSampler;\n#endif\nuniform sampler2D okUni_Sampler2D[7];uniform samplerCube okUni_SamplerCube[4];vec3 okGlb_P;vec3 okGlb_N;vec3 okGlb_V;vec3 okGlb_R;\n#define P okGlb_P\n#define CP okUni_General[7].xyz\n#define N okGlb_N\n#define V okGlb_V\n#define R okGlb_R\n#define T okUni_General[4].w\n#define RAND okUni_General[5].w\n#define EMI okUni_General[0].xyz\n#define AMB okUni_General[1].xyz\n#define DIF okUni_General[2].xyz\n#define SPE okUni_General[3].xyz\n#define GLO okUni_General[0].w\n#define ALPHA okUni_General[2].w\n#define GROUND okUni_General[4].xyz\n#define SKY okUni_General[5].xyz\n#ifdef OK_VERTEX_COLOR\n#define VC okVary_Color\n#else\n#define VC vec3(0.0)\n#endif\n#ifdef OK_TC12\n#define TC1 okVary_TC12.xy\n#define TC2 okVary_TC12.zw\n#else\n#ifdef OK_TC1\n#define TC1 okVary_TC1\n#endif\n#ifdef OK_TC2\n#define TC2 okVary_TC2\n#endif\n#endif\n#ifdef OK_TC34\n#define TC3 okVary_TC34.xy\n#define TC4 okVary_TC34.zw\n#else\n#ifdef OK_TC3\n#define TC3 okVary_TC3\n#endif\n#ifdef OK_TC4\n#define TC4 okVary_TC4\n#endif\n#endif\nvec2 okRotTC(vec2 d,float e){float a=cos(e);float b=sin(e);mat2 c=mat2(a,b,-b,a);return(c*(d-0.5))+0.5;}vec4 okFunc_FetchTexture(sampler2D f,vec2 g){return texture2D(f,g);}vec4 okFunc_FetchTexture(sampler2D f,vec2 g,float k,float l,float m){m=floor(m);vec2 h=1.0/vec2(k,l);float i=floor(m/k);float j=m-k*i;return texture2D(f,vec2(j,i)*h+g/vec2(k,l));}vec4 okFunc_FetchTexture(samplerCube f,vec3 n){return textureCube(f,n);}vec3 okFunc_GetMaterialEmissive(){\n#ifdef OK_SCRIPT_EMISSIVE_CODE\n{OK_SCRIPT_EMISSIVE_CODE}\n#else\nreturn okUni_General[0].xyz;\n#endif\n}vec3 okFunc_GetMaterialDiffuse(){\n#ifdef OK_SCRIPT_DIFFUSE_CODE\n{OK_SCRIPT_DIFFUSE_CODE}\n#else\n#ifdef OK_TEX_ALBEDO1||OK_TEX_ALBEDO2||OK_TEX_ALBEDO3||OK_TEX_ALBEDO4\nvec3 albedo=vec3(1,1,1);\n#ifdef OK_TEX_ALBEDO1\n#ifdef OK_TEX_ALBEDO1_CUBE\nalbedo=textureCube(okUni_SamplerCube[0],R).xyz;\n#else\nalbedo=texture2D(okUni_Sampler2D[0],OK_ALBEDO1_TC).xyz;\n#endif\n#endif\n#ifdef OK_TEX_ALBEDO2\n#ifdef OK_TEX_ALBEDO2_CUBE\nvec4 albedo2=textureCube(okUni_SamplerCube[1],R);\n#else\nvec4 albedo2=texture2D(okUni_Sampler2D[1],OK_ALBEDO2_TC);\n#endif\nalbedo=mix(albedo.xyz,albedo2.xyz,albedo2.a);\n#endif\n#ifdef OK_TEX_ALBEDO3\n#ifdef OK_TEX_ALBEDO3_CUBE\nvec4 albedo3=textureCube(okUni_SamplerCube[2],R);\n#else\nvec4 albedo3=texture2D(okUni_Sampler2D[2],OK_ALBEDO3_TC);\n#endif\nalbedo=mix(albedo.xyz,albedo3.xyz,albedo3.a);\n#endif\n#ifdef OK_TEX_ALBEDO4\n#ifdef OK_TEX_ALBEDO4_CUBE\nvec4 albedo4=textureCube(okUni_SamplerCube[3],R);\n#else\nvec4 albedo4=texture2D(okUni_Sampler2D[3],OK_ALBEDO4_TC);\n#endif\nalbedo=mix(albedo.xyz,albedo4.xyz,albedo4.a);\n#endif\nreturn albedo;\n#else\nreturn okUni_General[2].xyz;\n#endif\n#endif\n}float okFunc_GetMaterialDiffusePower(){\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\n{OK_SCRIPT_DIFFUSEPOWER_CODE}\n#else\nreturn 1.0;\n#endif\n}vec3 okFunc_GetMaterialSpecular(){\n#ifdef OK_SCRIPT_SPECULAR_CODE\n{OK_SCRIPT_SPECULAR_CODE}\n#else\n#ifdef OK_TEX_SPECULAR_LEVEL\nreturn texture2D(okUni_Sampler2D[6],OK_SPECULAR_LEVEL_TC).xyz*okUni_General[3].xyz;\n#else\nreturn vec3(okUni_General[1].w)*okUni_General[3].xyz;\n#endif\n#endif\n}float okFunc_GetMaterialSpecularPower(){\n#ifdef OK_SCRIPT_SPECULARPOWER_CODE\n{OK_SCRIPT_SPECULARPOWER_CODE}\n#else\nreturn okUni_General[0].w;\n#endif\n}float okFunc_GetMaterialAlpha(){\n#ifdef OK_SCRIPT_ALPHA_CODE\n{OK_SCRIPT_ALPHA_CODE}\n#else\n#ifdef OK_TEX_OPACITY\nreturn texture2D(okUni_Sampler2D[5],OK_OPACITY_TC).a;\n#else\nreturn okUni_General[2].a;\n#endif\n#endif\n}\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 okFunc_GetNormalScript(){OK_SCRIPT_NORMAL_CODE}\n#endif\nvec3 okFunc_GetMaterialNormal(){\n#ifdef OK_NORMAL\nvec3 vertexNormal=okVary_Normal;\n#else\nvec3 vertexNormal=vec3(0.0,1.0,0.0);\n#endif\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 normalT=okFunc_GetNormalScript();mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);vec3 retNormal=normalize(matTangent*normalT);\n#else\n#ifdef OK_TEX_NORMALMAP\nvec3 normalT=texture2D(okUni_Sampler2D[4],OK_NORMALMAP_TC).xyz;normalT=normalT*2.0-1.0;mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);vec3 retNormal=normalize(matTangent*normalT);\n#else\nvec3 retNormal=normalize(vertexNormal);\n#endif\n#endif\n#ifdef OK_TWO_SIDE\nreturn retNormal*(gl_FrontFacing?1.0:-1.0);\n#else\nreturn retNormal;\n#endif\n}void okFunc_GetMaterialDctLighting(vec3 LDIR,vec3 LCOLOR,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_DCTLIGHT_CODE\n{OK_SCRIPT_DCTLIGHT_CODE}\n#endif\n}void okFunc_GetMaterialPointLighting(vec3 LPOS,vec3 LCOLOR,vec3 LRANGE,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_POINTLIGHT_CODE\n{OK_SCRIPT_POINTLIGHT_CODE}\n#endif\n}void okFunc_GetMaterialSpotLighting(vec3 LPOS,vec3 LCOLOR,vec3 LDIR,float LINCONE,float LOUTCONE,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_SPOTLIGHT_CODE\n{OK_SCRIPT_SPOTLIGHT_CODE}\n#endif\n}void okFunc_DctLighting(vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightDir,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_DCTLIGHT_CODE\nokFunc_GetMaterialDctLighting(lightDir,lightColor,curDiffuse,curSpecular);\n#else\nvec3 lightVec=-lightDir;float diffuseFactor=max(0.0,dot(lightVec,normal));\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}void okFunc_PointLighting(vec3 pos,vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightPos,float lightRange,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_POINTLIGHT_CODE\nokFunc_GetMaterialPointLighting(lightPos,lightColor,lightRange,curDiffuse,curSpecular);\n#else\nvec3 lightVec=normalize(lightPos-pos);float lenFactor=max(0.0,1.0-distance(lightPos,pos)/lightRange);float diffuseFactor=max(0.0,dot(lightVec,normal))*lenFactor;\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}void okFunc_SpotLighting(vec3 pos,vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightPos,vec3 lightDir,float innerCone,float outerCone,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_SPOTLIGHT_CODE\nokFunc_GetMaterialSpotLighting(lightPos,lightColor,lightDir,innerCone,outerCone,curDiffuse,curSpecular);\n#else\nvec3 lightVec=normalize(lightPos-pos);float spotAngl=dot(lightVec,-lightDir);float innerAngl=cos(innerCone*0.5);float outerAngl=cos(outerCone*0.5);float diffuseFactor=clamp((spotAngl-outerAngl)/(innerAngl-outerAngl),0.0,1.0)*max(0.0,dot(lightVec,normal));\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}void main(void){P=okVary_Pos;vec3 normal=okFunc_GetMaterialNormal();N=normal;vec3 camVec=normalize(okUni_General[7].xyz-P);V=-camVec;vec3 reflectVec=normalize(reflect(-camVec,normal));R=reflectVec;vec2 screenCoord=okUni_General[6].xy+(okVary_ScrPos.xy/okVary_ScrPos.w+1.0)*0.5*okUni_General[6].zw;\n#ifdef OK_ALPHA_TEST\nif(okFunc_GetMaterialAlpha()<=okUni_General[3].w)discard;\n#endif\n#ifdef OK_DYNAMICLIGHTING\nvec3 emissive=okFunc_GetMaterialEmissive();vec3 ambient=mix(okUni_General[4].xyz,okUni_General[5].xyz,(normal.y+1.0)*0.5);ambient*=(okUni_General[1].xyz+okUni_General[3].xyz*pow(clamp(dot(camVec,reflectVec),0.0,1.0),8.0)*okFunc_GetMaterialSpecular());vec3 diffuse=vec3(0.0);vec3 specular=vec3(0.0);vec3 customlighting=vec3(0.0);\n#ifdef OK_DYNAMICSHADOW\nvec4 shadowFactor=vec4(texture2D(okUni_shadowSampler,screenCoord).xyz,1.0);\n#endif\n#endif\n#ifdef OK_DYNAMICLIGHTING\n#if OK_DCTLIGHT_NUM>=1\nokFunc_DctLighting(normal,camVec,reflectVec,okUni_General[8].xyz,fract(okUni_General[8].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[12],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=2\nokFunc_DctLighting(normal,camVec,reflectVec,okUni_General[9].xyz,fract(okUni_General[9].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[13],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=3\nokFunc_DctLighting(normal,camVec,reflectVec,okUni_General[10].xyz,fract(okUni_General[10].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[14],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=4\nokFunc_DctLighting(normal,camVec,reflectVec,okUni_General[11].xyz,fract(okUni_General[11].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[15],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=1\nokFunc_PointLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[16].xyz,okUni_General[16].w,fract(okUni_General[24].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[20],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=2\nokFunc_PointLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[17].xyz,okUni_General[17].w,fract(okUni_General[25].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[21],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=3\nokFunc_PointLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[18].xyz,okUni_General[18].w,fract(okUni_General[26].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[22],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=4\nokFunc_PointLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[19].xyz,okUni_General[19].w,fract(okUni_General[27].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[23],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=1\nokFunc_SpotLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[24].xyz,okUni_General[28].xyz,okUni_General[32].x,okUni_General[32].y,fract(okUni_General[28].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[36],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=2\nokFunc_SpotLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[25].xyz,okUni_General[29].xyz,okUni_General[33].x,okUni_General[33].y,fract(okUni_General[29].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[37],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=3\nokFunc_SpotLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[26].xyz,okUni_General[30].xyz,okUni_General[34].x,okUni_General[34].y,fract(okUni_General[30].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[38],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=4\nokFunc_SpotLighting(okVary_Pos,normal,camVec,reflectVec,okUni_General[27].xyz,okUni_General[31].xyz,okUni_General[35].x,okUni_General[35].y,fract(okUni_General[31].w*vec3(1.0,256.0,65536.0))\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[39],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#endif\n#ifdef OK_DYNAMICLIGHTING\nvec3 lightingColor=emissive+(ambient+diffuse)*okFunc_GetMaterialDiffuse()+specular*okFunc_GetMaterialSpecular();\n#else\nvec3 lightingColor=okFunc_GetMaterialEmissive()+(okUni_General[1].xyz+okUni_General[2].xyz)*okFunc_GetMaterialDiffuse();\n#endif\n#ifdef OK_AUTO_VERTEX_COLOR\nlightingColor+=VC;\n#endif\n#ifdef OK_FOG\n{float d=distance(okVary_Pos,okUni_General[7].xyz);float fog=clamp(1.0-1.0/exp(clamp((d-okUni_General[41].x)*okUni_General[41].y,0.0,1.0)*okUni_General[40].w),0.0,1.0);fog=smoothstep(0.0,0.95,fog);lightingColor=mix(lightingColor,okUni_General[40].xyz,fog);}\n#endif\ngl_FragColor=vec4(lightingColor,\n#ifdef OK_BLEND||OK_ALPHA_TEST\nokFunc_GetMaterialAlpha()\n#else\n1.0\n#endif\n);}",this.aVertexSourceMap.LightingDefault="attribute vec3 okAttr_Pos;uniform mat4 okUni_TransMat[3];void main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}",this.aFragmentSourceMap.LightingDefault="void main(void){gl_FragColor=vec4(1.0,0.0,0.0,1.0);}",this.aVertexSourceMap.Output="varying vec2 okVary_ScrTC;attribute vec3 okAttr_Pos;void main(void){gl_Position=vec4(okAttr_Pos,1.0);okVary_ScrTC=(okAttr_Pos.xy+1.0)*0.5;}",this.aFragmentSourceMap.Output="varying vec2 okVary_ScrTC;uniform sampler2D okUni_Tex;void main(void){vec4 a=texture2D(okUni_Tex,okVary_ScrTC);gl_FragColor=a;}",this.aVertexSourceMap.ShadowDepth="varying float okVary_Depth;\n#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\nattribute vec3 okAttr_Pos;\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nattribute vec3 okAttr_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nattribute vec3 okAttr_Color;\n#endif\n#ifdef OK_TC12\nattribute vec4 okAttr_TC12;\n#else\n#ifdef OK_TC1\nattribute vec2 okAttr_TC1;\n#endif\n#ifdef OK_TC2\nattribute vec2 okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nattribute vec4 okAttr_TC34;\n#else\n#ifdef OK_TC3\nattribute vec2 okAttr_TC3;\n#endif\n#ifdef OK_TC4\nattribute vec2 okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nattribute vec3 okAttr_Tangent;\n#endif\n#ifdef OK_BINORMAL\nattribute vec3 okAttr_Binormal;\n#endif\n#endif\n#ifdef OK_SKANIMATION\nattribute vec4 okAttr_BoneIdx;attribute vec4 okAttr_BoneWeight;uniform vec4 okUni_BoneMat[32*3];\n#endif\nuniform mat4 okUni_TransMat[3];void main(void){\n#ifdef OK_SKANIMATION\nmat4 a=mat4(0.0);{int c=int(okAttr_BoneIdx[0])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[0]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[1])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[1]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[2])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[2]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[3])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[3]*mat4(d,e,f,g);}\n#endif\n#ifdef OK_ALPHA_TEST\n#ifdef OK_NORMAL\nokVary_Normal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Normal,0.0)).xyz;\n#endif\n#ifdef OK_VERTEX_COLOR\nokVary_Color=okAttr_Color;\n#endif\n#ifdef OK_TC12\nokVary_TC12=okAttr_TC12;\n#else\n#ifdef OK_TC1\nokVary_TC1=okAttr_TC1;\n#endif\n#ifdef OK_TC2\nokVary_TC2=okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nokVary_TC34=okAttr_TC34;\n#else\n#ifdef OK_TC3\nokVary_TC3=okAttr_TC3;\n#endif\n#ifdef OK_TC4\nokVary_TC4=okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nokVary_Tangent=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Tangent,0.0)).xyz;\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Binormal,0.0)).xyz;;\n#endif\n#endif\nvec4 b=okUni_TransMat[0]*\n#ifdef OK_SKANIMATION\na*\n#endif\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nvec4(okAttr_Pos,1.0);\n#ifdef OK_ALPHA_TEST\nokVary_Pos=b.xyz/b.w;\n#endif\ngl_Position=okUni_TransMat[2]*b;okVary_Depth=gl_Position.z;}",this.aFragmentSourceMap.ShadowDepth="varying float okVary_Depth;\n#ifdef OK_ALPHA_TEST\nvarying vec3 okVary_Pos;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n#endif\n#ifdef OK_ALPHA_TEST\nuniform vec4 okUni_General[8];uniform sampler2D okUni_Sampler2D[7];uniform samplerCube okUni_SamplerCube[4];vec3 okGlb_P;vec3 okGlb_N;vec3 okGlb_V;vec3 okGlb_R;\n#define P okGlb_P\n#define CP okUni_General[7].xyz\n#define N okGlb_N\n#define V okGlb_V\n#define R okGlb_R\n#define T okUni_General[4].w\n#define RAND okUni_General[5].w\n#define EMI okUni_General[0].xyz\n#define AMB okUni_General[1].xyz\n#define DIF okUni_General[2].xyz\n#define SPE okUni_General[3].xyz\n#define GLO okUni_General[0].w\n#define ALPHA okUni_General[2].w\n#define GROUND okUni_General[4].xyz\n#define SKY okUni_General[5].xyz\n#ifdef OK_VERTEX_COLOR\n#define VC okVary_Color\n#else\n#define VC vec3(0.0)\n#endif\n#ifdef OK_TC12\n#define TC1 okVary_TC12.xy\n#define TC2 okVary_TC12.zw\n#else\n#ifdef OK_TC1\n#define TC1 okVary_TC1\n#endif\n#ifdef OK_TC2\n#define TC2 okVary_TC2\n#endif\n#endif\n#ifdef OK_TC34\n#define TC3 okVary_TC34.xy\n#define TC4 okVary_TC34.zw\n#else\n#ifdef OK_TC3\n#define TC3 okVary_TC3\n#endif\n#ifdef OK_TC4\n#define TC4 okVary_TC4\n#endif\n#endif\nvec2 okRotTC(vec2 d,float e){float a=cos(e);float b=sin(e);mat2 c=mat2(a,b,-b,a);return(c*(d-0.5))+0.5;}float okFunc_GetMaterialAlpha(){\n#ifdef OK_SCRIPT_ALPHA_CODE\nOK_SCRIPT_ALPHA_CODE\n#else\n#ifdef OK_TEX_OPACITY\nreturn texture2D(okUni_Sampler2D[5],OK_OPACITY_TC).a;\n#else\nreturn okUni_General[2].a;\n#endif\n#endif\n}\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 okFunc_GetNormalScript(){OK_SCRIPT_NORMAL_CODE}\n#endif\nvec3 okFunc_GetMaterialNormal(){\n#ifdef OK_NORMAL\nvec3 vertexNormal=okVary_Normal;\n#else\nvec3 vertexNormal=vec3(0.0,1.0,0.0);\n#endif\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 normalT=okFunc_GetNormalScript();mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\n#ifdef OK_TEX_NORMALMAP\nvec3 normalT=texture2D(okUni_Sampler2D[4],OK_NORMALMAP_TC).xyz;normalT=normalT*2.0-1.0;mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);return normalize(matTangent*normalT);\n#else\nreturn normalize(vertexNormal);\n#endif\n#endif\n}\n#endif\nvec4 encodeFloat(float f){vec4 bitSh=vec4(256*256*256,256*256,256,1);vec4 bitMsk=vec4(0,1.0/256.0,1.0/256.0,1.0/256.0);vec4 comp=fract(f*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main(void){\n#ifdef OK_ALPHA_TEST\nP=okVary_Pos;vec3 normal=okFunc_GetMaterialNormal();N=normal;vec3 camVec=normalize(okUni_General[7].xyz-okVary_Pos);V=-camVec;vec3 reflectVec=normalize(reflect(-camVec,normal));R=reflectVec;if(okFunc_GetMaterialAlpha()<=okUni_General[3].w)discard;\n#endif\ngl_FragColor=encodeFloat(okVary_Depth);}",this.aVertexSourceMap.ShadowDepthDefault="varying float okVary_Depth;attribute vec3 okAttr_Pos;uniform mat4 okUni_TransMat[3];void main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));okVary_Depth=gl_Position.z;}",this.aFragmentSourceMap.ShadowDepthDefault="varying float okVary_Depth;vec4 e(float d){vec4 a=vec4(256*256*256,256*256,256,1);vec4 b=vec4(0,1.0/256.0,1.0/256.0,1.0/256.0);vec4 c=fract(d*a);c-=c.xxyz*b;return c;}void main(void){gl_FragColor=e(okVary_Depth);}",this.aVertexSourceMap.ShadowFinal="varying vec4 screenPos;uniform mat4 matArray[3];attribute vec4 vertMask0;attribute vec4 vertMask1;uniform vec3 vertList[8];void main(void){vec3 a=vertList[0]*vertMask0.x;a+=vertList[1]*vertMask0.y;a+=vertList[2]*vertMask0.z;a+=vertList[3]*vertMask0.w;a+=vertList[4]*vertMask1.x;a+=vertList[5]*vertMask1.y;a+=vertList[6]*vertMask1.z;a+=vertList[7]*vertMask1.w;gl_Position=matArray[0]*vec4(a,1);screenPos=gl_Position;}",this.aFragmentSourceMap.ShadowFinal="varying vec4 screenPos;uniform mat4 matArray[3];uniform vec4 screenPosOffsetAndScale;uniform vec3 shadowPixelSizeAndOffset;uniform sampler2D samplerArray[2];vec4 a=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);float m(vec4 f){vec4 h=vec4(min(1.0,f.z-shadowPixelSizeAndOffset.z));vec2 i=f.xy/f.w;float j=dot(a,texture2D(samplerArray[1],i));vec4 k=vec4(dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(-1,-1))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(0,-1))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(1,-1))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(-1,0))));vec4 l=vec4(dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(1,0))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(-1,1))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(0,1))),dot(a,texture2D(samplerArray[1],i+shadowPixelSizeAndOffset.xy*vec2(1,1))));return(dot(sign(k-h),vec4(1.0))+dot(sign(l-h),vec4(1.0))+j)*0.111111;}void main(void){vec2 b=screenPos.xy/screenPos.w;vec2 c=screenPosOffsetAndScale.xy+(b+1.0)*0.5*screenPosOffsetAndScale.zw;float d=dot(a,texture2D(samplerArray[0],c));vec4 e=matArray[1]*vec4(b,d*2.0-1.0,1.0);e/=e.w;vec4 f=matArray[2]*e;float g=m(f);gl_FragColor=vec4(vec3(g),1.0);}",this.aVertexSourceMap.ShadowVolume="attribute vec4 vertMask0;attribute vec4 vertMask1;uniform vec3 vertList[8];uniform mat4 matViewProj;void main(void){vec3 a=vertList[0]*vertMask0.x;a+=vertList[1]*vertMask0.y;a+=vertList[2]*vertMask0.z;a+=vertList[3]*vertMask0.w;a+=vertList[4]*vertMask1.x;a+=vertList[5]*vertMask1.y;a+=vertList[6]*vertMask1.z;a+=vertList[7]*vertMask1.w;gl_Position=matViewProj*vec4(a,1);}",this.aFragmentSourceMap.ShadowVolume="void main(void){gl_FragColor=vec4(1,0,0,1);}"}function fe(){this.renderer=null,this.bEnable=!0,this.__aMatArray=[new it,new it,new it,new it]}function de(){D(this),this.depthFbo=null,this.depthTex=null,this.depthBuffer=null}function ve(){D(this),this.aShadowCasterList=new Array,this.iDepthTexSize=512,this.lightFbo=null,this.lightTex=null,this.lightDepthBuffer=null,this.projFbo=null,this.projTex=null,this.frustumMask=null,this.frustumIndexBuf=null,this.tempSamplerArray=[0,1]}function ge(){this.entity=null,this.light=null,this.aBatchList=null,this.mLightMat=null,this.mLightViewMat=null,this.mLightViewProjMat=null,this.lightFrustum=null,this.mShadowMat=null,this.fRatio=1,this.fResolution=0,this.rTexLayout=null,this.bNextPass=!1}function pe(){D(this),this.lightFbo=null,this.lightTex=null}function xe(){D(this),this.postTex=null,this.postTex_Half=null,this.dsBuffer_Half=null,this.postFbo=null}function ye(){this.sName="",this.iOffset=0,this.iStride=0,this.iSize=0,this.iIdx=0,this.buf=null}function _e(){this.aAttribFmt=V.object(),this.index=null,this.iDrawMode=0,this.iDrawStart=0,this.iDrawCount=0,this.materialRef=null,this.mMatRef=null,this.mMatNRef=null,this.aDctLightListRef=null,this.aPointLightListRef=null,this.aSpotLightListRef=null,this.bboxRef=null,this.aBoneMatList=null,this.sBoneIdxAttribName=null,this.sBoneWeightAttribName=null,this.bReceiveShadow=!0,this.bFaceCamera=!1,this.aResourceIdList=new Array,this.fSortKey=0}function Me(){this.aRenderEntityMap=new Object,this.aRenderBatchMap=new Object,this.aRenderBatchReleaseFlagMap=new Object,this.aLightListMap=new Object}function Te(t){this.rc=t,this.aRenderTargetMap=new Object}function be(t,e,i,r){var n=t.canvas;this.rc=e,this.resourceManager=i,this.sceneManager=r,this.shaderManager=new ue(e),S._SOURCE_PATH&&this.shaderManager.setShaderSourcePath(S._SOURCE_PATH+"/Engine/Shader"),this.renderSourceCollector=new Me,this.renderTargetCollector=new Te(e),this.renderEnv=new Yt,this.renderEnv.canvas=n,this.renderEnv.iCanvasWidth=n.clientWidth,this.renderEnv.iCanvasHeight=n.clientHeight,this.renderEnv.iStartTime=(new Date).getTime(),this.renderEnv.iCurTime=0;var a=this.resourceManager.createResource(1,"$R$Quad",!0);this.resourceManager.setCustomResourceState(a,5),function(t,e,i,r,n,a,s){var o=[e,i,0,e,n,0,r,n,0,r,i,0],h=[0,0,1,0,0,1,0,0,1,0,0,1],l=s?[0,1,0,0,1,0,1,1]:[0,0,0,1,1,1,1,0],m=[0,1,2,0,2,3];if(t.createAttribute("Position",o.length,o),t.createAttribute("Normal",h.length,h),t.createAttribute("Texcoord1",l.length,l),t.createIndex("Default",m.length,m,35044,4),t.setVertexNum(4),t.computeBoundingInfo(),a){for(var c=new Array,u=m.length/3,f=0;f<u;++f)c.push(m[3*f],m[3*f+1]),c.push(m[3*f+1],m[3*f+2]),c.push(m[3*f+2],m[3*f]);t.createIndex("Wireframe",c.length,c,35044,1)}}(this.resourceManager.getResource(a).createMesh("Quad"),-1,1,1,-1,!1,!0);var s=this.resourceManager.createResource(2,"$R$White",!0);this.resourceManager.setCustomResourceState(s,5),this.resourceManager.getResource(s).createTexture(3553,1,1,6408,5121,[255,255,255,255]);var o=this.resourceManager.createResource(2,"$R$Black",!0);this.resourceManager.setCustomResourceState(o,5),this.resourceManager.getResource(o).createTexture(3553,1,1,6408,5121,[0,0,0,0]),this.renderPipeline=[new de(e),new ve(e),new pe(e),new xe(e)];for(var h=this.renderPipeline.length,l=0;l<h;++l)this.renderPipeline[l].init(this);this._createPipelineResource()}Yt.prototype.clear=function(){this.camera=null,this.scene=null,this.vSkyColor.set(1,1,1),this.vGroundColor.set(.3,.3,.3),this.bFogEnable=!1,this.vFogColor.set(1,1,1),this.fFogDensity=3.5,this.fFogDistNear=.1,this.fFogDistFar=1,this.bShadow=!0,this.aStageEnableList=[!0,!0,!0],this.iStartTime=0,this.iCurTime=0,this.fRandom=0},Zt.prototype.clear=function(){this.mMat.identity(),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.releaseResource()},Zt.prototype.getType=function(){return this.iType},Zt.prototype.setId=function(t){this.iId=t},Zt.prototype.getId=function(){return this.iId},Zt.prototype.setName=function(t){this.sName=t},Zt.prototype.getName=function(){return this.sName},Zt.prototype.getResourceRefCount=function(t){return null==this.aResRefMap[t]?0:this.aResRefMap[t]},Zt.prototype.addResourceRef=function(t){null==this.aResRefMap[t]?this.aResRefMap[t]=1:this.aResRefMap[t]+=1},Zt.prototype.releaseResource=function(){var t=this.resourceManager;for(var e in this.aResRefMap)for(var i=this.aResRefMap[e],r=0;r<i;++r)t.deleteResource(parseInt(e));V._object(this.aResRefMap),this.aResRefMap=V.object()},Zt.prototype.getState=function(){return 4},Zt.prototype.getBoundingBox=function(){if(this.bBBoxDirty){var t=V.vec3(),e=V.vec3();t.x=-.01,t.y=-.01,t.z=-.01,e.x=.01,e.y=.01,e.z=.01,this.bbox.set(t,e),this.bbox.transformMat43(this.mMat),V._vec3(t),V._vec3(e),this.bBBoxDirty=!1}return this.bbox},Zt.prototype.getBoundingSphereCenter=function(){var t=this.getBoundingBox(),e=V.vec3();return e.x=.5*(t.vMin.x+t.vMax.x),e.y=.5*(t.vMin.y+t.vMax.y),e.z=.5*(t.vMin.z+t.vMax.z),e},Zt.prototype.getBoundingSphereRadius=function(){var t=this.getBoundingBox();return.5*Math.sqrt((t.vMax.x-t.vMin.x)*(t.vMax.x-t.vMin.x)+(t.vMax.y-t.vMin.y)*(t.vMax.y-t.vMin.y)+(t.vMax.z-t.vMin.z)*(t.vMax.z-t.vMin.z))},Zt.prototype.genRenderBatch=function(t,e,i){},Zt.prototype.setMat=function(t){t.clone(this.mMat),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.getMat43=function(){var t=V.mat43();return this.mMat.clone(t),t},Zt.prototype.getMat4=function(){var t=V.mat4();return this.mMat.toMat4(t),t},Zt.prototype.getNormalMat3=function(){if(this.bMatNDirty){var t=V.mat43();t=this.mMat.inverse(),V._mat43(this.mMatN),this.mMatN=t.transpose(),V._mat43(t),this.bMatNDirty=!1}var e=V.mat3();return this.mMatN.toMat3(e),e},Zt.prototype.getNormalMat43=function(){if(this.bMatNDirty){var t=V.mat43();t=this.mMat.inverse(),V._mat43(this.mMatN),this.mMatN=t.transpose(),V._mat43(t),this.bMatNDirty=!1}var e=V.mat43();return this.mMatN.clone(e),e},Zt.prototype.getNormalMat4=function(){if(this.bMatNDirty){var t=V.mat43();t=this.mMat.inverse(),V._mat43(this.mMatN),this.mMatN=t.transpose(),V._mat43(t),this.bMatNDirty=!1}var e=V.mat4();return this.mMatN.toMat4(e),e},Zt.prototype.getInvMat43=function(){this.bMatInvDirty&&(V._mat43(this.mMatInv),this.mMatInv=this.mMat.inverse(),this.bMatInvDirty=!1);var t=V.mat43();return this.mMatInv.clone(t),t},Zt.prototype.getInvMat4=function(){this.bMatInvDirty&&(V._mat43(this.mMatInv),this.mMatInv=this.mMat.inverse(),this.bMatInvDirty=!1);var t=V.mat4();return this.mMatInv.toMat4(t),t},Zt.prototype.setPos=function(t,e,i){null==e?(this.mMat.m03=t.x,this.mMat.m13=t.y,this.mMat.m23=t.z):(this.mMat.m03=t,this.mMat.m13=e,this.mMat.m23=i),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.getPos=function(){var t=V.vec3();return t.x=this.mMat.m03,t.y=this.mMat.m13,t.z=this.mMat.m23,t},Zt.prototype.move=function(t,e,i,r){var n=null;if(n=null!=i?ut(e,i,r):ut(e.x,e.y,e.z),2==t){var a=mt(n,this.mMat);V._mat43(this.mMat),this.mMat=a}else{a=mt(this.mMat,n);V._mat43(this.mMat),this.mMat=a}V._mat43(n),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.rotTarget=function(t,e,i){var r=V.mat43();this.mMat.clone(r),r.m03-=e.x,r.m13-=e.y,r.m23-=e.z;var n=mt(pt(t,i),r);V._mat43(r),n.m03+=e.x,n.m13+=e.y,n.m23+=e.z,n.clone(this.mMat),V._mat43(n),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.getDir=function(t){return this.mMat.getColumn(t-1).normalize(!0)},Zt.prototype.setDir=function(t,e,i,r){this._rotToDir(t,e,i,r)},Zt.prototype._rotToDir=function(t,e,i,r){var n=V.array();n.push(this.mMat.getColumn(0),this.mMat.getColumn(1),this.mMat.getColumn(2));var a=n[0].len(),s=n[1].len(),o=n[2].len();n[0].normalize(!0),n[1].normalize(!0),n[2].normalize(!0);var h=t-1;null!=i&&null!=r?(n[h].x=e,n[h].y=i,n[h].z=r):(n[h].x=e.x,n[h].y=e.y,n[h].z=e.z),n[h].normalize(!0);var l=n[(h+1)%3].clone();n[(h+1)%3]=Q(n[(h+2)%3],n[h]),n[(h+1)%3].equal(S.VEC3_ZERO)?(V._vec3(n[(h+1)%3]),n[(h+1)%3]=l,V._vec3(n[(h+2)%3]),n[(h+2)%3]=Q(n[h],n[(h+1)%3]),V._vec3(n[(h+1)%3]),n[(h+1)%3]=Q(n[(h+2)%3],n[h])):(V._vec3(l),V._vec3(n[(h+2)%3]),n[(h+2)%3]=Q(n[h],n[(h+1)%3])),n[0].normalize(!0),n[1].normalize(!0),n[2].normalize(!0),this.mMat.m00=n[0].x*a,this.mMat.m10=n[0].y*a,this.mMat.m20=n[0].z*a,this.mMat.m01=n[1].x*s,this.mMat.m11=n[1].y*s,this.mMat.m21=n[1].z*s,this.mMat.m02=n[2].x*o,this.mMat.m12=n[2].y*o,this.mMat.m22=n[2].z*o,this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this),V._vec3(n[0]),V._vec3(n[1]),V._vec3(n[2]),V._array(n)},Zt.prototype.rotX=function(t,e){var i=dt(e);if(2==t){var r=mt(i,this.mMat);V._mat43(this.mMat),this.mMat=r}else{r=mt(this.mMat,i);V._mat43(this.mMat),this.mMat=r}V._mat43(i),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.rotY=function(t,e){var i=vt(e);if(2==t){var r=mt(i,this.mMat);V._mat43(this.mMat),this.mMat=r}else{r=mt(this.mMat,i);V._mat43(this.mMat),this.mMat=r}V._mat43(i),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.rotZ=function(t,e){var i=gt(e);if(2==t){var r=mt(i,this.mMat);V._mat43(this.mMat),this.mMat=r}else{r=mt(this.mMat,i);V._mat43(this.mMat),this.mMat=r}V._mat43(i),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.scale=function(t,e,i,r){var n=null;if(n=null!=i?ft(e,i,r):e.x?ft(e.x,e.y,e.z):ft(e,e,e),2==t){var a=mt(n,this.mMat);V._mat43(this.mMat),this.mMat=a}else{a=mt(this.mMat,n);V._mat43(this.mMat),this.mMat=a}V._mat43(n),this.bMatNDirty=!0,this.bMatInvDirty=!0,this.bBBoxDirty=!0,this.dirtyMatFunc(),this.zone.dirtyEntity(this)},Zt.prototype.dirtyMatFunc=function(){},z(qt,Zt),qt.prototype.clear=function(){this.bVisible=!0,this.fVisibleDistance=-1,this.bCastShadow=!1,this.bReceiveShadow=!0,this.fShadowFadeFactor=1e-4,this.fShadowResolution=1,this.bSkybox=!1,D(this,"clear")},qt.prototype.enableVisible=function(t){this.bVisible=t},qt.prototype.isVisible=function(){return this.bVisible},qt.prototype.setVisibleDistance=function(t){this.fVisibleDistance=t},qt.prototype.getVisibleDistance=function(){return this.fVisibleDistance},qt.prototype.enableSkyBox=function(t){this.bSkybox=t,this.zone.forceVisibleEntity(this,t)},qt.prototype.isSkyBox=function(){return this.bSkybox},qt.prototype.enableCastShadow=function(t){this.bCastShadow=t},qt.prototype.isCastShadow=function(){return this.bCastShadow},qt.prototype.enableReceiveShadow=function(t){this.bReceiveShadow=t},qt.prototype.isReceiveShadow=function(){return this.bReceiveShadow},qt.prototype.setShadowFade=function(t){this.fShadowFadeFactor=t},qt.prototype.getShadowFade=function(){return this.fShadowFadeFactor},qt.prototype.setShadowResolution=function(t){this.fShadowResolution=t},qt.prototype.getShadowResolution=function(){return this.fShadowResolution},z(Qt,Zt),Qt.prototype.clear=function(){this.bVisible=!0,this.vColor=new j(1,1,1),this.bCastShadow=!1,this.vShadowColor.set(.5,.5,.5),this.iShadowIdx=3,this.fShadowFadeFactor=.006,D(this,"clear")},Qt.prototype.enableVisible=function(t){this.bVisible=t},Qt.prototype.isVisible=function(){return this.bVisible},Qt.prototype.enableCastShadow=function(t){this.bCastShadow=t},Qt.prototype.isCastShadow=function(){return this.bCastShadow},Qt.prototype.setShadowColor=function(t,e,i){null==e?t.clone(this.vShadowColor):this.vShadowColor.set(t,e,i)},Qt.prototype.setShadowFade=function(t){this.fShadowFadeFactor=t},Qt.prototype.getShadowFade=function(){return this.fShadowFadeFactor},Qt.prototype.setColor=function(t,e,i){null==e?t.clone(this.vColor):this.vColor.set(t,e,i)},Qt.prototype.getColor=function(){return this.vColor},Qt.prototype.isAffectEntity=function(t){return!0},z($t,Zt),$t.prototype.getSkyColor=function(){return this.vSkyColor},$t.prototype.getGroundColor=function(){return this.vGroundColor},$t.prototype.enableShadow=function(t){this.bShadow=t},$t.prototype.isShadowEnabled=function(){return this.bShadow},$t.prototype.enableFog=function(t,e){this.bFogEnable=e},$t.prototype.isFogEnabled=function(t){return this.bFogEnable},$t.prototype.getFogColor=function(t){var e=V.vec3();return this.vFogColor.clone(e)},$t.prototype.setFogDistanceNear=function(t,e){this.fFogDistNear=Math.max(.001,e)},$t.prototype.setFogDistanceFar=function(t,e){this.fFogDistFar=Math.max(.001,e)},$t.prototype.getFogDistanceNear=function(t){return this.fFogDistNear},$t.prototype.getFogDistanceFar=function(t){return this.fFogDistFar},$t.prototype.setFogDensity=function(t,e){this.fFogDensity=e},$t.prototype.getFogDensity=function(t){return this.fFogDensity},z(Jt,qt),Jt.prototype.clear=function(){this.resourceManager;this.deleteModel(),this.aMtrlMap&&V._object(this.aMtrlMap),this.aMtrlMap=V.object(),this.onModelLoad=null,D(this,"clear")},Jt.prototype.getState=function(){return-1==this.iModelId||5!=this.resourceManager.getResourceState(this.iModelId)?1:4},Jt.prototype.loadModel=function(t,e){this.deleteModel();var i=this.zone.scene._packModelUrl(t);return this.iModelId=this.resourceManager.createResource(1,i),this.resourceManager.registerListener(this.iModelId,this),2==this.resourceManager.getResourceState(this.iModelId)&&(null==e?this.resourceManager.loadModelByUrl(this.iModelId,i):this.resourceManager.loadModelByText(this.iModelId,e)),5==this.resourceManager.getResourceState(this.iModelId)&&this._postLoadModel(),!0},Jt.prototype.getModel=function(){return-1==this.iModelId||5!=this.resourceManager.getResourceState(this.iModelId)?null:this.resourceManager.getResource(this.iModelId)},Jt.prototype.deleteModel=function(){-1!=this.iModelId&&(this.resourceManager.deleteResource(this.iModelId),this.resourceManager.removeListener(this.iModelId,this),this.iModelId=-1,this.aMtrlMap=new Object,this.bBBoxDirty=!0)},Jt.prototype.getMaterialMap=function(){return this.aMtrlMap},Jt.prototype.getMaterial=function(t){if(null==t){for(var e in this.aMtrlMap)return this.aMtrlMap[e];return null}return this.aMtrlMap[t]},Jt.prototype.getBoundingBox=function(){if(this.bBBoxDirty){var t=this.getModel();if(null==t){var e=this.mMat.getColumn(3);this.bbox.set(e,e),V._vec3(e)}else t.getBoundingBox().clone(this.bbox),this.bbox.transformMat43(this.mMat),this.bBBoxDirty=!1}return this.bbox},Jt.prototype.genRenderBatch=function(t,e){this.zone.scene;var i=this.resourceManager,r=this.getModel();if(null!=r){var n=e.camera;if(this.fVisibleDistance>0){var a=n.getPos();if((a.x-this.mMat.m03)*(a.x-this.mMat.m03)+(a.y-this.mMat.m13)*(a.y-this.mMat.m13)+(a.z-this.mMat.m23)*(a.z-this.mMat.m23)>this.fVisibleDistance*this.fVisibleDistance)return}var s=r.getMeshMap();for(var o in s){for(var h=s[o],l=this.getMaterial(o),m=V.renderBatch(),c=0;c<7;++c){var u=l.getTextureResourceId(c);if(-1!=u){var f=i.getResource(u);f&&f.isVideoTexture()&&f.updateVideoTexture()}}var d=h.aAttribArrayBufferList,v=V.array();for(var g in d){var p=d[g],x=g.split("/"),y=0;v.length=0;for(var _=x.length,M=0;M<_;++M){var T=new ye,b=x[M];switch(v.push(T),m.aAttribFmt[b]=T,T.sName=b,T.iIdx=M,T.iOffset=y,T.buf=p,b){case"Position":case"Normal":case"Color":case"Texcoord1_Tangent":case"Texcoord1_Binormal":case"Texcoord2_Tangent":case"Texcoord2_Binormal":case"Texcoord3_Tangent":case"Texcoord3_Binormal":case"Texcoord4_Tangent":case"Texcoord4_Binormal":T.iSize=3,y+=3;break;case"Texcoord1":case"Texcoord2":case"Texcoord3":case"Texcoord4":T.iSize=2,y+=2;break;case"BoneIndex":case"BoneWeight":T.iSize=4,y+=4}}_=v.length;for(M=0;M<_;++M)v[M].iStride=y}V._array(v),l.bWireframe&&h.aIndexArrayBufferList.Wireframe?(m.index=h.aIndexArrayBufferList.Wireframe,m.iDrawMode=1):(m.index=h.aIndexArrayBufferList.Default,m.iDrawMode=4),m.iDrawStart=0,m.iDrawCount=m.index.getLength(),m.materialRef=l;var A=this.getMat43();this.bSkybox&&(A.m03+=n.mCamMat.m03,A.m13+=n.mCamMat.m13,A.m23+=n.mCamMat.m23),m.mMatRef=A,m.mMatNRef=this.getNormalMat43(),m.aDctLightListRef=this.__aDctLightList,m.aPointLightListRef=this.__aPointLightList,m.aSpotLightListRef=this.__aSpotLightList;var L=new bt;h.getBoundingBox().clone(L),L.transformMat43(this.mMat),m.bboxRef=L,m.bReceiveShadow=this.bReceiveShadow,t.push(m)}}},Jt.prototype.onMessage=function(t){switch(t.sMsg){case"RES_READY":this.iModelId==t.aArgs[0]&&this._postLoadModel(t.aArgs[0])}},Jt.prototype._postLoadModel=function(){this.bBBoxDirty=!0,this.zone.dirtyEntity(this);var t=this.resourceManager.getResource(this.iModelId);if(t)for(var e in t.getMeshMap()){var i=new zt;i.entity=this,t.getMesh(e).getMaterial().clone(i),this.aMtrlMap[e]=i}this.onLoad?this.onLoad(this.getId(),this.iModelId):this.onload&&this.onload(this.getId(),this.iModelId)},z(te,qt),te.prototype.clear=function(){for(var t in this.deleteModel(),this.defaultPlayer.clear(),this.aPlayerMap)this.aPlayerMap[t].clear();V._object(this.aPlayerMap),this.aPlayerMap=V.object(),this.bLocalBoundingBoxDirty=!0,D(this,"clear")},te.prototype.getState=function(){return-1==this.iModelId||5!=this.resourceManager.getResourceState(this.iModelId)?1:4},te.prototype.loadModel=function(t,e){this.deleteModel();var i=this.zone.scene._packModelUrl(t);return this.iModelId=this.resourceManager.createResource(1,i),this.resourceManager.registerListener(this.iModelId,this),2==this.resourceManager.getResourceState(this.iModelId)&&(null==e?this.resourceManager.loadModelByUrl(this.iModelId,i):this.resourceManager.loadModelByText(this.iModelId,e)),5==this.resourceManager.getResourceState(this.iModelId)&&this._postLoadModel(this.iModelId),!0},te.prototype.getModel=function(){return-1==this.iModelId||5!=this.resourceManager.getResourceState(this.iModelId)?null:this.resourceManager.getResource(this.iModelId)},te.prototype.deleteModel=function(){-1!=this.iModelId&&(this.resourceManager.removeListener(this.iModelId,this),this.resourceManager.deleteResource(this.iModelId),this.iModelId=-1,this.aMtrlMap=new Object)},te.prototype.getMaterialMap=function(){return this.aMtrlMap},te.prototype.getMaterial=function(t){if(null==t){for(var e in this.aMtrlMap)return this.aMtrlMap[e];return null}return this.aMtrlMap[t]},te.prototype.getBoundingBox=function(){if(this.bLocalBoundingBoxDirty){if(this.bboxL.set(new j(1e10,1e10,1e10),new j(-1e10,-1e10,-1e10)),5==this.resourceManager.getResourceState(this.iModelId)){var t=this.resourceManager.getResource(this.iModelId);for(var e in t.getMeshMap()){var i=t.getMesh(e),r=this.aPlayerMap[e]?this.aPlayerMap[e]:this.defaultPlayer;r.getSkin()!=i.getSkin()&&r.setSkin(i.getSkin()),this.bboxL=this.bboxL.union(r.getBoundingBox())}}this.bLocalBoundingBoxDirty=!1,this.bBBoxDirty=!0}if(this.bBBoxDirty)if(null==(t=this.getModel())){var n=this.mMat.getColumn(3);this.bbox.set(n,n),V._vec3(n)}else this.bboxL.clone(this.bbox),this.bbox.transformMat43(this.mMat),this.bBBoxDirty=!1;return this.bbox},te.prototype.genRenderBatch=function(t,e){var i=this.resourceManager,r=this.getModel();if(null!=r){var n=e.camera;if(this.fVisibleDistance>0){var a=n.getPos();if((a.x-this.mMat.m03)*(a.x-this.mMat.m03)+(a.y-this.mMat.m13)*(a.y-this.mMat.m13)+(a.z-this.mMat.m23)*(a.z-this.mMat.m23)>this.fVisibleDistance*this.fVisibleDistance)return}var s=r.getMeshMap();for(var o in s){for(var h=s[o],l=this.getMaterial(o),m=V.renderBatch(),c=0;c<7;++c){var u=l.getTextureResourceId(c);if(-1!=u){var f=i.getResource(u);f&&f.isVideoTexture()&&f.updateVideoTexture()}}var d=h.aAttribArrayBufferList,v=V.array();for(var g in d){var p=d[g],x=g.split("/"),y=0;v.length=0;for(var _=x.length,M=0;M<_;++M){var T=new ye,b=x[M];switch(v.push(T),m.aAttribFmt[b]=T,T.sName=b,T.iIdx=M,T.iOffset=y,T.buf=p,b){case"Position":case"Normal":case"Color":case"Texcoord1_Tangent":case"Texcoord1_Binormal":case"Texcoord2_Tangent":case"Texcoord2_Binormal":case"Texcoord3_Tangent":case"Texcoord3_Binormal":case"Texcoord4_Tangent":case"Texcoord4_Binormal":T.iSize=3,y+=3;break;case"Texcoord1":case"Texcoord2":case"Texcoord3":case"Texcoord4":T.iSize=2,y+=2;break;case"BoneIndex":case"BoneWeight":T.iSize=4,y+=4}}_=v.length;for(M=0;M<_;++M)v[M].iStride=y}V._array(v),l.bWireframe&&h.aIndexArrayBufferList.Wireframe?(m.index=h.aIndexArrayBufferList.Wireframe,m.iDrawMode=1):(m.index=h.aIndexArrayBufferList.Default,m.iDrawMode=4),m.iDrawStart=0,m.iDrawCount=m.index.getLength(),m.materialRef=l,m.mMatRef=this.getMat43(),m.mMatNRef=this.getNormalMat43(),m.aDctLightListRef=this.__aDctLightList,m.aPointLightListRef=this.__aPointLightList,m.aSpotLightListRef=this.__aSpotLightList;var A=this.aPlayerMap[o]?this.aPlayerMap[o]:this.defaultPlayer,L=h.getSkin();A.getSkin()!=L&&A.setSkin(L);var C=A.getBoneFinalMat43Array();m.aBoneMatList=[S.MAT43_ZERO].concat(C),L&&(m.sBoneIdxAttribName=L.getVertexBoneIdxAttribName(),m.sBoneWeightAttribName=L.getVertexBoneWeightAttribName());var E=new bt;h.getBoundingBox().clone(E),E.transformMat43(this.mMat),m.bboxRef=E,m.bReceiveShadow=this.bReceiveShadow,t.push(m)}}},te.prototype.activateChannel=function(t,e,i){if(i)null==this.aPlayerMap[i]&&(this.aPlayerMap[i]=this.defaultPlayer.clone()),this.aPlayerMap[i].activateChannel(t,e);else{for(var r in this.aPlayerMap)this.aPlayerMap[r].activateChannel(t,e);this.defaultPlayer.activateChannel(t,e)}},te.prototype.isActive=function(t,e){return e?null==this.aPlayerMap[e]?this.defaultPlayer.isActive(t):this.aPlayerMap[e].isActive(t):this.defaultPlayer.isActive(t)},te.prototype.setSpeed=function(t,e,i){if(i)null==this.aPlayerMap[i]&&(this.aPlayerMap[i]=this.defaultPlayer.clone()),this.aPlayerMap[i].setSpeed(t,e);else{for(var r in this.aPlayerMap)this.aPlayerMap[r].setSpeed(t,e);this.defaultPlayer.setSpeed(t,e)}},te.prototype.getSpeed=function(t,e){return e?null==this.aPlayerMap[e]?this.defaultPlayer.getSpeed(t):this.aPlayerMap[e].getSpeed(t):this.defaultPlayer.getSpeed(t)},te.prototype.enableLoop=function(t,e,i){if(i)null==this.aPlayerMap[i]&&(this.aPlayerMap[i]=this.defaultPlayer.clone()),this.aPlayerMap[i].enableLoop(t,e);else{for(var r in this.aPlayerMap)this.aPlayerMap[r].enableLoop(t,e);this.defaultPlayer.enableLoop(t,e)}},te.prototype.isLoop=function(t,e){return e?null==this.aPlayerMap[e]?this.defaultPlayer.isLoop(t):this.aPlayerMap[e].isLoop(t):this.defaultPlayer.isLoop(t)},te.prototype.setBlendMode=function(t,e){if(e)null==this.aPlayerMap[e]&&(this.aPlayerMap[e]=this.defaultPlayer.clone()),this.aPlayerMap[e].setBlendMode(t);else{for(var i in this.aPlayerMap)this.aPlayerMap[i].setBlendMode(t);this.defaultPlayer.setBlendMode(t)}},te.prototype.getBlendMode=function(t){return t?null==this.aPlayerMap[t]?this.defaultPlayer.getBlendMode():this.aPlayerMap[t].getBlendMode():this.defaultPlayer.getBlendMode()},te.prototype.getTickTime=function(t,e){return e?null==this.aPlayerMap[e]?this.defaultPlayer.getTickTime(t):this.aPlayerMap[e].getTickTime(t):this.defaultPlayer.getTickTime(t)},te.prototype.setTime=function(t,e,i){if(i)null==this.aPlayerMap[i]&&(this.aPlayerMap[i]=this.defaultPlayer.clone()),this.aPlayerMap[i].setTime(t,e);else{for(var r in this.aPlayerMap)this.aPlayerMap[r].setTime(t,e);this.defaultPlayer.setTime(t,e)}},te.prototype.update=function(t,e){if(e)null==this.aPlayerMap[e]&&(this.aPlayerMap[e]=this.defaultPlayer.clone()),this.aPlayerMap[e].update(-1,t);else{for(var i in this.aPlayerMap)this.aPlayerMap[i].update(-1,t);this.defaultPlayer.update(-1,t)}},te.prototype.onMessage=function(t){switch(t.sMsg){case"RES_READY":this.iModelId==t.aArgs[0]?this._postLoadModel(t.aArgs[0]):this._postLoadAnim(t.aArgs[0])}},te.prototype._postLoadModel=function(t){var e=this.resourceManager.getResource(this.iModelId);if(e=this.resourceManager.getResource(this.iModelId))for(var i in e.getMeshMap()){var r=new zt;r.entity=this,e.getMesh(i).getMaterial().clone(r),this.aMtrlMap[i]=r}this.bLocalBoundingBoxDirty=!0,this.bBBoxDirty=!0,this.zone.dirtyEntity(this),this.onLoad&&this.onLoad(this.getId(),t),this.onload&&this.onload(this.getId(),t)},te.prototype._postLoadAnim=function(t){this.bLocalBoundingBoxDirty=!0,this.bBBoxDirty=!0,this.zone.dirtyEntity(this),this.onLoad&&this.onLoad(this.getId(),t),this.onload&&this.onload(this.getId(),t)},z(ie,qt),ie.prototype.setTexture=function(t,e,i,r,n){var a=this.mesh.getMaterial();a.setTextureName(0,t),a.setTextureCoord(0,"Texcoord1"),""!=t?a.setDiffuseScript("VC * (ALBEDO1, TC1).rgb"):a.setDiffuseScript("VC"),""!=t?a.setAlphaScript("TC2.x * ALPHA * (ALBEDO1, TC1)."+(E(e)?e.toLowerCase():"a")):a.setAlphaScript("TC2.x * ALPHA"),this.iAnimWidth=i||1,this.iAnimHeight=r||1,this.iAnimCount=n||1},ie.prototype.setParticleMaxNum=function(t){if(this.iMaxCount=Math.min(t,1e4),this.iMaxCount){this.mesh.createAttribute("Position",4*t*3,null,35048),this.mesh.createAttribute("Color/Texcoord1/Texcoord2",4*t*7,null,35048);for(var e=V.array(),i=0;i<t;++i)e.push(4*i,4*i+1,4*i+3,4*i+3,4*i+1,4*i+2);this.mesh.createIndex("Default",2*t*3,e,35048,4),V._array(e)}},ie.prototype.getParticleMaxNum=function(){return this.iMaxCount},ie.prototype.setEmitDir=function(t,e,i){this._rotToDir(2,t,e,i)},ie.prototype.getEmitDir=function(){return this.mMat.getColumn(2)},ie.prototype.setEmitDirRange=function(t,e){this.aEmitDirRange[0]=t,this.aEmitDirRange[1]=null!=e?e:t},ie.prototype.getEmitDirRangeMin=function(){return this.aEmitDirRange[0]},ie.prototype.getEmitDirRangeMax=function(){return this.aEmitDirRange[1]},ie.prototype.setEmitCycle=function(t){this.fEmitCycle=t,this.fEmitLastTime=t},ie.prototype.getEmitCycle=function(){return this.fEmitCycle},ie.prototype.setEmitFlow=function(t){this.iEmitFlow=t},ie.prototype.getEmitFlow=function(){return this.iEmitFlow},ie.prototype.setEmitPos=function(t,e,i){this.setPos(t,e,i)},ie.prototype.getEmitPos=function(){return this.mMat.getColumn(3)},ie.prototype.getEmitPosRangeMin=function(){return this.aEmitOffset[0].clone()},ie.prototype.getEmitPosRangeMax=function(){return this.aEmitOffset[1].clone()},ie.prototype.setEmitVelocity=function(t,e){this.aEmitV[0]=t,this.aEmitV[1]=null!=e?e:t},ie.prototype.getEmitVelocityMin=function(){return this.aEmitV[0]},ie.prototype.getEmitVelocityMax=function(){return this.aEmitV[1]},ie.prototype.setParticleLife=function(t,e){this.aLife[0]=t,this.aLife[1]=null!=e?e:t},ie.prototype.getParticleLifeMin=function(){return this.aLife[0]},ie.prototype.getParticleLifeMax=function(){return this.aLife[1]},ie.prototype.setParticleAcceleration=function(t,e,i,r,n,a){null!=a?(this.aA[0].x=t,this.aA[0].y=e,this.aA[0].z=i,this.aA[1].x=r,this.aA[1].y=n,this.aA[1].z=a):null!=i?(this.aA[0].x=t,this.aA[0].y=e,this.aA[0].z=i,this.aA[1].x=t,this.aA[1].y=e,this.aA[1].z=i):null!=e?(this.aA[0].x=t.x,this.aA[0].y=t.y,this.aA[0].z=t.z,this.aA[1].x=e.x,this.aA[1].y=e.y,this.aA[1].z=e.z):(this.aA[0].x=t.x,this.aA[0].y=t.y,this.aA[0].z=t.z,this.aA[1].x=t.x,this.aA[1].y=t.y,this.aA[1].z=t.z)},ie.prototype.getParticleAccelerationMin=function(){return this.aA[0].clone()},ie.prototype.getParticleAccelerationMax=function(){return this.aA[1].clone()},ie.prototype.setParticleSize=function(t,e,i,r,n){1&t&&(null!=n?(this.aSize0[0].x=e,this.aSize0[0].y=i,this.aSize0[1].x=r,this.aSize0[1].y=n):P(i)?(this.aSize0[0].x=e,this.aSize0[0].y=i,this.aSize0[1].x=e,this.aSize0[1].y=i):i?(this.aSize0[0].x=e.x,this.aSize0[0].y=e.y,this.aSize0[1].x=i.x,this.aSize0[1].y=i.y):(this.aSize0[0].x=e.x,this.aSize0[0].y=e.y,this.aSize0[1].x=e.x,this.aSize0[1].y=e.y)),2&t&&(null!=n?(this.aSize1[0].x=e,this.aSize1[0].y=i,this.aSize1[1].x=r,this.aSize1[1].y=n):P(i)?(this.aSize1[0].x=e,this.aSize1[0].y=i,this.aSize1[1].x=e,this.aSize1[1].y=i):i?(this.aSize1[0].x=e.x,this.aSize1[0].y=e.y,this.aSize1[1].x=i.x,this.aSize1[1].y=i.y):(this.aSize1[0].x=e.x,this.aSize1[0].y=e.y,this.aSize1[1].x=e.x,this.aSize1[1].y=e.y))},ie.prototype.getParticleSizeMin=function(t){return 1==t?this.aSize0[0].clone():this.aSize1[0].clone()},ie.prototype.getParticleSizeMax=function(t){return t==S.PTIME_BEGIN?this.aSize0[1].clone():this.aSize1[1].clone()},ie.prototype.enableVarySize=function(t){this.bVarySize=t},ie.prototype.isVarySize=function(){return this.bVarySize},ie.prototype.setParticleColor=function(t,e,i,r,n,a,s){1&t&&(null!=s?(this.aColor0[0].x=e,this.aColor0[0].y=i,this.aColor0[0].z=r,this.aColor0[1].x=n,this.aColor0[1].y=a,this.aColor0[1].z=s):null!=r?(this.aColor0[0].x=e,this.aColor0[0].y=i,this.aColor0[0].z=r,this.aColor0[1].x=e,this.aColor0[1].y=i,this.aColor0[1].z=r):null!=i?(this.aColor0[0].x=e.x,this.aColor0[0].y=e.y,this.aColor0[0].z=e.z,this.aColor0[1].x=i.x,this.aColor0[1].y=i.y,this.aColor0[1].z=i.z):(this.aColor0[0].x=e.x,this.aColor0[0].y=e.y,this.aColor0[0].z=e.z,this.aColor0[1].x=e.x,this.aColor0[1].y=e.y,this.aColor0[1].z=e.z)),2&t&&(null!=s?(this.aColor1[0].x=e,this.aColor1[0].y=i,this.aColor1[0].z=r,this.aColor1[1].x=n,this.aColor1[1].y=a,this.aColor1[1].z=s):null!=r?(this.aColor1[0].x=e,this.aColor1[0].y=i,this.aColor1[0].z=r,this.aColor1[1].x=e,this.aColor1[1].y=i,this.aColor1[1].z=r):null!=i?(this.aColor1[0].x=e.x,this.aColor1[0].y=e.y,this.aColor1[0].z=e.z,this.aColor1[1].x=i.x,this.aColor1[1].y=i.y,this.aColor1[1].z=i.z):(this.aColor1[0].x=e.x,this.aColor1[0].y=e.y,this.aColor1[0].z=e.z,this.aColor1[1].x=e.x,this.aColor1[1].y=e.y,this.aColor1[1].z=e.z))},ie.prototype.getParticleColorMin=function(t){return 1==t?this.aColor0[0].clone():this.aColor1[0].clone()},ie.prototype.getParticleColorMax=function(t){return 1==t?this.aColor0[1].clone():this.aColor1[1].clone()},ie.prototype.enableVaryColor=function(t){this.bVaryColor=t},ie.prototype.isVaryColor=function(){return this.bVaryColor},ie.prototype.setParticleFadeInTime=function(t,e){this.aFadeIn[0]=t,this.aFadeIn[1]=null!=e?e:t},ie.prototype.getParticleFadeInTimeMin=function(){return this.aFadeIn[0]},ie.prototype.getParticleFadeInTimeMax=function(){return this.aFadeIn[1]},ie.prototype.setParticleFadeOutTime=function(t,e){this.aFadeOut[0]=t,this.aFadeOut[1]=null!=e?e:t},ie.prototype.getParticleFadeOutTimeMin=function(){return this.aFadeOut[0]},ie.prototype.getParticleFadeOutTimeMax=function(){return this.aFadeOut[1]},ie.prototype.getMaterial=function(){return this.mesh.getMaterial()},ie.prototype.getBoundingBox=function(){if(this.bBBoxDirty){var t=this.bbox.vMin.clone(),e=this.bbox.vMax.clone();t.x=Math.min(t.x,this.mMat.m03),t.y=Math.min(t.y,this.mMat.m13),t.z=Math.min(t.z,this.mMat.m23),e.x=Math.max(e.x,this.mMat.m03),e.y=Math.max(e.y,this.mMat.m13),e.z=Math.max(e.z,this.mMat.m23),this.bbox.set(t,e),V._vec3(t),V._vec3(e),this.bBBoxDirty=!1}return this.bbox},ie.prototype.update=function(t){if(this.bActive){for(var e=V.array(),i=this.getNormalMat43(),r=this.mMat.getColumn(3),n=this.mMat.getColumn(3),a=this.aParticles.getRoot();a;){if((f=a.data).lf+=t,f.lf>f.tlf){var s=a.next;V._particle(f),this.aParticles.remove(a),a=s}else{f.m.m03+=f.v.x*t/1e3,f.m.m13+=f.v.y*t/1e3,f.m.m23+=f.v.z*t/1e3,f.v.x+=f.ac.x*t/1e3,f.v.y+=f.ac.y*t/1e3,f.v.z+=f.ac.z*t/1e3;var o=f.lf/f.tlf;this.bVarySize&&(f.s.x=(1-o)*f.s0.x+o*f.s1.x,f.s.y=(1-o)*f.s0.y+o*f.s1.y),this.bVaryColor&&(f.c.x=(1-o)*f.c0.x+o*f.c1.x,f.c.y=(1-o)*f.c0.y+o*f.c1.y,f.c.z=(1-o)*f.c0.z+o*f.c1.z),f.lf<=f.fdi?f.a=f.lf/f.fdi:f.lf>=f.tlf-f.fdo?f.a=(f.tlf-f.lf)/f.fdo:f.a=1,r.x=Math.min(r.x,f.m.m03),r.y=Math.min(r.y,f.m.m13),r.z=Math.min(r.z,f.m.m23),n.x=Math.max(n.x,f.m.m03),n.y=Math.max(n.y,f.m.m13),n.z=Math.max(n.z,f.m.m23);var h=(y=(p=Math.floor(f.lf/f.tlf*this.iAnimCount))-(x=Math.floor(p/this.iAnimWidth))*this.iAnimWidth)/this.iAnimWidth,l=(y+1)/this.iAnimWidth,m=x/this.iAnimHeight,c=(x+1)/this.iAnimHeight;e.push(f.c.x,f.c.y,f.c.z,h,m,f.a,0,f.c.x,f.c.y,f.c.z,h,c,f.a,0,f.c.x,f.c.y,f.c.z,l,c,f.a,0,f.c.x,f.c.y,f.c.z,l,m,f.a,0),a=a.next}}if(this.fEmitLastTime+=t,this.fEmitLastTime>=this.fEmitCycle){this.fEmitLastTime-=this.fEmitCycle;for(var u=this.iEmitFlow;u>0&&this.aParticles.getSize()<this.iMaxCount;){u-=1;var f=V.particle();this.aParticles.pushBack(f);var d=Math.random();f.tlf=(1-d)*this.aLife[0]+d*this.aLife[1],f.lf=0,this.mMat.clone(f.m),d=Math.random(),f.m.m03+=(1-d)*this.aEmitPosRange[0].x+d*this.aEmitPosRange[1].x,d=Math.random(),f.m.m13+=(1-d)*this.aEmitPosRange[0].y+d*this.aEmitPosRange[1].y,d=Math.random(),f.m.m23+=(1-d)*this.aEmitPosRange[0].z+d*this.aEmitPosRange[1].z,d=Math.random();var v=new j(0,1,0);v.rotZ((1-d)*this.aEmitDirRange[0]+d*this.aEmitDirRange[1],!0),v.rotY(360*Math.random(),!0),v=ct(i,v);var g=(1-(d=Math.random()))*this.aEmitV[0]+d*this.aEmitV[1];f.v.x=v.x*g,f.v.y=v.y*g,f.v.z=v.z*g,d=Math.random(),f.ac.x=(1-d)*this.aA[0].x+d*this.aA[1].x,f.ac.y=(1-d)*this.aA[0].y+d*this.aA[1].y,f.ac.z=(1-d)*this.aA[0].z+d*this.aA[1].z,d=Math.random(),f.s0.x=(1-d)*this.aSize0[0].x+d*this.aSize0[1].x,d=Math.random(),f.s0.y=(1-d)*this.aSize0[0].y+d*this.aSize0[1].y,d=Math.random(),f.s1.x=(1-d)*this.aSize1[0].x+d*this.aSize1[1].x,d=Math.random(),f.s1.y=(1-d)*this.aSize1[0].x+d*this.aSize1[1].x,f.s.x=f.s0.x,f.s.y=f.s0.y,d=Math.random(),f.c0.x=(1-d)*this.aColor0[0].x+d*this.aColor0[1].x,d=Math.random(),f.c0.y=(1-d)*this.aColor0[0].y+d*this.aColor0[1].y,d=Math.random(),f.c0.z=(1-d)*this.aColor0[0].z+d*this.aColor0[1].z,d=Math.random(),f.c1.x=(1-d)*this.aColor1[0].x+d*this.aColor1[1].x,d=Math.random(),f.c1.y=(1-d)*this.aColor1[0].y+d*this.aColor1[1].y,d=Math.random(),f.c1.z=(1-d)*this.aColor1[0].z+d*this.aColor1[1].z,f.c.x=f.c0.x,f.c.y=f.c0.y,f.c.z=f.c0.z,d=Math.random(),f.fdi=(1-d)*this.aFadeIn[0]+d*this.aFadeIn[1],d=Math.random(),f.fdo=(1-d)*this.aFadeOut[0]+d*this.aFadeOut[1],f.a=0,r.x=Math.min(r.x,f.m.m03),r.y=Math.min(r.y,f.m.m13),r.z=Math.min(r.z,f.m.m23),n.x=Math.max(n.x,f.m.m03),n.y=Math.max(n.y,f.m.m13),n.z=Math.max(n.z,f.m.m23);var p,x,y;h=(y=(p=Math.floor(f.lf/f.tlf*this.iAnimCount))-(x=Math.floor(p/this.iAnimWidth))*this.iAnimWidth)/this.iAnimWidth,l=(y+1)/this.iAnimWidth,m=x/this.iAnimHeight,c=(x+1)/this.iAnimHeight;e.push(f.c.x,f.c.y,f.c.z,h,m,f.a,0,f.c.x,f.c.y,f.c.z,h,c,f.a,0,f.c.x,f.c.y,f.c.z,l,c,f.a,0,f.c.x,f.c.y,f.c.z,l,m,f.a,0)}}this.mesh.loadAttribute("Color/Texcoord1/Texcoord2",0,4*this.aParticles.getSize()*7,e),this.bbox.set(r,n),this.bBBoxDirty=!1,V._array(e),V._vec3(r),V._vec3(n)}},ie.prototype.genRenderBatch=function(t,e){if(0!=this.iCount&&this.bActive){for(var i=this.resourceManager,r=e.camera,n=this.mesh,a=this.mesh.getMaterial(),s=V.renderBatch(),o=0;o<7;++o){var h=a.getTextureResourceId(o);if(-1!=h){var l=i.getResource(h);l&&l.isVideoTexture()&&l.updateVideoTexture()}}for(var m=r.getRightDir(),c=r.getUpDir(),u=V.vec3(),f=V.vec3(),d=V.array(),v=this.aParticles.getRoot();v;){var g=v.data,p=.5*g.s.x,x=.5*g.s.y;u.x=m.x*p,u.y=m.y*p,u.z=m.z*p,f.x=c.x*x,f.y=c.y*x,f.z=c.z*x,d.push(g.m.m03-u.x+f.x,g.m.m13-u.y+f.y,g.m.m23-u.z+f.z,g.m.m03-u.x-f.x,g.m.m13-u.y-f.y,g.m.m23-u.z-f.z,g.m.m03+u.x-f.x,g.m.m13+u.y-f.y,g.m.m23+u.z-f.z,g.m.m03+u.x+f.x,g.m.m13+u.y+f.y,g.m.m23+u.z+f.z),v=v.next}this.mesh.loadAttribute("Position",0,4*this.aParticles.getSize()*3,d),V._vec3(m),V._vec3(c),V._vec3(u),V._vec3(f),V._array(d);var y=this.mesh.aAttribArrayBufferList;this.aAttribFmt.Position.buf=y.Position,this.aAttribFmt.Color.buf=y["Color/Texcoord1/Texcoord2"],this.aAttribFmt.Texcoord1.buf=y["Color/Texcoord1/Texcoord2"],this.aAttribFmt.Texcoord2.buf=y["Color/Texcoord1/Texcoord2"],s.aAttribFmt.Position=this.aAttribFmt.Position,s.aAttribFmt.Color=this.aAttribFmt.Color,s.aAttribFmt.Texcoord1=this.aAttribFmt.Texcoord1,s.aAttribFmt.Texcoord2=this.aAttribFmt.Texcoord2,s.index=n.aIndexArrayBufferList.Default,s.iDrawMode=4,s.iDrawStart=0,s.iDrawCount=6*this.aParticles.getSize(),s.materialRef=a;var _=S.MAT43_I;s.mMatRef=_,s.mMatNRef=S.MAT43_I,s.aDctLightListRef=this.__aDctLightList,s.aPointLightListRef=this.__aPointLightList,s.aSpotLightListRef=this.__aSpotLightList,s.bboxRef=this.bbox,s.bReceiveShadow=!1,t.push(s)}},ie.prototype.activate=function(t){if(this.bActive=t,this.bActive=!1){for(var e=this.aParticles.getRoot();e;){var i=e.data;V._particle(i),e=e.next}this.aParticles.clear(),this.fEmitLastTime=this.fEmitCycle}},ie.prototype.isActive=function(){return this.bActive},z(re,Qt),re.prototype.clear=function(){D(this,"clear")},re.prototype.setLightDir=function(t,e,i){var r=V.vec3();null==e?(r.x=-t.x,r.y=-t.y,r.z=-t.z):(r.x=-t,r.y=-e,r.z=-i),this.setDir(3,r),V._vec3(r)},re.prototype.getLightDir=function(){var t=this.mMat.getColumn(2);return t.x=-t.x,t.y=-t.y,t.z=-t.z,t},z(ne,Qt),ne.prototype.clear=function(){this.fRange=10,D(this,"clear")},ne.prototype.setRange=function(t){this.fRange=t,this.bBBoxDirty=!0,this.zone.dirtyEntity(this)},ne.prototype.getRange=function(){return this.fRange},ne.prototype.isAffectEntity=function(t){var e=t.getPos(),i=this.mMat.getColumn(3);return(e.x-i.x)*(e.x-i.x)+(e.y-i.y)*(e.y-i.y)+(e.z-i.z)*(e.z-i.z)<=this.fRange*this.fRange},z(ae,Qt),ae.prototype.clear=function(){this.fRange=10,this.fInnerCone=60*Math.PI/180,this.fOuterCone=75*Math.PI/180,this.bFrustumDirty=!0,D(this,"clear")},ae.prototype.setLightDir=function(t,e,i){var r=V.vec3();null==e?(r.x=-t.x,r.y=-t.y,r.z=-t.z):(r.x=-t,r.y=-e,r.z=-i),this.setDir(3,r),V._vec3(r)},ae.prototype.getLightDir=function(){var t=this.mMat.getColumn(2);return t.x=-t.x,t.y=-t.y,t.z=-t.z,t},ae.prototype.setRange=function(t){this.fRange=t,this.bBBoxDirty=!0,this.bFrustumDirty=!0,this.zone.dirtyEntity(this)},ae.prototype.getRange=function(){return this.fRange},ae.prototype.setInnerCone=function(t){var e=t*Math.PI/180;this.fInnerCone=e,this.bFrustumDirty=!0},ae.prototype.getInnerCone=function(){return 180*this.fInnerCone/Math.PI},ae.prototype.setOuterCone=function(t){var e=t*Math.PI/180;this.fOuterCone=e,this.bFrustumDirty=!0},ae.prototype.getOuterCone=function(){return 180*this.fOuterCone/Math.PI},ae.prototype.getLightFrustum=function(){if(this.bFrustumDirty){var t=rt(ot(180*this.fOuterCone/Math.PI,1,.01,this.fRange),this.getInvMat4());this.frustum.setByViewProjMat(t),this.bFrustumDirty=!1}return this.frustum},ae.prototype.isAffectEntity=function(t){return 0!=this.getLightFrustum().collideAABBox(t.getBoundingBox())},ae.prototype.dirtyMatFunc=function(){this.bFrustumDirty=!0},se.prototype={clear:function(){this.parent=null,this.iParentIdx=-1;for(var t=0;t<8;++t)this.aChildrenList[t]&&this.deleteChild(t);this.bbox.set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[0].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[1].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[2].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[3].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[4].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[5].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[6].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aChildrenBBox[7].set(S.VEC3_ZERO,S.VEC3_ZERO),this.aEntityList.clear(),this.iLevel=0},setBoundingBox:function(t){t.clone(this.bbox);var e=.5*(t.vMin.x+t.vMax.x),i=.5*(t.vMin.y+t.vMax.y),r=.5*(t.vMin.z+t.vMax.z),n=V.vec3(),a=V.vec3();n.x=t.vMin.x,n.y=t.vMin.y,n.z=t.vMin.z,a.x=e,a.y=i,a.z=r,this.aChildrenBBox[0].set(n,a),n.x=e,n.y=t.vMin.y,n.z=t.vMin.z,a.x=t.vMax.x,a.y=i,a.z=r,this.aChildrenBBox[1].set(n,a),n.x=t.vMin.x,n.y=t.vMin.y,n.z=r,a.x=e,a.y=i,a.z=t.vMax.z,this.aChildrenBBox[2].set(n,a),n.x=e,n.y=t.vMin.y,n.z=r,a.x=t.vMax.x,a.y=i,a.z=t.vMax.z,this.aChildrenBBox[3].set(n,a),n.x=t.vMin.x,n.y=i,n.z=t.vMin.z,a.x=e,a.y=t.vMax.y,a.z=r,this.aChildrenBBox[4].set(n,a),n.x=e,n.y=i,n.z=t.vMin.z,a.x=t.vMax.x,a.y=t.vMax.y,a.z=r,this.aChildrenBBox[5].set(n,a),n.x=t.vMin.x,n.y=i,n.z=r,a.x=e,a.y=t.vMax.y,a.z=t.vMax.z,this.aChildrenBBox[6].set(n,a),n.x=t.vMin.x,n.y=i,n.z=r,a.x=t.vMax.x,a.y=t.vMax.y,a.z=t.vMax.z,this.aChildrenBBox[7].set(n,a),V._vec3(n),V._vec3(a)},createChild:function(t){return null!=this.aChildrenList[t]||(this.iChildCount+=1),this.aChildrenList[t]},deleteChild:function(t){null!=this.aChildrenList[t]&&(this.aChildrenList[t].clear(),V._sceneNode(this.aChildrenList[t]),this.aChildrenList[t]=null,this.iChildCount-=1)},getChild:function(t){return this.aChildrenList[t]},getChildNum:function(){return this.iChildCount},attachEntity:function(t){this.aEntityList.pushBack(t)},removeEntity:function(t){this.aEntityList.remove(this.aEntityList.find(t))},getEntityNum:function(){return this.aEntityList.getSize()},getBoundingBox:function(){return this.bbox},traverseTree:function(t){var e=new Array;for(e.push(this);0!=e.length;){for(var i=e.shift(),r=0;r<8;++r)null!=i.aChildrenList[r]&&e.push(i.aChildrenList[r]);t(i)}}},oe.prototype={clear:function(){var t;for(this.iMaxLevel=4,this.iGranularity=1,this.rootNode.clear(),this.aLightList.clear(),V._object(this.aDirtyEntityMap),this.aDirtyEntityMap=V.object(),this.aUpdateEntityList.clear(),this.aEntityList.resetIterator();t=this.aEntityList.iterate();)t.clear();this.aEntityList.clear(),this.aForceVisibleEntityMap=new Object},setName:function(t){this.sName=t},getName:function(t){return this.sName},getScene:function(){return this.scene},getRootNode:function(){return this.rootNode},setBoundingBox:function(t,e){var i;for(this.rootNode.clear(),this.rootNode.setBoundingBox(t,e),this.aEntityList.resetIterator();i=this.aEntityList.iterate();)i.__aSceneNodeList.clear(),this.aDirtyEntityMap[i.getId()]=i},getBoundingBox:function(){return this.rootNode.getBoundingBox()},setMaxLevel:function(t){this.iMaxLevel=t},getMaxLevel:function(){return this.iMaxLevel},setGranularity:function(t){this.iGranularity=t},getGranularity:function(){return this.iGranularity},createEntity:function(t){var e=null;switch(t){case 1:e=new Jt(this);break;case 2:e=new te(this);break;case 256:e=new ie(this);break;case 4:e=new re(this),this.aLightList.pushBack(e);break;case 8:e=new ne(this),this.aLightList.pushBack(e);break;case 16:e=new ae(this),this.aLightList.pushBack(e);break;case 512:e=new $t(this)}if(e.setId(this.aEntityList.add(e)),e.__iSceneVisitFlag=-1,0!=(483&t)&&(e.__aSceneNodeList=new w,e.addSceneNode=function(t){this.__aSceneNodeList.pushBack(t)},e.removeSceneNode=function(t){this.__aSceneNodeList.remove(this.__aSceneNodeList.find(t))},this._addEntityToTree(this.rootNode,e)),0!=(258&t)&&this.aUpdateEntityList.pushBack(e),0!=(483&t)){e.__aDctLightList=new w,e.__aPointLightList=new w,e.__aSpotLightList=new w,e.addLight=function(t){4==t.iType?this.__aDctLightList.pushBack(t):8==t.iType?this.__aPointLightList.pushBack(t):16==t.iType&&this.__aSpotLightList.pushBack(t)},e.removeLight=function(t){4==t.iType?this.__aDctLightList.remove(this.__aDctLightList.find(t)):8==t.iType?this.__aPointLightList.remove(this.__aPointLightList.find(t)):16==t.iType&&this.__aSpotLightList.remove(this.__aSpotLightList.find(t))},e.findLight=function(t){return 4==t.iType?null!=this.__aDctLightList.find(t):8==t.iType?null!=this.__aPointLightList.find(t):16==t.iType?null!=this.__aSpotLightList.find(t):void 0},e.clearLight=function(){this.__aDctLightList.clear(),this.__aPointLightList.clear(),this.__aSpotLightList.clear()};for(var i=this.aLightList.getRoot();i;){(r=i.data).isAffectEntity(e)&&e.addLight(r),r.addAffectEntity(e),i=i.next}}else{var r,n;if(0!=(28&t))for((r=e).__aAffectEntityList=new w,r.addAffectEntity=function(t){r.__aAffectEntityList.pushBack(t)},r.removeAffectEntity=function(t){r.__aAffectEntityList.remove(r.__aAffectEntityList.find(t))},r.findAffectEntity=function(t){return null!=r.__aAffectEntityList.find(t)},r.clearAffectEntity=function(){r.__aAffectEntityList.clear()},this.aEntityList.resetIterator();n=this.aEntityList.iterate();)0!=(483&n.iType)&&r.isAffectEntity(n)&&(n.addLight(r),r.addAffectEntity(n))}return e},deleteEntity:function(t){var e,i=t;if(P(t))i=this.aEntityList.getDataByIndex(t);else if(E(t))for(this.aEntityList.resetIterator();e=this.aEntityList.iterate();)if(e.sName==t){i=e;break}if(0!=(28&i.iType)){for(var r=i,n=r.__aAffectEntityList.getRoot();n;)n.data.removeLight(r),n=n.next;r.clearAffectEntity(),this.aLightList.remove(this.aLightList.find(r))}else{0!=(483&i.iType)&&this._removeEntityFromTree(i);for(n=i.__aDctLightList.getRoot();n;)n.data.removeAffectEntity(i),n=n.next;for(n=i.__aPointLightList.getRoot();n;)n.data.removeAffectEntity(i),n=n.next;for(n=i.__aSpotLightList.getRoot();n;)n.data.removeAffectEntity(i),n=n.next;i.clearLight()}null!=this.aDirtyEntityMap[i.getId()]&&delete this.aDirtyEntityMap[i.getId()],0!=(258&i.iType)&&this.aUpdateEntityList.remove(this.aUpdateEntityList.find(i)),this.aEntityList.removeByIndex(i.getId())},getEntity:function(t){if(P(t))return this.aEntityList.getDataByIndex(t);var e;if(E(t))for(this.aEntityList.resetIterator();e=this.aEntityList.iterate();)if(e.sName==t)return e;return null},getEntityArray:function(t,e,i){var r;for(t=null!=t?t:V.array(),e=null!=e?e:-1,this.aEntityList.resetIterator();r=this.aEntityList.iterate();)if(e&r.iType){if(i&&!i(r))continue;t.push(r)}return t},dirtyEntity:function(t){var e=t.getId();null==this.aDirtyEntityMap[e]&&(this.aDirtyEntityMap[e]=t)},forceVisibleEntity:function(t,e){e?this.aForceVisibleEntityMap[t.getId()]=t.getId():this.aForceVisibleEntityMap[t.getId()]&&delete this.aForceVisibleEntityMap[t.getId()]},pick:function(t,e,i,r){null==i&&(i=-1),this._upDE(),this.iCurVisitFlag+=1;var n=null,a=1e10,s=new Object;if(null==r)for(var o=[this.rootNode];0!=o.length;){for(var h=(m=o.shift()).aEntityList.getRoot();h;){(c=h.data).__iSceneVisitFlag<this.iCurVisitFlag&&(1!=c.getState()&&0!=c.getBoundingBox().collideRay(t,e,s)&&c.iType&i&&s.fT0>0&&s.fT0<a&&(n=c,a=s.fT0),c.__iSceneVisitFlag=this.iCurVisitFlag),h=h.next}for(var l=0;l<8;++l){if(null!=m.aChildrenList[l])0!=m.aChildrenBBox[l].collideRay(t,e)&&o.push(m.aChildrenList[l])}}else for(o=[this.rootNode];0!=o.length;){var m;for(h=(m=o.shift()).aEntityList.getRoot();h;){var c;(c=h.data).__iSceneVisitFlag<this.iCurVisitFlag&&(1!=c.getState()&&0!=c.getBoundingBox().collideRay(t,e,s)&&c.iType&i&&r(c)&&s.fT0>0&&s.fT0<a&&(n=c,a=s.fT0),c.__iSceneVisitFlag=this.iCurVisitFlag),h=h.next}for(l=0;l<8;++l){if(null!=m.aChildrenList[l])0!=m.aChildrenBBox[l].collideRay(t,e)&&o.push(m.aChildrenList[l])}}return n},update:function(t){for(var e=this.aUpdateEntityList.getRoot();e;)e.data.update(t),e=e.next},_logTree:function(t){this._upDE();var e=new Array;for(e.push(null!=t?t:this.rootNode);0!=e.length;){for(var i=e.pop(),r="",n=0;n<i.iLevel;++n)r+="________";r+="[Min:"+i.bbox.vMin.x+","+i.bbox.vMin.y+","+i.bbox.vMin.z+"  Max:"+i.bbox.vMax.x+","+i.bbox.vMax.y+","+i.bbox.vMax.z+"]",r+="[E:";for(var a=!0,s=i.aEntityList.getRoot();s;)a||(r+=","),a=!1,r+=s.data.getId(),s=s.next;r+="]",window.console.log(r);for(n=0;n<i.aChildrenList.length;++n)null!=i.aChildrenList[n]&&e.push(i.aChildrenList[n])}},_addEntityToTree:function(t,e){var i=e.getBoundingBox();if(t.iLevel==this.iMaxLevel||1!=i.collideAABBox(t.bbox))return t.attachEntity(e),void e.addSceneNode(t);if(t.aEntityList.getSize()<=this.iGranularity&&0==t.getChildNum())return t.attachEntity(e),e.addSceneNode(t),void(t.aEntityList.getSize()>this.iGranularity&&this._splitNode(t));for(var r=0;r<8;++r){var n=t.aChildrenBBox[r].collideAABBox(i);if(1==n)this._addEntityToTree(t.createChild(r),e);else if(2==n){this._addEntityToTree(t.createChild(r),e);break}}},_splitNode:function(t){for(var e=new Array,i=t.aEntityList.getRoot();i;){var r=i.data,n=r.getBoundingBox();if(1!=n.collideAABBox(t.bbox))e.push(r),i=i.next;else{r.removeSceneNode(t);var a=i.next;t.aEntityList.remove(i),i=a;for(var s=0;s<8;++s){var o=t.aChildrenBBox[s].collideAABBox(n);if(1==o)this._addEntityToTree(t.createChild(s),r);else if(2==o){this._addEntityToTree(t.createChild(s),r);break}}}}t.aEntityList.clear();for(var h=0;h<e.length;++h)t.aEntityList.pushBack(e[h])},_removeEntityFromTree:function(t){for(var e=t.__aSceneNodeList.getRoot();e;){var i=e.data;if(i.removeEntity(t),0==i.aEntityList.getSize()&&0==i.getChildNum())for(var r=i;null!=r;){var n=r.parent;null!=n?(n.deleteChild(r.iParentIdx),r=0==n.getEntityNum()&&0==n.getChildNum()?n:null):r=null}e=e.next}t.__aSceneNodeList.clear()},_upDE:function(){var t=new Array;for(var e in this.aDirtyEntityMap){var i=this.aDirtyEntityMap[e];t.push(i),0==(28&i.iType)&&this._removeEntityFromTree(i),delete this.aDirtyEntityMap[e]}for(var r=t.length,n=0;n<r;++n){0==(28&(i=t[n]).iType)&&this._addEntityToTree(this.rootNode,i),this._evalLE(i)}},_evalLE:function(t){var e=t.getType();if(0!=(28&e)){for(var i=(n=t).__aAffectEntityList.getRoot();i;)i.data.removeLight(n),i=i.next;n.clearAffectEntity(),this.aEntityList.resetIterator()}else if(0!=(483&e)){for(var r=t.__aDctLightList.getRoot();r;){(n=r.data).removeAffectEntity(t),r=r.next}for(r=t.__aPointLightList.getRoot();r;){(n=r.data).removeAffectEntity(t),r=r.next}for(r=t.__aSpotLightList.getRoot();r;){(n=r.data).removeAffectEntity(t),r=r.next}for(t.clearLight(),r=this.aLightList.getRoot();r;){var n;(n=r.data).isAffectEntity(t)&&(t.addLight(n),n.addAffectEntity(t)),r=r.next}}},_dumpTree:function(t,e){var i=V.array();for(i.push(t);0!=i.length;){for(var r=i.shift(),n=r.aEntityList.getRoot();n;){var a=n.data;a.__iSceneVisitFlag<this.iCurVisitFlag&&(1!=a.getState()&&e.push(a),a.__iSceneVisitFlag=this.iCurVisitFlag),n=n.next}for(var s=0;s<8;++s)null!=r.aChildrenList[s]&&i.push(r.aChildrenList[s])}V._array(i)}},he.prototype={clear:function(){this.clearEntity(),this.clearCamera()},clearEntity:function(){for(var t in this.aZoneList)this.aZoneList[t].clear();V._object(this.aZoneList),this.aZoneList=V.object();var e=new oe(this);e.setName("Default"),this.aZoneList.Default=e},clearCamera:function(){this.aCameraList.clear()},getName:function(){return this.sName},setBaseUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/\/$/g,""),this.sBasePath=t},getBaseUrl:function(t){return this.sBasePath},setModelUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/\/$/g,""),this.sModelPath=t},_packModelUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/^\/+/g,"");var e=this.sBasePath;return e+=""!=e?"/"+this.sModelPath:this.sModelPath,e+=""!=e?"/"+t:t},getModelUrl:function(){return this.sModelPath},setSkAnimationUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/\/$/g,""),this.sAnimationPath=t},getSkAnimationUrl:function(){return this.sAnimationPath},_packSkAnimationUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/^\/+/g,"");var e=this.sBasePath;return e+=""!=e?"/"+this.sAnimationPath:this.sAnimationPath,e+=""!=e?"/"+t:t},setTerrainUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/\/$/g,""),this.sTerrainPath=t},getTerrainUrl:function(){return this.sTerrainPath},_packTerrainUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/^\/+/g,"");var e=this.sBasePath;return e+=""!=e?"/"+this.sTerrainPath:this.sTerrainPath,e+=""!=e?"/"+t:t},setTextureUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/\/$/g,""),this.sTexturePath=t},getTextureUrl:function(){return this.sTexturePath},_packTextureUrl:function(t){t=(t=t.replace(/\\/g,"/")).replace(/^\/+/g,"");var e=this.sBasePath;return e+=""!=e?"/"+this.sTexturePath:this.sTexturePath,e+=""!=e?"/"+t:t},getZone:function(t){return this.aZoneList[null!=t?t:"Default"]},setZoneBoundingBox:function(t,e,i){this.aZoneList[null!=i?i:"Default"].setBoundingBox(new bt(t,e))},getZoneBoundingBox:function(t){return this.aZoneList[null!=t?t:"Default"].getBoundingBox()},setZoneGranularity:function(t,e){this.aZoneList[null!=e?e:"Default"].setGranularity(t)},getZoneGranularity:function(t){return this.aZoneList[null!=t?t:"Default"].getGranularity()},setZoneMaxLevel:function(t,e){this.aZoneList[null!=e?e:"Default"].setMaxLevel(t)},getZoneMaxLevel:function(t){return this.aZoneList[null!=t?t:"Default"].getMaxLevel()},createCamera:function(t){var e=new Rt(this.resourceManager.rc);return null!=t&&e.setName(t),this.aCameraList.pushBack(e),e},deleteCamera:function(t){if(E(t))for(var e=this.aCameraList.getRoot();e;){if(e.data.getName()==t)return void this.aCameraList.remove(e);e=e.next}else this.aCameraList.remove(this.aCameraList.find(t))},getCamera:function(t){for(var e=this.aCameraList.getRoot();e;){if(e.data.getName()==t)return e.data;e=e.next}return null},getCameraArray:function(t,e){for(var i=this.aCameraList.getRoot();i;)(null==e||e(i.data))&&t.push(i.data),i=i.next;return null},createEntity:function(t,e,i){var r=this.aZoneList[null!=i?i:"Default"].createEntity(t);return e&&r.setName(e),r},deleteEntity:function(t,e){return this.aZoneList[null!=e?e:"Default"].deleteEntity(t)},getEntity:function(t,e){return this.aZoneList[null!=e?e:"Default"].getEntity(t)},getEntityArray:function(t,e,i,r){return this.aZoneList[null!=r?r:"Default"].getEntityArray(t,e,i)},cullByFrustum:function(t,e,i,r,n){return this.aZoneList[null!=n?n:"Default"].cullByFrustum(t,e,i,r)},pick:function(t,e,i,r,n){return this.aZoneList[null!=n?n:"Default"].pick(t,e,i,r)},update:function(t,e){this.aZoneList[null!=e?e:"Default"].update(t)}},le.prototype={clear:function(){for(var t in this.aSceneList)this.aSceneList[t].clear();V._object(this.aSceneList),this.aSceneList=V.object()},createScene:function(t){var e=this.aSceneList[t];return e||(e=new he(t,this.resourceManager),this.aSceneList[t]=e),e},deleteScene:function(t){var e=this.aSceneList[t];e&&(e.clear(),delete this.aSceneList[t])},getScene:function(t){return this.aSceneList[t]}},me.prototype={clear:function(){this.data&&(1==this.iType?this.data.clear():2==this.iType?this.data.releaseTexture():3==this.iType&&this.data.clear(),this.data=null),this.iType=0,this.sKey=null,this.iRef=0,this.iState=1,this.bCustom=!1,this.aListenerList.clear()}},ce.prototype={clear:function(){var t;for(this.aResList.resetIterator();t=this.aResList.iterate();)t.clear();this.aResList.clear(),V._object(this.aKeyIdMap),this.aKeyIdMap=V.object()},getResourceType:function(t){return this.aResList.isIndexValid(t)?this.aResList.getDataByIndex(t).iType:0},getResourceState:function(t){return this.aResList.isIndexValid(t)?this.aResList.getDataByIndex(t).iState:1},getResourceNum:function(){return this.aResList.getSize()},setCustomResourceState:function(t,e){if(!this.aResList.isIndexValid(t))return!1;var i=this.aResList.getDataByIndex(t);return!!i.bCustom&&(i.iState=e,!0)},createResource:function(t,e,i){var r,n=this.aKeyIdMap[e];if(null!=n)return(r=this.aResList.getDataByIndex(n)).iRef+=1,n;(r=new me).iType=t,r.iRef=1,r.iState=1==i?5:2,r.sKey=e,r.bCustom=1==i,1==t?r.data=new Vt(this.rc):2==t?r.data=new kt(this.rc):3==t&&(r.data=new It);var a=this.aResList.add(r);return this.aKeyIdMap[e]=a,a},getResource:function(t){if(P(t))return t<0?null:this.aResList.getDataByIndex(t).data;var e=this.aKeyIdMap[t];return null!=e?this.aResList.getDataByIndex(e).data:null},getResourceId:function(t){return null!=this.aKeyIdMap[t]?this.aKeyIdMap[t]:-1},deleteResource:function(t){var e=null,i=-1;if(P(t))e=this.aResList.getDataByIndex(t),i=t;else{var r=this.aKeyIdMap[t];null!=r&&(e=this.aResList.getDataByIndex(r),i=r)}e&&(e.iRef-=1,0==e.iRef&&(delete this.aKeyIdMap[e.sKey],e.clear(),this.aResList.removeByIndex(i),this.postMessage(i,"RES_DELETED",[i])))},registerListener:function(t,e){if(this.aResList.isIndexValid(t)){var i=this.aResList.getDataByIndex(t);null==i.aListenerList.find(e)&&i.aListenerList.pushBack(e)}},removeListener:function(t,e){if(this.aResList.isIndexValid(t)){var i=this.aResList.getDataByIndex(t);i.aListenerList.remove(i.aListenerList.find(e))}},loadModelByText:function(t,e){if(!this.aResList.isIndexValid(t))return!1;var i=this.aResList.getDataByIndex(t);return 1==i.iType&&!i.bCustom&&(3!=i.iState&&(i.iState=3,Ct.loadModel(1,i.data,e,!0,!0)?(i.iState=5,this.postMessage(t,"RES_READY",[t])):i.iState=2,!0))},loadSkAnimationByUrl:function(t,e,i){if(!this.aResList.isIndexValid(t))return!1;var r=this.aResList.getDataByIndex(t);return 3==r.iType&&!r.bCustom},loadSkAnimationByText:function(t,e){if(!this.aResList.isIndexValid(t))return!1;var i=this.aResList.getDataByIndex(t);return 3==i.iType&&!i.bCustom&&(3!=i.iState&&(i.iState=3,Ct.loadSkAnimation(1,i.data,e)?(i.iState=5,this.postMessage(t,"RES_READY",[t])):i.iState=2,!0))},loadTextureByUrl:function(t,e,i){if(!this.aResList.isIndexValid(t))return!1;var r=this.aResList.getDataByIndex(t);if(0==r.iType&&(r.iType=2,r.data=new kt(this.rc)),2!=r.iType||r.bCustom)return!1;if(3==r.iState)return!1;r.iState=3;var n=this,a=function(t){var e=t.lastIndexOf(".");return t.substring(e+1,t.length)}(e);if("mp4"!=a&&"ogg"!=a&&"ogv"!=a){var s=new Image;s.onload=function(){Ct.loadTextureFromImage(r.data,s,i),r.data.genMipMap(),r.iState=5,n.postMessage(t,"RES_READY",[t])},s.onerror=function(){r.iState=2},s.src=e}else{var o=e;(e=e.substring(0,e.lastIndexOf("."))).replace("\\","/"),e=e.substring(e.lastIndexOf("/")+1,e.length);var h=document.getElementById(e);h||((h=document.createElement("video")).src=o,h.id=e,h.autoplay=!0,h.preload="auto",h.loop=!0,r.data.video=h),h.addEventListener("error",(function(t){r.iState=2}),!1),h.addEventListener("ended",(function(t){h.play()}),!1)}return!0},loadTextureByImage:function(t,e,i){if(!this.aResList.isIndexValid(t))return!1;var r=this.aResList.getDataByIndex(t);return 0==r.iType&&(r.iType=2,r.data=new kt(this.rc)),2==r.iType&&!r.bCustom&&(3!=r.iState&&(r.iState=3,Ct.loadTextureFromImage(r.data,e,i),r.data.genMipMap(),r.iState=5,this.postMessage(t,"RES_READY",[t]),!0))},loadTextureByVideo:function(t,e,i){if(!this.aResList.isIndexValid(t))return!1;var r=this.aResList.getDataByIndex(t);return 0==r.iType&&(r.iType=2,r.data=new kt(this.rc)),2==r.iType&&!r.bCustom&&(3!=r.iState&&(r.iState=3,Ct.loadTextureFromVideo(r.data,e,i),r.data.video=e,r.iState=5,this.postMessage(t,"RES_READY",[t]),!0))},loadCubeTextureByUrl:function(t,e,i,r,n,a,s,o){if(!this.aResList.isIndexValid(t))return!1;var h=this.aResList.getDataByIndex(t);if(0==h.iType&&(h.iType=2,h.data=new kt(this.rc)),2!=h.iType||h.bCustom)return!1;if(3==h.iState)return!1;h.iState=3;var l=h.data,m=this,c=new Image;c.onerror=function(){h.iState=2};var u=new Image;u.onerror=function(){h.iState=2};var f=new Image;f.onerror=function(){h.iState=2};var d=new Image;d.onerror=function(){h.iState=2};var v=new Image;v.onerror=function(){h.iState=2};var g=new Image;return g.onerror=function(){h.iState=2},c.onload=function(){u.onload=function(){f.onload=function(){d.onload=function(){v.onload=function(){g.onload=function(){l.createTexture(34067,c.width,c.height,6408,5121,c,u,f,d,v,g),l.genMipMap(),h.iState=5,m.postMessage(t,"RES_READY",[t])},g.src=s},v.src=a},d.src=n},f.src=r},u.src=i},c.src=e,!0},postMessage:function(t,e,i){if(!this.aResList.isIndexValid(t))return!1;var r=new Object;r.sMsg=e,r.aArgs=i.slice();for(var n=this.aResList.getDataByIndex(t).aListenerList.getRoot();n;)n.data.onMessage(r),n=n.next}},ue.prototype={clear:function(){for(var t in this.sFloatPrecision="mediump",this.aVertexShaderMap)this.aVertexShaderMap[t].releaseShader(),this.aVertexShaderMap[t].releaseSource();for(var e in V._object(this.aVertexShaderMap),this.aVertexShaderMap=V.object(),this.aFragmentShaderMap)this.aFragmentShaderMap[e].releaseShader(),this.aFragmentShaderMap[e].releaseSource();for(var i in V._object(this.aFragmentShaderMap),this.aFragmentShaderMap=V.object(),this.aProgramMap)this.aProgramMap[i].releaseProgram();V._object(this.aProgramMap),this.aProgramMap=V.object()},setShaderSourcePath:function(t){this.sShaderSourcePath=t},getProgram:function(t,e,i){switch(t){case"Lighting":return this.getLightingProgram(e,i);case"Depth":return this.getDepthProgram(e,i);case"Glow":return this.getGlowProgram(e,i);case"ShadowDepth":return this.getShadowDepthProgram(e,i);case"ShadowVolume":return this.getShadowVolumeProgram();case"ShadowFinal":return this.getShadowFinalProgram();case"Output":return this.getOutputProgram()}},getFlatColorProgram:function(t){var e=this.aProgramMap.Fl;if(null!=e)return e;var i=this.aVertexShaderMap.Fl,r=this.aFragmentShaderMap.Fl;if(null==i||null==r){var n=null,a=null;null==i&&(n=new Bt(this.rc,35633)),null==r&&(a=new Bt(this.rc,35632));var s=new Object;s.sVs=n,s.sFs=a,this._getSrc("FlatColor",s);var o=new Object;o.TEX=t?1:0,null==i&&(n.compile(o),this.aVertexShaderMap.Fl=n,i=n),null==r&&(a.setFloatPrecision(this.sFloatPrecision),a.compile(o),this.aFragmentShaderMap.Fl=a,r=a)}var h=new wt(this.rc);return h.attachVertexShader(i),h.attachFragmentShader(r),h.link(),this.aProgramMap.Fl=h,h},getOutputProgram:function(){var t=this.aProgramMap.Op;if(null!=t)return t;var e=this.aVertexShaderMap.Op,i=this.aFragmentShaderMap.Op;if(null==e||null==i){var r=null,n=null;null==e&&(r=new Bt(this.rc,35633)),null==i&&(n=new Bt(this.rc,35632));var a=new Object;a.sVs=r,a.sFs=n,this._getSrc("Output",a),null==e&&(r.compile(),this.aVertexShaderMap.Op=r,e=r),null==i&&(n.setFloatPrecision(this.sFloatPrecision),n.compile(),this.aFragmentShaderMap.Op=n,i=n)}var s=new wt(this.rc);return s.attachVertexShader(e),s.attachFragmentShader(i),s.link(),this.aProgramMap.Op=s,s},getGaussianProgram:function(t){var e="Gau"+t,i=this.aProgramMap[e];if(null!=i)return i;var r=e,n=this.aVertexShaderMap.Gau,a=this.aFragmentShaderMap[r];if(null==n||null==a){var s=new Object;0==t?s.OK_HORIZONTAL=1:s.OK_VERTICAL=1;var o=null,h=null;null==n&&(o=new Bt(this.rc,35633)),null==a&&(h=new Bt(this.rc,35632));var l=new Object;l.sVs=o,l.sFs=h,this._getSrc("GaussianFilter",l),null==n&&(o.compile(s),this.aVertexShaderMap.Gau=o,n=o),null==a&&(h.setFloatPrecision(this.sFloatPrecision),h.compile(s),this.aFragmentShaderMap[r]=h,a=h)}var m=new wt(this.rc);return m.attachVertexShader(n),m.attachFragmentShader(a),m.link(),this.aProgramMap[e]=m,m},getDefaultDepthProgram:function(){var t="DeD",e=this.aProgramMap[t];if(null!=e)return e;var i=this.aVertexShaderMap[t],r=this.aFragmentShaderMap[t];if(null==i||null==r){var n=null,a=null;null==i&&(n=new Bt(this.rc,35633)),null==r&&(a=new Bt(this.rc,35632));var s=new Object;s.sVs=n,s.sFs=a,this._getSrc("DepthDefault",s),null==i&&(n.compile(),this.aVertexShaderMap[t]=n,i=n),null==r&&(a.setFloatPrecision(this.sFloatPrecision),a.compile(),this.aFragmentShaderMap[t]=a,r=a)}var o=new wt(this.rc);return o.attachVertexShader(i),o.attachFragmentShader(r),o.link(),this.aProgramMap[t]=o,o},getDepthProgram:function(t,e){var i,r,n,a=e.materialRef,s=e.aAttribFmt,o=e.aBoneMatList?1:0,h=e.bFaceCamera?1:0,l=0;if(a.bAlphaTest){for(var m=a.bAlphaScript?a.getPackedAlphaScript():"",c=a.bNormalScript?a.getPackedNormalScript():"",u=0,f=0;f<7;++f)""!=a.aTextureList[f]&&(u+=2<<2*f,34067==a.aTextureTypeList[0]&&(u+=2<<2*f+1));var d=s.Texcoord1,v=s.Texcoord2,g=s.Texcoord3,p=s.Texcoord4;l=(d?1:0)+(v?2:0)+(g?4:0)+(p?8:0)+(d&&v&&d.iIdx==v.iIdx-1?16:0)+(g&&p&&g.iIdx==p.iIdx-1?32:0);var x=""+(""!=a.aUvAttribList[0]?a.aUvAttribList[0].charAt(8):0)+(""!=a.aUvAttribList[1]?a.aUvAttribList[1].charAt(8):0)+(""!=a.aUvAttribList[2]?a.aUvAttribList[2].charAt(8):0)+(""!=a.aUvAttribList[3]?a.aUvAttribList[3].charAt(8):0)+(""!=a.aUvAttribList[4]?a.aUvAttribList[4].charAt(8):0)+(""!=a.aUvAttribList[5]?a.aUvAttribList[5].charAt(8):0)+(""!=a.aUvAttribList[6]?a.aUvAttribList[6].charAt(8):0),y=s["Position/Normal"]||s.Normal?1:0,_=""!=a.aTextureList[4]?1:0,M=""+(a.bVertexColor?1:0)+(s.Color?1:0),T=a.bTwoSide?1:0;if(i="De"+(a.bAlphaTest?1:0)+"_"+u+"_"+l+"_"+x+"_"+y+(a.bBlend?1:0)+M+o+T+h+"_"+m+"_"+c,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="De1_"+l+"_"+y+_+(s.Color?1:0)+o+h,n=i}else{var b;if(i="De0_"+o+h,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="De0_"+o+h,n="De0"}var A=this.aVertexShaderMap[r],L=this.aFragmentShaderMap[n];if(null==A||null==L){var S=new Object;if(1==o&&(S.OK_SKANIMATION=1),1==h&&(S.OK_BILLBOARD=1),a.bAlphaTest){1==y&&(S.OK_NORMAL=1),s.Color&&(S.OK_VERTEX_COLOR=1),a.bVertexColor&&(S.OK_AUTO_VERTEX_COLOR=1),T&&(S.OK_TWO_SIDE=1),a.bAlphaTest&&(S.OK_ALPHA_TEST=1),""!=a.aTextureList[0]&&(S.OK_TEX_ALBEDO1=1),""!=a.aTextureList[1]&&(S.OK_TEX_ALBEDO2=1),""!=a.aTextureList[2]&&(S.OK_TEX_ALBEDO3=1),""!=a.aTextureList[3]&&(S.OK_TEX_ALBEDO4=1),""!=a.aTextureList[4]&&(S.OK_TEX_NORMALMAP=1),""!=a.aTextureList[5]&&(S.OK_TEX_OPACITY=1),""!=a.aTextureList[6]&&(S.OK_TEX_SPECULAR_LEVEL=1),""!=a.aTangentAttribList[4]&&(S.OK_TANGENT=1),""!=a.aBinormalAttribList[4]&&(S.OK_BINORMAL=1),34067==a.aTextureTypeList[0]&&(S.OK_TEX_ALBEDO1_CUBE=1),34067==a.aTextureTypeList[1]&&(S.OK_TEX_ALBEDO2_CUBE=1),34067==a.aTextureTypeList[2]&&(S.OK_TEX_ALBEDO3_CUBE=1),34067==a.aTextureTypeList[3]&&(S.OK_TEX_ALBEDO4_CUBE=1);var C=new Object;16&l?(S.OK_TC12=1,C.Texcoord1="okVary_TC12.xy",C.Texcoord2="okVary_TC12.zw"):(1&l?(S.OK_TC1=1,C.Texcoord1="okVary_TC1"):C.Texcoord1="vec2(0.0, 0.0)",2&l?(S.OK_TC2=1,C.Texcoord2="okVary_TC2"):C.Texcoord2="vec2(0.0, 0.0)"),32&l?(S.OK_TC34=1,C.Texcoord3="okVary_TC34.xy",C.Texcoord4="okVary_TC34.zw"):(4&l?(S.OK_TC3=1,C.Texcoord3="okVary_TC3"):C.Texcoord3="vec2(0.0, 0.0)",8&l?(S.OK_TC4=1,C.Texcoord4="okVary_TC4"):C.Texcoord4="vec2(0.0, 0.0)"),C[a.aUvAttribList[0]]&&(S.OK_ALBEDO1_TC=C[a.aUvAttribList[0]]),C[a.aUvAttribList[1]]&&(S.OK_ALBEDO2_TC=C[a.aUvAttribList[1]]),C[a.aUvAttribList[2]]&&(S.OK_ALBEDO3_TC=C[a.aUvAttribList[2]]),C[a.aUvAttribList[3]]&&(S.OK_ALBEDO4_TC=C[a.aUvAttribList[3]]),C[a.aUvAttribList[4]]&&(S.OK_NORMALMAP_TC=C[a.aUvAttribList[4]]),C[a.aUvAttribList[5]]&&(S.OK_OPACITY_TC=C[a.aUvAttribList[5]]),C[a.aUvAttribList[6]]&&(S.OK_SPECULAR_LEVEL_TC=C[a.aUvAttribList[6]]),""!=m&&(S.OK_SCRIPT_ALPHA_CODE=m),""!=c&&(S.OK_SCRIPT_NORMAL_CODE=c)}var E=null,O=null;null==A&&(E=new Bt(this.rc,35633)),null==L&&(O=new Bt(this.rc,35632));var P=new Object;if(P.sVs=E,P.sFs=O,this._getSrc("Depth",P),null==A){if(!E.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultDepthProgram();this.aVertexShaderMap[r]=E,A=E}if(null==L){if(O.setFloatPrecision(this.sFloatPrecision),!O.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultDepthProgram();this.aFragmentShaderMap[n]=O,L=O}}var B=new wt(this.rc);return B.attachVertexShader(A),B.attachFragmentShader(L),B.link()?(this.aProgramMap[i]=B,B):this.getDefaultDepthProgram()},getDefaultShadowDepthProgram:function(){var t="ShDD",e=this.aProgramMap[t];if(null!=e)return e;var i=this.aVertexShaderMap[t],r=this.aFragmentShaderMap[t];if(null==i||null==r){var n=null,a=null;null==i&&(n=new Bt(this.rc,35633)),null==r&&(a=new Bt(this.rc,35632));var s=new Object;s.sVs=n,s.sFs=a,this._getSrc("ShadowDepthDefault",s),null==i&&(n.compile(),this.aVertexShaderMap[t]=n,i=n),null==r&&(a.setFloatPrecision(this.sFloatPrecision),a.compile(),this.aFragmentShaderMap[t]=a,r=a)}var o=new wt(this.rc);return o.attachVertexShader(i),o.attachFragmentShader(r),o.link(),this.aProgramMap[t]=o,o},getGlowProgram:function(t,e){var i,r,n,a=e.materialRef,s=e.aAttribFmt,o=e.aBoneMatList?1:0,h=e.bFaceCamera?1:0,l=0;if(a.bAlphaTest){for(var m=a.bAlphaScript?a.getPackedAlphaScript():"",c=a.bNormalScript?a.getPackedNormalScript():"",u=0,f=0;f<7;++f)""!=a.aTextureList[f]&&(u+=2<<2*f,34067==a.aTextureTypeList[0]&&(u+=2<<2*f+1));var d=s.Texcoord1,v=s.Texcoord2,g=s.Texcoord3,p=s.Texcoord4;l=(d?1:0)+(v?2:0)+(g?4:0)+(p?8:0)+(d&&v&&d.iIdx==v.iIdx-1?16:0)+(g&&p&&g.iIdx==p.iIdx-1?32:0);var x=""+(""!=a.aUvAttribList[0]?a.aUvAttribList[0].charAt(8):0)+(""!=a.aUvAttribList[1]?a.aUvAttribList[1].charAt(8):0)+(""!=a.aUvAttribList[2]?a.aUvAttribList[2].charAt(8):0)+(""!=a.aUvAttribList[3]?a.aUvAttribList[3].charAt(8):0)+(""!=a.aUvAttribList[4]?a.aUvAttribList[4].charAt(8):0)+(""!=a.aUvAttribList[5]?a.aUvAttribList[5].charAt(8):0)+(""!=a.aUvAttribList[6]?a.aUvAttribList[6].charAt(8):0),y=s["Position/Normal"]||s.Normal?1:0,_=""!=a.aTextureList[4]?1:0,M=""+(a.bVertexColor?1:0)+(s.Color?1:0),T=a.bTwoSide?1:0;if(i="Gl"+(a.bAlphaTest?1:0)+"_"+u+"_"+l+"_"+x+"_"+y+(a.bBlend?1:0)+M+o+T+h+"_"+m+"_"+c,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="Gl1_"+l+"_"+y+_+(s.Color?1:0)+o+h,n=i}else{var b;if(i="Gl0_"+o+h,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="Gl0_"+o+h,n="Gl0"}var A=this.aVertexShaderMap[r],L=this.aFragmentShaderMap[n];if(null==A||null==L){var S=new Object;if(1==o&&(S.OK_SKANIMATION=1),1==h&&(S.OK_BILLBOARD=1),a.bAlphaTest){1==y&&(S.OK_NORMAL=1),s.Color&&(S.OK_VERTEX_COLOR=1),a.bVertexColor&&(S.OK_AUTO_VERTEX_COLOR=1),T&&(S.OK_TWO_SIDE=1),a.bAlphaTest&&(S.OK_ALPHA_TEST=1),""!=a.aTextureList[0]&&(S.OK_TEX_ALBEDO1=1),""!=a.aTextureList[1]&&(S.OK_TEX_ALBEDO2=1),""!=a.aTextureList[2]&&(S.OK_TEX_ALBEDO3=1),""!=a.aTextureList[3]&&(S.OK_TEX_ALBEDO4=1),""!=a.aTextureList[4]&&(S.OK_TEX_NORMALMAP=1),""!=a.aTextureList[5]&&(S.OK_TEX_OPACITY=1),""!=a.aTextureList[6]&&(S.OK_TEX_SPECULAR_LEVEL=1),""!=a.aTangentAttribList[4]&&(S.OK_TANGENT=1),""!=a.aBinormalAttribList[4]&&(S.OK_BINORMAL=1),34067==a.aTextureTypeList[0]&&(S.OK_TEX_ALBEDO1_CUBE=1),34067==a.aTextureTypeList[1]&&(S.OK_TEX_ALBEDO2_CUBE=1),34067==a.aTextureTypeList[2]&&(S.OK_TEX_ALBEDO3_CUBE=1),34067==a.aTextureTypeList[3]&&(S.OK_TEX_ALBEDO4_CUBE=1);var C=new Object;16&l?(S.OK_TC12=1,C.Texcoord1="okVary_TC12.xy",C.Texcoord2="okVary_TC12.zw"):(1&l?(S.OK_TC1=1,C.Texcoord1="okVary_TC1"):C.Texcoord1="vec2(0.0, 0.0)",2&l?(S.OK_TC2=1,C.Texcoord2="okVary_TC2"):C.Texcoord2="vec2(0.0, 0.0)"),32&l?(S.OK_TC34=1,C.Texcoord3="okVary_TC34.xy",C.Texcoord4="okVary_TC34.zw"):(4&l?(S.OK_TC3=1,C.Texcoord3="okVary_TC3"):C.Texcoord3="vec2(0.0, 0.0)",8&l?(S.OK_TC4=1,C.Texcoord4="okVary_TC4"):C.Texcoord4="vec2(0.0, 0.0)"),C[a.aUvAttribList[0]]&&(S.OK_ALBEDO1_TC=C[a.aUvAttribList[0]]),C[a.aUvAttribList[1]]&&(S.OK_ALBEDO2_TC=C[a.aUvAttribList[1]]),C[a.aUvAttribList[2]]&&(S.OK_ALBEDO3_TC=C[a.aUvAttribList[2]]),C[a.aUvAttribList[3]]&&(S.OK_ALBEDO4_TC=C[a.aUvAttribList[3]]),C[a.aUvAttribList[4]]&&(S.OK_NORMALMAP_TC=C[a.aUvAttribList[4]]),C[a.aUvAttribList[5]]&&(S.OK_OPACITY_TC=C[a.aUvAttribList[5]]),C[a.aUvAttribList[6]]&&(S.OK_SPECULAR_LEVEL_TC=C[a.aUvAttribList[6]]),""!=m&&(S.OK_SCRIPT_ALPHA_CODE=m),""!=c&&(S.OK_SCRIPT_NORMAL_CODE=c)}var E=null,O=null;null==A&&(E=new Bt(this.rc,35633)),null==L&&(O=new Bt(this.rc,35632));var P=new Object;if(P.sVs=E,P.sFs=O,this._getSrc("Glow",P),null==A){if(!E.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultDepthProgram();this.aVertexShaderMap[r]=E,A=E}if(null==L){if(O.setFloatPrecision(this.sFloatPrecision),!O.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultDepthProgram();this.aFragmentShaderMap[n]=O,L=O}}var B=new wt(this.rc);return B.attachVertexShader(A),B.attachFragmentShader(L),B.link()?(this.aProgramMap[i]=B,B):this.getDefaultDepthProgram()},getDefaultGlowProgram:function(){var t="GlD",e=this.aProgramMap[t];if(null!=e)return e;var i=this.aVertexShaderMap[t],r=this.aFragmentShaderMap[t];if(null==i||null==r){var n=null,a=null;null==i&&(n=new Bt(this.rc,35633)),null==r&&(a=new Bt(this.rc,35632));var s=new Object;s.sVs=n,s.sFs=a,this._getSrc("GlowDefault",s),null==i&&(n.compile(),this.aVertexShaderMap[t]=n,i=n),null==r&&(a.setFloatPrecision(this.sFloatPrecision),a.compile(),this.aFragmentShaderMap[t]=a,r=a)}var o=new wt(this.rc);return o.attachVertexShader(i),o.attachFragmentShader(r),o.link(),this.aProgramMap[t]=o,o},getShadowDepthProgram:function(t,e){var i,r,n,a=e.materialRef,s=e.aAttribFmt,o=e.aBoneMatList?1:0,h=e.bFaceCamera?1:0,l=0;if(a.bAlphaTest){for(var m=a.bAlphaScript?a.getPackedAlphaScript():"",c=a.bNormalScript?a.getPackedNormalScript():"",u=0,f=0;f<7;++f)""!=a.aTextureList[f]&&(u+=2<<2*f,34067==a.aTextureTypeList[0]&&(u+=2<<2*f+1));var d=s.Texcoord1,v=s.Texcoord2,g=s.Texcoord3,p=s.Texcoord4;l=(d?1:0)+(v?2:0)+(g?4:0)+(p?8:0)+(d&&v&&d.iIdx==v.iIdx-1?16:0)+(g&&p&&g.iIdx==p.iIdx-1?32:0);var x=""+(""!=a.aUvAttribList[0]?a.aUvAttribList[0].charAt(8):0)+(""!=a.aUvAttribList[1]?a.aUvAttribList[1].charAt(8):0)+(""!=a.aUvAttribList[2]?a.aUvAttribList[2].charAt(8):0)+(""!=a.aUvAttribList[3]?a.aUvAttribList[3].charAt(8):0)+(""!=a.aUvAttribList[4]?a.aUvAttribList[4].charAt(8):0)+(""!=a.aUvAttribList[5]?a.aUvAttribList[5].charAt(8):0)+(""!=a.aUvAttribList[6]?a.aUvAttribList[6].charAt(8):0),y=s["Position/Normal"]||s.Normal?1:0,_=""!=a.aTextureList[4]?1:0,M=""+(a.bVertexColor?1:0)+(s.Color?1:0),T=a.bTwoSide?1:0;if(i="ShD"+(a.bAlphaTest?1:0)+u+"_"+l+"_"+x+y+(a.bBlend?1:0)+M+o+T+h+"_"+m+"_"+c,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="ShD1_"+l+"_"+y+_+(s.Color?1:0)+o+h,n=i}else{var b;if(i="ShD0_"+o+h,"Fail"==(b=this.aProgramMap[i]))return this.getDefaultShadowDepthProgram();if(null!=b)return b;r="ShD0_"+o+h,n="ShD0"}var A=this.aVertexShaderMap[r],L=this.aFragmentShaderMap[n];if(null==A||null==L){var S=new Object;if(1==o&&(S.OK_SKANIMATION=1),1==h&&(S.OK_BILLBOARD=1),a.bAlphaTest){1==y&&(S.OK_NORMAL=1),s.Color&&(S.OK_VERTEX_COLOR=1),a.bVertexColor&&(S.OK_AUTO_VERTEX_COLOR=1),T&&(S.OK_TWO_SIDE=1),a.bAlphaTest&&(S.OK_ALPHA_TEST=1),""!=a.aTextureList[0]&&(S.OK_TEX_ALBEDO1=1),""!=a.aTextureList[1]&&(S.OK_TEX_ALBEDO2=1),""!=a.aTextureList[2]&&(S.OK_TEX_ALBEDO3=1),""!=a.aTextureList[3]&&(S.OK_TEX_ALBEDO4=1),""!=a.aTextureList[4]&&(S.OK_TEX_NORMALMAP=1),""!=a.aTextureList[5]&&(S.OK_TEX_OPACITY=1),""!=a.aTextureList[6]&&(S.OK_TEX_SPECULAR_LEVEL=1),""!=a.aTangentAttribList[4]&&(S.OK_TANGENT=1),""!=a.aBinormalAttribList[4]&&(S.OK_BINORMAL=1),34067==a.aTextureTypeList[0]&&(S.OK_TEX_ALBEDO1_CUBE=1),34067==a.aTextureTypeList[1]&&(S.OK_TEX_ALBEDO2_CUBE=1),34067==a.aTextureTypeList[2]&&(S.OK_TEX_ALBEDO3_CUBE=1),34067==a.aTextureTypeList[3]&&(S.OK_TEX_ALBEDO4_CUBE=1);var C=new Object;16&l?(S.OK_TC12=1,C.Texcoord1="okVary_TC12.xy",C.Texcoord2="okVary_TC12.zw"):(1&l?(S.OK_TC1=1,C.Texcoord1="okVary_TC1"):C.Texcoord1="vec2(0.0, 0.0)",2&l?(S.OK_TC2=1,C.Texcoord2="okVary_TC2"):C.Texcoord2="vec2(0.0, 0.0)"),32&l?(S.OK_TC34=1,C.Texcoord3="okVary_TC34.xy",C.Texcoord4="okVary_TC34.zw"):(4&l?(S.OK_TC3=1,C.Texcoord3="okVary_TC3"):C.Texcoord3="vec2(0.0, 0.0)",8&l?(S.OK_TC4=1,C.Texcoord4="okVary_TC4"):C.Texcoord4="vec2(0.0, 0.0)"),C[a.aUvAttribList[0]]&&(S.OK_ALBEDO1_TC=C[a.aUvAttribList[0]]),C[a.aUvAttribList[1]]&&(S.OK_ALBEDO2_TC=C[a.aUvAttribList[1]]),C[a.aUvAttribList[2]]&&(S.OK_ALBEDO3_TC=C[a.aUvAttribList[2]]),C[a.aUvAttribList[3]]&&(S.OK_ALBEDO4_TC=C[a.aUvAttribList[3]]),C[a.aUvAttribList[4]]&&(S.OK_NORMALMAP_TC=C[a.aUvAttribList[4]]),C[a.aUvAttribList[5]]&&(S.OK_OPACITY_TC=C[a.aUvAttribList[5]]),C[a.aUvAttribList[6]]&&(S.OK_SPECULAR_LEVEL_TC=C[a.aUvAttribList[6]]),""!=m&&(S.OK_SCRIPT_ALPHA_CODE=m),""!=c&&(S.OK_SCRIPT_NORMAL_CODE=c)}var E=null,O=null;null==A&&(E=new Bt(this.rc,35633)),null==L&&(O=new Bt(this.rc,35632));var P=new Object;if(P.sVs=E,P.sFs=O,this._getSrc("ShadowDepth",P),null==A){if(!E.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultShadowDepthProgram();this.aVertexShaderMap[r]=E,A=E}if(null==L){if(O.setFloatPrecision(this.sFloatPrecision),!O.compile(S))return this.aProgramMap[i]="Fail",this.getDefaultShadowDepthProgram();this.aFragmentShaderMap[n]=O,L=O}}var B=new wt(this.rc);return B.attachVertexShader(A),B.attachFragmentShader(L),B.link()?(this.aProgramMap[i]=B,B):(this.aProgramMap[i]="Fail",this.getDefaultShadowDepthProgram())},getShadowVolumeProgram:function(){var t=this.aProgramMap.ShV;if(null!=t)return t;var e=this.aVertexShaderMap.ShV,i=this.aFragmentShaderMap.ShV;if(null==e||null==i){var r=null,n=null;null==e&&(r=new Bt(this.rc,35633)),null==i&&(n=new Bt(this.rc,35632));var a=new Object;a.sVs=r,a.sFs=n,this._getSrc("ShadowVolume",a),null==e&&(r.compile(),this.aVertexShaderMap.ShV=r,e=r),null==i&&(n.setFloatPrecision(this.sFloatPrecision),n.compile(),this.aFragmentShaderMap.ShV=n,i=n)}var s=new wt(this.rc);return s.attachVertexShader(e),s.attachFragmentShader(i),s.link(),this.aProgramMap.ShV=s,s},getShadowFinalProgram:function(){var t=this.aProgramMap.ShF;if(null!=t)return t;var e=this.aVertexShaderMap.ShF,i=this.aFragmentShaderMap.ShF;if(null==e||null==i){var r=null,n=null;null==e&&(r=new Bt(this.rc,35633)),null==i&&(n=new Bt(this.rc,35632));var a=new Object;a.sVs=r,a.sFs=n,this._getSrc("ShadowFinal",a),null==e&&(r.compile(),this.aVertexShaderMap.ShF=r,e=r),null==i&&(n.setFloatPrecision(this.sFloatPrecision),n.compile(),this.aFragmentShaderMap.ShF=n,i=n)}var s=new wt(this.rc);return s.attachVertexShader(e),s.attachFragmentShader(i),s.link(),this.aProgramMap.ShF=s,s},getDefaultLightingProgram:function(){var t="LiD",e=this.aProgramMap[t];if(null!=e)return e;var i=this.aVertexShaderMap[t],r=this.aFragmentShaderMap[t];if(null==i||null==r){var n=null,a=null;null==i&&(n=new Bt(this.rc,35633)),null==r&&(a=new Bt(this.rc,35632));var s=new Object;s.sVs=n,s.sFs=a,this._getSrc("LightingDefault",s),null==i&&(n.compile(),this.aVertexShaderMap[t]=n,i=n),null==r&&(a.setFloatPrecision(this.sFloatPrecision),a.compile(),this.aFragmentShaderMap[t]=a,r=a)}var o=new wt(this.rc);return o.attachVertexShader(i),o.attachFragmentShader(r),o.link(),this.aProgramMap[t]=o,o},getLightingProgram:function(t,e){for(var i=e.materialRef,r=e.aAttribFmt,n=e.getRefDctLightNum(),a=e.getRefPointLightNum(),s=e.getRefSpotLightNum(),o=t.bShadow&&!i.bWireframe&&e.bReceiveShadow&&t.aStageEnableList[1],h=i.bEmissiveScript?i.getPackedEmissiveScript():"",l=i.bDiffuseScript?i.getPackedDiffuseScript():"",m=i.bDiffusePowerScript?i.getPackedDiffusePowerScript():"",c=i.bSpecularScript?i.getPackedSpecularScript():"",u=i.bSpecularPowerScript?i.getPackedSpecularPowerScript():"",f=i.bAlphaScript?i.getPackedAlphaScript():"",d=i.bNormalScript?i.getPackedNormalScript():"",v=i.bDctLightScript?i.getPackedDctLightScript():"",g=i.bPointLightScript?i.getPackedPointLightScript():"",p=i.bSpotLightScript?i.getPackedSpotLightScript():"",x=0,y=0;y<7;++y)""!=i.aTextureList[y]&&(x+=2<<2*y,34067==i.aTextureTypeList[0]&&(x+=2<<2*y+1));var _=r.Texcoord1,M=r.Texcoord2,T=r.Texcoord3,b=r.Texcoord4,A=(_?1:0)+(M?2:0)+(T?4:0)+(b?8:0)+(_&&M&&_.iIdx==M.iIdx-1?16:0)+(T&&b&&T.iIdx==b.iIdx-1?32:0),L=""+(""!=i.aUvAttribList[0]?i.aUvAttribList[0].charAt(8):0)+(""!=i.aUvAttribList[1]?i.aUvAttribList[1].charAt(8):0)+(""!=i.aUvAttribList[2]?i.aUvAttribList[2].charAt(8):0)+(""!=i.aUvAttribList[3]?i.aUvAttribList[3].charAt(8):0)+(""!=i.aUvAttribList[4]?i.aUvAttribList[4].charAt(8):0)+(""!=i.aUvAttribList[5]?i.aUvAttribList[5].charAt(8):0)+(""!=i.aUvAttribList[6]?i.aUvAttribList[6].charAt(8):0),S=r["Position/Normal"]||r.Normal?1:0,C=""!=i.aTextureList[4]?1:0,E=e.aBoneMatList?1:0,O=e.bFaceCamera?1:0,P=""+(i.bVertexColor?1:0)+(r.Color?1:0),B=i.bTwoSide?1:0,w=t.bFogEnable&&i.bFog?1:0,k="Li"+n+a+s+"_"+x+"_"+A+"_"+L+"_"+(i.bDynamicLighting?1:0)+S+(i.bBlend?1:0)+(i.bAlphaTest?1:0)+(o?1:0)+P+E+B+O+w+"_"+h+"_"+l+"_"+m+"_"+c+"_"+u+"_"+f+"_"+d+"_"+v+"_"+g+"_"+p,R=this.aProgramMap[k];if("Fail"==R)return this.getDefaultLightingProgram();if(null!=R)return R;var z="Li"+A+"_"+S+C+(r.Color?"1":"0")+E+O,D=k,N=this.aVertexShaderMap[z],V=this.aFragmentShaderMap[D];if(null==N||null==V){var F=new Object;i.bDynamicLighting&&(F.OK_DYNAMICLIGHTING=1),F.OK_DCTLIGHT_NUM=n,F.OK_POINTLIGHT_NUM=a,F.OK_SPOTLIGHT_NUM=s,1==E&&(F.OK_SKANIMATION=1),1==O&&(F.OK_BILLBOARD=1),1==S&&(F.OK_NORMAL=1),r.Color&&(F.OK_VERTEX_COLOR=1),i.bVertexColor&&(F.OK_AUTO_VERTEX_COLOR=1),B&&(F.OK_TWO_SIDE=1),i.bBlend&&(F.OK_BLEND=1),!i.bAlphaTest||!i.bBlend&&t.aStageEnableList[0]||(F.OK_ALPHA_TEST=1),o&&(F.OK_DYNAMICSHADOW=1),w&&(F.OK_FOG=1),""!=i.aTextureList[0]&&(F.OK_TEX_ALBEDO1=1),""!=i.aTextureList[1]&&(F.OK_TEX_ALBEDO2=1),""!=i.aTextureList[2]&&(F.OK_TEX_ALBEDO3=1),""!=i.aTextureList[3]&&(F.OK_TEX_ALBEDO4=1),""!=i.aTextureList[4]&&(F.OK_TEX_NORMALMAP=1),""!=i.aTextureList[5]&&(F.OK_TEX_OPACITY=1),""!=i.aTextureList[6]&&(F.OK_TEX_SPECULAR_LEVEL=1),""!=i.aTangentAttribList[4]&&(F.OK_TANGENT=1),""!=i.aBinormalAttribList[4]&&(F.OK_BINORMAL=1),34067==i.aTextureTypeList[0]&&(F.OK_TEX_ALBEDO1_CUBE=1),34067==i.aTextureTypeList[1]&&(F.OK_TEX_ALBEDO2_CUBE=1),34067==i.aTextureTypeList[2]&&(F.OK_TEX_ALBEDO3_CUBE=1),34067==i.aTextureTypeList[3]&&(F.OK_TEX_ALBEDO4_CUBE=1);var I=new Object;16&A?(F.OK_TC12=1,I.Texcoord1="okVary_TC12.xy",I.Texcoord2="okVary_TC12.zw"):(1&A?(F.OK_TC1=1,I.Texcoord1="okVary_TC1"):I.Texcoord1="vec2(0.0, 0.0)",2&A?(F.OK_TC2=1,I.Texcoord2="okVary_TC2"):I.Texcoord2="vec2(0.0, 0.0)"),32&A?(F.OK_TC34=1,I.Texcoord3="okVary_TC34.xy",I.Texcoord4="okVary_TC34.zw"):(4&A?(F.OK_TC3=1,I.Texcoord3="okVary_TC3"):I.Texcoord3="vec2(0.0, 0.0)",8&A?(F.OK_TC4=1,I.Texcoord4="okVary_TC4"):I.Texcoord4="vec2(0.0, 0.0)"),I[i.aUvAttribList[0]]&&(F.OK_ALBEDO1_TC=I[i.aUvAttribList[0]]),I[i.aUvAttribList[1]]&&(F.OK_ALBEDO2_TC=I[i.aUvAttribList[1]]),I[i.aUvAttribList[2]]&&(F.OK_ALBEDO3_TC=I[i.aUvAttribList[2]]),I[i.aUvAttribList[3]]&&(F.OK_ALBEDO4_TC=I[i.aUvAttribList[3]]),I[i.aUvAttribList[4]]&&(F.OK_NORMALMAP_TC=I[i.aUvAttribList[4]]),I[i.aUvAttribList[5]]&&(F.OK_OPACITY_TC=I[i.aUvAttribList[5]]),I[i.aUvAttribList[6]]&&(F.OK_SPECULAR_LEVEL_TC=I[i.aUvAttribList[6]]),""!=h&&(F.OK_SCRIPT_EMISSIVE_CODE=h),""!=l&&(F.OK_SCRIPT_DIFFUSE_CODE=l),""!=m&&(F.OK_SCRIPT_DIFFUSEPOWER_CODE=m),""!=c&&(F.OK_SCRIPT_SPECULAR_CODE=c),""!=u&&(F.OK_SCRIPT_SPECULARPOWER_CODE=u),""!=f&&(F.OK_SCRIPT_ALPHA_CODE=f),""!=d&&(F.OK_SCRIPT_NORMAL_CODE=d),""!=v&&(F.OK_SCRIPT_DCTLIGHT_CODE=v),""!=g&&(F.OK_SCRIPT_POINTLIGHT_CODE=g),""!=p&&(F.OK_SCRIPT_SPOTLIGHT_CODE=p);var U=null,K=null;null==N&&(U=new Bt(this.rc,35633)),null==V&&(K=new Bt(this.rc,35632));var G=new Object;if(G.sVs=U,G.sFs=K,this._getSrc("Lighting",G),null==N){if(!U.compile(F))return this.aProgramMap[k]="Fail",this.getDefaultLightingProgram();this.aVertexShaderMap[z]=U,N=U}if(null==V){if(K.setFloatPrecision(this.sFloatPrecision),!K.compile(F))return this.aProgramMap[k]="Fail",this.getDefaultLightingProgram();this.aFragmentShaderMap[D]=K,V=K}}var j=new wt(this.rc);return j.attachVertexShader(N),j.attachFragmentShader(V),j.link()?(this.aProgramMap[k]=j,j):(this.aProgramMap[k]="Fail",this.getDefaultLightingProgram())},_getSrc:function(t,e){this.aVertexSourceMap&&(e.sVs&&e.sVs.loadSource(this.aVertexSourceMap[t]),e.sFs&&e.sFs.loadSource(this.aFragmentSourceMap[t]))}},fe.prototype.clear=function(){this.bEnable=!0,this.deleteResource()},fe.prototype.enable=function(t){this.bEnable=t},fe.prototype.isEnabled=function(){return this.bEnable},fe.prototype.init=function(t){this.renderer=t},fe.prototype.createResource=function(){},fe.prototype.deleteResource=function(){},fe.prototype.beginView=function(t){},fe.prototype.endView=function(){},fe.prototype.prepare=function(){},fe.prototype.render=function(){},fe.prototype._renderBatches=function(t,e,i,r,n,a,s,o){var h=this.renderer.rc,l=this.renderer.renderEnv,m=this.renderer.resourceManager,c=this.renderer.renderTargetCollector,u=this.renderer.shaderManager,f=l.camera,d=l.iCanvasWidth,v=l.iCanvasHeight,g=m.getResource("$R$White"),p=f.getPos(),x=o||f.getViewProjMat4(),y=f.getViewInvMat4();y.m03=y.m13=y.m23=0;var _=V.array();_.push(0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,l.vGroundColor.x,l.vGroundColor.y,l.vGroundColor.z,l.iCurTime/1e3,l.vSkyColor.x,l.vSkyColor.y,l.vSkyColor.z,l.fRandom,f.iViewportX/d,(v-f.iViewportY-f.iViewportHeight)/v,f.iViewportWidth/d,f.iViewportHeight/v,p.x,p.y,p.z,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,l.vFogColor.x,l.vFogColor.y,l.vFogColor.z,l.fFogDensity,l.fFogDistNear,1/(l.fFogDistFar-l.fFogDistNear),0,0,1,1,1,0);for(var M=t.length,T=0;T<M;++T){var b=t[T];if(!a||0!=a(b)){var A=b.aAttribFmt,L=b.materialRef,S=l.bShadow&&!L.bWireframe&&b.bReceiveShadow&&l.aStageEnableList[1],C=0,E=u.getProgram(e,l,b);E.bind(),b.mMatRef.toMat4(this.__aMatArray[0]),b.mMatNRef.toMat4(this.__aMatArray[1]),this.__aMatArray[2]=x,this.__aMatArray[3]=y,E.setUniformMat4Array("okUni_TransMat",this.__aMatArray);var O=A.Position;if(O&&E.setAttribute("okAttr_Pos",O.buf,O.iSize,O.iOffset,O.iStride),r||L.bAlphaTest){var P=A.Normal;P&&E.setAttribute("okAttr_Normal",P.buf,P.iSize,P.iOffset,P.iStride);var B=A.Color;B&&E.setAttribute("okAttr_Color",B.buf,B.iSize,B.iOffset,B.iStride)}if(L.bDepthTest?h.enable(2929):h.disable(2929),L.bDepthWrite?h.depthMask(!0):h.depthMask(!1),L.bTwoSide?h.disable(2884):h.enable(2884),1==b.iDrawMode&&h.lineWidth(L.fLineWidth),L.bBlend&&(h.blendEquationSeparate(L.iBlendEquation,L.iBlendEquationAlpha),h.blendFuncSeparate(L.iBlendSrc,L.iBlendDest,L.iBlendSrcAlpha,L.iBlendDestAlpha)),(i||L.bAlphaTest)&&(_[0]=L.vEmissive.x,_[1]=L.vEmissive.y,_[2]=L.vEmissive.z,_[3]=L.fGlossiness,_[4]=L.vAmbient.x,_[5]=L.vAmbient.y,_[6]=L.vAmbient.z,_[7]=L.fSpecularLevel,_[8]=L.vDiffuse.x,_[9]=L.vDiffuse.y,_[10]=L.vDiffuse.z,_[11]=L.fAlpha,_[12]=L.vSpecular.x,_[13]=L.vSpecular.y,_[14]=L.vSpecular.z,_[15]=L.fAlphaTestValue,_[168]=L.vGlowColor.x,_[169]=L.vGlowColor.y,_[170]=L.vGlowColor.z),r){var w=c.getRenderTarget("ShadowProj");S&&w&&(E.setSampler("okUni_shadowSampler",C),w.bind(C),h.texParameteri(3553,10240,9729),h.texParameteri(3553,10241,9729),h.texParameteri(3553,10242,33071),h.texParameteri(3553,10243,33071),C+=1);new Array,new Array;if(0!=b.getRefDctLightNum()){new Array,new Array;for(var k=b.aDctLightListRef.getRoot(),z=0;k;){var D=(U=k.data).getLightDir(),N=U.getColor();if(_[4*(8+z)]=D.x,_[4*(8+z)+1]=D.y,_[4*(8+z)+2]=D.z,_[4*(8+z)+3]=R(N),S&&(_[4*(12+z)]=0==U.iShadowIdx?1:0,_[4*(12+z)+1]=1==U.iShadowIdx?1:0,_[4*(12+z)+2]=2==U.iShadowIdx?1:0,_[4*(12+z)+3]=3==U.iShadowIdx?1:0),4==(z+=1))break;k=k.next}}if(0!=b.getRefPointLightNum())for(k=b.aPointLightListRef.getRoot(),z=0;k;){var F=(U=k.data).getPos(),I=U.getRange();N=U.getColor();if(_[4*(16+z)]=F.x,_[4*(16+z)+1]=F.y,_[4*(16+z)+2]=F.z,_[4*(16+z)+3]=I,_[4*(24+z)+3]=R(N),S&&(_[4*(20+z)]=0==U.iShadowIdx?1:0,_[4*(20+z)+1]=1==U.iShadowIdx?1:0,_[4*(20+z)+2]=2==U.iShadowIdx?1:0,_[4*(20+z)+3]=3==U.iShadowIdx?1:0),4==(z+=1))break;k=k.next}if(0!=b.getRefSpotLightNum())for(k=b.aSpotLightListRef.getRoot(),z=0;k;){F=(U=k.data).getPos(),D=U.getLightDir();var U,K=U.getInnerCone()*Math.PI/180,G=U.getOuterCone()*Math.PI/180;N=U.getColor();if(_[4*(24+z)]=F.x,_[4*(24+z)+1]=F.y,_[4*(24+z)+2]=F.z,_[4*(28+z)]=D.x,_[4*(28+z)+1]=D.y,_[4*(28+z)+2]=D.z,_[4*(28+z)+3]=R(N),_[4*(32+z)]=K,_[4*(32+z)+1]=G,S&&(_[4*(36+z)]=0==U.iShadowIdx?1:0,_[4*(36+z)+1]=1==U.iShadowIdx?1:0,_[4*(36+z)+2]=2==U.iShadowIdx?1:0,_[4*(36+z)+3]=3==U.iShadowIdx?1:0),4==(z+=1))break;k=k.next}}if((i||r||L.bAlphaTest)&&E.setUniformFloat4Array("okUni_General",_),n||L.bAlphaTest){for(var j=!1,H=!1,W=[0,0,0,0,0,0,0],X=[0,0,0,0],Y=0;Y<7;++Y)if(-1!=L.aTextureResIdList[Y]){var Z=m.getResource(L.aTextureResIdList[Y]),q=Z.isValid();if(q?Z.bind(C):g.bind(C),3553==Z.getType()){if(q){var Q=Z.isMipMap();h.texParameteri(3553,10240,L.aTextureFilterList[Y]),9729==L.aTextureFilterList[Y]?Q?h.texParameteri(3553,10241,9985):h.texParameteri(3553,10241,9729):h.texParameteri(3553,10241,L.aTextureFilterList[Y])}else h.texParameteri(3553,10240,9728),h.texParameteri(3553,10241,9728);h.texParameteri(3553,10242,L.aTextureWrapUList[Y]),h.texParameteri(3553,10243,L.aTextureWrapVList[Y]),W[Y]=C,j=!0}else if(34067==Z.getType()){if(q){Q=Z.isMipMap();h.texParameteri(34067,10240,L.aTextureFilterList[Y]),9729==L.aTextureFilterList[Y]?Q?h.texParameteri(34067,10241,9985):h.texParameteri(34067,10241,9729):h.texParameteri(34067,10241,L.aTextureFilterList[Y])}else h.texParameteri(3553,10240,9728),h.texParameteri(3553,10241,9728);h.texParameteri(34067,10242,L.aTextureWrapUList[Y]),h.texParameteri(34067,10243,L.aTextureWrapVList[Y]),X[Y]=C,H=!0}C+=1}j&&E.setSamplerArray("okUni_Sampler2D",W),H&&E.setSamplerArray("okUni_SamplerCube",X);var $=A.Texcoord1,J=A.Texcoord2;$&&J&&$.buf==J.buf&&$.iIdx==J.iIdx-1?E.setAttribute("okAttr_TC12",$.buf,$.iSize+J.iSize,$.iOffset,$.iStride):$?E.setAttribute("okAttr_TC1",$.buf,$.iSize,$.iOffset,$.iStride):J&&E.setAttribute("okAttr_TC2",J.buf,J.iSize,J.iOffset,J.iStride);var tt=A.Texcoord3,et=A.Texcoord4;tt&&et&&tt.buf==et.buf&&tt.iIdx==et.iIdx-1?E.setAttribute("okAttr_TC34",tt.buf,tt.iSize+tt.iSize,tt.iOffset,tt.iStride):tt?E.setAttribute("okAttr_TC3",tt.buf,tt.iSize,tt.iOffset,tt.iStride):et&&E.setAttribute("okAttr_TC4",et.buf,et.iSize,et.iOffset,et.iStride);var it=A[L.aTangentAttribList[4]];it&&E.setAttribute("okAttr_Tangent",it.buf,it.iSize,it.iOffset,it.iStride);var rt=A[L.aBinormalAttribList[4]];rt&&E.setAttribute("okAttr_Binormal",rt.buf,rt.iSize,rt.iOffset,rt.iStride)}if(b.aBoneMatList){var nt=A[b.sBoneIdxAttribName],at=A[b.sBoneWeightAttribName];E.setAttribute("okAttr_BoneIdx",nt.buf,nt.iSize,nt.iOffset,nt.iStride),E.setAttribute("okAttr_BoneWeight",at.buf,at.iSize,at.iOffset,at.iStride),E.setUniformMat43Array("okUni_BoneMat",b.aBoneMatList,!1)}s&&s(h,b),b.index.drawIndex(b.iDrawMode,b.iDrawStart,b.iDrawCount)}}h.enable(2929),h.depthMask(!0),h.enable(2884),V._array(_)},z(de,fe),de.prototype.createResource=function(){var t=this.renderer.rc,e=this.renderer.renderEnv,i=this.renderer.renderTargetCollector;null==this.depthTex&&(this.depthTex=new kt(t)),this.depthTex.createTexture(3553,e.iCanvasWidth,e.iCanvasHeight,6408),i.setRenderTarget("DTex",this.depthTex),null==this.depthStencilBuffer&&(this.depthStencilBuffer=new Ot(t)),this.depthStencilBuffer.createBuffer(34041,e.iCanvasWidth,e.iCanvasHeight),i.setRenderTarget("DSBuf",this.depthStencilBuffer),null==this.depthFbo&&(this.depthFbo=new Pt(t)),this.depthFbo.createBuffer(),this.depthFbo.bind(),this.depthFbo.attachRenderTexture(0,this.depthTex),this.depthFbo.attachDepthStencilBuffer(this.depthStencilBuffer),this.depthFbo.unbind()},de.prototype.deleteResource=function(){this.renderer.rc,this.renderer.renderEnv;var t=this.renderer.renderTargetCollector;this.depthTex&&(this.depthTex.releaseTexture(),t.setRenderTarget("DTex",null)),this.depthStencilBuffer&&(this.depthStencilBuffer.releaseBuffer(),t.setRenderTarget("DSBuf",null)),this.depthFbo&&this.depthFbo.releaseBuffer()},de.prototype.beginView=function(t){var e=this.renderer.rc,i=this.renderer.renderEnv.camera;1!=t&&(this.depthFbo.bind(),i.bindViewport(),e.clearColor(1,1,1,1),e.clearDepth(1),e.clear(17664),this.depthFbo.unbind())},de.prototype.endView=function(){},de.prototype.render=function(){var t=this.renderer.rc,e=this.renderer.renderEnv,i=this.renderer.renderSourceCollector;this.depthFbo.bind(),e.camera.bindViewport(),t.enable(2929),t.depthFunc(515),t.enable(2884),t.depthMask(!0);var r=i.getBatchList("Visible_Opaque");r.length>0&&this._renderBatches(r,"Depth",!1,!1,!1,this._clipBatch),this.depthFbo.unbind()},de.prototype._clipBatch=function(t){return t.materialRef.bDepthWrite},z(ve,fe),ve.prototype.clear=function(){this.aShadowCasterList.length=0,D(this,"clear")},ve.prototype.createResource=function(){var t=this.renderer.rc,e=this.renderer.renderEnv,i=(this.renderer.renderSourceCollector,this.renderer.renderTargetCollector);null==this.lightTex&&(this.lightTex=new kt(t)),this.lightTex.createTexture(3553,Math.min(this.iDepthTexSize,e.iCanvasWidth),Math.min(this.iDepthTexSize,e.iCanvasHeight),6408),i.setRenderTarget("ShadowDepth",this.lightTex),null==this.lightDepthBuffer&&(this.lightDepthBuffer=new Ot(t)),this.lightDepthBuffer.createBuffer(33189,Math.min(this.iDepthTexSize,e.iCanvasWidth),Math.min(this.iDepthTexSize,e.iCanvasHeight)),null==this.lightFbo&&(this.lightFbo=new Pt(t)),this.lightFbo.createBuffer(),this.lightFbo.bind(),this.lightFbo.attachRenderTexture(0,this.lightTex),this.lightFbo.attachDepthBuffer(this.lightDepthBuffer),this.lightFbo.unbind(),null==this.projTex&&(this.projTex=new kt(t)),this.projTex.createTexture(3553,e.iCanvasWidth,e.iCanvasHeight,6408),i.setRenderTarget("ShadowProj",this.projTex),null==this.projFbo&&(this.projFbo=new Pt(t)),this.projFbo.createBuffer(),this.projFbo.bind(),this.projFbo.attachRenderTexture(0,this.projTex),this.projFbo.attachDepthStencilBuffer(i.getRenderTarget("DSBuf")),this.projFbo.unbind(),null==this.frustumMask&&(this.frustumMask=[new Et(t),new Et(t)]),this.frustumMask[0].createBuffer(34962,5126,35044,new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),this.frustumMask[1].createBuffer(34962,5126,35044,new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])),null==this.frustumIndexBuf&&(this.frustumIndexBuf=new Et(t)),this.frustumIndexBuf.createBuffer(34963,5123,35044,new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,3,2,6,3,6,7,4,0,3,4,3,7,4,5,1,4,1,0,4,7,6,4,6,5]))},ve.prototype.deleteResource=function(){this.renderer.rc,this.renderer.renderEnv,this.renderer.renderSourceCollector;var t=this.renderer.renderTargetCollector;this.lightTex&&(this.lightTex.releaseTexture(),t.setRenderTarget("ShadowDepth",null)),this.lightDepthBuffer&&this.lightDepthBuffer.releaseBuffer(),this.lightFbo&&this.lightFbo.releaseBuffer(),this.projTex&&(this.projTex.releaseTexture(),t.setRenderTarget("ShadowProj",null)),this.projFbo&&this.projFbo.releaseBuffer(),this.frustumMask[0]&&this.frustumMask[0].releaseBuffer(),this.frustumMask[1]&&this.frustumMask[1].releaseBuffer(),this.frustumIndexBuf&&this.frustumIndexBuf.releaseBuffer()},ve.prototype.beginView=function(){},ve.prototype.endView=function(){},ve.prototype.render=function(){var t=this.renderer.rc,e=this.renderer.renderEnv,i=this.renderer.shaderManager,r=e.scene,n=r.getZone(),a=(this.renderer.renderSourceCollector,this.renderer.renderTargetCollector),s=e.camera,o=(s.getPos(),Math.min(e.iCanvasWidth,this.iDepthTexSize)),h=Math.min(e.iCanvasHeight,this.iDepthTexSize),l=s.getViewInvMat4();if(l.m03=l.m13=l.m23=0,e.bShadow&&r){this.aShadowCasterList.length=0;for(var m=0,c=n.aLightList.getRoot();c;){var u=c.data;if(u.bCastShadow&&u.bVisible){u.iShadowIdx=m,m+=1;for(var f=u.__aAffectEntityList.getRoot();f;){var d=f.data;483&d.getType()&&d.bVisible&&d.bCastShadow&&1!=d.getState()&&this._genShadowCaster(u,d,e),f=f.next}}else u.iShadowIdx=3;c=c.next}for(var v=this.aShadowCasterList.length,g=new k(o,h),p=0;p<v;++p){var x=this.aShadowCasterList[p],y=new G(0,0);x.fRatio>=1?(y.x=Math.min(o,x.fResolution*Math.max(e.camera.getViewportWidth(),e.camera.getViewportHeight())),y.y=Math.min(h,y.x/x.fRatio)):(y.y=Math.min(h,x.fResolution*Math.max(e.camera.getViewportWidth(),e.camera.getViewportHeight())),y.x=Math.min(o,y.y*x.fRatio)),y.x=Math.max(8,y.x),y.y=Math.max(8,y.y),x.rTexLayout=g.add(y.x,y.y),null==x.rTexLayout&&(x.bNextPass=!0,g.reset(o,h),x.rTexLayout=g.add(y.x,y.y)),x.rTexLayout.width=Math.min(x.rTexLayout.width,e.iCanvasWidth),x.rTexLayout.height=Math.min(x.rTexLayout.height,e.iCanvasHeight),x.rTexLayout.width-=3,x.rTexLayout.height-=3,x.rTexLayout.width=I(x.rTexLayout.width,4),x.rTexLayout.height=I(x.rTexLayout.height,4),x.rTexLayout.x+=2,x.rTexLayout.y+=2,x.rTexLayout.width-=2,x.rTexLayout.height-=2;var _=new G(x.rTexLayout.x/o,x.rTexLayout.y/h),M=new G(x.rTexLayout.width/o,x.rTexLayout.height/h),T=new it;x.mLightViewProjMat.clone(T),T.m00=(T.m00+T.m30)/2,T.m01=(T.m01+T.m31)/2,T.m02=(T.m02+T.m32)/2,T.m03=(T.m03+T.m33)/2,T.m00=T.m00*M.x+T.m30*_.x,T.m01=T.m01*M.x+T.m31*_.x,T.m02=T.m02*M.x+T.m32*_.x,T.m03=T.m03*M.x+T.m33*_.x,T.m10=(T.m10+T.m30)/2,T.m11=(T.m11+T.m31)/2,T.m12=(T.m12+T.m32)/2,T.m13=(T.m13+T.m33)/2,T.m10=T.m10*M.y+T.m30*_.y,T.m11=T.m11*M.y+T.m31*_.y,T.m12=T.m12*M.y+T.m32*_.y,T.m13=T.m13*M.y+T.m33*_.y,x.mShadowMat=T}this.projFbo.bind(),s.bindViewport(),t.clearColor(1,1,1,1),t.clear(17408);for(var b=a.getRenderTarget("DTex"),A=0;A<v;){this.lightFbo.bind(),t.viewport(0,0,o,h),t.scissor(0,0,o,h),t.clearColor(1,1,1,1),t.clear(16640),t.enable(2929),t.depthFunc(515);var L=0;for(L=A;L<v;++L){if((x=this.aShadowCasterList[L]).bNextPass){x.bNextPass=!1;break}var S=x.rTexLayout;t.viewport(S.x,S.y,S.width,S.height);var C=x.aBatchList;C.length>0&&this._renderBatches(C,"ShadowDepth",!1,!1,!1,null,this._setDepthBatch,x.mLightViewProjMat)}this.projFbo.bind(),s.bindViewport();for(p=A;p<L;++p){var E,O=(x=this.aShadowCasterList[p]).light;t.enable(2929),t.disable(2884),t.enable(2960),t.stencilFunc(519,0,4294967295),t.stencilOpSeparate(1028,7680,34056,7680),t.stencilOpSeparate(1029,7680,34055,7680),t.colorMask(!1,!1,!1,!1),t.depthMask(!1),(E=i.getShadowVolumeProgram()).bind(),E.setAttribute("vertMask0",this.frustumMask[0],4),E.setAttribute("vertMask1",this.frustumMask[1],4),x.lightFrustum.bPointDirty&&x.lightFrustum._genPointList(),E.setUniformVec3Array("vertList",x.lightFrustum.aPointList),E.setUniformMat4("matViewProj",s.getViewProjMat4()),this.frustumIndexBuf.drawIndex(4),t.disable(2929),t.stencilFunc(517,0,4294967295),t.stencilOp(7680,7680,7681),t.enable(3042),t.blendFuncSeparate(774,0,772,0),t.colorMask(0==O.iShadowIdx,1==O.iShadowIdx,2==O.iShadowIdx,!1),(E=i.getShadowFinalProgram()).bind(),E.setAttribute("vertMask0",this.frustumMask[0],4),E.setAttribute("vertMask1",this.frustumMask[1],4),E.setUniformVec3Array("vertList",x.lightFrustum.aPointList),s.getViewProjMat4().clone(this.__aMatArray[0]),s.getViewProjInvMat4().clone(this.__aMatArray[1]),x.mShadowMat.clone(this.__aMatArray[2]),E.setUniformMat4Array("matArray",this.__aMatArray),E.setUniformFloat4("screenPosOffsetAndScale",s.iViewportX/this.projTex.getSizeU(),(t.canvas.clientHeight-s.iViewportY-s.iViewportHeight)/this.projTex.getSizeV(),s.iViewportWidth/this.projTex.getSizeU(),s.iViewportHeight/this.projTex.getSizeV()),E.setUniformFloat3("shadowPixelSizeAndOffset",1/o,1/h,Math.max(u.fShadowFadeFactor,x.entity.fShadowFadeFactor)),E.setSamplerArray("samplerArray",this.tempSamplerArray),b.bind(0),t.texParameteri(3553,10240,9728),t.texParameteri(3553,10241,9728),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),this.lightTex.bind(1),t.texParameteri(3553,10240,9728),t.texParameteri(3553,10241,9728),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),this.frustumIndexBuf.drawIndex(4),t.disable(3042),t.enable(2929),A+=1}t.enable(2884),t.disable(2960),t.depthMask(!0),t.colorMask(!0,!0,!0,!0),this.projFbo.unbind(),s.bindViewport()}}},ve.prototype._setDepthBatch=function(t,e){t.enable(2929)},ve.prototype._genShadowCaster=function(t,e,i){var r=i.camera;if(4==t.getType()){(g=t.getMat43()).setColumn(3,0,0,0);for(var n=t.getInvMat43(),a=e.getBoundingBox(),s=new j(1e6,1e6,1e6),o=new j(-1e6,-1e6,-1e6),h=0;h<8;++h){s=Y(s,L=ct(n,a.getPoint(h))),o=Z(o,L)}var l=X(H(s,o),.5);l.z=o.z+.1;var m=W(o,s);g.setColumn(3,ct(g,l)),n=g.inverse(),(E=new ge).entity=e,E.light=t,E.aBatchList=new Array,e.genRenderBatch(E.aBatchList,i),E.mLightViewMat=new it,n.toMat4(E.mLightViewMat),E.mLightViewProjMat=rt(ht(.5*-m.x,.5*m.x,.5*m.y,.5*-m.y,.1,m.z+.1),E.mLightViewMat);var c=.1,u=m.z+.1;E.mLightViewProjMat.m20=-n.m20/(u-c),E.mLightViewProjMat.m21=-n.m21/(u-c),E.mLightViewProjMat.m22=-n.m22/(u-c),E.mLightViewProjMat.m23=(-n.m23-c)/(u-c),E.lightFrustum=new At,E.lightFrustum.setByViewProjMat(rt(ht(.5*-m.x,.5*m.x,.5*m.y,.5*-m.y,.1,1e4),E.mLightViewMat)),E.fRatio=m.x/m.y;var f=W(a.vMax,a.vMin).len(),d=new tt(.5*(a.vMax.x+a.vMin.x),.5*(a.vMax.y+a.vMin.y),.5*(a.vMax.z+a.vMin.z),1),v=nt(r.getViewProjMat4(),d);E.fResolution=e.fShadowResolution*f/Math.max(1,Math.abs(v.w)),this.aShadowCasterList.push(E)}else if(16==t.getType()){for(n=(g=t.getMat43()).inverse(),a=e.getBoundingBox(),s=new j(1e6,1e6,1e6),o=new j(-1e6,-1e6,-1e6),h=0;h<8;++h){s=Y(s,L=ct(n,a.getPoint(h))),o=Z(o,L)}(E=new ge).entity=e,E.light=t,E.aBatchList=new Array,e.genRenderBatch(E.aBatchList,i),E.mLightViewMat=new it,n.toMat4(E.mLightViewMat),E.fRatio=1;u=.1-s.z,c=Math.max(.1,-o.z);E.mLightViewProjMat=rt(ot(t.getOuterCone(),1,c,u),E.mLightViewMat),E.mLightViewProjMat.m20=-E.mLightViewMat.m20/(u-c),E.mLightViewProjMat.m21=-E.mLightViewMat.m21/(u-c),E.mLightViewProjMat.m22=-E.mLightViewMat.m22/(u-c),E.mLightViewProjMat.m23=(-E.mLightViewMat.m23-c)/(u-c),E.lightFrustum=new At,E.lightFrustum.setByViewProjMat(rt(ot(t.getOuterCone(),1,c,t.fRange),E.mLightViewMat));f=W(a.vMax,a.vMin).len(),d=new tt(.5*(a.vMax.x+a.vMin.x),.5*(a.vMax.y+a.vMin.y),.5*(a.vMax.z+a.vMin.z),1),v=nt(r.getViewProjMat4(),d);E.fResolution=e.fShadowResolution*f/Math.max(1,Math.abs(v.w)),this.aShadowCasterList.push(E)}else if(8==t.getType()){var g,p=W(t.getPos(),e.getPos()),x=new j(0,1,0),y=Q(x,p);y.equal(S.VEC3_ZERO)&&(x.set(1,0,0),y=Q(x,p)),x=Q(p,y),y=y.normalize(),x=x.normalize(),p=p.normalize(),(g=new lt).setColumn(0,y),g.setColumn(1,x),g.setColumn(2,p),g.setColumn(3,t.getPos());n=g.inverse(),a=e.getBoundingBox(),s=new j(1e6,1e6,1e6),o=new j(-1e6,-1e6,-1e6);var _=0,M=0;for(h=0;h<8;++h){s=Y(s,L=ct(n,a.getPoint(h))),o=Z(o,L),_=Math.max(_,Math.atan(Math.abs(L.x)/Math.max(.1,-L.z))),M=Math.max(M,Math.atan(Math.abs(L.y)/Math.max(.1,-L.z)))}if(Math.max(_,M)<120*Math.PI/180){(E=new ge).entity=e,E.light=t,E.aBatchList=new Array,e.genRenderBatch(E.aBatchList,i),E.mLightViewMat=new it,n.toMat4(E.mLightViewMat),E.fRatio=Math.tan(_)/Math.tan(M);u=.1-s.z,c=Math.max(.1,-o.z);E.mLightViewProjMat=rt(ot(2*M*180/Math.PI,E.fRatio,c,u),E.mLightViewMat),E.mLightViewProjMat.m20=-E.mLightViewMat.m20/(u-c),E.mLightViewProjMat.m21=-E.mLightViewMat.m21/(u-c),E.mLightViewProjMat.m22=-E.mLightViewMat.m22/(u-c),E.mLightViewProjMat.m23=(-E.mLightViewMat.m23-c)/(u-c),E.lightFrustum=new At,E.lightFrustum.setByViewProjMat(rt(ot(2*M*180/Math.PI,E.fRatio,c,t.fRange),E.mLightViewMat));f=W(a.vMax,a.vMin).len(),d=new tt(.5*(a.vMax.x+a.vMin.x),.5*(a.vMax.y+a.vMin.y),.5*(a.vMax.z+a.vMin.z),1),v=nt(r.getViewProjMat4(),d);E.fResolution=e.fShadowResolution*f/Math.max(1,Math.abs(v.w)),this.aShadowCasterList.push(E)}else{var T=[new lt,new lt,new lt,new lt,new lt,new lt],b=t.getPos();T[0].setColumn(0,0,1,0),T[0].setColumn(1,0,0,1),T[0].setColumn(2,1,0,0),T[0].setColumn(3,b),T[1].setColumn(0,0,-1,0),T[1].setColumn(1,0,0,1),T[1].setColumn(2,-1,0,0),T[1].setColumn(3,b),T[2].setColumn(0,-1,0,0),T[2].setColumn(1,0,0,1),T[2].setColumn(2,0,1,0),T[2].setColumn(3,b),T[3].setColumn(0,1,0,0),T[3].setColumn(1,0,0,1),T[3].setColumn(2,0,-1,0),T[3].setColumn(3,b),T[4].setColumn(0,1,0,0),T[4].setColumn(1,0,1,0),T[4].setColumn(2,0,0,1),T[4].setColumn(3,b),T[5].setColumn(0,1,0,0),T[5].setColumn(1,0,-1,0),T[5].setColumn(2,0,0,-1),T[5].setColumn(3,b);var A=[T[0].inverse(),T[1].inverse(),T[2].inverse(),T[3].inverse(),T[4].inverse(),T[5].inverse()];for(h=0;h<6;++h){for(n=A[h],a=e.getBoundingBox(),s=new j(1e6,1e6,1e6),o=new j(-1e6,-1e6,-1e6),_=0,M=0,h=0;h<8;++h){var L;s=Y(s,L=ct(n,a.getPoint(h))),o=Z(o,L)}u=.1-s.z,c=Math.max(.1,-o.z);if(!(u<.1)){var C=new At;if(C.setByViewProjMat(rt(ot(91,1,c,t.fRange),n)),0!=C.collideAABBox(a)){var E;(E=new ge).entity=e,E.light=t,E.aBatchList=new Array,e.genRenderBatch(E.aBatchList,i),E.mLightViewMat=new it,n.toMat4(E.mLightViewMat),E.fRatio=1,E.mLightViewProjMat=rt(ot(2*M*180/Math.PI,E.fRatio,c,u),E.mLightViewMat),E.mLightViewProjMat.m20=-E.mLightViewMat.m20/(u-c),E.mLightViewProjMat.m21=-E.mLightViewMat.m21/(u-c),E.mLightViewProjMat.m22=-E.mLightViewMat.m22/(u-c),E.mLightViewProjMat.m23=(-E.mLightViewMat.m23-c)/(u-c),E.lightFrustum=C;f=W(a.vMax,a.vMin).len(),d=new tt(.5*(a.vMax.x+a.vMin.x),.5*(a.vMax.y+a.vMin.y),.5*(a.vMax.z+a.vMin.z),1),v=nt(r.getViewProjMat4(),d);E.fResolution=e.fShadowResolution*f/Math.max(1,Math.abs(v.w)),this.aShadowCasterList.push(E)}}}}}},z(pe,fe),pe.prototype.createResource=function(){var t=this.renderer.rc,e=this.renderer.renderEnv,i=this.renderer.renderTargetCollector;null==this.lightTex&&(this.lightTex=new kt(t)),this.lightTex.createTexture(3553,e.iCanvasWidth,e.iCanvasHeight,6408),i.setRenderTarget("LTex",this.lightTex),null==this.lightFbo&&(this.lightFbo=new Pt(t)),this.lightFbo.createBuffer(),this.lightFbo.bind(),this.lightFbo.attachRenderTexture(0,this.lightTex),this.lightFbo.attachDepthStencilBuffer(i.getRenderTarget("DSBuf")),this.lightFbo.unbind()},pe.prototype.deleteResource=function(){this.renderer.rc,this.renderer.renderEnv;var t=this.renderer.renderTargetCollector;this.lightTex&&(this.lightTex.releaseTexture(),t.setRenderTarget("LTex",null)),this.lightFbo&&this.lightFbo.releaseBuffer()},pe.prototype.beginView=function(t){var e=this.renderer.rc,i=this.renderer.renderEnv.camera;if(1!=t){this.lightFbo.bind(),i.bindViewport();var r=i.getBackColor();e.clearColor(r.x,r.y,r.z,r.w),e.clear(16384),this.lightFbo.unbind()}},pe.prototype.endView=function(){},pe.prototype.render=function(t){var e=this.renderer.rc,i=(t=this.renderer.renderEnv,this.renderer.renderSourceCollector);this.lightFbo.bind(),t.camera.bindViewport();var r=i.getBatchList("Visible_Opaque");r.length>0&&(e.enable(2929),t.aStageEnableList[0]?e.depthFunc(514):e.depthFunc(515),e.enable(2884),e.disable(3042),this._renderBatches(r,"Lighting",!0,!0,!0),e.depthFunc(515));var n=i.getBatchList("Visible_Trans");n.length>0&&(e.enable(3042),e.enable(2884),this._renderBatches(n,"Lighting",!0,!0,!0),e.disable(3042)),this.lightFbo.unbind()},z(xe,fe),xe.prototype.createResource=function(){var t=this.renderer.rc,e=this.renderer.renderEnv;this.renderer.renderTargetCollector;null==this.postTex&&(this.postTex=new kt(t)),this.postTex.createTexture(3553,e.iCanvasWidth,e.iCanvasHeight,6408),null==this.postTex_Half&&(this.postTex_Half=new kt(t)),this.postTex_Half.createTexture(3553,Math.floor(.5*e.iCanvasWidth),Math.floor(.5*e.iCanvasHeight),6408),null==this.dsBuffer_Half&&(this.dsBuffer_Half=new Ot(t)),this.dsBuffer_Half.createBuffer(34041,Math.floor(.5*e.iCanvasWidth),Math.floor(.5*e.iCanvasHeight)),null==this.postFbo&&(this.postFbo=new Pt(t)),this.postFbo.createBuffer()},xe.prototype.deleteResource=function(){this.renderer.rc,this.renderer.renderEnv,this.renderer.renderTargetCollector;this.postTex&&this.postTex.releaseTexture(),this.postTex_Half&&this.postTex_Half.releaseTexture(),this.dsBuffer_Half&&this.dsBuffer_Half.releaseBuffer(),this.postFbo&&this.postFbo.releaseBuffer()},xe.prototype.beginView=function(t){},xe.prototype.endView=function(){},xe.prototype.render=function(){var t,e=this.renderer.rc,i=this.renderer.renderEnv,r=this.renderer.shaderManager,n=this.renderer.resourceManager,a=this.renderer.renderSourceCollector,s=this.renderer.renderTargetCollector,o=i.camera,h=i.iCanvasWidth,l=i.iCanvasHeight,m=n.getResource("$R$Quad").getMesh(),c=a.getBatchList("Visible_Glow");c.length>0&&(this.postFbo.bind(),this.postFbo.attachRenderTexture(0,this.postTex),this.postFbo.attachDepthStencilBuffer(s.getRenderTarget("DSBuf")),e.clearColor(0,0,0,0),e.clear(16384),e.enable(2929),e.depthFunc(515),o.bindViewport(),this._renderBatches(c,"Glow",!0,!1,!1,null,null,null,!0),e.disable(2929),e.depthMask(!1),this.postFbo.attachRenderTexture(0,this.postTex_Half),this.postFbo.attachDepthStencilBuffer(this.dsBuffer_Half),e.viewport(0,0,this.postTex_Half.getSizeU(),this.postTex_Half.getSizeV()),(t=r.getGaussianProgram(0)).bind(),t.setAttribute("okAttr_Pos",m.getAttributeArrayBuffer("Position"),3),t.setUniformFloat2("okUni_TexelSize",1/this.postTex.getSizeU(),1/this.postTex.getSizeV()),t.setUniformFloat4("okUni_ScreenPosOffsetAndScale",o.iViewportX/h,(l-o.iViewportY-o.iViewportHeight)/l,o.iViewportWidth/h,o.iViewportHeight/l),t.setTexture("okUni_Tex",this.postTex,33071,9729,9729),m.draw(),e.enable(3042),e.blendEquation(32774),e.blendFunc(1,1),this.postFbo.attachRenderTexture(0,s.getRenderTarget("LTex")),this.postFbo.attachDepthStencilBuffer(s.getRenderTarget("DSBuf")),e.viewport(0,0,h,l),(t=r.getGaussianProgram(1)).bind(),t.setAttribute("okAttr_Pos",m.getAttributeArrayBuffer("Position"),3),t.setUniformFloat2("okUni_TexelSize",1/this.postTex_Half.getSizeU(),1/this.postTex_Half.getSizeV()),t.setUniformFloat4("okUni_ScreenPosOffsetAndScale",0,0,1,1),t.setTexture("okUni_Tex",this.postTex_Half,33071,9729,9729),m.draw(),this.postFbo.unbind(),e.enable(2929),e.depthMask(!0),e.disable(3042))},ye.prototype={clear:function(){this.sName="",this.iOffset=0,this.iStride=0,this.iSize=0,this.buf=null}},_e.prototype={clear:function(){V._object(this.aAttribFmt),this.aAttribFmt=V.object(),this.index=null,this.iDrawMode=0,this.iDrawStart=0,this.iDrawCount=0,this.materialRef=null,this.mMatRef=null,this.mMatNRef=null,this.aDctLightListRef=null,this.aPointLightListRef=null,this.aSpotLightListRef=null,this.aBoneMatList=null,this.sBoneIdxAttribName=null,this.sBoneWeightAttribName=null,this.bboxRef=null,this.bReceiveShadow=!0,this.bFaceCamera=!1,this.aResourceIdList.length=0,this.fSortKey=0},addResourceId:function(t){this.aResourceIdList.push(t)},getRefDctLightNum:function(){return null==this.aDctLightListRef?0:this.aDctLightListRef.getSize()},getRefPointLightNum:function(){return null==this.aPointLightListRef?0:this.aPointLightListRef.getSize()},getRefSpotLightNum:function(){return null==this.aSpotLightListRef?0:this.aSpotLightListRef.getSize()}},Me.prototype={clear:function(){for(var t in this.aRenderEntityMap=new Object,this.aRenderBatchMap){var e=this.aRenderBatchMap[t];if(1==this.aRenderBatchReleaseFlagMap[t])for(var i=e.length,r=0;r<i;++r)V._renderBatch(e[r]);e.length=0,delete this.aRenderBatchMap[t]}this.aRenderBatchReleaseFlagMap=new Object,this.aLightListMap=new Object},createEntityList:function(t){var e=new Array;return this.aRenderEntityMap[t]=e,e},clearEntityList:function(t){this.aRenderEntityMap[t]&&(this.aRenderEntityMap[t].length=0)},attachEntity:function(t,e,i){this.aRenderEntityMap[t].push(e)},genBatchList:function(t,e){var i=this.aRenderEntityMap[t],r=e.camera;if(null!=i){for(var n=new Array,a=i.length,s=0;s<a;++s){var o=i[s];o.bVisible&&1!=o.getState(r.getFrustum())&&o.genRenderBatch(n,e)}this.aRenderBatchMap[t]=n,this.aRenderBatchReleaseFlagMap[t]=!1}},sortBatchListByCamera:function(t,e,i){for(var r=e.camera,n=this.aRenderBatchMap[t],a=r.getPos(),s=n.length,o=0;o<s;++o){var h=n[o],l=h.bboxRef,m=l.vMin,c=l.vMax,u=new j(.5*(m.x+c.x),.5*(m.y+c.y),.5*(m.z+c.z));h.fSortKey=J(u,a)}var f=n.sort(i?this._N2FSortFunc:this._F2NSortFunc);this.aRenderBatchMap[t]=f},getEntityList:function(t){return this.aRenderEntityMap[t]},createBatchList:function(t){return this.aRenderBatchReleaseFlagMap[t]=!1,this.aRenderBatchMap[t]=V.array(),this.aRenderBatchMap[t]},getBatchList:function(t){return this.aRenderBatchMap[t]},enableReleaseBatch:function(t,e){this.aRenderBatchReleaseFlagMap[t]=e},createLightList:function(t){this.aLightListMap[t]=new Array},attachLight:function(t,e){this.aLightListMap[t].push(e)},getLightList:function(t){return this.aLightListMap[t]},_F2NSortFunc:function(t,e){return e.fSortKey-t.fSortKey},_N2FSortFunc:function(t,e){return t.fSortKey-e.fSortKey}},Te.prototype={clear:function(){for(var t in this.aRenderTargetMap)delete this.aRenderTargetMap[t]},setRenderTarget:function(t,e){this.aRenderTargetMap[t]=e},getRenderTarget:function(t){return this.aRenderTargetMap[t]},setFinalRenderTarget:function(){this.rc.bindFramebuffer(36160,null)}},be.prototype={clear:function(){this.shaderManager.clear(),this.renderSourceCollector.clear(),this.renderTargetCollector.clear(),this.renderEnv.clear(),this.resourceManager.deleteResource("$R$Quad"),this.resourceManager.deleteResource("$R$White"),this.resourceManager.deleteResource("$R$Black");for(var t=this.renderPipeline.length,e=0;e<t;++e)this.renderPipeline[e].clear()},_createPipelineResource:function(){for(var t=this.renderPipeline.length,e=0;e<t;++e)this.renderPipeline[e].createResource()},_deletePipelineResource:function(){for(var t=this.renderPipeline.length,e=0;e<t;++e)this.renderPipeline[e].init(this),this.renderPipeline[e].deleteResource()},_onResize:function(){this.renderEnv.iCanvasWidth=this.renderEnv.canvas.clientWidth,this.renderEnv.iCanvasHeight=this.renderEnv.canvas.clientHeight,this._deletePipelineResource(),this._createPipelineResource()},enableStage:function(t,e){this.renderPipeline[t].enable(e),this.renderEnv.aStageEnableList[t]=e},isStageEnabled:function(t){return this.renderEnv.aStageEnableList[t]},getRenderSourceCollector:function(){return this.renderSourceCollector},getRenderTargetCollector:function(){return this.renderTargetCollector},clearView:function(t,e,i,r){var n=this.rc;this.renderPipeline[2].lightFbo.bind(),16384&t&&(null==e&&(e=this.renderEnv.camera.vBackColor),n.clearColor(e.x,e.y,e.z,e.w)),256&t&&n.clearDepth(i||1),1024&t&&n.stencilFunc(519,r||0,4294967295),n.clear(t)},beginView:function(t,e){var i=this.rc;this.renderEnv.camera=t,i.enable(3089),t.bindViewport();for(var r=this.renderPipeline.length,n=0;n<r;++n){this.renderPipeline[n].beginView(e)}},endView:function(){for(var t=this.renderPipeline.length,e=0;e<t;++e){this.renderPipeline[e].endView()}this.renderEnv.camera=null},renderScene:function(t){this.renderEnv.scene=t;var e=this.renderSourceCollector;e.clear(),t.getZone().cullByFrustum(this.renderEnv.camera.getFrustum(),e.createEntityList("Visible")),this._postCull();for(var i=this.renderPipeline.length,r=0;r<i;++r){var n=this.renderPipeline[r];n.bEnable&&n.render()}this.renderEnv.scene=null},renderEntity:function(t){var e=this.renderSourceCollector;e.clear(),e.createEntityList("Visible").push(t),this._postCull();var i=this.renderEnv.aStageEnableList[1];this.enableStage(1,!1);for(var r=this.renderPipeline.length,n=0;n<r;++n){var a=this.renderPipeline[n];a.bEnable&&a.render()}this.enableStage(1,i)},renderEntityArray:function(t){var e=this.renderSourceCollector;e.clear();for(var i=e.createEntityList("Visible"),r=t.length,n=0;n<r;++n)i.push(t[n]);this._postCull();var a=this.renderEnv.aStageEnableList[1];this.enableStage(1,!1);var s=this.renderPipeline.length;for(n=0;n<s;++n){var o=this.renderPipeline[n];o.bEnable&&o.render()}this.enableStage(1,a)},present:function(){this.renderEnv.iCurTime=(new Date).getTime()-this.renderEnv.iStartTime,this.renderEnv.fRandom=Math.random();var t=this.rc,e=this.renderEnv,i=this.renderTargetCollector.getRenderTarget("LTex");t.bindFramebuffer(36160,null),t.viewport(0,0,e.iCanvasWidth,e.iCanvasHeight),t.scissor(0,0,e.iCanvasWidth,e.iCanvasHeight),t.disable(2929),t.depthMask(!1),t.disable(3042);var r=this.resourceManager.getResource("$R$Quad").getMesh(0),n=this.shaderManager.getOutputProgram();n.bind(),n.setAttribute("okAttr_Pos",r.getAttributeArrayBuffer("Position"),3),n.setTexture("okUni_Tex",i,33071,9728),r.draw(),t.enable(2929),t.depthMask(!0),this.renderEnv.iCanvasWidth==this.renderEnv.canvas.width&&this.renderEnv.iCanvasHeight==this.renderEnv.canvas.height||this._onResize()},setSceneConfig:function(t){t.vSkyColor.clone(this.renderEnv.vSkyColor),t.vGroundColor.clone(this.renderEnv.vGroundColor),this.renderEnv.bShadow=t.bShadow,this.renderEnv.bFogEnable=t.bFogEnable,t.vFogColor.clone(this.renderEnv.vFogColor),this.renderEnv.fFogDistNear=t.fFogDistNear,this.renderEnv.fFogDistFar=t.fFogDistFar,this.renderEnv.fFogDensity=t.fFogDensity,t.iFogMode=this.renderEnv.iFogMode},setSkyColor:function(t,e,i){null!=e?this.renderEnv.vSkyColor.set(t,e,i):t.clone(this.renderEnv.vSkyColor)},getSkyColor:function(){return this.renderEnv.vSkyColor},setGroundColor:function(t,e,i){null!=e?this.renderEnv.vGroundColor.set(t,e,i):t.clone(this.renderEnv.vGroundColor)},getGroundColor:function(){return this.renderEnv.vGroundColor},enableFog:function(t,e){this.renderEnv.bFogEnable=e},isFogEnabled:function(t){return this.renderEnv.bFogEnable},setFogColor:function(t,e,i,r){null==i?(this.renderEnv.vFogColor.x=e.x,this.renderEnv.vFogColor.y=e.y,this.renderEnv.vFogColor.z=e.z):(this.renderEnv.vFogColor.x=e,this.renderEnv.vFogColor.y=i,this.renderEnv.vFogColor.z=r)},getFogColor:function(t){var e=V.vec3();return this.renderEnv.vFogColor.clone(e)},setFogDistanceNear:function(t,e){this.renderEnv.fFogDistNear=Math.max(.001,e)},setFogDistanceFar:function(t,e){this.renderEnv.fFogDistFar=Math.max(.001,e)},getFogDistanceNear:function(t){return this.renderEnv.fFogDistNear},getFogDistanceFar:function(t){return this.renderEnv.fFogDistFar},setFogDensity:function(t,e){this.renderEnv.fFogDensity=e},getFogDensity:function(t){return this.renderEnv.fFogDensity},enableShadow:function(t){this.renderEnv.bShadow=t},isShadowEnabled:function(){return this.renderEnv.bShadow},_drawTexture:function(t){this.rc.bindFramebuffer(36160,null),this.rc.viewport(0,0,t.getSizeU(),t.getSizeV()),this.rc.disable(2929);var e=this.resourceManager.getResource("$R$Quad").getMesh(),i=this.shaderManager.getFlatColorProgram(!0);i.bind(),i.setUniformMat4("matWorld",rt(st(0,0,-.1),function(t,e,i){var r=V.vec3();null!=e?(r.x=t,r.y=e,r.z=i):(r.x=t.x,r.y=t.y,r.z=t.z);var n=V.mat4();return n.m00=r.x,n.m11=r.y,n.m22=r.z,V._vec3(r),n}(.5*t.getSizeU(),.5*t.getSizeV(),1))),i.setUniformMat4("matViewProj",ht(.5*-t.getSizeU(),.5*t.getSizeU(),.5*t.getSizeV(),.5*-t.getSizeV(),.1,100)),i.setAttribute("position",e.getAttributeArrayBuffer("Position"),3),i.setAttribute("texcoord",e.getAttributeArrayBuffer("Texcoord1"),2),i.setUniformFloat3("color",1,1,1),i.setSampler("texSampler",0),t.bind(0),this.rc.texParameteri(3553,10240,9728),this.rc.texParameteri(3553,10241,9728),this.rc.texParameteri(3553,10242,33071),this.rc.texParameteri(3553,10243,33071),e.draw()},_postCull:function(){var t=this.renderSourceCollector;t.genBatchList("Visible",this.renderEnv),t.enableReleaseBatch("Visible",!0);for(var e=t.getBatchList("Visible"),i=t.createBatchList("Visible_Opaque"),r=t.createBatchList("Visible_Trans"),n=t.createBatchList("Visible_Glow"),a=e.length,s=0;s<a;++s){var o=e[s],h=o.materialRef;h.bBlend?r.push(o):i.push(o),h.bGlow&&n.push(o)}t.sortBatchListByCamera("Visible_Trans",this.renderEnv,0)}};i(369);var Ae=function(t){Object(m.a)(i,t);var e=Object(c.a)(i);function i(t){var r;return Object(o.a)(this,i),(r=e.call(this,t)).initGL=function(){try{console.log("4- entered initGL");var t=document.getElementsByClassName("RENDER");console.log("Get canvas element : ",t),r.gl=t[0].getContext("experimental-webgl"),r.gl.viewportWidth=t[0].width,r.gl.viewportHeight=t[0].height}catch(e){console.log(e)}r.gl||alert("Could not initialise WebGL")},r.WebGLStart=function(){console.log("3- Has entered webgl start"),console.log("state before gl init",r.state),r.initGL(),r.initShaders(),r.parseResponseData(r.state),r.gl.clearColor(.1,.1,.1,1),r.gl.enable(r.gl.DEPTH_TEST),console.log("7- GL fully initialized")},r.getShader=function(t,e,i){var r;if("fragment_shader"===i)r=t.createShader(t.FRAGMENT_SHADER);else{if("vertex_shader"!==i)return null;r=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert(t.getShaderInfoLog(r)),null)},r.initShaders=function(){console.log("5- initShaders");var t=r.getShader(r.gl,"\n    precision mediump float;\n\n    varying vec3 vTransformedNormal;\n    varying vec3 vAlbedo;\n    varying vec4 vPosition;\n\n    uniform float uMaterialShininess;\n\n    uniform bool uUseHighlight;\n    uniform bool uUseLighting;\n\n    uniform vec3 uAmbientColor;\n\n    uniform vec3 uPointLightingLocation;\n    uniform vec3 uPointLightingSpecularColor;\n    uniform vec3 uPointLightingDiffuseColor;\n\n    uniform float uEnvLightLuminance;\n    uniform float uDiffuseLightLuminance;\n\n    void main(void) {\n\n        vec3 lightWeighting;\n        //\u662f\u5426\u5f00\u542f\u5149\u7167\u6548\u679c\n        if (!uUseLighting) {\n            lightWeighting = vec3(1.0, 1.0, 1.0);\n        } else {\n            //\u8ba1\u7b97\u5149\u7167\u7684\u65b9\u5411\n            vec3 lightDirection = normalize(uPointLightingLocation - vPosition.xyz);\n            vec3 normal = normalize(vTransformedNormal);\n\n            //\u7528\u6765\u5b58\u50a8\u955c\u9762\u9ad8\u5149\u7684\u5e26\u6765\u7684\u4eae\u5ea6\n            float specularLightWeighting = 0.0;\n            //\u4f7f\u7528\u5149\u7167\u7684\u540c\u65f6\u5f00\u542f\u955c\u9762\u9ad8\u5149\u6548\u679c\n            if (uUseHighlight) {\n                //\u9996\u5148\u5f97\u5230\u89c2\u5bdf\u65b9\u5411\u4e0a\u7684\u5355\u4f4d\u5411\u91cfV\n                vec3 eyeDirection = normalize(-vPosition.xyz);\n                //\u8ba1\u7b97\u51fa\u6765\u53cd\u5c04\u65b9\u5411\n                vec3 reflectionDirection = reflect(-lightDirection, normal);\n\n            }\n\n            float diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);\n            //lightWeighting = uAmbientColor\n            //  + uPointLightingSpecularColor * specularLightWeighting\n            //  + uPointLightingDiffuseColor * diffuseLightWeighting;\n\n\n            lightWeighting = uAmbientColor * uEnvLightLuminance\n                + uPointLightingSpecularColor * specularLightWeighting\n                + uPointLightingDiffuseColor * diffuseLightWeighting * uDiffuseLightLuminance;\n        }\n\n        vec4 fragmentColor;\n        fragmentColor = vec4(vAlbedo.r, vAlbedo.g, vAlbedo.b, 1.0);\n\n        //fragmentColor = vec4(vAlbedo, 1.0)\n\n        gl_FragColor = (vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a) + 1.0) / 2.0;\n    }\n","fragment_shader"),e=r.getShader(r.gl,"\n    attribute vec3 aVertexPosition;\n    attribute vec3 aVertexNormal;\n    attribute vec3 aVertexAlbedo;\n\n    uniform mat4 uModelViewVMatrix;\n    uniform mat4 uProjectionMatrix;\n    uniform mat4 uNormalMatrix;\n\n    varying vec3 vTransformedNormal;\n    varying vec4 vPosition;\n    varying vec3 vAlbedo;\n\n    void main(void) {\n        vPosition = uModelViewVMatrix * vec4(aVertexPosition, 1.0);\n        gl_Position = uProjectionMatrix * vPosition;\n        vTransformedNormal = (uNormalMatrix * vec4(aVertexNormal , 1.0)).xyz;\n        vAlbedo = aVertexAlbedo;\n    }\n","vertex_shader");r.shaderProgram=r.gl.createProgram(),r.gl.attachShader(r.shaderProgram,e),r.gl.attachShader(r.shaderProgram,t),r.gl.linkProgram(r.shaderProgram),r.gl.getProgramParameter(r.shaderProgram,r.gl.LINK_STATUS)||alert("Could not initialise shaders"),r.gl.useProgram(r.shaderProgram),r.shaderProgram.vertexPositionAttribute=r.gl.getAttribLocation(r.shaderProgram,"aVertexPosition"),r.gl.enableVertexAttribArray(r.shaderProgram.vertexPositionAttribute),r.shaderProgram.vertexNormalAttribute=r.gl.getAttribLocation(r.shaderProgram,"aVertexNormal"),r.gl.enableVertexAttribArray(r.shaderProgram.vertexNormalAttribute),r.shaderProgram.vertexAlbedoAttribute=r.gl.getAttribLocation(r.shaderProgram,"aVertexAlbedo"),r.gl.enableVertexAttribArray(r.shaderProgram.vertexAlbedoAttribute),r.shaderProgram.pMatrixUniform=r.gl.getUniformLocation(r.shaderProgram,"uProjectionMatrix"),r.shaderProgram.mvMatrixUniform=r.gl.getUniformLocation(r.shaderProgram,"uModelViewVMatrix"),r.shaderProgram.nMatrixUniform=r.gl.getUniformLocation(r.shaderProgram,"uNormalMatrix"),r.shaderProgram.materialShininessUniform=r.gl.getUniformLocation(r.shaderProgram,"uMaterialShininess"),r.shaderProgram.showSpecularHighlightsUniform=r.gl.getUniformLocation(r.shaderProgram,"uUseHighlight"),r.shaderProgram.useLightingUniform=r.gl.getUniformLocation(r.shaderProgram,"uUseLighting"),r.shaderProgram.ambientColorUniform=r.gl.getUniformLocation(r.shaderProgram,"uAmbientColor"),r.shaderProgram.pointLightingLocationUniform=r.gl.getUniformLocation(r.shaderProgram,"uPointLightingLocation"),r.shaderProgram.pointLightingSpecularColorUniform=r.gl.getUniformLocation(r.shaderProgram,"uPointLightingSpecularColor"),r.shaderProgram.pointLightingDiffuseColorUniform=r.gl.getUniformLocation(r.shaderProgram,"uPointLightingDiffuseColor"),r.shaderProgram.envLightLuminance=r.gl.getUniformLocation(r.shaderProgram,"uEnvLightLuminance"),r.shaderProgram.diffuseLightluminance=r.gl.getUniformLocation(r.shaderProgram,"uDiffuseLightLuminance")},r.parseResponseData=function(t){console.log("6- parseResponseData"),console.log("data in the parser: ",t),r.resVertexNormalBuffer=r.gl.createBuffer(),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resVertexNormalBuffer),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(t.normals),r.gl.STATIC_DRAW),r.resVertexNormalBuffer.itemSize=3,r.resVertexNormalBuffer.numItems=t.normals.length/3,r.resVertexPositionBuffer=r.gl.createBuffer(),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resVertexPositionBuffer),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(t.depth),r.gl.STATIC_DRAW),r.resVertexPositionBuffer.itemSize=3,r.resVertexPositionBuffer.numItems=t.depth.length/3,r.resAlbedoBuffer=r.gl.createBuffer(),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resAlbedoBuffer),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(t.albedo),r.gl.STATIC_DRAW),r.resAlbedoBuffer.itemSize=3,r.resAlbedoBuffer.numItems=t.albedo.length/3,r.resVertexIndexBuffer=r.gl.createBuffer(),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,r.resVertexIndexBuffer),r.gl.bufferData(r.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.indices),r.gl.STATIC_DRAW),r.resVertexIndexBuffer.itemSize=1,r.resVertexIndexBuffer.numItems=t.indices.length,console.log("resVertexIndexBuffer",r.resVertexIndexBuffer),console.log("resVertexPositionBuffer",r.resVertexPositionBuffer),r.gl.uniform1f(r.shaderProgram.envLightLuminance,parseFloat(t.env_light)),r.gl.uniform1f(r.shaderProgram.diffuseLightluminance,parseFloat(t.diffuse_light))},r.drawScene=function(t){var e=st(0,0,t.distance),i=ot(45,r.gl.viewportWidth/r.gl.viewportHeight,.1,100);if(r.gl.viewport(0,0,r.gl.viewportWidth,r.gl.viewportHeight),r.gl.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),null!=r.resVertexPositionBuffer&&null!=r.resVertexNormalBuffer&&null!=r.resVertexIndexBuffer&&null!=r.resAlbedoBuffer){var n=r.props.useSpecular;r.gl.uniform1i(r.shaderProgram.showSpecularHighlightsUniform,n);var a=r.props.useLight;r.gl.uniform1i(r.shaderProgram.useLightingUniform,a),a&&(r.gl.uniform3f(r.shaderProgram.ambientColorUniform,1,1,1),r.gl.uniform3f(r.shaderProgram.pointLightingLocationUniform,-10,4,-20),r.gl.uniform3f(r.shaderProgram.pointLightingSpecularColorUniform,.8,.8,.8),r.gl.uniform3f(r.shaderProgram.pointLightingDiffuseColorUniform,.8,.8,.8)),e.rot(1,t.flatR,1,0,1,!0),r.props.enableRotation?e.rotY(1,r.rotAngle,!0):e.rotY(1,t.horizonR,!0),e.rotZ(1,t.zRotation,!0),e.translate(2,t.leftRight,t.topDown,0,!0),r.gl.uniform1f(r.shaderProgram.materialShininessUniform,32),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resVertexPositionBuffer),r.gl.vertexAttribPointer(r.shaderProgram.vertexPositionAttribute,r.resVertexPositionBuffer.itemSize,r.gl.FLOAT,!1,0,0),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resVertexNormalBuffer),r.gl.vertexAttribPointer(r.shaderProgram.vertexNormalAttribute,r.resVertexNormalBuffer.itemSize,r.gl.FLOAT,!1,0,0),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.resAlbedoBuffer),r.gl.vertexAttribPointer(r.shaderProgram.vertexAlbedoAttribute,r.resAlbedoBuffer.itemSize,r.gl.FLOAT,!1,0,0),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,r.resVertexIndexBuffer),r.gl.uniformMatrix4fv(r.shaderProgram.pMatrixUniform,!1,i.toArray()),r.gl.uniformMatrix4fv(r.shaderProgram.mvMatrixUniform,!1,e.toArray());var s=e.inverse().transpose();r.gl.uniformMatrix4fv(r.shaderProgram.nMatrixUniform,!1,s.toArray()),r.gl.drawElements(r.gl.TRIANGLES,r.resVertexIndexBuffer.numItems,r.gl.UNSIGNED_SHORT,0)}},r.animate=function(){var t=(new Date).getTime();if(0!=r.lastTime){var e=t-r.lastTime;r.rotAngle+=.05*e}r.lastTime=t},r.canvas=n.a.createRef(),r.state={shouldBeginRendering:r.props.shouldRender,pointLightX:r.props.pX,pointLightY:r.props.pY,pointLightZ:r.props.pZ,depth:r.props.depth,albedo:r.props.albedo,env_light:r.props.env_light,diffuse_light:r.props.diffuse_light,normals:r.props.normals,indices:r.props.indices,useLight:r.props.useLight,useSpecular:r.props.useSpecular,leftRight:r.props.leftRight,topDown:r.props.topDown,zRotation:r.props.zRotation,horizonR:r.props.horizonR,flatR:r.props.flatR,distance:r.props.distance,enableRotation:r.props.enableRotation},r.shaderProgram=null,r.resVertexPositionBuffer=null,r.resVertexNormalBuffer=null,r.resAlbedoBuffer=null,r.gl=null,r.lastTime=0,r.rotAngle=180,r}return Object(h.a)(i,[{key:"tick",value:function(t){this.drawScene(t),this.animate()}},{key:"componentWillReceiveProps",value:function(t,e){this.setState({shouldBeginRendering:this.props.shouldRender,pointLightX:this.props.pX,pointLightY:this.props.pY,pointLightZ:this.props.pZ,depth:this.props.depth,albedo:this.props.albedo,env_light:this.props.env_light,diffuse_light:this.props.diffuse_light,normals:this.props.normals,indices:this.props.indices,useLight:this.props.useLight,useSpecular:this.props.useSpecular,leftRight:this.props.leftRight,topDown:this.props.topDown,zRotation:this.props.zRotation,horizonR:this.props.horizonR,flatR:this.props.flatR,distance:this.props.distance,enableRotation:this.props.enableRotation})}},{key:"componentWillMount",value:function(){console.log("componentWillMount-props.shouldRender : ",this.props.shouldRender),this.setState({shouldBeginRendering:this.props.shouldRender,pointLightX:this.props.pX,pointLightY:this.props.pY,pointLightZ:this.props.pZ,depth:this.props.depth,albedo:this.props.albedo,env_light:this.props.env_light,diffuse_light:this.props.diffuse_light,normals:this.props.normals,indices:this.props.indices,useLight:this.props.lightSwitchValue,useSpecular:this.props.shinySwitchValue,leftRight:this.props.leftRight,topDown:this.props.topDown,zRotation:this.props.zRotation,horizonR:this.props.horizonR,flatR:this.props.flatR,distance:this.props.distance})}},{key:"componentDidMount",value:function(){var t=this;console.log("componentDidMount-props.shouldRender : ",this.props.shouldRender),console.log(this.props.depth),this.props.shouldRender&&(console.log("1- Enter WebGL initialization"),this.WebGLStart(this.props)),this.gl&&(this.timerID=setInterval((function(){return t.tick(t.state)}),1e3/60),console.log("2- tick triggered")),console.log(this.gl)}},{key:"componentWillUpdate",value:function(t,e,i){}},{key:"render",value:function(){return console.log("Canvas_Render rendered"),Object(f.jsx)("div",{children:Object(f.jsx)("canvas",{ref:this.canvas,className:"RENDER",width:400,height:400})})}}]),i}(r.Component),Le=Object(p.a)()(g),Se=function(t){Object(m.a)(i,t);var e=Object(c.a)(i);function i(t){var r;return Object(o.a)(this,i),(r=e.call(this,t)).getXFromAttribInput=function(t,e){r.setState({pointLightX:e})},r.getYFromAttribInput=function(t,e){r.setState({pointLightY:e})},r.getZFromAttribInput=function(t,e){r.setState({pointLightZ:e})},r.getLeftRightSlider=function(t,e){r.setState({leftRight:e})},r.getTopDownSlider=function(t,e){r.setState({topDown:e})},r.getZaxisSlider=function(t,e){r.setState({zRotation:e})},r.getHorizontalSlider=function(t,e){r.setState({horizontalRotation:e})},r.getFlatSlider=function(t,e){r.setState({flatRotation:e})},r.getDistanceSlider=function(t,e){r.setState({pDistance:e})},r.getRenderStatus=function(t){r.setState({shouldRender:t})},r.getRenderInfo=function(t,e,i,n,a,s){r.setState({depth:t,albedo:e,env_light:i,diffuse_light:n,indices:a,normals:s})},r.state={shouldRender:!1,depth:[],albedo:[],env_light:[],diffuse_light:[],indices:[],normals:[],leftRight:0,topDown:0,zRotation:-180,horizontalRotation:180,flatRotation:0,pDistance:-.3,lightSwitchValue:!0,shinySwitchValue:!1,pointLightX:-10.1,pointLightY:4.1,pointLightZ:-20.1,enableRotation:!1},r.getXFromAttribInput=r.getXFromAttribInput.bind(Object(l.a)(r)),r.getYFromAttribInput=r.getYFromAttribInput.bind(Object(l.a)(r)),r.getZFromAttribInput=r.getZFromAttribInput.bind(Object(l.a)(r)),r.getLeftRightSlider=r.getLeftRightSlider.bind(Object(l.a)(r)),r.getTopDownSlider=r.getTopDownSlider.bind(Object(l.a)(r)),r.getZaxisSlider=r.getZaxisSlider.bind(Object(l.a)(r)),r.getHorizontalSlider=r.getHorizontalSlider.bind(Object(l.a)(r)),r.getFlatSlider=r.getFlatSlider.bind(Object(l.a)(r)),r.getDistanceSlider=r.getDistanceSlider.bind(Object(l.a)(r)),r.getRenderStatus=r.getRenderStatus.bind(Object(l.a)(r)),r.getRenderInfo=r.getRenderInfo.bind(Object(l.a)(r)),r}return Object(h.a)(i,[{key:"render",value:function(){var t=this;return console.log("main render"),console.log("mobile page received :",this.state),Object(f.jsxs)(f.Fragment,{children:[this.state.shouldRender?Object(f.jsx)(Ae,{pX:this.state.pointLightX,pY:this.state.pointLightY,pZ:this.state.pointLightZ,depth:this.state.depth,albedo:this.state.albedo,env_light:this.state.env_light,diffuse_light:this.state.diffuse_light,indices:this.state.indices,normals:this.state.normals,useLight:this.state.lightSwitchValue,useSpecular:this.state.shinySwitchValue,leftRight:this.state.leftRight,topDown:this.state.topDown,zRotation:this.state.zRotation,horizonR:this.state.horizontalRotation,flatR:this.state.flatRotation,distance:this.state.pDistance,shouldRender:this.state.shouldRender,enableRotation:this.state.enableRotation}):Object(f.jsx)("div",{className:"loadingText",style:{width:300,height:300,position:"absolute",top:150,left:120,fontSize:20,color:"blue"},children:" Loading ..."}),Object(f.jsx)(L,{parent:this}),Object(f.jsx)(u.a,{defaultActiveKey:"0",className:"transform-accordion",onChange:this.onChange,children:Object(f.jsx)(u.a.Panel,{header:"Rotation Configuration",children:Object(f.jsxs)(u.c,{children:[Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:.001,name:"LeftRight",min:-1,max:1,defaultValue:0,parent:this})})}),Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:.001,name:"TopDown",min:-1,max:1,defaultValue:0,parent:this})})}),Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:.01,name:"ZaxisRotation",min:-180,max:180,defaultValue:0,parent:this})})}),Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:.01,name:"HorizontalRotate",min:0,max:360,defaultValue:180,parent:this})})}),Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:.01,name:"FlatRotation",min:0,max:360,defaultValue:0,parent:this})})}),Object(f.jsx)(u.c.Item,{children:Object(f.jsx)("div",{style:{padding:3.5},children:Object(f.jsx)(d,{step:1e-4,name:"PerspectiveDistance",min:-2,max:-.001,defaultValue:-.3,parent:this})})})]})})}),Object(f.jsx)("div",{style:{marginTop:10,marginBottom:10},children:Object(f.jsxs)(u.a,{defaultActiveKey:"0",className:"my-accordion",onChange:this.onChange,children:[Object(f.jsx)(u.a.Panel,{header:"Effect Option",children:Object(f.jsxs)(u.c,{className:"effect-list",children:[Object(f.jsx)(u.c.Item,{extra:Object(f.jsx)(u.e,{checked:this.state.lightSwitchValue,onChange:function(){return t.setState({lightSwitchValue:!t.state.lightSwitchValue})}}),children:"-  Lighting Effect"}),Object(f.jsx)(u.c.Item,{extra:Object(f.jsx)(u.e,{checked:this.state.shinySwitchValue,onChange:function(){return t.setState({shinySwitchValue:!t.state.shinySwitchValue})}}),children:"-  Specular Effect"}),Object(f.jsx)(u.c.Item,{extra:Object(f.jsx)(u.e,{checked:this.state.enableRotation,onChange:function(){return t.setState({enableRotation:!t.state.enableRotation})}}),children:"-  Auto Rotation"})]})}),Object(f.jsx)(u.a.Panel,{header:"Point LightSource Attribute",children:Object(f.jsx)(u.c,{className:"attrib-list",children:Object(f.jsx)(Le,{parent:this})})})]})})]})}}]),i}(r.Component);s.a.render(Object(f.jsx)(Se,{}),document.getElementById("root"))}},[[370,1,2]]]);
//# sourceMappingURL=main.426db272.chunk.js.map